<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>CEBE | Bitcoin Treasury Company Analysis</title>
    <meta name="description" content="Track Common Equity Bitcoin Exposure (CEBE) across Bitcoin Treasury Companies. Rigorous analysis of drag, capital structure, and actual BTC ownership for common shareholders.">
    
    <!-- PWA Meta Tags -->
    <meta name="application-name" content="CEBE">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="CEBE">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#09090b">
    <meta name="msapplication-TileColor" content="#09090b">
    
    <!-- Favicon: Magnifying glass with ₿ -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect fill='%2309090b' width='32' height='32' rx='4'/%3E%3Ccircle cx='13' cy='13' r='8' fill='none' stroke='%23f97316' stroke-width='2'/%3E%3Cline x1='19' y1='19' x2='27' y2='27' stroke='%23f97316' stroke-width='2.5' stroke-linecap='round'/%3E%3Ctext x='13' y='17' font-family='Arial,sans-serif' font-size='10' font-weight='700' fill='%23f97316' text-anchor='middle'%3E%E2%82%BF%3C/text%3E%3C/svg%3E">
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="manifest" href="manifest.json">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #09090b;
            --bg-secondary: #0f0f11;
            --bg-card: #141416;
            --bg-elevated: #1a1a1d;
            --orange-primary: #f97316;
            --orange-light: #fb923c;
            --orange-glow: rgba(249, 115, 22, 0.12);
            --orange-border: rgba(249, 115, 22, 0.25);
            --text-primary: #fafafa;
            --text-secondary: #a1a1aa;
            --text-muted: #52525b;
            --green: #22c55e;
            --green-muted: rgba(34, 197, 94, 0.15);
            --red: #ef4444;
            --red-muted: rgba(239, 68, 68, 0.15);
            --yellow: #eab308;
            --yellow-muted: rgba(234, 179, 8, 0.15);
            --border-subtle: rgba(255, 255, 255, 0.06);
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }
        
        .container { max-width: 1400px; margin: 0 auto; padding: 40px 20px; }
        
        /* Modern Logo with Glow */
        .header { text-align: center; margin-bottom: 60px; }
        
        .logo-container { position: relative; display: inline-block; }
        
        .logo {
            font-size: 42px;
            font-weight: 300;
            letter-spacing: 24px;
            padding-left: 24px;
            color: var(--text-primary);
            position: relative;
            z-index: 1;
        }
        
        .logo span {
            background: linear-gradient(135deg, var(--orange-primary) 0%, var(--orange-light) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 600;
        }
        
        .logo-whisper {
            font-size: 13px;
            font-weight: 400;
            letter-spacing: 10px;
            padding-left: 10px;
            margin-top: 4px;
            text-transform: lowercase;
            background: linear-gradient(180deg, 
                rgba(161, 161, 170, 0.6) 0%, 
                rgba(82, 82, 91, 0.2) 100%
            );
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .logo-glow {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 60px;
            background: radial-gradient(ellipse, rgba(249, 115, 22, 0.3) 0%, transparent 70%);
            filter: blur(20px);
            z-index: 0;
        }
        
        .tagline { 
            font-size: 14px; 
            color: var(--text-muted); 
            margin-top: 12px;
            font-weight: 400;
            letter-spacing: 0.5px;
        }
        
        .last-updated { 
            font-size: 11px; 
            color: var(--text-muted); 
            margin-top: 16px; 
            font-family: 'JetBrains Mono', monospace;
            opacity: 0.7;
        }
        
        /* Loading State */
        .loading { text-align: center; padding: 80px; color: var(--text-secondary); }
        .loading-spinner { 
            display: inline-block; 
            width: 32px; 
            height: 32px; 
            border: 2px solid var(--border-subtle); 
            border-top-color: var(--orange-primary); 
            border-radius: 50%; 
            animation: spin 0.8s linear infinite; 
            margin-bottom: 16px; 
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Table Hint */
        .table-hint {
            text-align: center;
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 16px;
        }
        
        .table-hint:hover {
            color: var(--orange-primary);
        }
        
        /* CEBE Explainer Banner */
        .cebe-banner {
            max-width: 720px;
            margin: 0 auto 16px;
            padding: 16px 20px;
            border: 1px solid var(--orange-border, rgba(249,115,22,0.25));
            background: rgba(249, 115, 22, 0.06);
            border-radius: 12px;
            text-align: center;
        }
        .cebe-banner-title {
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            font-weight: 700;
            color: var(--orange-primary);
            letter-spacing: 1px;
            margin-bottom: 8px;
        }
        .cebe-banner-formula {
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            color: var(--text-muted);
            line-height: 1.7;
            margin-bottom: 8px;
        }
        .cebe-banner-formula .label {
            display: inline-block;
            color: #71717a;
            margin-right: 4px;
        }
        .cebe-banner-formula .val {
            color: #a1a1aa;
        }
        .cebe-banner-formula .highlight {
            color: var(--orange-primary);
        }
        .cebe-banner-note {
            font-size: 11px;
            color: #52525b;
            line-height: 1.5;
        }
        
        /* Cycle Toggle */
        .cycle-toggle {
            display: inline-flex;
            gap: 2px;
            background: var(--bg-primary);
            border-radius: 6px;
            padding: 2px;
            margin-top: 4px;
        }
        .cycle-toggle button {
            font-family: 'JetBrains Mono', monospace;
            font-size: 9px;
            font-weight: 500;
            padding: 2px 6px;
            border: none;
            border-radius: 4px;
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.15s;
            letter-spacing: 0.3px;
        }
        .cycle-toggle button:hover { color: var(--text-secondary); }
        .cycle-toggle button.active {
            background: var(--orange-primary);
            color: #000;
        }
        
        /* Table Container */
        .table-container {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin-bottom: 40px;
        }
        
        .data-table { width: 100%; border-collapse: collapse; min-width: 900px; }
        
        .data-table th {
            background: var(--bg-secondary);
            padding: 14px 24px;
            text-align: left;
            font-weight: 500;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            color: var(--text-muted);
            border-bottom: 1px solid var(--border-subtle);
            cursor: default;
            user-select: none;
        }
        
        .data-table th[data-sort] {
            cursor: pointer;
            position: relative;
            padding-right: 28px;
            transition: color 0.15s;
        }
        
        .data-table th[data-sort="cycle_mnav"] {
            padding-right: 14px;
        }
        
        .data-table th[data-sort="cycle_mnav"]::after {
            display: none;
        }
        
        .data-table th[data-sort]:hover {
            color: var(--orange-primary);
        }
        
        .data-table th[data-sort]::after {
            content: '\2195';
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 10px;
            opacity: 0.3;
        }
        
        .data-table th[data-sort].sort-asc::after {
            content: '\25B2';
            opacity: 0.8;
            color: var(--orange-primary);
        }
        
        .data-table th[data-sort].sort-desc::after {
            content: '\25BC';
            opacity: 0.8;
            color: var(--orange-primary);
        }
        
        .data-table td {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-subtle);
            vertical-align: middle;
        }
        
        .data-table tbody tr {
            cursor: pointer;
            transition: all 0.15s ease;
        }
        
        .data-table tbody tr:last-child td { border-bottom: none; }
        
        .data-table tbody tr:hover { 
            background: var(--orange-glow);
        }
        
        .data-table tbody tr:active {
            background: rgba(249, 115, 22, 0.18);
        }
        
        /* Company Cell */
        .company-cell { display: flex; align-items: center; gap: 16px; }
        
        .company-info { display: flex; flex-direction: column; gap: 2px; }
        
        .company-ticker { 
            font-family: 'JetBrains Mono', monospace; 
            font-weight: 600; 
            font-size: 15px; 
            color: var(--orange-primary);
            letter-spacing: 0.5px;
        }
        
        /* Multi-ticker display */
        .company-tickers {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-items: center;
        }
        
        .ticker-badge {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
            font-size: 12px;
            color: var(--orange-primary);
            background: rgba(249, 115, 22, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            letter-spacing: 0.3px;
        }
        
        .ticker-badge.primary {
            font-size: 14px;
            background: rgba(249, 115, 22, 0.15);
            padding: 3px 8px;
        }
        
        .ticker-separator {
            color: var(--text-muted);
            font-size: 10px;
        }
        
        .company-name { 
            font-size: 13px; 
            color: var(--text-secondary);
            font-weight: 400;
        }
        
        /* Metrics */
        .metric-value { 
            font-family: 'JetBrains Mono', monospace; 
            font-weight: 500; 
            font-size: 16px;
            letter-spacing: -0.3px;
        }
        
        .metric-label { 
            font-size: 10px; 
            color: var(--text-muted); 
            margin-top: 3px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Drag Badge */
        .drag-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 64px;
            padding: 6px 12px;
            border-radius: 8px;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 500;
            font-size: 13px;
        }
        
        .drag-low { background: var(--green-muted); color: var(--green); }
        .drag-medium { background: var(--yellow-muted); color: var(--yellow); }
        .drag-high { background: var(--red-muted); color: var(--red); }
        .drag-zero { background: var(--green-muted); color: var(--green); }
        
        /* Source Column */
        .source-cell {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .source-text {
            font-size: 11px;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
        }
        
        .click-hint {
            font-size: 10px;
            color: var(--orange-primary);
            opacity: 0;
            transition: opacity 0.15s ease;
        }
        
        .data-table tbody tr:hover .click-hint {
            opacity: 1;
        }
        
        /* Trend Indicator */
        .trend-cell {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .mini-chart {
            width: 60px;
            height: 24px;
        }
        
        .mini-chart svg {
            width: 100%;
            height: 100%;
        }
        
        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .modal-overlay.active { display: flex; }
        
        .modal {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 20px;
            max-width: 560px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }
        
        .modal-header {
            padding: 24px 28px;
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title-group { display: flex; flex-direction: column; gap: 4px; }
        
        .modal-title { 
            font-size: 20px; 
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .modal-tickers {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .modal-ticker { 
            color: var(--orange-primary); 
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            font-weight: 500;
            background: rgba(249, 115, 22, 0.1);
            padding: 2px 8px;
            border-radius: 4px;
        }
        
        .modal-close {
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            color: var(--text-secondary);
            width: 32px;
            height: 32px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.15s ease;
        }
        
        .modal-close:hover { 
            background: var(--bg-secondary);
            color: var(--text-primary);
        }
        
        .modal-body { padding: 0; }
        
        /* Modal Tabs */
        .modal-tabs {
            display: flex;
            border-bottom: 1px solid var(--border-subtle);
            padding: 0 28px;
            gap: 0;
        }
        
        .modal-tab {
            padding: 14px 20px;
            font-size: 12px;
            font-weight: 500;
            color: var(--text-muted);
            background: none;
            border: none;
            cursor: pointer;
            position: relative;
            transition: color 0.15s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .modal-tab:hover { color: var(--text-secondary); }
        
        .modal-tab.active { 
            color: var(--orange-primary);
        }
        
        .modal-tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--orange-primary);
        }
        
        .tab-content {
            display: none;
            padding: 24px 28px;
        }
        
        .tab-content.active { display: block; }
        
        .modal-section { margin-bottom: 28px; }
        .modal-section:last-child { margin-bottom: 0; }
        
        .section-title {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            margin-bottom: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .section-title::before {
            content: '';
            width: 3px;
            height: 12px;
            background: var(--orange-primary);
            border-radius: 2px;
        }
        
        /* Metric Grid */
        .metric-grid { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); 
            gap: 12px; 
        }
        
        .metric-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            padding: 16px;
        }
        
        .metric-card-value { 
            font-family: 'JetBrains Mono', monospace; 
            font-size: 22px; 
            font-weight: 600; 
            margin-bottom: 4px;
            letter-spacing: -0.5px;
        }
        
        .metric-card-label { 
            font-size: 11px; 
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Capital Structure */
        .capital-structure { 
            background: var(--bg-secondary); 
            border: 1px solid var(--border-subtle);
            border-radius: 12px; 
            overflow: hidden;
        }
        
        .capital-item { 
            display: flex; 
            justify-content: space-between; 
            padding: 12px 16px; 
            border-bottom: 1px solid var(--border-subtle);
        }
        
        .capital-item:last-child { border-bottom: none; }
        
        .capital-label { color: var(--text-secondary); font-size: 13px; }
        
        .capital-value { 
            font-family: 'JetBrains Mono', monospace; 
            font-weight: 500;
            font-size: 13px;
        }
        
        .capital-item.total {
            background: var(--bg-elevated);
        }
        
        .capital-item.total .capital-label,
        .capital-item.total .capital-value {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .capital-note {
            font-size: 11px;
            color: var(--text-muted);
            font-style: italic;
            padding: 10px 16px;
            background: var(--bg-elevated);
            border-radius: 0 0 12px 12px;
            border-top: 1px solid var(--border-subtle);
        }
        
        /* Formula Box */
        .formula-box {
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            overflow: hidden;
        }
        
        .formula-step {
            display: flex;
            gap: 16px;
            padding: 16px;
            border-bottom: 1px solid var(--border-subtle);
        }
        
        .formula-step:last-child { border-bottom: none; }
        
        .step-number {
            width: 28px;
            height: 28px;
            background: var(--orange-muted);
            color: var(--orange-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            flex-shrink: 0;
        }
        
        .step-content { flex: 1; }
        
        .step-title {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        
        .step-formula {
            font-size: 11px;
            color: var(--text-muted);
            font-style: italic;
            margin-bottom: 8px;
        }
        
        .step-calc {
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .step-calc .highlight {
            color: var(--orange-primary);
            font-weight: 600;
        }
        
        .formula-note {
            margin-top: 16px;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border-radius: 8px;
            font-size: 11px;
            color: var(--text-muted);
            font-style: italic;
        }
        
        /* History Section */
        .history-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border-subtle);
        }
        
        .history-chart {
            height: 120px;
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 16px;
            display: flex;
            align-items: flex-end;
            gap: 4px;
        }
        
        .history-bar {
            flex: 1;
            background: var(--orange-primary);
            border-radius: 4px 4px 0 0;
            min-height: 8px;
            opacity: 0.6;
            transition: opacity 0.15s ease;
        }
        
        .history-bar:hover {
            opacity: 1;
        }
        
        .history-bar.current {
            background: var(--orange-light);
            opacity: 1;
        }
        
        /* Simulator Styles */
        .sim-inputs {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 24px;
        }
        
        .sim-input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .sim-label {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .sim-input-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .sim-currency {
            color: var(--text-muted);
            font-size: 16px;
        }
        
        .sim-input {
            flex: 1;
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            padding: 12px 14px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 16px;
            color: var(--text-primary);
            outline: none;
            transition: border-color 0.15s ease;
        }
        
        .sim-input:focus {
            border-color: var(--orange-primary);
        }
        
        .sim-input::placeholder {
            color: var(--text-muted);
        }
        
        .sim-live-btn {
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            color: var(--orange-primary);
            padding: 12px 14px;
            border-radius: 8px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.15s ease;
            white-space: nowrap;
        }
        
        .sim-live-btn:hover {
            background: var(--orange-muted);
            border-color: var(--orange-primary);
        }
        
        .sim-live-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .sim-duration-btns {
            display: flex;
            gap: 8px;
        }
        
        .sim-duration-btn {
            flex: 1;
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            color: var(--text-secondary);
            padding: 10px 12px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
        }
        
        .sim-duration-btn:hover {
            border-color: var(--orange-border);
            color: var(--text-primary);
        }
        
        .sim-duration-btn.active {
            background: var(--orange-muted);
            border-color: var(--orange-primary);
            color: var(--orange-primary);
        }
        
        .sim-duration-note {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 8px;
            font-style: italic;
        }
        
        .sim-slider {
            width: 100%;
            height: 6px;
            -webkit-appearance: none;
            appearance: none;
            background: var(--bg-secondary);
            border-radius: 3px;
            outline: none;
            margin-top: 4px;
        }
        
        .sim-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: var(--orange-primary);
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.15s ease;
        }
        
        .sim-slider::-webkit-slider-thumb:hover {
            transform: scale(1.1);
        }
        
        .sim-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: var(--orange-primary);
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }
        
        .sim-slider-labels {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            color: var(--text-muted);
            margin-top: 4px;
        }
        
        .sim-comparison {
            display: flex;
            align-items: stretch;
            gap: 16px;
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 20px;
        }
        
        .sim-col {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .sim-col.projected {
            background: var(--orange-muted);
            margin: -20px -20px -20px 0;
            padding: 20px;
            border-radius: 0 12px 12px 0;
        }
        
        .sim-col-header {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-subtle);
        }
        
        .sim-col.projected .sim-col-header {
            color: var(--orange-primary);
            border-color: var(--orange-border);
        }
        
        .sim-arrow {
            display: flex;
            align-items: center;
            color: var(--text-muted);
            font-size: 24px;
        }
        
        .sim-metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .sim-metric-label {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .sim-metric-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .sim-col.projected .sim-metric-value {
            color: var(--orange-light);
        }
        
        .sim-stock-result {
            background: var(--bg-secondary);
            border-radius: 12px;
            overflow: hidden;
        }
        
        .sim-stock-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-subtle);
            font-size: 13px;
        }
        
        .sim-stock-row:last-child {
            border-bottom: none;
        }
        
        .sim-stock-row span:first-child {
            color: var(--text-secondary);
        }
        
        .sim-stock-row span:last-child {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 500;
        }
        
        .sim-stock-row.highlight-row {
            background: var(--orange-muted);
        }
        
        .sim-stock-row.highlight-row span:last-child {
            color: var(--orange-primary);
            font-size: 16px;
        }
        
        .sim-stock-row.change-row span:last-child.positive {
            color: var(--green);
        }
        
        .sim-stock-row.change-row span:last-child.negative {
            color: var(--red);
        }
        
        .sim-stock-row.mnav-input-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .mnav-input-wrapper {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .mnav-input {
            width: 70px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            padding: 6px 8px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            color: var(--text-primary);
            text-align: right;
            outline: none;
        }
        
        .mnav-input:focus {
            border-color: var(--orange-primary);
        }
        
        .mnav-input::placeholder {
            color: var(--text-muted);
            font-size: 11px;
        }
        
        .mnav-x {
            color: var(--text-muted);
            font-size: 13px;
        }
        
        .sim-disclaimer {
            margin-top: 20px;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border-left: 3px solid var(--yellow);
            border-radius: 0 8px 8px 0;
            font-size: 11px;
            color: var(--text-muted);
            line-height: 1.5;
        }
        
        .sim-wrapper-impact {
            margin-top: 16px;
        }
        
        .sim-wrapper-bar {
            display: flex;
            align-items: center;
            gap: 12px;
            background: rgba(255, 140, 0, 0.06);
            border: 1px solid var(--orange-border);
            border-radius: 10px;
            padding: 14px 16px;
        }
        
        .sim-wrapper-bar.negative-wrapper {
            background: rgba(34, 197, 94, 0.06);
            border-color: rgba(34, 197, 94, 0.3);
        }
        
        .sim-wrapper-icon {
            font-size: 20px;
            flex-shrink: 0;
        }
        
        .sim-wrapper-content {
            flex: 1;
            min-width: 0;
        }
        
        .sim-wrapper-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 2px;
        }
        
        .sim-wrapper-detail {
            font-size: 11px;
            color: var(--text-muted);
            line-height: 1.4;
        }
        
        .sim-wrapper-delta {
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            font-weight: 600;
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        @media (max-width: 500px) {
            .sim-comparison {
                flex-direction: column;
            }
            
            .sim-arrow {
                transform: rotate(90deg);
                justify-content: center;
                padding: 8px 0;
            }
            
            .sim-col.projected {
                margin: 0 -20px -20px -20px;
                border-radius: 0 0 12px 12px;
            }
        }
        
        /* Footer */
        .footer { 
            text-align: center; 
            padding: 40px 20px; 
            border-top: 1px solid var(--border-subtle); 
            margin-top: 40px; 
        }
        
        /* BTC Price Display */
        .btc-price-display {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            border-radius: 20px;
            padding: 8px 16px;
            margin: 16px 0;
        }
        
        .btc-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--orange-primary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .btc-price {
            font-family: 'JetBrains Mono', monospace;
            font-size: 15px;
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .btc-price.updating {
            animation: pulse 1s ease-in-out;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .footer-text { 
            color: var(--text-muted); 
            font-size: 13px; 
        }
        
        .footer-link { 
            color: var(--orange-primary); 
            text-decoration: none;
            transition: color 0.15s ease;
        }
        
        .footer-link:hover { 
            color: var(--orange-light);
        }
        
        .footer-formula {
            margin-top: 12px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            color: var(--text-muted);
            opacity: 0.6;
        }
        
        .footer-roadmap {
            margin-top: 16px;
            font-size: 11px;
            color: var(--orange-primary);
            opacity: 0.7;
        }
        
        /* Meta info */
        .modal-meta {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: var(--text-muted);
            padding-top: 16px;
            border-top: 1px solid var(--border-subtle);
            margin-top: 20px;
        }
        
        /* Encumbrance / Costs Tab */
        .cost-section { margin-bottom: 20px; }
        .cost-section-title {
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 1.5px;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .cost-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-subtle);
            font-size: 13px;
        }
        .cost-row:last-child { border-bottom: none; }
        .cost-row.total-row {
            border-top: 2px solid var(--orange-border);
            border-bottom: none;
            margin-top: 4px;
            padding-top: 12px;
            font-weight: 600;
        }
        .cost-row.offset-row { color: var(--green); }
        .cost-row.net-row {
            border-top: 2px solid var(--orange-primary);
            border-bottom: none;
            margin-top: 4px;
            padding-top: 12px;
            font-weight: 700;
            font-size: 14px;
        }
        .cost-label {
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .cost-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
        }
        .cost-value-group {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .cost-pct {
            font-size: 11px;
            color: var(--text-muted);
            min-width: 52px;
            text-align: right;
        }
        .est-badge {
            display: inline-block;
            font-size: 9px;
            font-weight: 700;
            letter-spacing: 0.5px;
            padding: 1px 4px;
            border-radius: 3px;
            background: var(--yellow-muted);
            color: var(--yellow);
            vertical-align: middle;
        }
        .verified-badge {
            display: inline-block;
            font-size: 9px;
            font-weight: 700;
            letter-spacing: 0.5px;
            padding: 1px 4px;
            border-radius: 3px;
            background: var(--green-muted);
            color: var(--green);
            vertical-align: middle;
        }
        .wrapper-fee-hero {
            text-align: center;
            padding: 20px;
            background: var(--bg-elevated);
            border-radius: 12px;
            border: 1px solid var(--border-subtle);
            margin-bottom: 20px;
        }
        .wrapper-fee-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 36px;
            font-weight: 700;
            color: var(--orange-primary);
        }
        .wrapper-fee-label {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 4px;
            letter-spacing: 0.5px;
        }
        .wrapper-fee-sublabel {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 2px;
        }
        .cost-pending {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
            font-size: 14px;
        }
        .cost-pending-icon { font-size: 32px; margin-bottom: 12px; }
        .cost-note {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 16px;
            padding-top: 12px;
            border-top: 1px solid var(--border-subtle);
            line-height: 1.5;
        }
        
        /* Responsive */
        @media (max-width: 900px) {
            .data-table { display: block; overflow-x: auto; }
            .logo { font-size: 32px; letter-spacing: 16px; padding-left: 16px; }
            .metric-grid { grid-template-columns: 1fr; }
        }
        
        @media (max-width: 600px) {
            .container { padding: 20px 12px; }
            .data-table th, .data-table td { padding: 14px 16px; }
            .metric-value { font-size: 14px; }
            .modal { border-radius: 16px; }
            .modal-body { padding: 20px; }
            .company-tickers { gap: 4px; }
            .ticker-badge { font-size: 10px; padding: 2px 4px; }
            .ticker-badge.primary { font-size: 12px; }
            .cebe-banner { margin: 0 4px 16px; padding: 12px 14px; }
            .cebe-banner-formula .label { display: block; margin-bottom: 2px; margin-right: 0; }
        }
    </style>
    <script>
        window.va = window.va || function () { (window.vaq = window.vaq || []).push(arguments); };
    </script>
    <script defer src="/_vercel/insights/script.js"></script>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="logo-container">
                <div class="logo-glow"></div>
                <h1 class="logo"><span>CEBE</span></h1>
                <p class="logo-whisper">tracker</p>
            </div>
            <p class="tagline">Common Equity Bitcoin Exposure</p>
            <div style="display:flex; justify-content:center; gap:8px; flex-wrap:wrap; margin-top:10px;">
                <a href="/framework" style="display:inline-block; padding:5px 14px; border-radius:20px; border:1px solid rgba(249,115,22,0.3); background:rgba(249,115,22,0.06); color:#f97316; font-size:11px; font-weight:600; letter-spacing:1.5px; font-family:'JetBrains Mono',monospace; text-decoration:none; transition:all 0.2s;" onmouseover="this.style.background='rgba(249,115,22,0.15)';this.style.borderColor='rgba(249,115,22,0.6)'" onmouseout="this.style.background='rgba(249,115,22,0.06)';this.style.borderColor='rgba(249,115,22,0.3)'">FRAMEWORK</a>
                <a href="/modeler" style="display:inline-block; padding:5px 14px; border-radius:20px; border:1px solid rgba(249,115,22,0.3); background:rgba(249,115,22,0.06); color:#f97316; font-size:11px; font-weight:600; letter-spacing:1.5px; font-family:'JetBrains Mono',monospace; text-decoration:none; transition:all 0.2s;" onmouseover="this.style.background='rgba(249,115,22,0.15)';this.style.borderColor='rgba(249,115,22,0.6)'" onmouseout="this.style.background='rgba(249,115,22,0.06)';this.style.borderColor='rgba(249,115,22,0.3)'">MODELER</a>
                <a href="/endgame" style="display:inline-block; padding:5px 14px; border-radius:20px; border:1px solid rgba(249,115,22,0.3); background:rgba(249,115,22,0.06); color:#f97316; font-size:11px; font-weight:600; letter-spacing:1.5px; font-family:'JetBrains Mono',monospace; text-decoration:none; transition:all 0.2s;" onmouseover="this.style.background='rgba(249,115,22,0.15)';this.style.borderColor='rgba(249,115,22,0.6)'" onmouseout="this.style.background='rgba(249,115,22,0.06)';this.style.borderColor='rgba(249,115,22,0.3)'">ENDGAME</a>
                <a href="/cebe" style="display:inline-block; padding:5px 14px; border-radius:20px; border:1px solid rgba(249,115,22,0.3); background:rgba(249,115,22,0.06); color:#f97316; font-size:11px; font-weight:600; letter-spacing:1.5px; font-family:'JetBrains Mono',monospace; text-decoration:none; transition:all 0.2s;" onmouseover="this.style.background='rgba(249,115,22,0.15)';this.style.borderColor='rgba(249,115,22,0.6)'" onmouseout="this.style.background='rgba(249,115,22,0.06)';this.style.borderColor='rgba(249,115,22,0.3)'">CEBE vs BPS</a>
            </div>
            <div class="btc-price-display" id="btcPriceDisplay">
                <span class="btc-label">BTC</span>
                <span class="btc-price" id="headerBtcPrice">-</span>
            </div>
            <p class="last-updated" id="lastUpdated">Loading data...</p>
        </header>
        
        <div class="cebe-banner">
            <div class="cebe-banner-title">DRAG ≠ "AMPLIFICATION"</div>
            <div class="cebe-banner-formula">
                <span class="label">Companies report:</span> <span class="val">(Debt + Preferred) ÷ BTC Reserve</span><br>
                <span class="label">CEBE measures:</span> <span class="highlight">(Debt + Preferred − Cash) ÷ BTC Reserve</span>
            </div>
            <div class="cebe-banner-note">
                Cash can service senior claims. It reduces what actually compresses common equity ownership. CEBE drag is always lower than company-reported amplification.
            </div>
        </div>
        
        <p class="table-hint">Click any company to view full CEBE breakdown, simulations, and historical tracking</p>
        
        <div class="table-container">
            <div class="loading" id="loadingState">
                <div class="loading-spinner"></div>
                <p>Loading CEBE data...</p>
            </div>
            <table class="data-table" id="dataTable" style="display: none;">
                <thead>
                    <tr>
                        <th data-sort="name">Company</th>
                        <th>Stock Price</th>
                        <th data-sort="btc">BTC Holdings</th>
                        <th data-sort="cebe">CEBE</th>
                        <th data-sort="drag">Drag</th>
                        <th data-sort="equity">Common Equity</th>
                        <th data-sort="cycle_mnav" title="CEBE mNAV adjusted for wrapper cost over a full cycle">
                            <span id="cycleHeader">Cycle mNAV (4Y)</span>
                            <div class="cycle-toggle" id="cycleToggle">
                                <button data-years="2">2Y</button>
                                <button data-years="4" class="active">4Y</button>
                                <button data-years="6">6Y</button>
                            </div>
                        </th>
                        <th data-sort="cebe_mnav" title="Stock price / CEBE NAV per share -- are you paying a premium or discount to net BTC value?">CEBE mNAV</th>
                        <th style="width: 100px;">Source</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
        
        <footer class="footer">
            <p class="footer-text">
                CEBE Framework by <a href="https://x.com/chcbearsfan" class="footer-link" target="_blank">@chcbearsfan</a> &middot; 
                <a href="/framework" class="footer-link">Read the Framework</a>
            </p>
            <p class="footer-text" style="margin-top:4px">Not financial advice &middot; Data updates after each filing</p>
            <p class="footer-formula">CEBE = (Total BTC - Senior Claims in BTC) / Shares</p>
        </footer>
    </div>
    
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal" id="modal">
            <div class="modal-header">
                <div class="modal-title-group">
                    <h2 class="modal-title" id="modalTitle">Company</h2>
                    <div class="modal-tickers" id="modalTickers"></div>
                </div>
                <button class="modal-close" id="modalClose">&times;</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>
    
    <script>
        // Google Sheets Configuration
        const SHEET_ID = '1BNsCWGVU08PDinDcfzJccqcuj9_KrK1VZGETErzBZvg';
        const SNAPSHOTS_GID = '771405586';
        
        // Finnhub API Key (for stock prices)
        const FINNHUB_API_KEY = 'd5tuehhr01qtjet1d7k0d5tuehhr01qtjet1d7kg';
        
        // Live price cache
        let liveBtcPrice = null;
        let liveStockPrices = {};
        
        // Fetch live BTC price from CoinGecko (free, no key needed)
        // Also derives FX rates from BTC cross-rates
        async function fetchBtcPrice() {
            try {
                const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd,eur,brl,gbp,jpy');
                const data = await response.json();
                liveBtcPrice = data.bitcoin.usd;
                
                // Derive FX rates: 1 foreign unit = X USD
                // e.g. if BTC = $96,000 USD and BTC = R$550,000 BRL, then 1 BRL = 96000/550000 = $0.1745
                if (data.bitcoin.eur > 0) fxRates.EUR = data.bitcoin.usd / data.bitcoin.eur;
                if (data.bitcoin.brl > 0) fxRates.BRL = data.bitcoin.usd / data.bitcoin.brl;
                if (data.bitcoin.gbp > 0) fxRates.GBP = data.bitcoin.usd / data.bitcoin.gbp;
                if (data.bitcoin.jpy > 0) fxRates.JPY = data.bitcoin.usd / data.bitcoin.jpy;
                
                console.log('[FX] Rates derived from CoinGecko BTC cross-rates:', fxRates);
                return liveBtcPrice;
            } catch (error) {
                console.error('Failed to fetch BTC price:', error);
                return null;
            }
        }
        
        // Fetch live stock price from Finnhub (with CEBE API fallback)
        async function fetchStockPrice(symbol) {
            if (FINNHUB_API_KEY === 'YOUR_FINNHUB_KEY_HERE') {
                console.log(`[Finnhub] No API key configured for ${symbol}`);
                return null;
            }
            
            // Try Finnhub first
            try {
                console.log(`[Finnhub] Fetching price for ${symbol}...`);
                const response = await fetch(`https://finnhub.io/api/v1/quote?symbol=${symbol}&token=${FINNHUB_API_KEY}`);
                const data = await response.json();
                console.log(`[Finnhub] Response for ${symbol}:`, data);
                if (data.c && data.c > 0) {
                    liveStockPrices[symbol] = data.c;
                    console.log(`[Finnhub] Got price for ${symbol}: $${data.c}`);
                    return data.c;
                }
                console.log(`[Finnhub] No valid price for ${symbol}, trying CEBE API...`);
            } catch (error) {
                console.error(`[Finnhub] Failed to fetch ${symbol}:`, error);
            }
            
            // Fallback to CEBE API proxy
            try {
                console.log(`[CEBE API] Fetching price for ${symbol}...`);
                const response = await fetch(`/api/stock-price?symbol=${symbol}`);
                const data = await response.json();
                console.log(`[CEBE API] Response:`, data);
                if (data.price && data.price > 0) {
                    liveStockPrices[symbol] = data.price;
                    console.log(`[CEBE API] Got price for ${symbol}: ${data.price} ${data.currency || ''}`);
                    return data.price;
                }
                console.log(`[CEBE API] No valid price for ${symbol}`);
            } catch (error) {
                console.error(`[CEBE API] Failed to fetch ${symbol}:`, error);
            }
            
            return null;
        }
        
        // Ticker symbol mapping for Finnhub/Yahoo
        const tickerToStock = {
            MSTR: 'MSTR',
            MTPLF: 'MTPLF',
            ASST: 'ASST',
            TSWCF: 'TSWCF',
            ALCPB: 'ALCPB.PA',
            OBTC3: 'OBTC3.SA',
            BRR: 'BRR',
            NAKA: 'NAKA'
        };
        
        // Stock price currency — what currency does Finnhub return for each symbol?
        // OTC tickers (MTPLF, TSWCF) return USD. Foreign exchange tickers return local currency.
        const stockCurrency = {
            MSTR: 'USD',
            MTPLF: 'USD',
            ASST: 'USD',
            TSWCF: 'USD',
            ALCPB: 'EUR',
            OBTC3: 'BRL',
            BRR: 'USD',
            NAKA: 'USD'
        };
        
        // FX rates to USD (populated at init)
        let fxRates = { USD: 1, EUR: 1, BRL: 1, GBP: 1, JPY: 1 };
        
        // Company metadata with multi-ticker support
        const companyMeta = {
            MSTR: { 
                name: 'Strategy', 
                exchange: 'Nasdaq: MSTR',
                displayTickers: ['MSTR'],
                primaryTicker: 'MSTR'
            },
            MTPLF: { 
                name: 'Metaplanet', 
                exchange: 'TYO: 3350 / OTC: MPJPY, MTPLF / FRA: DN3', 
                fx_note: 'JPY claims at snapshot FX',
                displayTickers: ['3350', 'MPJPY', 'MTPLF', 'DN3'],
                primaryTicker: '3350'
            },
            ASST: { 
                name: 'Strive', 
                exchange: 'Nasdaq: ASST',
                displayTickers: ['ASST'],
                primaryTicker: 'ASST'
            },
            TSWCF: { 
                name: 'Smarter Web Co', 
                exchange: 'LSE: SWC / OTC: TSWCF / FRA: 3M8', 
                fx_note: 'GBP claims at snapshot FX',
                displayTickers: ['SWC', 'TSWCF', '3M8'],
                primaryTicker: 'SWC'
            },
            ALCPB: { 
                name: 'Capital B', 
                exchange: 'Euronext: ALCPB / OTC: CPTLF', 
                fx_note: 'EUR claims at snapshot FX',
                displayTickers: ['ALCPB', 'CPTLF'],
                primaryTicker: 'ALCPB'
            },
            OBTC3: { 
                name: 'OranjeBTC', 
                exchange: 'B3: OBTC3', 
                fx_note: 'BRL claims converted to USD',
                displayTickers: ['OBTC3'],
                primaryTicker: 'OBTC3'
            },
            BRR: { 
                name: 'ProCap Financial', 
                exchange: 'Nasdaq: BRR',
                displayTickers: ['BRR'],
                primaryTicker: 'BRR'
            },
            NAKA: { 
                name: 'Nakamoto', 
                exchange: 'Nasdaq: NAKA',
                displayTickers: ['NAKA'],
                primaryTicker: 'NAKA'
            }
        };
        
        let allSnapshots = [];
        let companiesData = {};
        let currentSnapshots = [];
        let currentSort = { key: null, dir: 'asc' };
        let cycleYears = 4;
        
        // Get wrapper fee % for a ticker from encumbrance data
        function getWrapperFee(ticker) {
            const enc = encumbranceData[ticker];
            if (!enc || !enc.lastUpdated || !enc.items) return null;
            const totalCost = enc.items.reduce((sum, i) => sum + i.amount, 0);
            const totalOffset = enc.offsets.reduce((sum, o) => sum + o.amount, 0);
            const netCost = totalCost - totalOffset;
            const btcReserve = enc.btcReserveForCalc || 1;
            return netCost / btcReserve; // as decimal, e.g. 0.0169
        }
        
        // Calculate Cycle mNAV: CEBE mNAV adjusted for wrapper cost over cycle
        function calcCycleMnav(cebeMnav, ticker) {
            const wrapper = getWrapperFee(ticker);
            if (wrapper === null || cebeMnav <= 0) return null;
            return cebeMnav * Math.pow(1 - wrapper, cycleYears);
        }
        
        // Encumbrance data — Annual Cost to Common Equity
        // Sources: 10-K, DEF 14A, 8-K, earnings releases
        // EST = estimated from prior filings, will backfill from upcoming 10-Ks
        const encumbranceData = {
            MSTR: {
                lastUpdated: '2026-02-05',
                btcReserveForCalc: 60000000000, // ~$60B for wrapper fee % calc
                items: [
                    { category: 'dividends', label: 'Preferred Dividends (all series)', sublabel: 'STRK 8% · STRF 10% · STRD 10% · STRC 11.25% · STRE 10%', amount: 888000000, pctOfReserve: null, verified: false, note: 'Currently all paid in cash. STRK/STRD can be paid in shares at Strategy\'s election but no share-settled payments observed in 8-K filings to date.' },
                    { category: 'interest', label: 'Convertible Debt Interest', sublabel: '0.42% weighted avg on $8.2B', amount: 35000000, pctOfReserve: null, verified: true, note: 'Contractual — zero-coupon on most tranches' },
                    { category: 'sbc', label: 'Stock-Based Compensation', sublabel: 'RSUs, PSUs, options — all employees', amount: 85000000, pctOfReserve: null, verified: false, note: 'FY2024: $77M, ~10% YoY growth. Dilutes shares without buying BTC.' },
                    { category: 'exec', label: 'Executive Cash Compensation', sublabel: 'CEO, CFO, GC, Chairman', amount: 5700000, pctOfReserve: null, verified: true, note: 'FY2024 DEF 14A: Le salary $1M + bonus $880K + other $473K = $2.35M. Kang salary $640K + bonus $564K + other $173K = $1.38M. Shao salary $640K + bonus $564K + other $18K = $1.22M. Saylor salary $1 + other $792K (security/perks) = $792K. Total: $5.74M.' },
                    { category: 'board', label: 'Board Compensation (cash only)', sublabel: '7 outside directors · equity captured in SBC line', amount: 900000, pctOfReserve: null, verified: true, note: 'DEF 14A: $100K/yr base retainer + committee fees per director. Board equity awards (~$350K/yr/director) included in SBC expense line, not here. Cash portion only to avoid double-count.' },
                ],
                offsets: [
                    { label: 'Net Software Business Income', sublabel: '~$490M revenue, ~66% margin, minus SG&A (ex-SBC)', amount: 5000000, verified: false, note: 'Software business roughly break-even on non-GAAP basis (ex-SBC). Q4 2025: $123M rev, 66.1% margin. Full-year OpEx detail pending FY2025 10-K.' },
                ],
                sources: [
                    'Q4 2025 Earnings Release (Feb 5, 2026)',
                    'FY2024 DEF 14A Proxy Statement',
                    'FY2024 10-K (filed Feb 18, 2025)',
                ],
                pendingBackfill: [
                    'FY2025 10-K (expected ~Feb 18, 2026) — full SBC detail, operating expenses',
                    'FY2025 DEF 14A (~Apr 2026) — updated exec comp, RSU/PSU schedules',
                ]
            },
            ASST: {
                lastUpdated: '2026-02-13',
                btcReserveForCalc: 1280000000, // ~$1.28B at ~$97K
                items: [
                    { category: 'dividends', label: 'SATA Preferred Dividend', sublabel: '12.50% on $426.6M notional (variable rate)', amount: 53300000, pctOfReserve: null, verified: true, note: 'Rate adjusts monthly. 4.27M SATA shares × $100 par × 12.50%' },
                    { category: 'interest', label: 'Legacy Debt Interest', sublabel: 'Semler debt retiring Apr 2026', amount: 500000, pctOfReserve: null, verified: false, note: '~$10M remaining, retiring soon' },
                    { category: 'sbc', label: 'Stock-Based Compensation', sublabel: 'CEO + CLO + CFO + CMO RSU grants', amount: 8000000, pctOfReserve: null, verified: false, note: 'Cole $17M/5yr=$3.4M. Beirne 2.2M RSUs/3yr=$2.8M. Pham 556K RSUs/3yr=$706K. Sarkhani 741K RSUs/3yr=$941K. Grant-date FMV ~$3.81 (Sept 15, 2025). Source: S-4 employment agreements.' },
                    { category: 'exec', label: 'Executive Cash Compensation', sublabel: 'CEO + CLO + CFO + CMO base + target bonus', amount: 5200000, pctOfReserve: null, verified: true, note: 'Cole: $800K + $1.6M bonus + $250K security = $2.65M. Pham: $500K + $500K = $1M. Beirne: $500K + $500K = $1M. Sarkhani: $350K + $175K = $525K. Source: S-4 employment agreements, Sept 15 2025.' },
                ],
                offsets: [
                    { label: 'Strive AUM Management Fees', sublabel: '~$2.3B AUM generating advisory fees', amount: 12000000, verified: false, note: 'Estimated. Actual fee schedule not yet disclosed in filings.' },
                ],
                sources: [
                    '8-K (Feb 13, 2026) — SATA details, BTC holdings',
                    'S-4 Registration Statement — exec comp, merger terms',
                ],
                pendingBackfill: [
                    'FY2025 10-K (expected ~Mar 31, 2026) — first full post-merger filing',
                    'DEF 14A (~Apr-May 2026) — complete exec comp tables, SBC schedules',
                ]
            },
            MTPLF: {
                lastUpdated: '2026-02-14',
                btcReserveForCalc: 3405000000, // 35,102 BTC × $97K
                items: [
                    { category: 'operations', label: 'Operating Expenses (COGS + SGA)', sublabel: '¥2,617M — hotel + BTC segment + corporate', amount: 17200000, pctOfReserve: null, verified: true, note: 'FY2025 決算短信. Includes hotel segment costs (¥267M COGS), BTC segment costs (¥1,277M COGS), corporate SGA. Converted at ¥152/$.' },
                    { category: 'dividends', label: 'MERCURY Class B Dividend', sublabel: '¥49/share × 23.61M shares (cash, JPY)', amount: 59000, pctOfReserve: null, verified: true, note: 'FY2025: ¥9M (only 2 days — issued Dec 29, 2025). Full year forward: ~¥1,157M ($7.6M). Converted at ¥152/$.' },
                    { category: 'interest', label: 'Credit Facility Interest', sublabel: '$355M at ~SOFR+2.25% (rate EST)', amount: 7000, pctOfReserve: null, verified: false, note: 'FY2025: ¥1M (drawn late in year). Full year forward: ~¥3,140M ($20.7M). Rate not disclosed — estimated from market comparables. Converted at ¥152/$.' },
                    { category: 'sbc', label: 'Share Issuance Amortization', sublabel: '¥418M — warrant/equity issuance costs', amount: 2750000, pctOfReserve: null, verified: true, note: 'FY2025 決算短信. Non-cash expense from equity raises. Converted at ¥152/$.' },
                ],
                offsets: [
                    { label: 'BTC Income (Options/Derivatives)', sublabel: '¥8,468M — covered calls, puts, lending', amount: 55700000, verified: true, note: 'FY2025 決算短信. Structural revenue from derivative strategies on BTC holdings. Generates income regardless of BTC price direction. Converted at ¥152/$.' },
                    { label: 'Hotel Segment Revenue', sublabel: '¥436M — Royal Oak Hotel operations', amount: 2900000, verified: true, note: 'FY2025 決算短信. Legacy hotel business contributes positive revenue. Converted at ¥152/$.' },
                ],
                sources: [
                    'FY2025 決算短信 (Feb 14, 2026) — all P&L line items',
                    'Credit facility draw notice (Jan 30, 2026) — $355M USD',
                    'MERCURY Class B prospectus — ¥49/share annual dividend',
                ],
                pendingBackfill: [
                    'Securities report due ~March 25, 2026 — credit facility interest rate, MERCURY par value, detailed SBC/comp breakdown.',
                    'All amounts converted JPY→USD at ¥152/$. Wrapper fee calculated on USD-equivalent basis.',
                ]
            },
            TSWCF: {
                lastUpdated: '2026-02-20',
                btcReserveForCalc: 260800000, // 2,689 BTC x ~$97K
                items: [
                    { category: 'exec', label: 'Board Compensation', sublabel: 'CEO £450K · CFO £300K · Chairman £150K · 3 NEDs £210K', amount: 1399000, pctOfReserve: null, verified: true, note: 'FY2025 Annual Report remuneration report. Webley (CEO) £450K, Soleiman (CFO) £300K, Wade (Chairman) £150K, Evans (NED) £75K, Casson (SID/NED) £75K, Thomas (NED) £60K. Total £1,110,000 (converted at £1=$1.26). Audited by PKF Littlejohn LLP.' },
                    { category: 'operations', label: 'Professional & Legal', sublabel: 'Advisors, solicitors, audit fees', amount: 464000, pctOfReserve: null, verified: true, note: 'FY2025: £368,514. Recurring advisory and compliance costs. Converted at £1=$1.26. Source: Annual Report Note 5.' },
                    { category: 'operations', label: 'Listing & Compliance', sublabel: 'LSE Main Market + Aquis fees, registrar, IR', amount: 418000, pctOfReserve: null, verified: true, note: 'FY2025: £331,400. Ongoing stock exchange and regulatory costs. Converted at £1=$1.26. Source: Annual Report Note 5.' },
                    { category: 'operations', label: 'Staff & Social Security', sublabel: 'Non-director employees + NI + pension', amount: 355000, pctOfReserve: null, verified: true, note: 'FY2025: Non-director staff £183,373 + social security & pension £98,602 = £281,975. Converted at £1=$1.26. Source: Annual Report Notes 6-7.' },
                    { category: 'interest', label: 'CLN Interest', sublabel: 'Smarter Convert — zero-coupon', amount: 0, pctOfReserve: null, verified: true, note: 'The £15.8M Smarter Convert CLN is zero-coupon. No cash interest payments. Matures August 2026 — noteholder can convert to shares at £2.0475, take ~178 BTC from segregated wallet, or cash equivalent. Source: Prospectus Jan 16, 2026.' },
                ],
                offsets: [
                    { label: 'Web Design Revenue (SWC Ltd)', sublabel: 'Acquired April 2025 — recurring web services', amount: 88000, verified: true, note: 'FY2025: £70,029 revenue (partial year from April 2025 acquisition). Net profit £8,005. Annualized run-rate likely higher. Acquisitions pipeline planned per 10-Year Plan. Source: Annual Report Note 28.' },
                ],
                sources: [
                    'FY2025 Annual Report (year ended 31 Oct 2025) — audited by PKF Littlejohn LLP',
                    'Jan 16, 2026 LSE Prospectus — CLN terms, warrant details, share count',
                    'RNS filings via LSE — BTC holdings updates',
                ],
                pendingBackfill: [
                    'FY2025 one-off costs (~£7.4M, mostly £5.6M share issue costs from IPO/raises) excluded from recurring total.',
                    '96M pre-IPO warrants at 2.5p exercisable Apr 2026-Apr 2028 — will add ~£2.4M cash but significant dilution when exercised.',
                    'CLN settlement (Aug 2026) will change cost structure — drag drops to 0% but may add ~7.7M shares if converted.',
                ]
            },
            ALCPB: {
                lastUpdated: '2026-02-17',
                btcReserveForCalc: 275000000, // 2,834 BTC x ~$97K
                items: [
                    { category: 'operations', label: 'Personnel Expenses', sublabel: 'Salaries, AGA (free share grants), employer charges', amount: 11400000, pctOfReserve: null, verified: true, note: 'H1 2025: EUR5,483K annualized = EUR10.97M ($11.4M at 1.04). Includes AGA (French free share grants) — SBC component embedded, not separable without annual report. Source: H1 2025 semi-annual report, approved by Board Oct 30, 2025.' },
                    { category: 'operations', label: 'General & Administrative', sublabel: 'Includes ~EUR2.4M/yr BTC strategy costs (legal, advisory)', amount: 6200000, pctOfReserve: null, verified: true, note: 'H1 2025: EUR2,959K annualized = EUR5.9M ($6.2M). Up 14.5% YoY — includes ~EUR1.2M in BTC strategy launch costs. Source: H1 2025 semi-annual report.' },
                    { category: 'sbc', label: 'Stock-Based Compensation (AGA)', sublabel: 'French free share grants — embedded in personnel line', amount: 0, pctOfReserve: null, verified: false, note: 'AGA mentioned in adjusted EBITDA calc but amount not disclosed separately. Embedded within personnel expenses above. Will extract from FY2025 annual report (expected Mar 25, 2026).' },
                    { category: 'interest', label: 'Debt Service', sublabel: 'All OCAs (convertible bonds) fully converted', amount: 0, pctOfReserve: null, verified: true, note: 'Capital B had OCA convertible bonds that have all been converted to equity. 0% drag — no senior claims of any kind. Pure equity structure.' },
                ],
                offsets: [
                    { label: 'Consulting Revenue (iOrga + Trimane)', sublabel: 'Data intelligence, AI, decentralized tech consulting', amount: 11800000, verified: true, note: 'H1 2025: EUR5,649K annualized = EUR11.3M ($11.8M). Down 23% YoY from staff turnover post-judicial recovery exit. Operating entities EBITDA positive: EUR583K H1 (up 66% YoY). FY2024 TTM: ~$15M. Source: H1 2025 semi-annual report.' },
                ],
                sources: [
                    'H1 2025 semi-annual report (approved by Board Oct 30, 2025)',
                    'FY2024 annual results (Apr 30, 2025) — net income EUR1,361K (profitable)',
                    'Weekly BTC acquisition press releases (cptlb.com/investors)',
                ],
                pendingBackfill: [
                    'FY2025 annual results expected ~Mar 25, 2026 — will provide: full-year opex, AGA/SBC detail, aggregate director comp',
                    'Key exec: Alexandre Laizet (Deputy CEO, Director of Bitcoin Strategy). Individual comp not yet disclosed — French Euronext Growth companies report aggregate director comp in rapport de gestion.',
                    'H1 2025 figures annualized — H2 may differ due to BTC strategy ramp-up costs and consulting revenue recovery.',
                ]
            },
            OBTC3: {
                lastUpdated: '2026-02-20',
                btcReserveForCalc: 361000000, // 3,722 BTC x ~$97K
                items: [
                    { category: 'interest', label: 'Convertible Note Interest', sublabel: '$23M zero-coupon — no interest payments', amount: 0, pctOfReserve: null, verified: true, note: 'Convertible note is zero-coupon. No cash interest, no share dilution from coupon payments. $23M principal due at maturity Sep 2030. Source: CVM filings, company disclosures.' },
                    { category: 'operations', label: 'Operating Expenses (est)', sublabel: '57 employees · education + treasury ops', amount: 1500000, pctOfReserve: null, verified: false, note: 'Estimated from Q3 2025 ITR partial-quarter data. FY2025 net loss ~R$1.12M (~$194K) suggests very lean cost structure. Company notes expenses are partially indexed to BTC, reducing cash drag during downturns. Full-year detail pending FY2025 annual report.' },
                ],
                offsets: [
                    { label: 'Education Revenue (Intergraus)', sublabel: 'Legacy prep courses + financial education', amount: 500000, verified: false, note: 'Estimated. Cursinho Intergraus (acquired via reverse IPO) generates education revenue. Scale unknown — likely small. FY2025 annual report will provide first full-year disclosure.' },
                ],
                sources: [
                    'CVM weekly filings (Feb 2026) — BTC holdings, share buybacks',
                    'Q3 2025 ITR (Sep 30, 2025) — first and only quarterly filing',
                    'Company press releases via CVM / B3',
                ],
                pendingBackfill: [
                    'FY2025 annual report (expected ~Mar-Apr 2026) — first full-year financials, OpEx breakdown, exec comp, SBC details',
                    'CEO/board compensation not yet disclosed in any public filing. Board includes Joshua Levine (chair, ex-BlackRock/Bridgewater), Fernando Ulrich, Julio Capua (ex-XP).',
                    'Company states expenses are partially indexed to BTC — unusual structure that reduces cash drag in downturns. Detail pending.',
                ]
            },
            BRR: {
                lastUpdated: '2026-02-18',
                btcReserveForCalc: 485680000, // 5,007 BTC x $97K
                items: [
                    { category: 'operations', label: 'G&A (recurring est)', sublabel: 'Period $7.63M less ~$3.5M one-time SPAC costs', amount: 4000000, pctOfReserve: null, verified: false, note: 'Inception-period G&A of $7.63M includes substantial one-time SPAC transaction costs (~$3.5M). Recurring run-rate estimated at ~$4M/yr. Source: 10-K FY2025.' },
                    { category: 'sbc', label: 'Stock-Based Compensation', sublabel: 'RSUs vest at $15-$50 targets (stock ~$2.50)', amount: 5700000, pctOfReserve: null, verified: false, note: '$17.1M unrecognized RSU cost / ~3yr avg vesting. Market-based targets ($15-$50) far above current price (~$2.50). Actual expense timing is probabilistic. Source: 10-K Note 13.' },
                    { category: 'operations', label: 'Rent (to Inflection Points)', sublabel: '$19,600/mo sublease, month-to-month', amount: 235200, pctOfReserve: null, verified: true, note: 'Month-to-month sublease to Inflection Points (Pompliano entity). 60-day notice to terminate. $58,800 recorded for partial period. Source: 10-K Note 15.' },
                    { category: 'interest', label: 'Interest Expense (cash)', sublabel: 'Zero-coupon convertible notes', amount: 0, pctOfReserve: null, verified: true, note: 'Converts are zero-coupon. $534K non-cash interest (discount amortization) not included. Source: 10-K Note 8.' },
                ],
                offsets: [
                    { label: 'Revenue (Media/Advertising)', sublabel: '$85K for partial period, annualized', amount: 170000, verified: false, note: '$85K earned inception through Dec 31, 2025. Annualized estimate. Source: 10-K income statement.' },
                    { label: 'Put Option Income', sublabel: 'Premium from selling BTC puts', amount: 1000000, verified: false, note: '$534K premium in FY2025. $889K received Jan 2026 alone for 900 BTC at $70K-$80K strikes. Variable income. Source: 10-K Notes 11-12, 18.' },
                    { label: 'Interest Income', sublabel: 'Cash on deposit', amount: 500000, verified: false, note: '$260K earned in partial period on cash deposits. Annualized estimate. Source: 10-K income statement.' },
                ],
                sources: [
                    'BRR 10-K FY2025 (filed Feb 18, 2026)',
                    'Note 18 Subsequent Events (Feb 9 deleveraging)',
                    'Note 15 Related Party (Inflection Points sublease)',
                ],
                pendingBackfill: [
                    'Q1 2026 10-Q (expected May 2026) will provide first full-quarter recurring data',
                    'Confirm SBC expense trajectory as RSU targets remain far out of money',
                ]
            },
            NAKA: {
                lastUpdated: '2026-02-19',
                btcReserveForCalc: 518000000, // 5,398 BTC x ~$96K
                items: [
                    { category: 'interest', label: 'Kraken Loan Interest', sublabel: '$210M USDT at 8.0% p.a.', amount: 16800000, pctOfReserve: null, verified: true, note: 'Master Loan Agreement Dec 3, 2025. $210M USDT, 8% fixed, maturity Dec 4, 2026. BTC-collateralized (154% Required Margin Ratio). Default rate 13%. Source: 8-K Dec 9, 2025 + Exhibit 10.1.' },
                    { category: 'operations', label: 'Operating Expenses (Q3 annualized)', sublabel: 'G&A + healthcare ops + digital asset costs', amount: 43200000, pctOfReserve: null, verified: false, note: 'Q3 2025 OpEx $10.8M x 4. Includes legacy healthcare, digital asset admin, G&A. 10-Q filed late (NT 10-Q Nov 14). Source: Q3 2025 10-Q.' },
                    { category: 'exec', label: 'Executive Cash Compensation', sublabel: 'Bailey (CEO) + Evans (CIO) + Creighton (CCO)', amount: 3500000, pctOfReserve: null, verified: true, note: 'Bailey: $700K base + $250K signing. Evans: $500K + $250K signing. Creighton: $600K + $250K signing. Excludes performance bonuses (up to $2.1M Bailey, $1.5M Evans, $200K Creighton). Source: 8-K Aug 14, 2025.' },
                    { category: 'sbc', label: 'Stock-Based Compensation', sublabel: 'Options + RSUs + performance awards', amount: 10000000, pctOfReserve: null, verified: false, note: 'Estimated. Bailey: 5M options + $1M RSU + $1M perf RSU/yr. Evans: 10M options + $800K perf RSU/yr. Creighton: 4M options + $600K perf RSU/yr. 37.6M shares reserved under 2025 plan. Source: 8-K Aug 14, 2025.' },
                    { category: 'board', label: 'Board Compensation', sublabel: '6 directors x $300K (cash + equity)', amount: 1800000, pctOfReserve: null, verified: true, note: 'Each non-employee director: $75K cash retainer + 500K stock options + $50K-100K committee fees. Source: 8-K Aug 14, 2025 Director Compensation policy.' },
                    { category: 'operations', label: 'BTC Inc Services Agreement', sublabel: 'Marketing, branding, conference services', amount: 960000, pctOfReserve: null, verified: true, note: 'Related-party agreement with BTC Inc (Bailey entity). $80K/month. Source: 8-K/S-4 disclosures.' },
                ],
                offsets: [
                    { label: 'Healthcare Revenue', sublabel: 'KindlyMD legacy clinics (declining)', amount: 1600000, verified: false, note: 'Q3 2025: $0.4M revenue (down from $0.6M YoY). Annualized ~$1.6M. Negligible relative to costs. Source: Q3 2025 10-Q.' },
                ],
                sources: [
                    'Q3 2025 10-Q (filed late Nov 2025)',
                    '8-K Aug 14, 2025 (exec comp, board comp)',
                    '8-K Dec 9, 2025 (Kraken loan terms)',
                    'Exhibit 10.1 Master Loan Agreement',
                ],
                pendingBackfill: [
                    'FY2025 10-K (expected spring 2026) for full-year expenses',
                    'Cash position update (Q3 $24.2M is 5 months stale)',
                    'BTC Inc deal close would add ~$62M revenue but 363.6M dilutive shares',
                    'WARNING: BTC-secured debt. Kraken can force-liquidate collateral with zero notice at Liquidation Ratio breach.',
                ]
            }
        };
        
        // Fetch and parse Google Sheets CSV
        async function fetchSheetData(gid) {
            const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&gid=${gid}`;
            const response = await fetch(url);
            const text = await response.text();
            return parseCSV(text);
        }
        
        function parseCSV(text) {
            const lines = text.split('\n');
            const headers = parseCSVLine(lines[0]);
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim()) {
                    const values = parseCSVLine(lines[i]);
                    const row = {};
                    headers.forEach((h, idx) => {
                        row[h.replace(/"/g, '').trim()] = values[idx]?.replace(/"/g, '').trim() || '';
                    });
                    data.push(row);
                }
            }
            return data;
        }
        
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let char of line) {
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);
            return result;
        }
        
        function calculateMetrics(snapshot) {
            const btcHoldings = parseFloat(snapshot.btc_holdings) || 0;
            const shares = parseFloat(snapshot.shares_outstanding) || 1;
            const debt = parseFloat(snapshot.debt_usd) || 0;
            const preferred = parseFloat(snapshot.preferred_usd) || 0;
            const cash = parseFloat(snapshot.cash_usd) || 0;
            const btcPrice = liveBtcPrice || parseFloat(snapshot.btc_price) || 100000;
            
            const netClaimsUsd = debt + preferred - cash;
            const netClaimsBtc = Math.max(0, netClaimsUsd / btcPrice);
            const drag = btcHoldings > 0 ? Math.max(0, netClaimsBtc / btcHoldings) : 0;
            const commonEquityBtc = Math.max(0, btcHoldings - netClaimsBtc);
            const bps = (btcHoldings / shares) * 100000000;
            const cebe = (commonEquityBtc / shares) * 100000000;
            const commonEquityPct = Math.max(0, 1 - drag);
            
            return { 
                netClaimsUsd, netClaimsBtc, drag, commonEquityBtc, 
                bps, cebe, commonEquityPct, debt, preferred, cash, btcPrice 
            };
        }
        
        function formatNumber(num) {
            return num.toLocaleString('en-US', { maximumFractionDigits: 0 });
        }
        
        function formatCurrency(num) {
            if (Math.abs(num) >= 1e9) return '$' + (num / 1e9).toFixed(2) + 'B';
            if (Math.abs(num) >= 1e6) return '$' + (num / 1e6).toFixed(1) + 'M';
            return '$' + formatNumber(num);
        }
        
        function getDragClass(drag) {
            if (drag <= 0.001) return 'drag-zero';
            if (drag < 0.15) return 'drag-low';
            if (drag < 0.30) return 'drag-medium';
            return 'drag-high';
        }
        
        function getCompanyHistory(ticker) {
            return allSnapshots
                .filter(s => s.ticker === ticker && (!s.status || s.status.toLowerCase() === 'live'))
                .sort((a, b) => a.snapshot_date.localeCompare(b.snapshot_date));
        }
        
        function getLatestSnapshots(snapshots) {
            const latest = {};
            const order = ['MSTR', 'MTPLF', 'ASST', 'TSWCF', 'ALCPB', 'OBTC3', 'BRR', 'NAKA'];
            
            snapshots.forEach(s => {
                const ticker = s.ticker;
                if (!latest[ticker] || s.snapshot_date > latest[ticker].snapshot_date) {
                    latest[ticker] = s;
                }
            });
            
            return order.filter(t => latest[t]).map(t => latest[t]);
        }
        
        // Generate ticker display HTML
        function renderTickerDisplay(meta) {
            const tickers = meta.displayTickers || [meta.primaryTicker];
            if (tickers.length === 1) {
                return `<div class="company-ticker">${tickers[0]}</div>`;
            }
            
            return `<div class="company-tickers">
                ${tickers.map((t, i) => 
                    `<span class="ticker-badge ${i === 0 ? 'primary' : ''}">${t}</span>`
                ).join('')}
            </div>`;
        }
        
        function renderTable(snapshots) {
            currentSnapshots = snapshots;
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            
            let latestDate = '';
            
            snapshots.forEach(snapshot => {
                const ticker = snapshot.ticker;
                const meta = companyMeta[ticker] || { name: ticker, exchange: '', displayTickers: [ticker], primaryTicker: ticker };
                const metrics = calculateMetrics(snapshot);
                
                if (snapshot.snapshot_date > latestDate) latestDate = snapshot.snapshot_date;
                
                // Store for modal
                companiesData[ticker] = { ...snapshot, ...meta, metrics };
                
                const row = document.createElement('tr');
                row.setAttribute('data-ticker', ticker);
                
                // Truncate source for display
                const sourceShort = (snapshot.source || 'N/A').length > 20 
                    ? (snapshot.source || 'N/A').substring(0, 18) + '...' 
                    : (snapshot.source || 'N/A');
                
                row.innerHTML = `
                    <td>
                        <div class="company-cell">
                            <div class="company-info">
                                ${renderTickerDisplay(meta)}
                                <div class="company-name">${meta.name}</div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <div class="metric-value stock-price" data-symbol="${tickerToStock[ticker] || ticker}">-</div>
                        <div class="metric-label">${stockCurrency[ticker] || 'USD'}</div>
                    </td>
                    <td>
                        <div class="metric-value">${formatNumber(parseFloat(snapshot.btc_holdings))}</div>
                        <div class="metric-label">BTC</div>
                    </td>
                    <td>
                        <div class="metric-value">${formatNumber(Math.round(metrics.cebe))}</div>
                        <div class="metric-label">sats/share</div>
                    </td>
                    <td>
                        <span class="drag-badge ${getDragClass(metrics.drag)}">${(metrics.drag * 100).toFixed(1)}%</span>
                    </td>
                    <td>
                        <div class="metric-value">${(metrics.commonEquityPct * 100).toFixed(1)}%</div>
                        <div class="metric-label">of BTC</div>
                    </td>
                    <td>
                        <div class="metric-value cycle-mnav" data-ticker="${ticker}" data-cebe-btc="${metrics.cebe / 100000000}">-</div>
                        <div class="metric-label">wrapper-adjusted</div>
                    </td>
                    <td>
                        <div class="metric-value cebe-mnav" data-ticker="${ticker}" data-cebe-btc="${metrics.cebe / 100000000}">-</div>
                    </td>
                    <td>
                        <div class="source-cell">
                            <span class="source-text" title="${snapshot.source || 'N/A'}">${sourceShort}</span>
                            <span class="click-hint">Click for details</span>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            document.getElementById('lastUpdated').textContent = `Last updated: ${latestDate}`;
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('dataTable').style.display = 'table';
            
            // Add click handlers
            document.querySelectorAll('#tableBody tr').forEach(row => {
                row.addEventListener('click', () => {
                    const ticker = row.getAttribute('data-ticker');
                    openModal(ticker);
                });
            });
            
            // Reapply cached stock prices after re-render (for sort)
            applyStockPricesFromCache();
        }
        
        function applyStockPricesFromCache() {
            document.querySelectorAll('.stock-price').forEach(el => {
                const symbol = el.dataset.symbol;
                const price = liveStockPrices[symbol];
                if (!price) return;
                
                const ticker = Object.keys(tickerToStock).find(k => tickerToStock[k] === symbol) || symbol;
                const currency = stockCurrency[ticker] || 'USD';
                const fxRate = fxRates[currency] || 1;
                const priceUsd = price * fxRate;
                
                const currencySymbols = { USD: '$', EUR: '\u20AC', BRL: 'R$', GBP: '\u00A3', JPY: '\u00A5' };
                const sym = currencySymbols[currency] || '$';
                el.textContent = sym + price.toFixed(2);
                
                const cycleMnavEl = document.querySelector(`.cycle-mnav[data-ticker="${ticker}"]`);
                
                const cebeMnavEl = document.querySelector(`.cebe-mnav[data-ticker="${ticker}"]`);
                if (cebeMnavEl && priceUsd > 0 && liveBtcPrice > 0) {
                    const cebeBtc = parseFloat(cebeMnavEl.dataset.cebeBtc) || 0;
                    const navPerShare = cebeBtc * liveBtcPrice;
                    if (navPerShare > 0) {
                        const cebeMnav = priceUsd / navPerShare;
                        cebeMnavEl.textContent = cebeMnav.toFixed(2) + 'x';
                        if (cebeMnav < 0.95) cebeMnavEl.style.color = 'var(--green)';
                        else if (cebeMnav > 1.05) cebeMnavEl.style.color = 'var(--red)';
                        else cebeMnavEl.style.color = 'var(--text-primary)';
                        
                        // Update Cycle mNAV
                        if (cycleMnavEl) {
                            const cycleMnav = calcCycleMnav(cebeMnav, ticker);
                            if (cycleMnav !== null) {
                                cycleMnavEl.textContent = cycleMnav.toFixed(2) + 'x';
                                if (cycleMnav < 0.95) cycleMnavEl.style.color = 'var(--green)';
                                else if (cycleMnav > 1.05) cycleMnavEl.style.color = 'var(--red)';
                                else cycleMnavEl.style.color = 'var(--text-primary)';
                            } else {
                                cycleMnavEl.textContent = '-';
                                cycleMnavEl.style.color = 'var(--text-muted)';
                            }
                        }
                    }
                }
            });
        }
        
        // Column sorting
        function getSortValue(snapshot, key) {
            const meta = companyMeta[snapshot.ticker] || {};
            const metrics = calculateMetrics(snapshot);
            const ticker = snapshot.ticker;
            const stockSymbol = tickerToStock[ticker] || ticker;
            const stockPrice = liveStockPrices[stockSymbol] || 0;
            const currency = stockCurrency[ticker] || 'USD';
            const priceUsd = currency !== 'USD' && fxRates[currency] ? stockPrice * fxRates[currency] : stockPrice;
            
            switch(key) {
                case 'name': return (meta.name || ticker).toLowerCase();
                case 'btc': return parseFloat(snapshot.btc_holdings) || 0;
                case 'cebe': return metrics.cebe || 0;
                case 'drag': return metrics.drag || 0;
                case 'equity': return metrics.commonEquityPct || 0;
                case 'cycle_mnav': {
                    const cebeNAV = (metrics.cebe / 100000000) * (liveBtcPrice || 96000);
                    const cebeMnav = priceUsd > 0 && cebeNAV > 0 ? priceUsd / cebeNAV : 0;
                    const cycleMnav = calcCycleMnav(cebeMnav, ticker);
                    return cycleMnav !== null ? cycleMnav : 999;
                }
                case 'cebe_mnav': {
                    const cebeNAV = (metrics.cebe / 100000000) * (liveBtcPrice || 96000);
                    return priceUsd > 0 && cebeNAV > 0 ? priceUsd / cebeNAV : 0;
                }
                default: return 0;
            }
        }
        
        function sortTable(key) {
            if (currentSnapshots.length === 0) return;
            
            if (currentSort.key === key) {
                currentSort.dir = currentSort.dir === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.key = key;
                currentSort.dir = key === 'name' ? 'asc' : 'desc';
            }
            
            const sorted = [...currentSnapshots].sort((a, b) => {
                const va = getSortValue(a, key);
                const vb = getSortValue(b, key);
                let cmp = 0;
                if (typeof va === 'string') {
                    cmp = va.localeCompare(vb);
                } else {
                    cmp = va - vb;
                }
                return currentSort.dir === 'asc' ? cmp : -cmp;
            });
            
            renderTable(sorted);
            
            // Update header arrows
            document.querySelectorAll('.data-table th[data-sort]').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
                if (th.getAttribute('data-sort') === key) {
                    th.classList.add(currentSort.dir === 'asc' ? 'sort-asc' : 'sort-desc');
                }
            });
        }
        
        // Attach sort handlers after DOM ready
        function initSortHeaders() {
            document.querySelectorAll('.data-table th[data-sort]').forEach(th => {
                th.addEventListener('click', (e) => {
                    e.stopPropagation();
                    sortTable(th.getAttribute('data-sort'));
                });
            });
        }
        
        function renderCostsTab(ticker) {
            const enc = encumbranceData[ticker];
            if (!enc || !enc.lastUpdated || enc.items.length === 0) {
                const pendingMsg = enc?.pendingBackfill?.[0] || 'Encumbrance data not yet available for this company.';
                return `
                    <div class="cost-pending">
                        <div class="cost-pending-icon">📋</div>
                        <div style="font-weight:600; margin-bottom:8px;">Encumbrance Data Pending</div>
                        <div style="font-size:12px; line-height:1.6;">${pendingMsg}</div>
                    </div>
                `;
            }
            
            // Calculate totals
            const totalCost = enc.items.reduce((sum, i) => sum + i.amount, 0);
            const totalOffset = enc.offsets.reduce((sum, o) => sum + o.amount, 0); // positive = helps reduce cost
            const netCost = totalCost - totalOffset;
            
            // Use live BTC reserve value if available, otherwise use hardcoded
            const btcReserve = enc.btcReserveForCalc || 1;
            const wrapperFee = (netCost / btcReserve) * 100;
            
            // Build cost rows
            function costRow(item) {
                const pct = ((item.amount / btcReserve) * 100).toFixed(2);
                const badge = item.verified 
                    ? '<span class="verified-badge">VERIFIED</span>' 
                    : '<span class="est-badge">EST</span>';
                return `
                    <div class="cost-row" title="${item.note || ''}">
                        <div class="cost-label">
                            <span>${item.label}</span>
                            ${badge}
                        </div>
                        <div class="cost-value-group">
                            <span class="cost-pct">${pct}%</span>
                            <span class="cost-value">${formatCurrency(item.amount)}</span>
                        </div>
                    </div>
                `;
            }
            
            function offsetRow(item) {
                const net = item.amount;
                const pct = ((Math.abs(net) / btcReserve) * 100).toFixed(2);
                const badge = item.verified 
                    ? '<span class="verified-badge">VERIFIED</span>' 
                    : '<span class="est-badge">EST</span>';
                return `
                    <div class="cost-row offset-row" title="${item.note || ''}">
                        <div class="cost-label">
                            <span>${item.label}</span>
                            ${badge}
                        </div>
                        <div class="cost-value-group">
                            <span class="cost-pct">-${pct}%</span>
                            <span class="cost-value">-${formatCurrency(Math.abs(net))}</span>
                        </div>
                    </div>
                `;
            }
            
            // Group items by category
            const operationsItems = enc.items.filter(i => i.category === 'operations');
            const dividendItems = enc.items.filter(i => i.category === 'dividends');
            const interestItems = enc.items.filter(i => i.category === 'interest');
            const sbcItems = enc.items.filter(i => i.category === 'sbc');
            const compItems = enc.items.filter(i => i.category === 'exec' || i.category === 'board');
            
            let html = '';
            
            // Wrapper Fee Hero
            const isNegative = netCost < 0;
            const heroColor = isNegative ? 'color:#22c55e' : wrapperFee > 3 ? 'color:#ef4444' : '';
            const heroLabel = isNegative ? 'Annual Surplus — Self-Funding Structure' : 'Annual Cost to Common Equity';
            const heroCostDisplay = isNegative 
                ? `${formatCurrency(Math.abs(netCost))} surplus / yr on ${formatCurrency(btcReserve)} BTC reserve`
                : `${formatCurrency(netCost)} / yr on ${formatCurrency(btcReserve)} BTC reserve`;
            html += `
                <div class="wrapper-fee-hero">
                    <div class="wrapper-fee-value" style="${heroColor}">${wrapperFee.toFixed(2)}%</div>
                    <div class="wrapper-fee-label">${heroLabel}</div>
                    <div class="wrapper-fee-sublabel">${heroCostDisplay}</div>
                </div>
            `;
            
            // Operations Costs
            if (operationsItems.length > 0) {
                html += `<div class="cost-section">
                    <div class="cost-section-title">⚙️ Operating Expenses</div>
                    ${operationsItems.map(costRow).join('')}
                </div>`;
            }
            
            // Dividend Costs
            if (dividendItems.length > 0) {
                html += `<div class="cost-section">
                    <div class="cost-section-title">💰 Dividend Obligations</div>
                    ${dividendItems.map(costRow).join('')}
                </div>`;
            }
            
            // Interest Costs
            if (interestItems.length > 0) {
                html += `<div class="cost-section">
                    <div class="cost-section-title">🏦 Debt Service</div>
                    ${interestItems.map(costRow).join('')}
                </div>`;
            }
            
            // SBC
            if (sbcItems.length > 0) {
                html += `<div class="cost-section">
                    <div class="cost-section-title">📊 Stock-Based Compensation</div>
                    ${sbcItems.map(costRow).join('')}
                </div>`;
            }
            
            // Exec & Board Comp
            if (compItems.length > 0) {
                html += `<div class="cost-section">
                    <div class="cost-section-title">👔 Cash Compensation</div>
                    ${compItems.map(costRow).join('')}
                </div>`;
            }
            
            // Total line
            const totalPct = ((totalCost / btcReserve) * 100).toFixed(2);
            html += `
                <div class="cost-row total-row">
                    <div class="cost-label"><span>Total Annual Cost</span></div>
                    <div class="cost-value-group">
                        <span class="cost-pct">${totalPct}%</span>
                        <span class="cost-value">${formatCurrency(totalCost)}</span>
                    </div>
                </div>
            `;
            
            // Revenue Offsets
            if (enc.offsets.length > 0) {
                html += `<div class="cost-section" style="margin-top:16px;">
                    <div class="cost-section-title">📈 Revenue Offsets</div>
                    ${enc.offsets.map(offsetRow).join('')}
                </div>`;
            }
            
            // Net Cost line
            const netPct = ((netCost / btcReserve) * 100).toFixed(2);
            const netColor = netCost < 0 ? 'color:#22c55e' : 'color:var(--orange-primary)';
            const netLabel = netCost < 0 ? 'Net Annual Surplus (Wrapper Fee)' : 'Net Annual Cost (Wrapper Fee)';
            const netDisplay = netCost < 0 
                ? `-${formatCurrency(Math.abs(netCost))}` 
                : formatCurrency(netCost);
            html += `
                <div class="cost-row net-row">
                    <div class="cost-label"><span>${netLabel}</span></div>
                    <div class="cost-value-group">
                        <span class="cost-pct" style="${netColor}">${netPct}%</span>
                        <span class="cost-value" style="${netColor}">${netDisplay}</span>
                    </div>
                </div>
            `;
            
            // Sources & pending
            html += `<div class="cost-note">`;
            html += `<strong>Sources:</strong> ${enc.sources.join(' · ')}<br>`;
            if (enc.pendingBackfill.length > 0) {
                html += `<strong>Pending backfill:</strong> ${enc.pendingBackfill.join(' · ')}`;
            }
            html += `<br><br>`;
            html += `<span class="est-badge">EST</span> = estimated from prior filings &nbsp; <span class="verified-badge">VERIFIED</span> = confirmed from current filings`;
            html += `<br>Data as of ${enc.lastUpdated}. Hover any row for detail.`;
            html += `</div>`;
            
            return `<div class="modal-section">${html}</div>`;
        }
        
        function openModal(ticker) {
            const data = companiesData[ticker];
            if (!data) return;
            
            const m = data.metrics;
            const history = getCompanyHistory(ticker);
            
            document.getElementById('modalTitle').textContent = data.name;
            
            // Render all tickers in modal header
            const tickers = data.displayTickers || [ticker];
            document.getElementById('modalTickers').innerHTML = tickers.map(t => 
                `<span class="modal-ticker">${t}</span>`
            ).join('');
            
            // Build history chart
            let historyHTML = '<p style="color: var(--text-muted); font-size: 13px;">No historical data available yet.</p>';
            if (history.length > 1) {
                const cebeValues = history.map(h => calculateMetrics(h).cebe);
                const maxCebe = Math.max(...cebeValues);
                
                const bars = history.map((h, i) => {
                    const cebe = calculateMetrics(h).cebe;
                    const height = maxCebe > 0 ? (cebe / maxCebe) * 100 : 10;
                    const isCurrent = i === history.length - 1;
                    return `<div class="history-bar ${isCurrent ? 'current' : ''}" style="height: ${Math.max(8, height)}%" title="${h.period}: ${formatNumber(Math.round(cebe))} sats"></div>`;
                }).join('');
                
                historyHTML = `
                    <div class="history-chart">${bars}</div>
                    <div style="display: flex; justify-content: space-between; font-size: 11px; color: var(--text-muted); margin-top: 8px;">
                        <span>${history[0].period}</span>
                        <span>${history[history.length - 1].period}</span>
                    </div>
                `;
            }
            
            document.getElementById('modalBody').innerHTML = `
                <div class="modal-tabs">
                    <button class="modal-tab active" data-tab="overview">Overview</button>
                    <button class="modal-tab" data-tab="costs">Costs</button>
                    <button class="modal-tab" data-tab="simulate">Simulate</button>
                    <button class="modal-tab" data-tab="calculation">Calculation</button>
                    <button class="modal-tab" data-tab="history">History</button>
                </div>
                
                <!-- Overview Tab -->
                <div class="tab-content active" id="tab-overview">
                    <div class="modal-section">
                        <div class="section-title">CEBE Metrics</div>
                        <div class="metric-grid">
                            <div class="metric-card">
                                <div class="metric-card-value">${formatNumber(parseFloat(data.btc_holdings))}</div>
                                <div class="metric-card-label">BTC Holdings</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-card-value">${formatNumber(Math.round(m.cebe))}</div>
                                <div class="metric-card-label">CEBE (sats/share)</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-card-value" style="color: ${m.drag < 0.15 ? 'var(--green)' : m.drag < 0.30 ? 'var(--yellow)' : 'var(--red)'}">${(m.drag * 100).toFixed(1)}%</div>
                                <div class="metric-card-label">Drag</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-card-value" style="color: var(--green)">${(m.commonEquityPct * 100).toFixed(1)}%</div>
                                <div class="metric-card-label">Common Equity Owns</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="modal-section">
                        <div class="section-title">Capital Structure</div>
                        <div class="capital-structure">
                            <div class="capital-item">
                                <span class="capital-label">Debt</span>
                                <span class="capital-value">${formatCurrency(m.debt)}</span>
                            </div>
                            <div class="capital-item">
                                <span class="capital-label">Preferred Stock</span>
                                <span class="capital-value">${formatCurrency(m.preferred)}</span>
                            </div>
                            <div class="capital-item">
                                <span class="capital-label">Cash Offset</span>
                                <span class="capital-value">-${formatCurrency(m.cash)}</span>
                            </div>
                            <div class="capital-item total">
                                <span class="capital-label">Net Senior Claims</span>
                                <span class="capital-value">${formatCurrency(m.netClaimsUsd)}</span>
                            </div>
                        </div>
                        <div class="capital-note">Senior claims include convertibles and preferred equity senior to common${data.fx_note ? '. ' + data.fx_note : ''}.</div>
                    </div>
                    
                    <div class="modal-meta">
                        <span>${data.exchange}</span>
                        <span>Source: ${data.source || 'N/A'}</span>
                    </div>
                </div>
                
                <!-- Costs Tab -->
                <div class="tab-content" id="tab-costs">
                    ${renderCostsTab(ticker)}
                </div>
                
                <!-- Simulate Tab -->
                <div class="tab-content" id="tab-simulate">
                    <div class="modal-section">
                        <div class="section-title">Drag Compression Simulator</div>
                        
                        <div class="sim-inputs">
                            <div class="sim-input-group">
                                <label class="sim-label">BTC Price</label>
                                <div class="sim-input-row">
                                    <span class="sim-currency">$</span>
                                    <input type="number" id="simBtcPrice" class="sim-input" value="${Math.round(m.btcPrice)}" min="10000" max="1000000" step="1000">
                                    <button class="sim-live-btn" id="fetchBtcBtn" title="Fetch live price">Live</button>
                                </div>
                                <input type="range" id="simBtcSlider" class="sim-slider" min="25000" max="500000" step="5000" value="${Math.round(m.btcPrice)}">
                                <div class="sim-slider-labels">
                                    <span>$25K</span>
                                    <span>$500K</span>
                                </div>
                            </div>
                            
                            <div class="sim-input-group">
                                <label class="sim-label">Current Stock Price</label>
                                <div class="sim-input-row">
                                    <span class="sim-currency">$</span>
                                    <input type="number" id="simStockPrice" class="sim-input" value="" placeholder="Enter price" min="0" step="0.01">
                                    <button class="sim-live-btn" id="fetchStockBtn" title="Fetch live price" data-symbol="${tickerToStock[ticker] || ticker}">Live</button>
                                </div>
                            </div>
                            
                            <div class="sim-input-group">
                                <label class="sim-label">Time Horizon</label>
                                <div class="sim-duration-btns">
                                    <button class="sim-duration-btn active" data-years="0">Now</button>
                                    <button class="sim-duration-btn" data-years="1">1Y</button>
                                    <button class="sim-duration-btn" data-years="3">3Y</button>
                                    <button class="sim-duration-btn" data-years="5">5Y</button>
                                </div>
                                <div class="sim-duration-note" id="simDurationNote"></div>
                            </div>
                        </div>
                        
                        <div class="sim-results" id="simResults">
                            <div class="sim-comparison">
                                <div class="sim-col">
                                    <div class="sim-col-header">Today</div>
                                    <div class="sim-metric">
                                        <span class="sim-metric-label">BTC Price</span>
                                        <span class="sim-metric-value" id="simTodayBtc">$${formatNumber(Math.round(m.btcPrice))}</span>
                                    </div>
                                    <div class="sim-metric">
                                        <span class="sim-metric-label">Drag</span>
                                        <span class="sim-metric-value" id="simTodayDrag">${(m.drag * 100).toFixed(1)}%</span>
                                    </div>
                                    <div class="sim-metric">
                                        <span class="sim-metric-label">CEBE</span>
                                        <span class="sim-metric-value" id="simTodayCebe">${formatNumber(Math.round(m.cebe))} sats</span>
                                    </div>
                                    <div class="sim-metric">
                                        <span class="sim-metric-label">You Own</span>
                                        <span class="sim-metric-value" id="simTodayOwn">${(m.commonEquityPct * 100).toFixed(1)}%</span>
                                    </div>
                                </div>
                                <div class="sim-arrow">-></div>
                                <div class="sim-col projected">
                                    <div class="sim-col-header" id="simProjHeader">Projected</div>
                                    <div class="sim-metric">
                                        <span class="sim-metric-label">BTC Price</span>
                                        <span class="sim-metric-value" id="simProjBtc">$${formatNumber(Math.round(m.btcPrice))}</span>
                                    </div>
                                    <div class="sim-metric">
                                        <span class="sim-metric-label">Drag</span>
                                        <span class="sim-metric-value" id="simProjDrag">${(m.drag * 100).toFixed(1)}%</span>
                                    </div>
                                    <div class="sim-metric">
                                        <span class="sim-metric-label">CEBE</span>
                                        <span class="sim-metric-value" id="simProjCebe">${formatNumber(Math.round(m.cebe))} sats</span>
                                    </div>
                                    <div class="sim-metric">
                                        <span class="sim-metric-label">You Own</span>
                                        <span class="sim-metric-value" id="simProjOwn">${(m.commonEquityPct * 100).toFixed(1)}%</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="sim-wrapper-impact" id="simWrapperSection" style="display: none;">
                                <div class="sim-wrapper-bar">
                                    <div class="sim-wrapper-icon">⚙️</div>
                                    <div class="sim-wrapper-content">
                                        <div class="sim-wrapper-title">Wrapper Cost Impact</div>
                                        <div class="sim-wrapper-detail" id="simWrapperDetail"></div>
                                    </div>
                                    <div class="sim-wrapper-delta" id="simWrapperDelta"></div>
                                </div>
                            </div>
                            
                            <div class="sim-stock-projection" id="simStockSection" style="display: none;">
                                <div class="section-title" style="margin-top: 20px;">Share Price Projection</div>
                                <div class="sim-stock-result">
                                    <div class="sim-stock-row">
                                        <span>Current Price</span>
                                        <span id="simCurrentStock">$-</span>
                                    </div>
                                    <div class="sim-stock-row">
                                        <span>Current CEBE mNAV</span>
                                        <span id="simMnav">-</span>
                                    </div>
                                    <div class="sim-stock-row mnav-input-row">
                                        <span>Projected CEBE mNAV</span>
                                        <div class="mnav-input-wrapper">
                                            <input type="number" id="simProjMnav" class="mnav-input" value="" placeholder="same" min="0.1" max="10" step="0.1">
                                            <span class="mnav-x">x</span>
                                        </div>
                                    </div>
                                    <div class="sim-stock-row highlight-row">
                                        <span>Projected Price</span>
                                        <span id="simProjStock">$-</span>
                                    </div>
                                    <div class="sim-stock-row change-row">
                                        <span>Change</span>
                                        <span id="simStockChange">-</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="sim-disclaimer">
                            For educational purposes only. Assumes no changes to capital structure or share count. Wrapper costs projected at current annual rate. Not financial advice.
                        </div>
                    </div>
                </div>
                
                <!-- Calculation Tab -->
                <div class="tab-content" id="tab-calculation">
                    <div class="modal-section">
                        <div class="section-title">Step-by-Step CEBE Calculation</div>
                        <div class="formula-box">
                            <div class="formula-step">
                                <div class="step-number">1</div>
                                <div class="step-content">
                                    <div class="step-title">Calculate Net Senior Claims (USD)</div>
                                    <div class="step-formula">Debt + Preferred - Cash</div>
                                    <div class="step-calc">${formatCurrency(m.debt)} + ${formatCurrency(m.preferred)} - ${formatCurrency(m.cash)} = <span class="highlight">${formatCurrency(m.netClaimsUsd)}</span></div>
                                </div>
                            </div>
                            <div class="formula-step">
                                <div class="step-number">2</div>
                                <div class="step-content">
                                    <div class="step-title">Convert Claims to BTC</div>
                                    <div class="step-formula">Net Claims / BTC Price</div>
                                    <div class="step-calc">${formatCurrency(m.netClaimsUsd)} / $${formatNumber(m.btcPrice)} = <span class="highlight">${formatNumber(Math.round(m.netClaimsBtc))} BTC</span></div>
                                </div>
                            </div>
                            <div class="formula-step">
                                <div class="step-number">3</div>
                                <div class="step-content">
                                    <div class="step-title">Calculate Common Equity BTC</div>
                                    <div class="step-formula">Total BTC - Claims BTC</div>
                                    <div class="step-calc">${formatNumber(parseFloat(data.btc_holdings))} - ${formatNumber(Math.round(m.netClaimsBtc))} = <span class="highlight">${formatNumber(Math.round(m.commonEquityBtc))} BTC</span></div>
                                </div>
                            </div>
                            <div class="formula-step">
                                <div class="step-number">4</div>
                                <div class="step-content">
                                    <div class="step-title">Calculate CEBE (sats/share)</div>
                                    <div class="step-formula">Common Equity BTC / Shares x 100M</div>
                                    <div class="step-calc">${formatNumber(Math.round(m.commonEquityBtc))} / ${formatNumber(parseFloat(data.shares_outstanding))} x 100M = <span class="highlight">${formatNumber(Math.round(m.cebe))} sats</span></div>
                                </div>
                            </div>
                            <div class="formula-step">
                                <div class="step-number">5</div>
                                <div class="step-content">
                                    <div class="step-title">Calculate Drag</div>
                                    <div class="step-formula">Claims BTC / Total BTC</div>
                                    <div class="step-calc">${formatNumber(Math.round(m.netClaimsBtc))} / ${formatNumber(parseFloat(data.btc_holdings))} = <span class="highlight">${(m.drag * 100).toFixed(1)}%</span></div>
                                </div>
                            </div>
                        </div>
                        <div class="formula-note">BTC price from snapshot date (${data.snapshot_date}), not live spot</div>
                    </div>
                </div>
                
                <!-- History Tab -->
                <div class="tab-content" id="tab-history">
                    <div class="modal-section">
                        <div class="section-title">CEBE Over Time</div>
                        ${historyHTML}
                    </div>
                </div>
            `;
            
            // Add tab click handlers
            document.querySelectorAll('.modal-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
                });
            });
            
            // Simulator interaction handlers — compute net annual wrapper from encumbranceData
            const enc = encumbranceData[ticker];
            let netAnnualWrapper = 0;
            let hasWrapperData = false;
            if (enc && enc.lastUpdated && enc.items.length > 0) {
                const totalCost = enc.items.reduce((s, i) => s + i.amount, 0);
                const totalOffset = enc.offsets.reduce((s, o) => s + o.amount, 0);
                netAnnualWrapper = totalCost - totalOffset;
                hasWrapperData = true;
            }
            
            const simData = {
                ticker: ticker,
                btcHoldings: parseFloat(data.btc_holdings),
                shares: parseFloat(data.shares_outstanding),
                netClaimsUsd: m.netClaimsUsd,
                originalBtcPrice: m.btcPrice,
                originalDrag: m.drag,
                originalCebe: m.cebe,
                originalOwn: m.commonEquityPct,
                netAnnualWrapper: netAnnualWrapper,
                hasWrapperData: hasWrapperData
            };
            
            function updateSimulation() {
                const newBtcPrice = parseFloat(document.getElementById('simBtcPrice').value) || simData.originalBtcPrice;
                const stockPrice = parseFloat(document.getElementById('simStockPrice').value);
                
                // Calculate wrapper cost erosion for time horizon
                const wrapperErosion = selectedYears > 0 ? simData.netAnnualWrapper * selectedYears : 0;
                const adjustedNetClaimsUsd = simData.netClaimsUsd + wrapperErosion;
                
                // Calculate new metrics at projected BTC price (wrapper-adjusted when years > 0)
                const newClaimsBtc = adjustedNetClaimsUsd / newBtcPrice;
                const newDrag = simData.btcHoldings > 0 ? newClaimsBtc / simData.btcHoldings : 0;
                const newCommonEquityBtc = simData.btcHoldings - newClaimsBtc;
                const newCebe = simData.shares > 0 ? (newCommonEquityBtc / simData.shares) * 100000000 : 0;
                const newOwn = 1 - newDrag;
                
                // Update projected values
                document.getElementById('simProjBtc').textContent = '$' + formatNumber(Math.round(newBtcPrice));
                document.getElementById('simProjDrag').textContent = (newDrag * 100).toFixed(1) + '%';
                document.getElementById('simProjCebe').textContent = formatNumber(Math.round(newCebe)) + ' sats';
                document.getElementById('simProjOwn').textContent = (newOwn * 100).toFixed(1) + '%';
                
                // Wrapper impact callout
                const wrapperSection = document.getElementById('simWrapperSection');
                if (selectedYears > 0 && simData.hasWrapperData && simData.netAnnualWrapper !== 0) {
                    wrapperSection.style.display = 'block';
                    const bar = wrapperSection.querySelector('.sim-wrapper-bar');
                    const isNegative = simData.netAnnualWrapper < 0;
                    
                    // Calculate pure drag-only CEBE for comparison
                    const pureClaimsBtc = simData.netClaimsUsd / newBtcPrice;
                    const pureCommonBtc = simData.btcHoldings - pureClaimsBtc;
                    const pureCebe = simData.shares > 0 ? (pureCommonBtc / simData.shares) * 100000000 : 0;
                    const cebeDelta = Math.round(newCebe - pureCebe);
                    
                    const annualDisplay = isNegative 
                        ? '+$' + formatNumber(Math.abs(Math.round(simData.netAnnualWrapper / 1000000))) + 'M/yr net income'
                        : '$' + formatNumber(Math.round(simData.netAnnualWrapper / 1000000)) + 'M/yr cost';
                    const cumDisplay = isNegative
                        ? '+$' + formatNumber(Math.abs(Math.round(wrapperErosion / 1000000))) + 'M over ' + selectedYears + 'Y'
                        : '$' + formatNumber(Math.round(wrapperErosion / 1000000)) + 'M over ' + selectedYears + 'Y';
                    
                    document.getElementById('simWrapperDetail').textContent = annualDisplay + ' \u2192 ' + cumDisplay;
                    
                    const deltaEl = document.getElementById('simWrapperDelta');
                    deltaEl.textContent = (cebeDelta >= 0 ? '+' : '') + formatNumber(cebeDelta) + ' sats';
                    deltaEl.style.color = cebeDelta >= 0 ? 'var(--green)' : 'var(--red)';
                    
                    bar.className = 'sim-wrapper-bar' + (isNegative ? ' negative-wrapper' : '');
                    wrapperSection.querySelector('.sim-wrapper-icon').textContent = isNegative ? '💰' : '⚙️';
                    wrapperSection.querySelector('.sim-wrapper-title').textContent = isNegative ? 'Net Income Benefit' : 'Wrapper Cost Impact';
                } else {
                    wrapperSection.style.display = 'none';
                }
                
                // Color code drag change
                const projDragEl = document.getElementById('simProjDrag');
                if (newDrag < simData.originalDrag) {
                    projDragEl.style.color = 'var(--green)';
                } else if (newDrag > simData.originalDrag) {
                    projDragEl.style.color = 'var(--red)';
                } else {
                    projDragEl.style.color = '';
                }
                
                // Stock price projection using CEBE mNAV (matches table formula)
                if (stockPrice > 0) {
                    document.getElementById('simStockSection').style.display = 'block';
                    // Convert stock price to USD (Finnhub returns local currency for foreign tickers)
                    const currency = stockCurrency[simData.ticker] || 'USD';
                    const fxRate = fxRates[currency] || 1;
                    const currencySymbols = { USD: '$', EUR: '\u20AC', BRL: 'R$', GBP: '\u00A3', JPY: '\u00A5' };
                    const currSym = currencySymbols[currency] || '$';
                    document.getElementById('simCurrentStock').textContent = currSym + stockPrice.toFixed(2);
                    const priceUsd = stockPrice * fxRate;
                    
                    // CEBE mNAV = priceUsd / (cebe_btc x liveBtcPrice)
                    // This is the EXACT same formula used in the main table
                    const currentBtcPriceForMnav = liveBtcPrice || simData.originalBtcPrice;
                    const currentCebeBtc = simData.originalCebe / 100000000;
                    const currentCebeNavPerShare = currentCebeBtc * currentBtcPriceForMnav;
                    const currentCebeMnav = currentCebeNavPerShare > 0 ? priceUsd / currentCebeNavPerShare : 0;
                    document.getElementById('simMnav').textContent = currentCebeMnav.toFixed(2) + 'x';
                    
                    // Use projected CEBE mNAV if entered, otherwise use current
                    const projMnavInput = parseFloat(document.getElementById('simProjMnav').value);
                    const projCebeMnav = projMnavInput > 0 ? projMnavInput : currentCebeMnav;
                    
                    // Project new stock price at new BTC price
                    // newCebe already calculated above from drag simulation
                    const newCebeBtc = newCebe / 100000000;
                    const newCebeNavPerShare = newCebeBtc * newBtcPrice;
                    const projectedStockPriceUsd = newCebeNavPerShare * projCebeMnav;
                    // Convert back to local currency for display
                    const projectedStockPrice = fxRate > 0 ? projectedStockPriceUsd / fxRate : projectedStockPriceUsd;
                    document.getElementById('simProjStock').textContent = currSym + projectedStockPrice.toFixed(2);
                    
                    // Calculate change
                    const stockChange = ((projectedStockPrice - stockPrice) / stockPrice) * 100;
                    const changeEl = document.getElementById('simStockChange');
                    changeEl.textContent = (stockChange >= 0 ? '+' : '') + stockChange.toFixed(1) + '%';
                    changeEl.className = stockChange >= 0 ? 'positive' : 'negative';
                } else {
                    document.getElementById('simStockSection').style.display = 'none';
                }
            }
            
            // Bind input events
            document.getElementById('simBtcPrice').addEventListener('input', (e) => {
                document.getElementById('simBtcSlider').value = e.target.value;
                updateSimulation();
            });
            
            document.getElementById('simBtcSlider').addEventListener('input', (e) => {
                document.getElementById('simBtcPrice').value = e.target.value;
                updateSimulation();
            });
            
            document.getElementById('simStockPrice').addEventListener('input', updateSimulation);
            document.getElementById('simProjMnav').addEventListener('input', updateSimulation);
            
            // Duration button handlers
            let selectedYears = 0;
            document.querySelectorAll('.sim-duration-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.sim-duration-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    selectedYears = parseInt(btn.dataset.years);
                    
                    const noteEl = document.getElementById('simDurationNote');
                    const headerEl = document.getElementById('simProjHeader');
                    
                    if (selectedYears > 0) {
                        // Assume 15% annual BTC CAGR for projection
                        const projectedBtc = Math.round(simData.originalBtcPrice * Math.pow(1.15, selectedYears));
                        document.getElementById('simBtcPrice').value = projectedBtc;
                        document.getElementById('simBtcSlider').value = Math.min(projectedBtc, 500000);
                        const wrapperNote = simData.hasWrapperData && simData.netAnnualWrapper !== 0
                            ? ' Includes wrapper cost erosion from Costs tab.'
                            : '';
                        noteEl.textContent = 'Assuming 15% annual BTC appreciation.' + wrapperNote + ' Adjust slider to explore scenarios.';
                        headerEl.textContent = 'In ' + selectedYears + ' Year' + (selectedYears > 1 ? 's' : '');
                    } else {
                        document.getElementById('simBtcPrice').value = Math.round(simData.originalBtcPrice);
                        document.getElementById('simBtcSlider').value = Math.round(simData.originalBtcPrice);
                        noteEl.textContent = '';
                        headerEl.textContent = 'Projected';
                    }
                    updateSimulation();
                });
            });
            
            // Live BTC price button
            document.getElementById('fetchBtcBtn').addEventListener('click', async (e) => {
                const btn = e.target;
                btn.disabled = true;
                btn.textContent = '...';
                
                const price = await fetchBtcPrice();
                if (price) {
                    document.getElementById('simBtcPrice').value = Math.round(price);
                    document.getElementById('simBtcSlider').value = Math.round(price);
                    updateSimulation();
                }
                
                btn.disabled = false;
                btn.textContent = 'Live';
            });
            
            // Live stock price button
            document.getElementById('fetchStockBtn').addEventListener('click', async (e) => {
                const btn = e.target;
                const symbol = btn.dataset.symbol;
                btn.disabled = true;
                btn.textContent = '...';
                
                const price = await fetchStockPrice(symbol);
                if (price) {
                    document.getElementById('simStockPrice').value = price.toFixed(2);
                    updateSimulation();
                } else {
                    document.getElementById('simStockPrice').placeholder = 'API unavailable';
                }
                
                btn.disabled = false;
                btn.textContent = 'Live';
            });
            
            document.getElementById('modalOverlay').classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        
        function closeModal() {
            document.getElementById('modalOverlay').classList.remove('active');
            document.body.style.overflow = '';
        }
        
        // Event Listeners
        document.getElementById('modalOverlay').addEventListener('click', (e) => {
            if (e.target === document.getElementById('modalOverlay')) {
                closeModal();
            }
        });
        
        document.getElementById('modalClose').addEventListener('click', closeModal);
        document.getElementById('modal').addEventListener('click', (e) => e.stopPropagation());
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeModal(); });
        
        // Initialize
        async function init() {
            try {
                // Fetch live BTC price FIRST
                const price = await fetchBtcPrice();
                if (price) {
                    const el = document.getElementById('headerBtcPrice');
                    el.textContent = '$' + formatNumber(Math.round(price));
                    el.classList.add('updating');
                    setTimeout(() => el.classList.remove('updating'), 1000);
                }
                
                allSnapshots = await fetchSheetData(SNAPSHOTS_GID);
                
                // Filter to only show 'live' status rows
                const liveSnapshots = allSnapshots.filter(s => !s.status || s.status.toLowerCase() === 'live');
                
                const latest = getLatestSnapshots(liveSnapshots);
                renderTable(latest);
                initSortHeaders();
                
                // Fetch live stock prices for table
                document.querySelectorAll('.stock-price').forEach(async (el) => {
                    const symbol = el.dataset.symbol;
                    const price = await fetchStockPrice(symbol);
                    if (price) {
                        // Find the ticker for this symbol
                        const ticker = Object.keys(tickerToStock).find(k => tickerToStock[k] === symbol) || symbol;
                        const currency = stockCurrency[ticker] || 'USD';
                        const fxRate = fxRates[currency] || 1;
                        const priceUsd = price * fxRate;
                        
                        // Display in local currency with correct symbol
                        const currencySymbols = { USD: '$', EUR: '€', BRL: 'R$', GBP: '£', JPY: '¥' };
                        const sym = currencySymbols[currency] || '$';
                        el.textContent = sym + price.toFixed(2);
                        
                        // Update Cycle mNAV and CEBE mNAV (always in USD terms)
                        const cycleMnavEl = document.querySelector(`.cycle-mnav[data-ticker="${ticker}"]`);
                        const cebeMnavEl = document.querySelector(`.cebe-mnav[data-ticker="${ticker}"]`);
                        if (cebeMnavEl && priceUsd > 0 && liveBtcPrice > 0) {
                            const cebeBtc = parseFloat(cebeMnavEl.dataset.cebeBtc) || 0;
                            const navPerShare = cebeBtc * liveBtcPrice;
                            if (navPerShare > 0) {
                                const cebeMnav = priceUsd / navPerShare;
                                cebeMnavEl.textContent = cebeMnav.toFixed(2) + 'x';
                                // Color code: green = discount, red = premium
                                if (cebeMnav < 0.95) {
                                    cebeMnavEl.style.color = 'var(--green)';
                                } else if (cebeMnav > 1.05) {
                                    cebeMnavEl.style.color = 'var(--red)';
                                } else {
                                    cebeMnavEl.style.color = 'var(--text-primary)';
                                }
                                
                                // Cycle mNAV
                                if (cycleMnavEl) {
                                    const cycleMnav = calcCycleMnav(cebeMnav, ticker);
                                    if (cycleMnav !== null) {
                                        cycleMnavEl.textContent = cycleMnav.toFixed(2) + 'x';
                                        if (cycleMnav < 0.95) cycleMnavEl.style.color = 'var(--green)';
                                        else if (cycleMnav > 1.05) cycleMnavEl.style.color = 'var(--red)';
                                        else cycleMnavEl.style.color = 'var(--text-primary)';
                                    } else {
                                        cycleMnavEl.textContent = '-';
                                        cycleMnavEl.style.color = 'var(--text-muted)';
                                    }
                                }
                            }
                        }
                    } else {
                        el.textContent = '-';
                    }
                });
                
            } catch (error) {
                console.error('Failed to load data:', error);
                document.getElementById('loadingState').innerHTML = `
                    <p style="color: var(--red);">Failed to load data</p>
                    <p style="font-size: 12px; margin-top: 8px; color: var(--text-muted);">${error.message}</p>
                    <p style="font-size: 11px; margin-top: 16px; color: var(--text-muted);">Make sure the Google Sheet is published to web</p>
                `;
            }
        }
        
        init();
        
        // Cycle mNAV toggle handlers
        document.querySelectorAll('#cycleToggle button').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation(); // Don't trigger column sort
                document.querySelectorAll('#cycleToggle button').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                cycleYears = parseInt(btn.dataset.years);
                document.getElementById('cycleHeader').textContent = 'Cycle mNAV (' + cycleYears + 'Y)';
                // Recalculate all cycle mNAV cells
                applyStockPricesFromCache();
            });
        });
        
        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(reg => console.log('SW registered'))
                .catch(err => console.log('SW registration failed:', err));
        }
    </script>
</body>
</html>
