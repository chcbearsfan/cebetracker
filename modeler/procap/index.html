<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>ProCap Financial Modeler | CEBE Tracker</title>
    <meta name="description" content="Model ProCap Financial (BRR) share price through CEBE. BTC-collateralized convertible debt. Zero-coupon converts, Dec 2028 maturity. Nasdaq: BRR.">
    <meta name="theme-color" content="#09090b">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect fill='%2309090b' width='32' height='32' rx='4'/%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' stop-color='%23f97316'/%3E%3Cstop offset='100%25' stop-color='%23fb923c'/%3E%3C/linearGradient%3E%3C/defs%3E%3Ctext x='16' y='15' font-family='Arial,sans-serif' font-size='14' font-weight='700' fill='url(%23g)' text-anchor='middle'%3ECE%3C/text%3E%3Ctext x='16' y='28' font-family='Arial,sans-serif' font-size='14' font-weight='700' fill='url(%23g)' text-anchor='middle'%3EBE%3C/text%3E%3C/svg%3E">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #09090b;
            --bg-secondary: #0f0f11;
            --bg-card: #141416;
            --bg-elevated: #1a1a1d;
            --orange-primary: #f97316;
            --orange-light: #fb923c;
            --orange-glow: rgba(249, 115, 22, 0.12);
            --orange-border: rgba(249, 115, 22, 0.25);
            --text-primary: #fafafa;
            --text-secondary: #a1a1aa;
            --text-muted: #52525b;
            --green: #22c55e;
            --green-muted: rgba(34, 197, 94, 0.15);
            --red: #ef4444;
            --red-muted: rgba(239, 68, 68, 0.15);
            --yellow: #eab308;
            --yellow-muted: rgba(234, 179, 8, 0.15);
            --border-subtle: rgba(255, 255, 255, 0.06);
            --mono: 'JetBrains Mono', monospace;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }

        body::before {
            content: '';
            position: fixed;
            inset: 0;
            pointer-events: none;
            background-image:
                linear-gradient(rgba(249,115,22,0.015) 1px, transparent 1px),
                linear-gradient(90deg, rgba(249,115,22,0.015) 1px, transparent 1px);
            background-size: 48px 48px;
            z-index: 0;
        }

        .container {
            max-width: 680px;
            margin: 0 auto;
            padding: 24px 16px 60px;
            position: relative;
            z-index: 1;
        }

        /* HEADER */
        .header { text-align: center; margin-bottom: 28px; }
        .nav-back {
            display: inline-block;
            font-size: 12px;
            color: var(--text-muted);
            text-decoration: none;
            margin-bottom: 12px;
            letter-spacing: 1px;
            transition: color 0.2s;
        }
        .nav-back:hover { color: var(--orange-primary); }
        .logo-container { position: relative; display: inline-block; margin-bottom: 6px; }
        .logo {
            font-size: 32px; font-weight: 300; letter-spacing: 16px;
            padding-left: 16px; color: var(--text-primary);
            position: relative; z-index: 1;
        }
        .logo span {
            background: linear-gradient(135deg, var(--orange-primary) 0%, var(--orange-light) 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
            font-weight: 600;
        }
        .logo-whisper {
            font-size: 11px; font-weight: 400; letter-spacing: 8px; padding-left: 8px;
            margin-top: 2px; text-transform: lowercase;
            background: linear-gradient(180deg, rgba(161,161,170,0.6) 0%, rgba(82,82,91,0.2) 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
        }
        .logo-glow {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 180px; height: 50px;
            background: radial-gradient(ellipse, rgba(249,115,22,0.3) 0%, transparent 70%);
            filter: blur(20px); z-index: 0;
        }
        .logo-badge {
            display: inline-block; font-size: 11px; font-weight: 600;
            padding: 4px 10px; border-radius: 6px;
            background: rgba(56,189,248,0.1); border: 1px solid rgba(56,189,248,0.3);
            color: #38bdf8; letter-spacing: 1px; font-family: var(--mono); margin-top: 8px;
        }
        .header-sub { font-size: 13px; color: var(--text-muted); letter-spacing: 1px; margin-top: 4px; }
        .live-strip {
            display: flex; align-items: center; justify-content: center; gap: 16px;
            margin-top: 12px; font-size: 11px; font-family: var(--mono);
            color: var(--text-muted); flex-wrap: wrap;
        }
        .live-dot {
            width: 6px; height: 6px; border-radius: 50%; background: var(--green);
            display: inline-block; animation: pulse-dot 2s ease infinite;
        }
        @keyframes pulse-dot { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
        .live-price { color: var(--text-secondary); }

        /* CLAIMS BANNER */
        .claims-banner {
            background: rgba(249,115,22,0.06); border: 1px solid var(--orange-border);
            border-radius: 12px; padding: 16px 20px; text-align: center; margin-bottom: 24px;
        }
        .claims-banner.low-drag { background: var(--green-muted); border-color: rgba(34,197,94,0.25); }
        .claims-banner.high-drag { background: var(--red-muted); border-color: rgba(239,68,68,0.25); }
        .claims-title { font-size: 20px; font-weight: 700; color: var(--orange-primary); margin-bottom: 4px; font-family: var(--mono); }
        .claims-banner.low-drag .claims-title { color: var(--green); }
        .claims-banner.high-drag .claims-title { color: var(--red); }
        .claims-sub { font-size: 13px; color: var(--text-secondary); }
        .claims-formula { font-size: 11px; color: #71717a; font-family: var(--mono); margin-top: 6px; letter-spacing: 0.3px; }
        .claims-stack { display: flex; flex-direction: column; gap: 6px; margin-top: 12px; }
        .claim-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 8px 12px; border-radius: 8px; background: rgba(255,255,255,0.02);
            border: 1px solid var(--border-subtle); font-size: 12px;
        }
        .claim-label { color: var(--text-secondary); font-weight: 500; }
        .claim-value { font-family: var(--mono); font-weight: 600; }
        .claim-badge {
            font-size: 9px; font-family: var(--mono); font-weight: 700;
            padding: 2px 6px; border-radius: 4px; margin-left: 6px;
        }
        .claim-badge.convert { background: rgba(56,189,248,0.12); color: #38bdf8; }
        .claim-badge.collateral { background: rgba(168,85,247,0.12); color: #a855f7; }
        .claim-badge.cash { background: var(--green-muted); color: var(--green); }
        .claim-total {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 12px; border-radius: 8px; background: rgba(249,115,22,0.06);
            border: 1px solid var(--orange-border); font-size: 13px; font-weight: 700;
        }
        .claim-total-label { color: var(--orange-light); }
        .claim-total-value { font-family: var(--mono); color: var(--orange-primary); }

        /* COLLATERAL BAR */
        .collateral-bar-container { margin-top: 12px; }
        .collateral-bar-label {
            display: flex; justify-content: space-between; font-size: 11px;
            font-family: var(--mono); margin-bottom: 4px;
        }
        .collateral-bar-track {
            height: 8px; border-radius: 4px; background: rgba(255,255,255,0.06); overflow: hidden;
        }
        .collateral-bar-fill {
            height: 100%; border-radius: 4px; transition: width 0.3s, background 0.3s;
        }
        .collateral-bar-note { font-size: 10px; color: var(--text-muted); margin-top: 4px; text-align: center; }

        /* EARNOUT TOGGLE */
        .earnout-toggle {
            display: flex; align-items: center; justify-content: center; gap: 10px;
            margin-bottom: 20px; padding: 10px 16px; border-radius: 10px;
            background: var(--bg-card); border: 1px solid var(--border-subtle);
            font-size: 12px; color: var(--text-secondary);
        }
        .earnout-toggle label { cursor: pointer; display: flex; align-items: center; gap: 8px; }
        .toggle-switch {
            position: relative; width: 36px; height: 20px; display: inline-block;
        }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider {
            position: absolute; inset: 0; background: #333; border-radius: 10px;
            cursor: pointer; transition: 0.3s;
        }
        .toggle-slider:before {
            content: ''; position: absolute; width: 16px; height: 16px;
            left: 2px; bottom: 2px; background: #888; border-radius: 50%; transition: 0.3s;
        }
        .toggle-switch input:checked + .toggle-slider { background: var(--orange-primary); }
        .toggle-switch input:checked + .toggle-slider:before { transform: translateX(16px); background: #fff; }
        .earnout-detail { font-family: var(--mono); font-size: 10px; color: var(--text-muted); }

        /* SCENARIO CARDS */
        .scenarios-section { margin-bottom: 24px; }
        .scenarios-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        @media (max-width: 500px) { .scenarios-row { grid-template-columns: repeat(2, 1fr); } }
        .scenario-card {
            padding: 16px 12px 14px; border-radius: 12px; border: 1.5px solid var(--border-subtle);
            background: var(--bg-card); cursor: pointer; transition: all 0.25s ease;
            text-align: center; user-select: none; position: relative;
        }
        .scenario-card:hover { border-color: rgba(255,255,255,0.12); background: var(--bg-elevated); transform: translateY(-2px); }
        .scenario-card.active { border-color: var(--orange-primary); background: var(--orange-glow); box-shadow: 0 0 20px rgba(249,115,22,0.1); }
        .scenario-icon { font-size: 22px; margin-bottom: 4px; }
        .scenario-name { font-size: 12px; font-weight: 600; letter-spacing: 0.5px; margin-bottom: 4px; }
        .scenario-price { font-size: 15px; font-weight: 700; font-family: var(--mono); color: var(--orange-light); }
        .scenario-mnav { font-size: 10px; color: var(--text-muted); font-family: var(--mono); margin-top: 4px; }
        .horizon-badge {
            position: absolute; top: 6px; right: 8px; font-size: 8px; font-weight: 700;
            font-family: var(--mono); padding: 2px 6px; border-radius: 4px; letter-spacing: 0.5px;
        }
        .now-badge { background: var(--green-muted); color: var(--green); }
        .future-badge { background: rgba(56,189,248,0.1); color: #38bdf8; }

        /* GROUP LABELS */
        .group-label { display:flex; align-items:center; gap:10px; margin-bottom:10px; }
        .group-label-badge {
            font-size:9px; font-weight:700; font-family:var(--mono); padding:3px 8px;
            border-radius:4px; letter-spacing:1px; flex-shrink:0;
        }
        .group-label-badge.now { background:var(--green-muted); color:var(--green); }
        .group-label-badge.future { background:rgba(56,189,248,0.1); color:#38bdf8; }
        .group-label-text { font-size:9px; letter-spacing:2px; font-weight:600; color:var(--text-muted); }
        .group-label-line { flex:1; height:1px; background:var(--border-subtle); }
        .scenario-group { margin-bottom:16px; }

        /* HERO */
        .hero {
            text-align: center; padding: 28px 20px; margin-bottom: 20px;
            background: linear-gradient(180deg, rgba(249,115,22,0.04) 0%, transparent 100%);
            border-radius: 20px; border: 1px solid rgba(249,115,22,0.1);
        }
        .hero-label { font-size: 10px; letter-spacing: 3px; color: var(--text-muted); margin-bottom: 6px; font-weight: 500; }
        .hero-price {
            font-size: 64px; font-weight: 700; font-family: var(--mono);
            line-height: 1; margin-bottom: 8px; transition: color 0.3s;
        }
        .hero-price.positive { color: var(--green); }
        .hero-price.negative { color: var(--red); }
        .hero-price.neutral { color: var(--text-primary); }
        .hero-usd { font-size: 18px; font-family: var(--mono); color: var(--text-secondary); margin-bottom: 6px; }
        .hero-change { font-size: 16px; font-weight: 600; font-family: var(--mono); margin-bottom: 4px; }
        .hero-change.up { color: var(--green); }
        .hero-change.down { color: var(--red); }
        .hero-vs { font-size: 11px; color: var(--text-muted); }
        .hero-implied {
            margin-top: 10px; font-size: 12px; font-family: var(--mono); color: var(--text-secondary);
            padding: 6px 14px; border-radius: 20px; background: rgba(255,255,255,0.03);
            border: 1px solid var(--border-subtle); display: inline-block;
        }
        .hero-implied em { font-style: normal; color: var(--orange-primary); font-weight: 600; }

        /* NARRATIVE */
        .narrative { background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: 14px; padding: 20px; margin-bottom: 20px; }
        .narrative-title { font-size: 14px; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .narrative-body { display: flex; flex-direction: column; gap: 10px; }
        .narr-item { display: flex; align-items: flex-start; gap: 10px; padding: 10px 14px; border-radius: 10px; font-size: 13px; line-height: 1.5; }
        .narr-item.green { background: var(--green-muted); border: 1px solid rgba(34,197,94,0.2); color: #86efac; }
        .narr-item.red { background: var(--red-muted); border: 1px solid rgba(239,68,68,0.2); color: #fca5a5; }
        .narr-item.amber { background: var(--yellow-muted); border: 1px solid rgba(234,179,8,0.2); color: #fde68a; }
        .narr-item.info { background: rgba(56,189,248,0.08); border: 1px solid rgba(56,189,248,0.2); color: #7dd3fc; }
        .narr-item.neutral { background: rgba(255,255,255,0.03); border: 1px solid var(--border-subtle); color: var(--text-secondary); }
        .narr-icon { font-size: 16px; flex-shrink: 0; margin-top: 1px; }
        .narr-text strong { color: var(--text-primary); }

        /* METRICS */
        .metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 8px; margin-bottom: 20px; }
        .metric-card { background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: 10px; padding: 12px 10px; text-align: center; }
        .metric-label { font-size: 8px; letter-spacing: 1.5px; color: var(--text-muted); margin-bottom: 4px; font-weight: 600; }
        .metric-value { font-size: 17px; font-weight: 700; font-family: var(--mono); line-height: 1.2; }
        .metric-sub { font-size: 9px; color: #3f3f46; margin-top: 2px; font-family: var(--mono); }
        .metric-value.good { color: var(--green); }
        .metric-value.warn { color: var(--yellow); }
        .metric-value.danger { color: var(--red); }

        /* COLLAPSIBLE */
        .collapse-section { margin-bottom: 12px; }
        .collapse-section summary {
            display: flex; align-items: center; gap: 8px; padding: 14px 16px;
            background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: 12px;
            cursor: pointer; font-size: 13px; font-weight: 600; color: var(--text-secondary);
            letter-spacing: 0.5px; transition: all 0.2s; list-style: none; user-select: none;
        }
        .collapse-section summary::-webkit-details-marker { display: none; }
        .collapse-section summary:hover { border-color: rgba(255,255,255,0.12); color: var(--text-primary); }
        .collapse-section[open] summary { border-radius: 12px 12px 0 0; border-bottom-color: transparent; color: var(--orange-primary); }
        .collapse-body { padding: 16px; background: var(--bg-card); border: 1px solid var(--border-subtle); border-top: none; border-radius: 0 0 12px 12px; }

        /* CONTROLS */
        .controls-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px; }
        @media (max-width: 500px) { .controls-grid { grid-template-columns: 1fr; } }
        .control-card { background: var(--bg-secondary); border: 1px solid var(--border-subtle); border-radius: 10px; padding: 14px; }
        .control-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .control-label { font-size: 10px; letter-spacing: 1.5px; color: var(--text-muted); font-weight: 600; }
        .control-value { font-size: 18px; font-weight: 700; font-family: var(--mono); color: var(--orange-light); }
        .control-locked { font-size:10px; color:var(--text-muted); margin-top:6px; text-align:center; }
        input[type="range"] { -webkit-appearance: none; width: 100%; height: 6px; border-radius: 3px; background: #333; outline: none; cursor: pointer; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 20px; border-radius: 50%; background: var(--orange-primary); box-shadow: 0 0 10px rgba(249,115,22,0.4); cursor: grab; }
        input[type="range"]::-moz-range-thumb { width: 20px; height: 20px; border-radius: 50%; background: var(--orange-primary); border: none; box-shadow: 0 0 10px rgba(249,115,22,0.4); cursor: grab; }
        .slider-labels { display: flex; justify-content: space-between; font-size: 9px; color: #444; font-family: var(--mono); margin-top: 4px; }
        .mnav-presets { display: flex; gap: 6px; margin-top: 10px; flex-wrap: wrap; }
        .mnav-btn {
            padding: 4px 10px; border-radius: 6px; border: 1px solid var(--border-subtle);
            background: transparent; color: var(--text-muted); font-size: 11px; font-family: var(--mono);
            cursor: pointer; transition: all 0.2s;
        }
        .mnav-btn:hover { border-color: var(--orange-primary); color: var(--text-primary); }
        .mnav-btn.active { background: var(--orange-glow); border-color: var(--orange-primary); color: var(--orange-primary); font-weight: 600; }
        .toggle-row { display: flex; gap: 6px; flex-wrap: wrap; }
        .toggle-btn {
            padding: 6px 14px; border-radius: 8px; border: 1px solid var(--border-subtle);
            background: transparent; color: var(--text-muted); font-size: 12px; font-family: var(--mono);
            cursor: pointer; transition: all 0.2s; font-weight: 500;
        }
        .toggle-btn:hover { border-color: rgba(255,255,255,0.15); color: var(--text-primary); }
        .toggle-btn.active { background: var(--orange-glow); border-color: var(--orange-primary); color: var(--orange-primary); font-weight: 700; }

        /* WATERFALL */
        .waterfall { display: flex; align-items: center; gap: 6px; padding: 16px; overflow-x: auto; flex-wrap: wrap; justify-content: center; }
        .wf-step { padding: 10px 12px; border-radius: 8px; text-align: center; min-width: 70px; }
        .wf-step.btc-val { background: rgba(249,115,22,0.08); border: 1px solid var(--orange-border); }
        .wf-step.nav { background: var(--green-muted); border: 1px solid rgba(34,197,94,0.2); }
        .wf-step.shares { background: rgba(255,255,255,0.03); border: 1px solid var(--border-subtle); }
        .wf-step.result { background: rgba(249,115,22,0.1); border: 1px solid var(--orange-primary); }
        .wf-label { font-size: 8px; letter-spacing: 1px; color: var(--text-muted); font-weight: 600; margin-bottom: 2px; }
        .wf-value { font-size: 14px; font-weight: 700; font-family: var(--mono); }
        .wf-arrow { color: #444; font-size: 16px; }

        /* MATRIX */
        .matrix-table { width: 100%; border-collapse: collapse; font-size: 12px; font-family: var(--mono); }
        .matrix-table th { padding: 8px 6px; font-size: 10px; color: var(--text-muted); border-bottom: 1px solid var(--border-subtle); text-align: center; font-weight: 600; }
        .matrix-table td { padding: 8px 6px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.02); }
        .matrix-table .row-label { text-align: left; color: var(--text-secondary); font-weight: 600; white-space: nowrap; }
        .matrix-cell-green { color: var(--green); }
        .matrix-cell-lightgreen { color: #4ade80; }
        .matrix-cell-red { color: var(--red); }
        .matrix-cell-lightred { color: #f87171; }
        .matrix-cell-current { background: rgba(249,115,22,0.1); border-radius: 4px; font-weight: 700; }

        /* CONTRAST */
        .contrast-title { font-size: 12px; font-weight: 700; letter-spacing: 1px; color: var(--text-muted); margin-bottom: 16px; text-align: center; }
        .contrast-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
        .contrast-item { text-align: center; padding: 12px; border-radius: 10px; background: rgba(255,255,255,0.02); border: 1px solid var(--border-subtle); }
        .contrast-company { font-size: 10px; font-weight: 700; letter-spacing: 1px; color: var(--text-muted); margin-bottom: 4px; }
        .contrast-value { font-size: 24px; font-weight: 700; font-family: var(--mono); }
        .contrast-label { font-size: 10px; color: var(--text-muted); margin-top: 2px; }

        /* PROJECTION TABLE */
        .status-green { color: var(--green); }
        .status-amber { color: #f59e0b; }
        .status-red { color: var(--red); }

        /* LOADING */
        .loading-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 60vh; gap: 16px; }
        .loading-spinner { width: 32px; height: 32px; border: 2px solid var(--border-subtle); border-top-color: var(--orange-primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { font-size: 11px; letter-spacing: 3px; color: var(--text-muted); font-family: var(--mono); }

        /* FOOTER */
        .footer { text-align: center; padding-top: 24px; border-top: 1px solid var(--border-subtle); font-size: 11px; color: var(--text-muted); line-height: 1.8; }
        .footer a { color: var(--orange-primary); text-decoration: none; }
        .footer a:hover { text-decoration: underline; }
        .footer-formula { font-family: var(--mono); font-size: 10px; margin-top: 8px; color: #3f3f46; }

        @media (max-width: 768px) { .hero-price { font-size: 48px; } }
        @media (max-width: 480px) {
            .hero-price { font-size: 36px; }
            .control-value { font-size: 16px; }
            .logo { font-size: 24px; letter-spacing: 10px; padding-left: 10px; }
            .contrast-row { grid-template-columns: 1fr; }
        }
    </style>
    <script defer src="/_vercel/insights/script.js"></script>
    <script defer src="/_vercel/speed-insights/script.js"></script>
</head>
<body>

<div class="loading-screen" id="loadingScreen">
    <div class="loading-spinner"></div>
    <div class="loading-text">LOADING LIVE DATA</div>
</div>

<div class="container" id="app" style="display:none">

    <!-- Header -->
    <div class="header">
        <a href="/modeler" class="nav-back">&larr; modelers</a>
        <div class="logo-container">
            <div class="logo-glow"></div>
            <div class="logo"><span>CEBE</span></div>
            <p class="logo-whisper">tracker</p>
        </div>
        <div class="logo-badge">&#127482;&#127480; PROCAP FINANCIAL MODELER</div>
        <div class="header-sub" id="headerSub">BTC-Collateralized Converts &middot; Nasdaq: BRR</div>
        <div class="live-strip" id="liveStrip">
            <span><span class="live-dot"></span> Live Data</span>
            <span class="live-price" id="liveBtcDisplay">BTC $&mdash;</span>
            <span class="live-price" id="liveDataDate">&mdash;</span>
        </div>
    </div>

    <!-- Earnout Toggle -->
    <div class="earnout-toggle">
        <label>
            <span class="toggle-switch">
                <input type="checkbox" id="earnoutToggle">
                <span class="toggle-slider"></span>
            </span>
            Include Earnout Shares (17.8M, Dec 2027)
        </label>
        <span class="earnout-detail" id="earnoutDetail">83.4M shares</span>
    </div>

    <!-- Claims Banner -->
    <div class="claims-banner" id="claimsBanner">
        <div class="claims-title" id="claimsDragDisplay">DRAG: &mdash;%</div>
        <div class="claims-sub" id="claimsSub">Zero-coupon converts &minus; cash offsets</div>
        <div class="claims-formula" id="claimsFormula"></div>
    </div>

    <!-- Scenario Cards -->
    <div class="scenarios-section">
        <div class="scenario-group">
            <div class="group-label"><span class="group-label-badge now">&#9889; NOW</span><span class="group-label-text">WHAT IF BTC WERE AT THIS PRICE TODAY</span><div class="group-label-line"></div></div>
            <div class="scenarios-row" id="snapshotBar"></div>
        </div>
        <div class="scenario-group">
            <div class="group-label"><span class="group-label-badge future">&rarr; FORWARD</span><span class="group-label-text">PROJECTIONS &middot; CONVERT MATURITY DEC 2028 &middot; WRAPPER COSTS</span><div class="group-label-line"></div></div>
            <div class="scenarios-row" id="projectionBar"></div>
        </div>
    </div>

    <!-- Hero -->
    <div class="hero">
        <div class="hero-label" id="heroLabel">MODELED BRR SHARE PRICE</div>
        <div class="hero-price neutral" id="heroPrice">&mdash;</div>
        <div class="hero-usd" id="heroUsd"></div>
        <div class="hero-change" id="heroChange">&mdash;</div>
        <div class="hero-vs" id="heroVs">vs current market price</div>
        <div class="hero-implied" id="heroImplied" style="display:none">
            Market implies <em id="impliedMnavVal">&mdash;</em> mNAV
        </div>
    </div>

    <!-- Narrative -->
    <div class="narrative" id="narrativePanel">
        <div class="narrative-title">&#128269; What happens here</div>
        <div class="narrative-body" id="narrativeBody"></div>
    </div>

    <!-- Metrics -->
    <div class="metrics-grid" id="metricsGrid"></div>

    <!-- Controls (collapsed) -->
    <details class="collapse-section">
        <summary>&#9881; Adjust Inputs</summary>
        <div class="collapse-body">
            <div class="controls-grid">
                <div class="control-card">
                    <div class="control-header">
                        <span class="control-label">BTC PRICE</span>
                        <span class="control-value" id="btcPriceDisplay">$&mdash;</span>
                    </div>
                    <input type="range" id="btcSlider" min="0" max="1000" value="500">
                    <div class="slider-labels"><span>$10K</span><span>$1M</span></div>
                    <div class="control-locked" id="btcLockedMsg" style="display:none">&#128274; Controlled by scenario CAGR curve</div>
                </div>
                <div class="control-card">
                    <div class="control-header">
                        <span class="control-label">mNAV MULTIPLE</span>
                        <span class="control-value" id="mnavDisplay">1.00&times;</span>
                    </div>
                    <input type="range" id="mnavSlider" min="30" max="400" value="100">
                    <div class="mnav-presets" id="mnavPresets"></div>
                    <div class="control-locked" id="mnavLockedMsg" style="display:none">&#128274; Controlled by scenario mNAV curve</div>
                </div>
                <div class="control-card">
                    <div class="control-header"><span class="control-label">TIME HORIZON</span><span class="control-value" id="horizonDisplay">Now</span></div>
                    <div class="toggle-row" id="horizonBar"></div>
                </div>
            </div>
        </div>
    </details>

    <!-- Claims Stack -->
    <details class="collapse-section">
        <summary>&#9878; Senior Claims Stack</summary>
        <div class="collapse-body" id="claimsBody"></div>
    </details>

    <!-- Value Waterfall -->
    <details class="collapse-section">
        <summary>&#128256; Value Waterfall</summary>
        <div class="collapse-body" style="padding:0;">
            <div class="waterfall" id="waterfall"></div>
        </div>
    </details>

    <!-- Projection Table -->
    <div id="projectionSection" style="display:none;">
        <details class="collapse-section" open>
            <summary>&#128200; Year-by-Year Projection</summary>
            <div class="collapse-body" style="padding:0;">
                <div style="overflow-x:auto;">
                    <table class="matrix-table" id="projTable"></table>
                </div>
                <div id="projEvents" style="padding:12px 16px;font-size:12px;color:#a1a1aa;line-height:1.7;"></div>
            </div>
        </details>
    </div>

    <!-- Assumptions -->
    <div id="assumptionsSection" style="display:none;">
        <details class="collapse-section">
            <summary>&#128196; Assumptions &amp; Sources</summary>
            <div class="collapse-body" id="assumptions" style="font-size:12px;color:#a1a1aa;line-height:1.7;"></div>
        </details>
    </div>

    <!-- Sensitivity Matrix -->
    <details class="collapse-section">
        <summary>&#127919; Price Sensitivity Matrix</summary>
        <div class="collapse-body" style="padding:0;">
            <div style="overflow-x:auto;">
                <table class="matrix-table" id="matrixTable"></table>
            </div>
        </div>
    </details>

    <!-- Drag Contrast -->
    <details class="collapse-section">
        <summary>&#9878; How BRR Drag Compares</summary>
        <div class="collapse-body" id="contrastBody"></div>
    </details>

    <!-- Footer -->
    <div class="footer">
        <p>CEBE Framework by <a href="https://x.com/chcbearsfan" target="_blank">&#64;chcbearsfan</a> &middot; <a href="/">cebetracker.io</a> &middot; <a href="https://x.com/chcbearsfan/status/2014767364819063207" target="_blank">Read the Framework</a></p>
        <p style="margin-top:4px">Not financial advice &middot; Data updates after each filing</p>
        <p class="footer-formula">CEBE = (Total BTC &minus; Senior Claims in BTC) &divide; Shares Outstanding</p>
    </div>

</div>

<script>
// ═══════════════════════════════════════════════
// CEBE PROCAP FINANCIAL (BRR) MODELER
// cebetracker.io -- ProCap Financial
// BTC-collateralized zero-coupon converts
// ═══════════════════════════════════════════════

// --- COMPANY DATA ---
const COMPANY = {
    name: 'ProCap Financial',
    flag: '&#127482;&#127480;',
    tickers: 'Nasdaq: BRR',
    tagline: 'BTC-Collateralized Converts',
    currency: 'USD',
    currencySymbol: '$',
    sheetTicker: 'BRR',
    defaults: {
        btc_holdings: 5007,
        shares: 83422775,
        stock_price_local: 2.50,
        fx_rate: 1.0,
        debt_usd: 99600000,       // Post Feb 9 deleveraging
        preferred_usd: 0,
        cash_usd: 71698690,       // Free $19.97M + equivalents $25.0M + restricted $26.72M
    },
    // Wrapper cost components
    ga_annual_usd: 4e6,           // G&A recurring estimate
    sbc_annual_usd: 5.7e6,        // RSU amortization ($17.1M / 3yr)
    rent_annual_usd: 235200,      // Inflection Points sublease
    revenue_offset_usd: 170000,   // Media/advertising
    put_income_usd: 1e6,          // BTC put premium income
    interest_income_usd: 500000,  // Cash on deposit
    // Collateral structure
    collateral_btc: 3000,         // BTC pledged to US Bank
    collateral_val_ratio: 0.50,   // Valued at 50%
    collateral_cash: 26722563,    // Cash pledged alongside
    collateral_breach: 1.0,       // Coverage breach trigger
    // Convert details
    convert_face: 99600000,
    convert_maturity_year: 2028,
    convert_conversion_price: 13.00,
    convert_shares_per_1000: 76.9,
    // Dilution events
    earnout_shares: 17800000,     // Auto-vest Dec 2027
    earnout_year: 2027,
};

const SHEET_ID = '1BNsCWGVU08PDinDcfzJccqcuj9_KrK1VZGETErzBZvg';
const SNAPSHOTS_GID = '771405586';

const SCENARIOS = [
    { id: 'wipeout', icon: '&#128128;', name: 'Wipeout',       btc: 25000,  mnav: 0.5, horizon: 0, group: 'snapshot', type: 'static' },
    { id: 'current', icon: '&#128205;', name: 'Current',       btc: null,   mnav: 1.0, horizon: 0, group: 'snapshot', type: 'static' },
    { id: 'bull',    icon: '&#9728;',   name: 'Bull',          btc: 150000, mnav: 1.5, horizon: 0, group: 'snapshot', type: 'static' },
    { id: 'siege',    icon: '&#127984;', name: 'Siege',         btc: 50000,  mnav: 0.7, horizon: 5, group: 'projection', type: 'siege' },
    { id: 'powerlaw', icon: '&#128200;', name: 'Power Law',     btc: null,   mnav: null, horizon: 5, group: 'projection', type: 'powerlaw' },
    { id: 'maturity', icon: '&#128197;', name: 'To Maturity',   btc: null,   mnav: null, horizon: 3, group: 'projection', type: 'maturity' },
];

// Power Law Support Line
const POWERLAW_CAGR = [
    {year:1,cagr:.30},{year:2,cagr:.27},{year:3,cagr:.25},{year:4,cagr:.24},{year:5,cagr:.23},
];
const POWERLAW_MNAV = [
    {year:0,mnav:1.0},{year:1,mnav:1.0},{year:2,mnav:1.1},{year:3,mnav:1.2},{year:4,mnav:1.2},{year:5,mnav:1.2},
];

// To Maturity: 20% CAGR to Dec 2028, conservative mNAV ramp
const MATURITY_CAGR = [
    {year:1,cagr:.20},{year:2,cagr:.20},{year:3,cagr:.20},
];
const MATURITY_MNAV = [
    {year:0,mnav:1.0},{year:1,mnav:1.0},{year:2,mnav:1.1},{year:3,mnav:1.2},
];

const MNAV_PRESETS = [0.5, 0.75, 1.0, 1.5, 2.0, 3.0];
const MATRIX_BTC = [10000, 25000, 50000, 75000, 100000, 150000, 200000, 300000, 500000];
const MATRIX_MNAVS = [0.5, 0.75, 1.0, 1.5, 2.0, 3.0];

const HORIZON_OPTIONS = [{label:'Now',years:0},{label:'1Y',years:1},{label:'3Y',years:3},{label:'5Y',years:5}];
const START_YEAR = 2026;

// --- STATE ---
let btcPrice = 97000;
let mnavMultiple = 1.0;
let horizonYears = 0;
let activeScenario = 'current';
let liveBtcPrice = null;
let liveFxRate = 1.0;
let loadedData = {};
let includeEarnout = false;

// --- HELPERS ---
const $ = id => document.getElementById(id);
const fmt = n => Math.round(n).toLocaleString('en-US');
const fmtB = n => n >= 1e9 ? '$' + (n/1e9).toFixed(1) + 'B' : n >= 1e6 ? '$' + (n/1e6).toFixed(0) + 'M' : '$' + fmt(n);
const fmtPrice = p => {
    if (p >= 1e6) return '$' + (p/1e6).toFixed(1) + 'M';
    if (p >= 1000) return '$' + fmt(p);
    if (p >= 0.01) return '$' + p.toFixed(2);
    return '$0.00';
};
const fmtPct = (p, dec=1) => (p * 100).toFixed(dec) + '%';
const fmtSats = s => fmt(Math.round(s));

function sliderToBtc(val) {
    const minLog = Math.log10(10000);
    const maxLog = Math.log10(1000000);
    return Math.round(Math.pow(10, minLog + (val / 1000) * (maxLog - minLog)));
}
function btcToSlider(btc) {
    const minLog = Math.log10(10000);
    const maxLog = Math.log10(1000000);
    return Math.round(((Math.log10(Math.max(10000, btc)) - minLog) / (maxLog - minLog)) * 1000);
}

function getShares() {
    var base = loadedData.shares || COMPANY.defaults.shares;
    return includeEarnout ? base + COMPANY.earnout_shares : base;
}

function getData() {
    return {
        btcHoldings: loadedData.btc_holdings || COMPANY.defaults.btc_holdings,
        shares: getShares(),
        stockLocal: loadedData.stock_price_local || COMPANY.defaults.stock_price_local,
        fxRate: 1.0,
        debtUsd: loadedData.debt_usd || COMPANY.defaults.debt_usd,
        preferredUsd: 0,
        cashUsd: loadedData.cash_usd || COMPANY.defaults.cash_usd,
        snapshotDate: loadedData.snapshot_date || null,
    };
}

// Collateral coverage ratio
function calcCollateralCoverage(btcP) {
    var co = COMPANY;
    var btcVal = co.collateral_btc * btcP * co.collateral_val_ratio;
    var total = btcVal + co.collateral_cash;
    return co.convert_face > 0 ? total / co.convert_face : Infinity;
}

// --- CSV PARSER ---
function parseCSVLine(line) {
    const r = []; let c = '', q = false;
    for (const ch of line) { if (ch === '"') q = !q; else if (ch === ',' && !q) { r.push(c); c = ''; } else c += ch; }
    r.push(c); return r;
}
function parseCSV(text) {
    const lines = text.split('\n');
    const headers = parseCSVLine(lines[0]);
    return lines.slice(1).filter(l => l.trim()).map(l => {
        const vals = parseCSVLine(l);
        const row = {};
        headers.forEach((h, i) => { row[h.replace(/"/g,'').trim()] = vals[i]?.replace(/"/g,'').trim() || ''; });
        return row;
    });
}

// --- CORE MATH ---
function compute(btcH, shares, btcP, mnav, debtUsd, prefUsd, cashUsd) {
    var netClaims = Math.max(0, (debtUsd || 0) + (prefUsd || 0) - (cashUsd || 0));
    var claimsBtc = btcP > 0 ? netClaims / btcP : 0;
    var drag = btcH > 0 ? claimsBtc / btcH : 0;
    var bpsBtc = shares > 0 ? btcH / shares : 0;
    var bpsSats = Math.round(bpsBtc * 1e8);
    var cebeBtc = shares > 0 ? (btcH - claimsBtc) / shares : 0;
    var cebeSats = Math.max(0, Math.round(cebeBtc * 1e8));
    var navUsd = (btcH * btcP) - netClaims;
    var navPerShare = shares > 0 ? navUsd / shares : 0;
    var modeledUsd = navPerShare * mnav;
    var breakEven = btcH > 0 ? netClaims / btcH : 0;
    var amplification = drag < 1 ? 1 / (1 - drag) : Infinity;
    return { bpsBtc, bpsSats, cebeBtc, cebeSats, navUsd, navPerShare, modeledUsd, drag, netClaims, claimsBtc, breakEven, amplification, debtUsd: debtUsd || 0, prefUsd: prefUsd || 0, cashUsd: cashUsd || 0 };
}

function getActiveType() {
    var s = SCENARIOS.find(function(x){return x.id===activeScenario});
    return s ? s.type : 'static';
}
function isSlidersLocked() { var t = getActiveType(); return t === 'powerlaw' || t === 'maturity'; }

// --- PROJECTION ENGINE ---
function projectYears(years) {
    var d = getData(), co = COMPANY;
    var btcH = d.btcHoldings, shares = d.shares, cash = d.cashUsd;
    var debtUsd = d.debtUsd;
    var results = [], allEvents = [];
    var startBtc = liveBtcPrice || btcPrice;

    // Wrapper cost components
    var gaAnnual = co.ga_annual_usd;
    var sbcAnnual = co.sbc_annual_usd;
    var rentAnnual = co.rent_annual_usd;
    var revenueOffset = co.revenue_offset_usd;
    var putIncome = co.put_income_usd;
    var interestIncome = co.interest_income_usd;
    var grossCost = gaAnnual + sbcAnnual + rentAnnual;
    var netOffset = revenueOffset + putIncome + interestIncome;

    for (var y = 0; y <= years; y++) {
        var calYear = START_YEAR + y, yearEvents = [];

        // 1. BTC PRICE + mNAV
        var yearBtcPrice, yearMnav;
        var sType = getActiveType();
        if (sType === 'siege') { yearBtcPrice = 50000; yearMnav = 0.7; }
        else if (sType === 'powerlaw') {
            if (y === 0) { yearBtcPrice = startBtc; yearMnav = POWERLAW_MNAV[0].mnav; }
            else {
                var ce = POWERLAW_CAGR[Math.min(y - 1, POWERLAW_CAGR.length - 1)];
                var prevB = y === 1 ? startBtc : results[y - 1].yearBtcPrice;
                yearBtcPrice = prevB * (1 + ce.cagr);
                yearMnav = POWERLAW_MNAV[Math.min(y, POWERLAW_MNAV.length - 1)].mnav;
            }
        }
        else if (sType === 'maturity') {
            if (y === 0) { yearBtcPrice = startBtc; yearMnav = MATURITY_MNAV[0].mnav; }
            else {
                var ce = MATURITY_CAGR[Math.min(y - 1, MATURITY_CAGR.length - 1)];
                var prevB = y === 1 ? startBtc : results[y - 1].yearBtcPrice;
                yearBtcPrice = prevB * (1 + ce.cagr);
                yearMnav = MATURITY_MNAV[Math.min(y, MATURITY_MNAV.length - 1)].mnav;
            }
        }
        else { yearBtcPrice = btcPrice; yearMnav = mnavMultiple; }

        // 2. EARNOUT DILUTION (Dec 2027)
        var status = 'green', btcSold = 0, yearSbcShares = 0;
        if (y > 0 && calYear >= co.earnout_year && !includeEarnout) {
            // If earnout not already toggled on, it kicks in at Y2027
            // But since we model from the toggle state, only add if toggle is OFF
            // and we haven't already added in a prior year
            if (y === (co.earnout_year - START_YEAR) && !includeEarnout) {
                shares += co.earnout_shares;
                yearEvents.push({type:'earnout',cls:'amber',icon:'\u{1F4C5}',text:'<strong>Earnout vests.</strong> 17.8M shares auto-vest Dec 2027. Share count: ' + (shares/1e6).toFixed(1) + 'M. Dilution: ~' + ((co.earnout_shares / (shares - co.earnout_shares)) * 100).toFixed(0) + '%.'});
            }
        }

        // 3. OPERATING COSTS (drain cash)
        if (y > 0) {
            var netDrain = grossCost - netOffset;
            cash -= netDrain;

            // Siege: capital markets closed
            if (sType === 'siege' && cash < 0) {
                var deficit = Math.abs(cash);
                btcSold = yearBtcPrice > 0 ? deficit / yearBtcPrice : 0;
                btcH = Math.max(0, btcH - btcSold);
                cash = 0;
                status = 'red';
                yearEvents.push({type:'btcsale',cls:'red',icon:'\u26A0\uFE0F',text:'<strong>BTC liquidated.</strong> Sold ' + fmt(Math.round(btcSold)) + ' BTC (' + fmtB(deficit) + ') to cover costs. Capital markets closed.'});
            }
        }

        // 4. CONVERT MATURITY (Dec 2028)
        if (y > 0 && calYear >= co.convert_maturity_year && debtUsd > 0) {
            if (sType === 'siege') {
                // Siege: must sell BTC to repay
                var repayBtc = yearBtcPrice > 0 ? debtUsd / yearBtcPrice : 0;
                btcH = Math.max(0, btcH - repayBtc);
                btcSold += repayBtc;
                status = 'red';
                yearEvents.push({type:'maturity',cls:'red',icon:'\u{1F4A5}',text:'<strong>Converts mature.</strong> ' + fmtB(debtUsd) + ' due. Sold ' + fmt(Math.round(repayBtc)) + ' BTC to repay. No refinancing assumed in siege.'});
            } else {
                // Non-siege: assume refinancing at similar terms (debt stays)
                // Or pay from cash if available
                if (cash >= debtUsd) {
                    cash -= debtUsd;
                    yearEvents.push({type:'maturity',cls:'green',icon:'\u2705',text:'<strong>Converts retired.</strong> ' + fmtB(debtUsd) + ' paid from cash reserves.'});
                } else {
                    // Refinance
                    yearEvents.push({type:'maturity',cls:'info',icon:'\u{1F504}',text:'<strong>Converts refinanced.</strong> ' + fmtB(debtUsd) + ' rolled into new facility at maturity. Assumes capital markets open.'});
                }
            }
            if (sType === 'siege' || cash >= 0) {
                // Only zero out debt if actually repaid
                if (sType === 'siege' || (calYear >= co.convert_maturity_year && cash >= 0 && yearEvents.some(e => e.type === 'maturity' && e.cls === 'green'))) {
                    // Check if we actually paid it off
                }
            }
            // For siege: debt is gone (sold BTC). For non-siege refinance: debt persists.
            if (sType === 'siege') {
                debtUsd = 0;
            }
            // For cash payoff: debt is gone
            if (yearEvents.some(e => e.type === 'maturity' && e.cls === 'green')) {
                debtUsd = 0;
            }
        }

        // 5. SBC DILUTION
        if (y > 0 && sbcAnnual > 0) {
            var netCl = Math.max(0, debtUsd - cash);
            var navNow = Math.max(0, (btcH * yearBtcPrice) - netCl);
            var navPS = shares > 0 ? navNow / shares : 0;
            var tmpPrice = navPS * yearMnav;
            if (tmpPrice > 0) { yearSbcShares = sbcAnnual / tmpPrice; shares += yearSbcShares; }
        }

        // 6. COLLATERAL COVERAGE CHECK
        var coverage = 0;
        if (debtUsd > 0) {
            var btcVal = co.collateral_btc * yearBtcPrice * co.collateral_val_ratio;
            coverage = (btcVal + co.collateral_cash) / debtUsd;
            if (coverage < co.collateral_breach) {
                yearEvents.push({type:'collateral',cls:'red',icon:'\u{1F6A8}',text:'<strong>Collateral breach.</strong> Coverage ratio ' + coverage.toFixed(2) + 'x (breach at 1.0x). 60-day cure period. 3,000 BTC pledged at US Bank at risk.'});
                status = 'red';
            } else if (coverage < 1.5) {
                yearEvents.push({type:'collateral',cls:'amber',icon:'\u26A0\uFE0F',text:'<strong>Collateral warning.</strong> Coverage ' + coverage.toFixed(2) + 'x. Approaching 1.0x breach threshold.'});
                if (status !== 'red') status = 'amber';
            }
        }

        // 7. YEAR-END STATE
        var m = compute(btcH, shares, yearBtcPrice, yearMnav, debtUsd, 0, cash);

        // Wrapper fee
        var btcReserveVal = btcH * yearBtcPrice;
        var netAnnualCost = grossCost - netOffset;
        var wrapperFee = btcReserveVal > 0 ? netAnnualCost / btcReserveVal : 0;

        results.push({
            year: y, calYear: calYear, btcH: btcH, shares: shares, cebeSats: m.cebeSats, drag: m.drag,
            navPerShare: m.navPerShare, modeledPrice: m.modeledUsd, cash: cash, btcSold: btcSold, status: status,
            amp: m.amplification, breakEven: m.breakEven,
            yearBtcPrice: yearBtcPrice, yearMnav: yearMnav,
            sbcSharesAdded: yearSbcShares, events: yearEvents, netClaimsUsd: m.netClaims,
            remainingDebt: debtUsd, totalPrefFace: 0,
            wrapperFee: wrapperFee, netAnnualCost: netAnnualCost,
            coverage: coverage,
        });
        yearEvents.forEach(function(e){ allEvents.push({year:y, type:e.type, cls:e.cls, icon:e.icon, text:e.text}); });
    }
    results._events = allEvents;
    return results;
}

// --- DATA LOADING ---
async function loadData() {
    try {
        const btcRes = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd')
            .then(r => r.json()).catch(() => null);
        if (btcRes && btcRes.bitcoin) { liveBtcPrice = btcRes.bitcoin.usd; }

        const sheetText = await fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&gid=${SNAPSHOTS_GID}`)
            .then(r => r.text()).catch(() => null);

        if (sheetText) {
            const rows = parseCSV(sheetText);
            let best = null;
            rows.forEach(r => {
                if (r.ticker === COMPANY.sheetTicker && (!r.status || r.status.toLowerCase() === 'live')) {
                    if (!best || r.snapshot_date > best.snapshot_date) best = r;
                }
            });
            if (best) {
                loadedData = {
                    btc_holdings: parseFloat(best.btc_holdings) || COMPANY.defaults.btc_holdings,
                    shares: parseFloat(best.shares_outstanding) || COMPANY.defaults.shares,
                    debt_usd: parseFloat(best.debt_usd) || COMPANY.defaults.debt_usd,
                    preferred_usd: 0,
                    cash_usd: parseFloat(best.cash_usd) || COMPANY.defaults.cash_usd,
                    snapshot_date: best.snapshot_date || null,
                };
            }
        }

        // Fetch live stock price
        try {
            const stockRes = await fetch('https://finnhub.io/api/v1/quote?symbol=BRR&token=cu2qj11r01qmftiv1t90cu2qj11r01qmftiv1t9g')
                .then(r => r.json()).catch(() => null);
            if (stockRes && stockRes.c > 0) {
                loadedData.stock_price_local = stockRes.c;
            }
        } catch(e) {}

        btcPrice = liveBtcPrice || 97000;
        SCENARIOS.find(s => s.id === 'current').btc = btcPrice;

        $('loadingScreen').style.display = 'none';
        $('app').style.display = 'block';

        $('headerSub').innerHTML = COMPANY.tagline + ' &middot; ' + COMPANY.tickers;
        buildScenarioBar();
        buildMnavPresets();
        buildHorizonBar();
        syncSliders();
        render();
    } catch (err) {
        console.error('Load failed:', err);
        $('loadingScreen').innerHTML = '<div style="text-align:center;color:#a1a1aa;font-size:13px"><p style="margin-bottom:12px">Failed to load data</p><p style="font-size:11px;color:#52525b">' + err.message + '</p><p style="margin-top:12px"><a href="/modeler" style="color:#f97316">&larr; Back to modelers</a></p></div>';
    }
}

// ═══════════════════════════════════════════════
// RENDERING
// ═══════════════════════════════════════════════

function render() {
    const co = COMPANY;
    const d = getData();
    var projResults = null, endR = null;

    if (horizonYears > 0) {
        projResults = projectYears(horizonYears);
        var endState = projResults[projResults.length - 1];
        endR = compute(endState.btcH, endState.shares, endState.yearBtcPrice, endState.yearMnav, endState.remainingDebt, 0, endState.cash);
        endR._proj = endState;
    }

    const r = endR || compute(d.btcHoldings, d.shares, btcPrice, mnavMultiple, d.debtUsd, 0, d.cashUsd);

    renderHero(r, co, d);
    renderClaimsBanner(r);
    renderNarrative(r, co, d, projResults);
    renderMetrics(r, co, d, projResults);
    renderClaims(r);
    renderWaterfall(r, co, d);
    renderMatrix(co, d);
    renderContrast(r);

    if (projResults && horizonYears > 0) {
        $('projectionSection').style.display = 'block';
        $('assumptionsSection').style.display = 'block';
        renderProjectionTable(projResults);
        renderAssumptions();
    } else {
        $('projectionSection').style.display = 'none';
        $('assumptionsSection').style.display = 'none';
    }

    var heroLabel = $('heroLabel');
    if (horizonYears > 0) {
        heroLabel.innerHTML = 'MODELED BRR SHARE PRICE <span class="horizon-badge future-badge">Y' + horizonYears + '</span>';
    } else {
        heroLabel.innerHTML = 'MODELED BRR SHARE PRICE';
    }

    $('liveBtcDisplay').textContent = 'BTC ' + fmtPrice(liveBtcPrice || btcPrice);
    $('liveDataDate').textContent = d.snapshotDate ? 'Data: ' + d.snapshotDate : '';

    // Earnout detail
    $('earnoutDetail').textContent = (d.shares / 1e6).toFixed(1) + 'M shares';

    updateSliderFills();
}

function renderHero(r, co, d) {
    const price = r.modeledUsd;
    const el = $('heroPrice');

    if (price <= 0) {
        el.textContent = '$0.00';
        el.className = 'hero-price negative';
        $('heroUsd').textContent = 'Common equity wiped out at this price';
        $('heroChange').textContent = '';
        $('heroVs').textContent = '';
        $('heroImplied').style.display = 'none';
        return;
    }

    el.innerHTML = '$' + (price >= 1 ? price.toFixed(2) : price.toFixed(4));
    $('heroUsd').textContent = '';

    const market = d.stockLocal;
    if (market > 0) {
        const chg = price - market;
        const chgPct = (chg / market) * 100;
        const sign = chg >= 0 ? '+' : '';
        $('heroChange').textContent = sign + chgPct.toFixed(1) + '%';
        $('heroChange').className = 'hero-change ' + (chg >= 0 ? 'up' : 'down');
        el.className = 'hero-price ' + (chgPct > 5 ? 'positive' : chgPct < -5 ? 'negative' : 'neutral');
        $('heroVs').innerHTML = 'vs market $' + market.toFixed(2);
    } else {
        $('heroChange').textContent = '';
        el.className = 'hero-price neutral';
        $('heroVs').textContent = '';
    }

    if (market > 0 && r.navPerShare > 0) {
        const impliedMnav = market / r.navPerShare;
        $('impliedMnavVal').textContent = impliedMnav.toFixed(2) + '\u00d7';
        $('heroImplied').style.display = 'inline-block';
    } else {
        $('heroImplied').style.display = 'none';
    }
}

function renderClaimsBanner(r) {
    const banner = $('claimsBanner');
    const dragPct = (r.drag * 100).toFixed(1);
    const useBtcP = r._proj ? r._proj.yearBtcPrice : btcPrice;
    const totalBtc = useBtcP > 0 ? Math.round((r.navUsd + r.netClaims) / useBtcP) : 0;
    const claimsBtc = Math.round(r.claimsBtc);
    const sharesM = r._proj ? (r._proj.shares / 1e6).toFixed(1) : (getData().shares / 1e6).toFixed(1);
    $('claimsDragDisplay').textContent = 'DRAG: ' + dragPct + '%';
    $('claimsSub').innerHTML = 'Common equity owns ' + ((1 - r.drag) * 100).toFixed(1) + '% of ' + fmt(totalBtc) + ' BTC &middot; Break-even: ' + fmtPrice(r.breakEven);
    $('claimsFormula').innerHTML = 'CEBE = (' + fmt(totalBtc) + ' \u2212 ' + fmt(claimsBtc) + ') \u00f7 ' + sharesM + 'M = ' + fmtSats(r.cebeSats) + ' sats/share';
    banner.className = 'claims-banner' + (r.drag < 0.1 ? ' low-drag' : r.drag > 0.5 ? ' high-drag' : '');
}

function renderNarrative(r, co, d, projResults) {
    const items = [];
    const scenarioObj = SCENARIOS.find(s => s.id === activeScenario);
    const scenarioName = scenarioObj ? scenarioObj.name : 'Custom';
    var useBtc = (r._proj ? r._proj.yearBtcPrice : btcPrice);
    var useMnav = (r._proj ? r._proj.yearMnav : mnavMultiple);
    var useBtcH = (r._proj ? r._proj.btcH : d.btcHoldings);

    document.querySelector('.narrative-title').innerHTML = '&#128269; ' + scenarioName + (horizonYears > 0 ? ' \u2014 Year ' + horizonYears : '') + ' \u2014 ' + fmtPrice(useBtc) + ' BTC';

    // Drag
    const dragPct = (r.drag * 100).toFixed(1);
    const ownPct = ((1 - r.drag) * 100).toFixed(1);
    if (r.drag < 0.10) {
        items.push({ cls: 'green', icon: '&#9989;', text: '<strong>' + dragPct + '% drag \u2014 near pure equity.</strong> After the Feb 9 deleveraging ($235M \u2192 $99.6M), BRR\'s capital structure is extremely clean. Common shareholders own ' + ownPct + '% of the ' + fmt(useBtcH) + ' BTC.' });
    } else if (r.drag < 0.3) {
        items.push({ cls: 'info', icon: '&#128200;', text: '<strong>' + dragPct + '% drag.</strong> Common equity owns ' + ownPct + '% of the ' + fmt(useBtcH) + ' BTC. ' + fmtB(r.debtUsd) + ' in zero-coupon converts is the only senior claim.' });
    } else {
        items.push({ cls: 'amber', icon: '&#9888;', text: '<strong>' + dragPct + '% drag \u2014 elevated.</strong> At ' + fmtPrice(useBtc) + ' BTC, convertible debt claims consume ' + dragPct + '% of holdings.' });
    }

    // Collateral coverage
    var coverage = calcCollateralCoverage(useBtc);
    if (r.debtUsd > 0) {
        if (coverage < 1.0) {
            items.push({ cls: 'red', icon: '&#128680;', text: '<strong>Collateral breach: ' + coverage.toFixed(2) + 'x.</strong> Below 1.0x threshold. 3,000 BTC + $26.7M cash pledged at US Bank. 60-day cure period before enforcement.' });
        } else if (coverage < 1.5) {
            items.push({ cls: 'amber', icon: '&#9888;', text: '<strong>Collateral coverage: ' + coverage.toFixed(2) + 'x.</strong> Approaching breach threshold (1.0x). 3,000 BTC valued at 50% + $26.7M cash securing $99.6M in converts.' });
        } else {
            items.push({ cls: 'green', icon: '&#128274;', text: '<strong>Collateral coverage: ' + coverage.toFixed(2) + 'x.</strong> Well above 1.0x breach threshold. 3,000 BTC + $26.7M cash securing $99.6M converts at US Bank.' });
        }
    }

    // Break-even
    if (useBtc < r.breakEven * 2) {
        items.push({ cls: 'red', icon: '&#128680;', text: '<strong>Break-even proximity.</strong> At ' + fmtPrice(r.breakEven) + ', net claims equal total BTC value. Current price is ' + ((useBtc / r.breakEven - 1) * 100).toFixed(0) + '% above. BRR\'s break-even is extremely low due to minimal net claims.' });
    } else {
        items.push({ cls: 'green', icon: '&#128161;', text: '<strong>Break-even: ' + fmtPrice(r.breakEven) + '.</strong> BTC would need to fall ' + ((1 - r.breakEven / useBtc) * 100).toFixed(0) + '% before common equity hits zero. Extremely low due to $71.7M cash offsetting $99.6M converts.' });
    }

    // Convert maturity
    if (r.debtUsd > 0) {
        items.push({ cls: 'info', icon: '&#128197;', text: '<strong>Convert maturity: Dec 2028.</strong> ' + fmtB(r.debtUsd) + ' in zero-coupon converts due. Zero cash interest until maturity. Must refinance or repay. Conversion price ~$13/share.' });
    }

    // mNAV
    if (useMnav > 1.1) {
        items.push({ cls: 'amber', icon: '&#9888;', text: '<strong>Premium at ' + useMnav.toFixed(2) + '\u00d7 mNAV.</strong> Market pricing above net BTC value.' });
    } else if (useMnav < 0.9) {
        items.push({ cls: 'green', icon: '&#128176;', text: '<strong>Discount at ' + useMnav.toFixed(2) + '\u00d7 mNAV.</strong> Market pricing BRR below net Bitcoin value. BTC exposure cheaper than spot through equity.' });
    }

    // Earnout warning
    if (includeEarnout) {
        items.push({ cls: 'neutral', icon: '&#128197;', text: '<strong>Earnout included.</strong> 17.8M shares added to base count (83.4M \u2192 101.2M). Auto-vests Dec 2027. ~21% dilution to existing shareholders.' });
    }

    // Projection events
    if (projResults && projResults._events && horizonYears > 0) {
        projResults._events.forEach(function(e) {
            items.push({ cls: e.cls, icon: e.icon, text: e.text });
        });
    }

    $('narrativeBody').innerHTML = items.map(i =>
        '<div class="narr-item ' + i.cls + '"><span class="narr-icon">' + i.icon + '</span><span>' + i.text + '</span></div>'
    ).join('');
}

function renderMetrics(r, co, d, projResults) {
    const dragPct = (r.drag * 100).toFixed(1);
    const dragCls = r.drag < 0.1 ? 'good' : r.drag > 0.3 ? 'danger' : 'warn';

    // Wrapper fee
    var btcResVal = d.btcHoldings * btcPrice;
    var grossCost = co.ga_annual_usd + co.sbc_annual_usd + co.rent_annual_usd;
    var netOffset = co.revenue_offset_usd + co.put_income_usd + co.interest_income_usd;
    var netCost = grossCost - netOffset;
    var wfPct = btcResVal > 0 ? netCost / btcResVal : 0;
    var wfCls = wfPct > 0.05 ? 'danger' : wfPct > 0.03 ? 'warn' : '';

    // Collateral coverage
    var useBtcP = r._proj ? r._proj.yearBtcPrice : btcPrice;
    var coverage = r.debtUsd > 0 ? calcCollateralCoverage(useBtcP) : Infinity;
    var covText = coverage >= 100 ? 'N/A' : coverage.toFixed(2) + 'x';
    var covCls = coverage < 1.0 ? 'danger' : coverage < 1.5 ? 'warn' : 'good';

    const metrics = [
        { label: 'CEBE', value: fmtSats(r.cebeSats) + ' sats', cls: '' },
        { label: 'DRAG', value: dragPct + '%', cls: dragCls },
        { label: 'AMPLIFICATION', value: r.amplification < 10 ? r.amplification.toFixed(2) + '&times;' : '&infin;', cls: '' },
        { label: 'BREAK-EVEN', value: fmtPrice(r.breakEven), cls: '' },
        { label: 'NAV/SHARE', value: '$' + (r.navPerShare >= 1 ? r.navPerShare.toFixed(2) : r.navPerShare.toFixed(4)), cls: '' },
        { label: 'WRAPPER FEE', value: (wfPct * 100).toFixed(2) + '%', sub: fmtB(netCost) + '/yr net', cls: wfCls },
        { label: 'COLLATERAL', value: covText, cls: r.debtUsd > 0 ? covCls : '' },
        { label: 'NET CLAIMS', value: fmtB(r.netClaims), cls: '' },
    ];

    $('metricsGrid').innerHTML = metrics.map(m =>
        '<div class="metric-card"><div class="metric-label">' + m.label + '</div><div class="metric-value ' + (m.cls||'') + '">' + m.value + '</div>' + (m.sub ? '<div style="font-size:10px;color:#71717a;margin-top:2px">' + m.sub + '</div>' : '') + '</div>'
    ).join('');
}

function renderClaims(r) {
    var useBtcP = r._proj ? r._proj.yearBtcPrice : btcPrice;
    var coverage = r.debtUsd > 0 ? calcCollateralCoverage(useBtcP) : 0;
    var covColor = coverage < 1.0 ? 'var(--red)' : coverage < 1.5 ? 'var(--yellow)' : 'var(--green)';
    var covPct = Math.min(coverage / 3, 1) * 100; // scale bar to max 3x
    var covBg = coverage < 1.0 ? 'var(--red)' : coverage < 1.5 ? 'var(--yellow)' : 'var(--green)';

    var html = '<div class="claims-stack">' +
        '<div class="claim-row"><span class="claim-label">Convertible Notes <span class="claim-badge convert">ZERO-COUPON</span></span><span class="claim-value">' + fmtB(r.debtUsd) + '</span></div>' +
        '<div class="claim-row"><span class="claim-label">Cash + Restricted <span class="claim-badge cash">OFFSET</span></span><span class="claim-value" style="color:var(--green)">-' + fmtB(r.cashUsd) + '</span></div>' +
        '<div class="claim-total"><span class="claim-total-label">NET SENIOR CLAIMS</span><span class="claim-total-value">' + fmtB(r.netClaims) + '</span></div>' +
        '<div style="margin-top:10px;font-size:11px;color:var(--text-muted);text-align:center">= ' + fmt(Math.round(r.claimsBtc)) + ' BTC at ' + fmtPrice(useBtcP) + '</div>';

    // Collateral coverage bar
    if (r.debtUsd > 0) {
        html += '<div class="collateral-bar-container">' +
            '<div class="collateral-bar-label">' +
                '<span style="color:var(--text-muted)">Collateral Coverage</span>' +
                '<span style="color:' + covColor + ';font-weight:700">' + coverage.toFixed(2) + 'x</span>' +
            '</div>' +
            '<div class="collateral-bar-track">' +
                '<div class="collateral-bar-fill" style="width:' + covPct + '%;background:' + covBg + '"></div>' +
            '</div>' +
            '<div class="collateral-bar-note">3,000 BTC (50% val) + $26.7M cash / $99.6M converts &middot; Breach at 1.0x</div>' +
        '</div>';
    }

    html += '</div>';
    $('claimsBody').innerHTML = html;
}

function renderWaterfall(r, co, d) {
    const sym = co.currencySymbol;
    const navLocal = r.navPerShare;
    const priceLocal = r.modeledUsd;
    var grossBtcVal = d.btcHoldings * btcPrice;

    $('waterfall').innerHTML =
        '<div class="wf-step btc-val"><div class="wf-label">BTC RESERVE</div><div class="wf-value">' + fmtB(grossBtcVal) + '</div></div>' +
        '<span class="wf-arrow">&#8594;</span>' +
        '<div class="wf-step" style="background:var(--red-muted);border:1px solid rgba(239,68,68,0.2)"><div class="wf-label">CLAIMS</div><div class="wf-value" style="color:var(--red)">&#8722;' + fmtB(r.netClaims) + '</div></div>' +
        '<span class="wf-arrow">=</span>' +
        '<div class="wf-step nav"><div class="wf-label">NAV</div><div class="wf-value">' + fmtB(r.navUsd) + '</div></div>' +
        '<span class="wf-arrow">&#247;</span>' +
        '<div class="wf-step shares"><div class="wf-label">SHARES</div><div class="wf-value">' + (d.shares / 1e6).toFixed(0) + 'M</div></div>' +
        '<span class="wf-arrow">=</span>' +
        '<div class="wf-step shares"><div class="wf-label">NAV/SHARE</div><div class="wf-value">' + sym + (navLocal >= 1 ? navLocal.toFixed(2) : navLocal.toFixed(4)) + '</div></div>' +
        '<span class="wf-arrow">&times;</span>' +
        '<div class="wf-step shares"><div class="wf-label">mNAV</div><div class="wf-value">' + mnavMultiple.toFixed(2) + '&times;</div></div>' +
        '<span class="wf-arrow">=</span>' +
        '<div class="wf-step result"><div class="wf-label">PRICE</div><div class="wf-value">' + sym + (priceLocal >= 1 ? priceLocal.toFixed(2) : priceLocal.toFixed(4)) + '</div></div>';
}

function renderMatrix(co, d) {
    const sym = co.currencySymbol;
    let html = '<thead><tr><th>BTC &#8595; \\ mNAV &#8594;</th>';
    MATRIX_MNAVS.forEach(m => { html += '<th>' + m.toFixed(m % 1 === 0 ? 0 : 2) + '&times;</th>'; });
    html += '</tr></thead><tbody>';

    MATRIX_BTC.forEach(btcP => {
        const r = compute(d.btcHoldings, d.shares, btcP, 1.0, d.debtUsd, 0, d.cashUsd);
        const label = btcP >= 1e6 ? '$' + (btcP/1e6) + 'M' : '$' + (btcP/1e3) + 'K';
        html += '<tr><td class="row-label">' + label + '</td>';
        MATRIX_MNAVS.forEach(m => {
            const priceUsd = r.navPerShare * m;
            const display = priceUsd >= 100 ? sym + Math.round(priceUsd).toLocaleString() : priceUsd >= 1 ? sym + priceUsd.toFixed(2) : priceUsd >= 0.01 ? sym + priceUsd.toFixed(4) : sym + '0.00';
            const marketUsd = d.stockLocal;
            let cls = '';
            if (marketUsd > 0) {
                const ratio = priceUsd / marketUsd;
                if (ratio > 1.5) cls = 'matrix-cell-green';
                else if (ratio > 1.1) cls = 'matrix-cell-lightgreen';
                else if (ratio < 0.5) cls = 'matrix-cell-red';
                else if (ratio < 0.9) cls = 'matrix-cell-lightred';
            }
            const btcClose = Math.abs(btcP - btcPrice) < btcPrice * 0.25;
            const mnavClose = Math.abs(m - mnavMultiple) < 0.15;
            if (btcClose && mnavClose) cls += ' matrix-cell-current';
            html += '<td class="' + cls + '">' + display + '</td>';
        });
        html += '</tr>';
    });
    html += '</tbody>';
    $('matrixTable').innerHTML = html;
}

function renderContrast(r) {
    const brrDrag = (r.drag * 100).toFixed(1);
    const brrOwn = ((1 - r.drag) * 100).toFixed(1);
    const brrColor = r.drag < 0.1 ? 'var(--green)' : r.drag > 0.3 ? 'var(--red)' : 'var(--yellow)';

    $('contrastBody').innerHTML =
        '<div class="contrast-title">DRAG COMPARISON AT ' + fmtPrice(btcPrice) + ' BTC</div>' +
        '<div class="contrast-row">' +
            '<div class="contrast-item"><div class="contrast-company">BRR</div><div class="contrast-value" style="color:' + brrColor + '">' + brrDrag + '%</div><div class="contrast-label">owns ' + brrOwn + '%</div></div>' +
            '<div class="contrast-item"><div class="contrast-company">STRIVE</div><div class="contrast-value" style="color:var(--yellow)">~24%</div><div class="contrast-label">owns ~76%</div></div>' +
            '<div class="contrast-item"><div class="contrast-company">STRATEGY</div><div class="contrast-value" style="color:var(--orange-light)">~27%</div><div class="contrast-label">owns ~73%</div></div>' +
        '</div>' +
        '<div style="margin-top:14px;font-size:12px;color:var(--text-muted);line-height:1.6">' +
            '<strong style="color:var(--text-secondary)">BRR\'s structure:</strong> Pure convertible debt, no preferred stock. After Feb 9 deleveraging ($235M \u2192 $99.6M), drag compressed from ~43% to ~6%. Converts are zero-coupon with Dec 2028 maturity.' +
            '<br><br>' +
            '<strong style="color:var(--text-secondary)">The collateral difference:</strong> BRR is the only tracked BTCTC with BTC-secured debt. 3,000 BTC + $26.7M cash pledged at US Bank. This creates a unique coverage ratio risk that other BTCTCs don\'t have, but the extremely low break-even (~$5,573) provides a massive safety margin.' +
        '</div>';
}

function renderProjectionTable(results) {
    var html = '<thead><tr><th>Year</th><th>BTC Price</th><th>BTC Held</th><th>Shares (M)</th><th>Debt</th><th>Cash</th><th>Drag %</th><th>CEBE</th><th>Price</th><th>Status</th></tr></thead><tbody>';
    results.forEach(function(row) {
        var statusIcon = row.status === 'green' ? '&#9989;' : row.status === 'amber' ? '&#9888;' : '&#128680;';
        html += '<tr>' +
            '<td>' + (row.year === 0 ? 'Now' : 'Y' + row.year + ' (' + row.calYear + ')') + '</td>' +
            '<td>' + fmtPrice(row.yearBtcPrice) + '</td>' +
            '<td>' + fmt(Math.round(row.btcH)) + '</td>' +
            '<td>' + (row.shares / 1e6).toFixed(1) + '</td>' +
            '<td>' + fmtB(row.remainingDebt) + '</td>' +
            '<td>' + fmtB(Math.max(0,row.cash)) + '</td>' +
            '<td class="status-' + row.status + '">' + (row.drag * 100).toFixed(1) + '%</td>' +
            '<td>' + fmtSats(row.cebeSats) + '</td>' +
            '<td>$' + (row.modeledPrice >= 1 ? row.modeledPrice.toFixed(2) : row.modeledPrice.toFixed(4)) + '</td>' +
            '<td>' + statusIcon + '</td>' +
        '</tr>';
    });
    html += '</tbody>';
    $('projTable').innerHTML = html;

    var events = results._events || [];
    if (events.length > 0) {
        $('projEvents').innerHTML = '<strong style="color:var(--text-secondary)">Events:</strong><br>' +
            events.map(function(e) { return '<span style="color:var(--text-muted)">Y' + e.year + ':</span> ' + e.text; }).join('<br>');
    } else {
        $('projEvents').innerHTML = '<span style="color:var(--text-muted)">No material events during projection period.</span>';
    }
}

function renderAssumptions() {
    var co = COMPANY, sType = getActiveType();
    var t = '';
    if (sType === 'siege') {
        t = '<strong>Siege:</strong> BTC $50,000 for entire horizon. mNAV 0.7\u00d7. Capital markets closed. $99.6M converts must be repaid at maturity (Dec 2028) via BTC sales. Tests: can BRR survive a prolonged bear market through maturity?';
    } else if (sType === 'powerlaw') {
        t = '<strong>Power Law (Support Floor):</strong> BTC follows the power law support line. ~23% avg CAGR decelerating. mNAV conservative 1.0x to 1.2x. Convert refinancing assumed at maturity.';
    } else if (sType === 'maturity') {
        t = '<strong>To Maturity:</strong> 20% BTC CAGR to Dec 2028. mNAV 1.0x to 1.2x. Models the path from today through convert maturity. Key question: what does BRR look like when the $99.6M comes due?';
    } else {
        t = '<strong>Custom projection:</strong> BTC ' + fmtPrice(btcPrice) + ', mNAV ' + mnavMultiple.toFixed(2) + '\u00d7. Capital structure frozen except for scheduled events.';
    }
    t += '<br><br><strong>Wrapper costs:</strong> G&A ~$4M/yr (est), SBC ~$5.7M/yr (RSUs vest at $15-$50, stock at ~$2.50), rent $235K/yr. Offset by ~$1.7M/yr in put income, revenue, and interest.';
    t += '<br><br><strong>Key events:</strong> Earnout shares (17.8M) auto-vest Dec 2027. Converts ($99.6M zero-coupon) mature Dec 2028. CEO takes $1/yr salary.';
    t += '<br><br><strong>Data:</strong> 10-K FY2025 (filed Feb 18, 2026). Note 18 subsequent events for post-deleveraging figures. Live BTC from CoinGecko.';
    $('assumptions').innerHTML = t;
}

// ═══════════════════════════════════════════════
// UI BUILDERS & EVENT HANDLERS
// ═══════════════════════════════════════════════

function buildHorizonBar() {
    $('horizonBar').innerHTML = HORIZON_OPTIONS.map(function(h) {
        return '<button class="toggle-btn ' + (h.years === horizonYears ? 'active' : '') + '" data-years="' + h.years + '">' + h.label + '</button>';
    }).join('');

    document.querySelectorAll('#horizonBar .toggle-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            horizonYears = parseInt(btn.dataset.years);
            $('horizonDisplay').textContent = horizonYears === 0 ? 'Now' : horizonYears + 'Y';
            buildHorizonBar();
            render();
        });
    });
}

function buildScenarioBar() {
    var snapshots = SCENARIOS.filter(function(s){ return s.group === 'snapshot'; });
    var projections = SCENARIOS.filter(function(s){ return s.group === 'projection'; });

    function renderCards(arr) {
        return arr.map(function(s) {
            var priceDisplay = s.btc ? (s.btc >= 1e6 ? '$' + (s.btc/1e6) + 'M' : '$' + (s.btc/1e3) + 'K') : fmtPrice(liveBtcPrice || btcPrice);
            var badge = s.horizon > 0 ? '<span class="horizon-badge future-badge">' + s.horizon + 'Y</span>' : '<span class="horizon-badge now-badge">NOW</span>';
            var mnavText;
            if (s.type === 'maturity') {
                priceDisplay = '&rarr; Maturity';
                mnavText = 'Dec 2028 &middot; 3Y';
            } else if (s.type === 'powerlaw') {
                priceDisplay = '&rarr; PL Floor';
                mnavText = 'Support floor &middot; 5Y';
            } else {
                var mnavVal = s.mnav !== null && s.mnav !== undefined ? s.mnav : 1.0;
                mnavText = mnavVal.toFixed(1) + '&times; mNAV';
                if (s.horizon > 0) mnavText += ' &middot; ' + s.horizon + 'Y';
            }
            return '<div class="scenario-card ' + (s.id === activeScenario ? 'active' : '') + '" data-scenario="' + s.id + '">' +
                badge +
                '<div class="scenario-icon">' + s.icon + '</div>' +
                '<div class="scenario-name">' + s.name + '</div>' +
                '<div class="scenario-price">' + priceDisplay + '</div>' +
                '<div class="scenario-mnav">' + mnavText + '</div>' +
            '</div>';
        }).join('');
    }

    $('snapshotBar').innerHTML = renderCards(snapshots);
    $('projectionBar').innerHTML = renderCards(projections);

    document.querySelectorAll('.scenario-card').forEach(card => {
        card.addEventListener('click', () => {
            const id = card.dataset.scenario;
            const scenario = SCENARIOS.find(s => s.id === id);
            if (!scenario) return;
            activeScenario = id;
            btcPrice = scenario.btc || (liveBtcPrice || 97000);
            mnavMultiple = scenario.mnav !== null && scenario.mnav !== undefined ? scenario.mnav : 1.0;
            if (scenario.horizon !== undefined) {
                horizonYears = scenario.horizon;
                $('horizonDisplay').textContent = horizonYears === 0 ? 'Now' : horizonYears + 'Y';
                buildHorizonBar();
            }
            syncSliders();
            buildScenarioBar();
            updateMnavPresets();
            render();
        });
    });
}

function buildMnavPresets() {
    $('mnavPresets').innerHTML = MNAV_PRESETS.map(m =>
        '<button class="mnav-btn ' + (Math.abs(m - mnavMultiple) < 0.01 ? 'active' : '') + '" data-mnav="' + m + '">' + m.toFixed(m % 1 === 0 ? 0 : 2) + '&times;</button>'
    ).join('');

    document.querySelectorAll('.mnav-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            if (isSlidersLocked()) return;
            mnavMultiple = parseFloat(btn.dataset.mnav);
            $('mnavSlider').value = mnavMultiple * 100;
            $('mnavDisplay').textContent = mnavMultiple.toFixed(2) + '\u00d7';
            activeScenario = '';
            updateMnavPresets();
            buildScenarioBar();
            render();
        });
    });
}

function updateMnavPresets() {
    document.querySelectorAll('.mnav-btn').forEach(btn => {
        btn.classList.toggle('active', Math.abs(parseFloat(btn.dataset.mnav) - mnavMultiple) < 0.01);
    });
}

function syncSliders() {
    var locked = isSlidersLocked();
    $('btcSlider').value = btcToSlider(btcPrice);
    $('btcPriceDisplay').textContent = fmtPrice(btcPrice);
    $('mnavSlider').value = mnavMultiple * 100;
    $('mnavDisplay').textContent = mnavMultiple.toFixed(2) + '\u00d7';
    $('btcSlider').disabled = locked;
    $('mnavSlider').disabled = locked;
    $('btcSlider').style.opacity = locked ? '0.35' : '1';
    $('mnavSlider').style.opacity = locked ? '0.35' : '1';
    $('btcLockedMsg').style.display = locked ? 'block' : 'none';
    $('mnavLockedMsg').style.display = locked ? 'block' : 'none';
    updateMnavPresets();
}

function updateSliderFills() {
    const btcSlider = $('btcSlider');
    const btcPct = (btcSlider.value / 1000) * 100;
    btcSlider.style.background = 'linear-gradient(90deg, var(--orange-primary) ' + btcPct + '%, #333 ' + btcPct + '%)';
    const mnavSlider = $('mnavSlider');
    const mnavPct = ((mnavSlider.value - 30) / (400 - 30)) * 100;
    mnavSlider.style.background = 'linear-gradient(90deg, var(--orange-primary) ' + mnavPct + '%, #333 ' + mnavPct + '%)';
}

// --- SLIDER EVENTS ---
$('btcSlider').addEventListener('input', (e) => {
    if (isSlidersLocked()) return;
    btcPrice = sliderToBtc(parseInt(e.target.value));
    $('btcPriceDisplay').textContent = fmtPrice(btcPrice);
    activeScenario = '';
    buildScenarioBar();
    render();
});

$('mnavSlider').addEventListener('input', (e) => {
    if (isSlidersLocked()) return;
    mnavMultiple = parseInt(e.target.value) / 100;
    $('mnavDisplay').textContent = mnavMultiple.toFixed(2) + '\u00d7';
    activeScenario = '';
    updateMnavPresets();
    buildScenarioBar();
    render();
});

// --- EARNOUT TOGGLE ---
$('earnoutToggle').addEventListener('change', (e) => {
    includeEarnout = e.target.checked;
    render();
});

// --- KEYBOARD SHORTCUTS ---
document.addEventListener('keydown', (e) => {
    if (e.target.tagName === 'INPUT') return;
    if (e.key >= '1' && e.key <= '6') {
        const idx = parseInt(e.key) - 1;
        if (SCENARIOS[idx]) {
            const scenario = SCENARIOS[idx];
            activeScenario = scenario.id;
            btcPrice = scenario.btc || (liveBtcPrice || 97000);
            mnavMultiple = scenario.mnav !== null && scenario.mnav !== undefined ? scenario.mnav : 1.0;
            if (scenario.horizon !== undefined) {
                horizonYears = scenario.horizon;
                $('horizonDisplay').textContent = horizonYears === 0 ? 'Now' : horizonYears + 'Y';
                buildHorizonBar();
            }
            syncSliders();
            buildScenarioBar();
            updateMnavPresets();
            render();
        }
    }
});

// --- INIT ---
loadData();
</script>
</body>
</html>
