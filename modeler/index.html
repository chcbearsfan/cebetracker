<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>CEBE Modeler | MSTR Share Price Analysis</title>
    <meta name="description" content="Model Strategy (MSTR) share price through the CEBE framework. Scenario analysis, drag compression, dividend cascade modeling, and sensitivity matrix.">

    <meta name="application-name" content="CEBE">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#09090b">

    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect fill='%2309090b' width='32' height='32' rx='4'/%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' stop-color='%23f97316'/%3E%3Cstop offset='100%25' stop-color='%23fb923c'/%3E%3C/linearGradient%3E%3C/defs%3E%3Ctext x='16' y='15' font-family='Arial,sans-serif' font-size='14' font-weight='700' fill='url(%23g)' text-anchor='middle'%3ECE%3C/text%3E%3Ctext x='16' y='28' font-family='Arial,sans-serif' font-size='14' font-weight='700' fill='url(%23g)' text-anchor='middle'%3EBE%3C/text%3E%3C/svg%3E">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-primary: #09090b;
            --bg-secondary: #0f0f11;
            --bg-card: #141416;
            --bg-elevated: #1a1a1d;
            --orange-primary: #f97316;
            --orange-light: #fb923c;
            --orange-glow: rgba(249, 115, 22, 0.12);
            --orange-border: rgba(249, 115, 22, 0.25);
            --text-primary: #fafafa;
            --text-secondary: #a1a1aa;
            --text-muted: #52525b;
            --green: #22c55e;
            --green-muted: rgba(34, 197, 94, 0.15);
            --red: #ef4444;
            --red-muted: rgba(239, 68, 68, 0.15);
            --yellow: #eab308;
            --yellow-muted: rgba(234, 179, 8, 0.15);
            --border-subtle: rgba(255, 255, 255, 0.06);
            --mono: 'JetBrains Mono', monospace;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* Background grid */
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            pointer-events: none;
            background-image:
                linear-gradient(rgba(249,115,22,0.015) 1px, transparent 1px),
                linear-gradient(90deg, rgba(249,115,22,0.015) 1px, transparent 1px);
            background-size: 48px 48px;
            z-index: 0;
        }

        .container {
            max-width: 680px;
            margin: 0 auto;
            padding: 24px 16px 60px;
            position: relative;
            z-index: 1;
        }

        /* √¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê HEADER √¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê */
        .header { text-align: center; margin-bottom: 28px; }
        .nav-back {
            display: inline-block;
            font-size: 12px;
            color: var(--text-muted);
            text-decoration: none;
            margin-bottom: 12px;
            letter-spacing: 1px;
            transition: color 0.2s;
        }
        .nav-back:hover { color: var(--orange-primary); }
        .logo-container {
            position: relative;
            display: inline-block;
            margin-bottom: 6px;
        }
        .logo {
            font-size: 32px;
            font-weight: 300;
            letter-spacing: 16px;
            padding-left: 16px;
            color: var(--text-primary);
            position: relative;
            z-index: 1;
        }
        .logo span {
            background: linear-gradient(135deg, var(--orange-primary) 0%, var(--orange-light) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 600;
        }
        .logo-whisper {
            font-size: 11px;
            font-weight: 400;
            letter-spacing: 8px;
            padding-left: 8px;
            margin-top: 2px;
            text-transform: lowercase;
            background: linear-gradient(180deg, 
                rgba(161, 161, 170, 0.6) 0%, 
                rgba(82, 82, 91, 0.2) 100%
            );
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .logo-glow {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 180px;
            height: 50px;
            background: radial-gradient(ellipse, rgba(249, 115, 22, 0.3) 0%, transparent 70%);
            filter: blur(20px);
            z-index: 0;
        }
        .logo-badge {
            display: inline-block;
            font-size: 11px;
            font-weight: 600;
            padding: 4px 10px;
            border-radius: 6px;
            background: rgba(249,115,22,0.12);
            border: 1px solid var(--orange-border);
            color: var(--orange-primary);
            letter-spacing: 1px;
            font-family: var(--mono);
            margin-top: 8px;
        }
        .header-sub {
            font-size: 13px;
            color: var(--text-muted);
            letter-spacing: 1px;
            margin-top: 4px;
        }
        .live-strip {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            margin-top: 12px;
            font-size: 11px;
            font-family: var(--mono);
            color: var(--text-muted);
            flex-wrap: wrap;
        }
        .live-dot {
            width: 6px; height: 6px;
            border-radius: 50%;
            background: var(--green);
            display: inline-block;
            animation: pulse-dot 2s ease infinite;
        }
        @keyframes pulse-dot {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }
        .live-price { color: var(--text-secondary); }

        /* √¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê SCENARIO CARDS √¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê */
        .scenarios-section { margin-bottom: 24px; }
        .scenario-group { margin-bottom: 14px; }
        .scenario-group:last-child { margin-bottom: 0; }
        .group-label {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            padding-left: 4px;
        }
        .group-label-badge {
            font-size: 9px;
            font-family: var(--mono);
            font-weight: 700;
            letter-spacing: 1.5px;
            padding: 3px 8px;
            border-radius: 4px;
            white-space: nowrap;
        }
        .group-label-badge.now {
            background: rgba(255,255,255,0.04);
            color: var(--text-muted);
            border: 1px solid var(--border-subtle);
        }
        .group-label-badge.future {
            background: rgba(249, 115, 22, 0.08);
            color: var(--orange-primary);
            border: 1px solid var(--orange-border);
        }
        .group-label-text {
            font-size: 9px;
            letter-spacing: 2px;
            font-weight: 600;
            color: var(--text-muted);
        }
        .group-label-line {
            flex: 1;
            height: 1px;
            background: var(--border-subtle);
        }
        .scenarios-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        @media (max-width: 500px) {
            .scenarios-row { grid-template-columns: repeat(2, 1fr); }
        }
        .scenario-card {
            padding: 16px 12px 14px;
            border-radius: 12px;
            border: 1.5px solid var(--border-subtle);
            background: var(--bg-card);
            cursor: pointer;
            transition: all 0.25s ease;
            text-align: center;
            user-select: none;
            position: relative;
        }
        .scenario-card:hover {
            border-color: rgba(255,255,255,0.12);
            background: var(--bg-elevated);
            transform: translateY(-2px);
        }
        .scenario-card.active {
            border-color: var(--orange-primary);
            background: var(--orange-glow);
            box-shadow: 0 0 20px rgba(249,115,22,0.1);
        }
        .scenario-card.projection {
            border-left: 3px solid rgba(249, 115, 22, 0.3);
        }
        .scenario-card.projection.active {
            border-left-color: var(--orange-primary);
        }
        .horizon-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            font-size: 9px;
            font-weight: 700;
            font-family: var(--mono);
            padding: 2px 6px;
            border-radius: 4px;
            letter-spacing: 0.5px;
        }
        .horizon-badge.now-badge {
            background: rgba(255,255,255,0.04);
            color: #52525b;
            border: 1px solid rgba(255,255,255,0.06);
        }
        .horizon-badge.future-badge {
            background: rgba(249, 115, 22, 0.1);
            color: var(--orange-primary);
            border: 1px solid var(--orange-border);
        }
        .scenario-icon { font-size: 22px; margin-bottom: 4px; }
        .scenario-name {
            font-size: 12px;
            font-weight: 600;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        .scenario-price {
            font-size: 15px;
            font-weight: 700;
            font-family: var(--mono);
            color: var(--orange-light);
        }
        .scenario-mnav {
            font-size: 10px;
            color: var(--text-muted);
            font-family: var(--mono);
            margin-top: 4px;
        }

        /* √¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê HERO √¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê */
        .hero {
            text-align: center;
            padding: 28px 20px;
            margin-bottom: 20px;
            background: linear-gradient(180deg, rgba(249,115,22,0.04) 0%, transparent 100%);
            border-radius: 20px;
            border: 1px solid rgba(249,115,22,0.1);
        }
        .hero-label {
            font-size: 10px;
            letter-spacing: 3px;
            color: var(--text-muted);
            margin-bottom: 6px;
            font-weight: 500;
        }
        .hero-price {
            font-size: 64px;
            font-weight: 700;
            font-family: var(--mono);
            line-height: 1;
            margin-bottom: 8px;
            transition: color 0.3s;
        }
        .hero-price.positive { color: var(--green); }
        .hero-price.negative { color: var(--red); }
        .hero-price.neutral { color: var(--text-primary); }
        .hero-change {
            font-size: 16px;
            font-weight: 600;
            font-family: var(--mono);
            margin-bottom: 4px;
        }
        .hero-change.up { color: var(--green); }
        .hero-change.down { color: var(--red); }
        .hero-vs {
            font-size: 11px;
            color: var(--text-muted);
        }
        .hero-implied {
            margin-top: 10px;
            font-size: 12px;
            font-family: var(--mono);
            color: var(--text-secondary);
            padding: 6px 14px;
            border-radius: 20px;
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--border-subtle);
            display: inline-block;
        }
        .hero-implied em {
            font-style: normal;
            color: var(--orange-primary);
            font-weight: 600;
        }

        /* √¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê NARRATIVE PANEL √¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê */
        .narrative {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 14px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .narrative-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .narrative-body {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .narr-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 10px 14px;
            border-radius: 10px;
            font-size: 13px;
            line-height: 1.5;
        }
        .narr-item.green {
            background: var(--green-muted);
            border: 1px solid rgba(34,197,94,0.2);
            color: #86efac;
        }
        .narr-item.red {
            background: var(--red-muted);
            border: 1px solid rgba(239,68,68,0.2);
            color: #fca5a5;
        }
        .narr-item.amber {
            background: var(--yellow-muted);
            border: 1px solid rgba(234,179,8,0.2);
            color: #fde68a;
        }
        .narr-item.info {
            background: rgba(56,189,248,0.08);
            border: 1px solid rgba(56,189,248,0.2);
            color: #7dd3fc;
        }
        .narr-item.neutral {
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--border-subtle);
            color: var(--text-secondary);
        }
        .narr-icon { font-size: 16px; flex-shrink: 0; margin-top: 1px; }
        .narr-text strong { color: var(--text-primary); }

        /* √¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê METRICS ROW √¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 8px;
            margin-bottom: 20px;
        }
        .metric-card {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            padding: 12px 10px;
            text-align: center;
        }
        .metric-label {
            font-size: 8px;
            letter-spacing: 1.5px;
            color: var(--text-muted);
            margin-bottom: 4px;
            font-weight: 600;
        }
        .metric-value {
            font-size: 17px;
            font-weight: 700;
            font-family: var(--mono);
            line-height: 1.2;
        }
        .metric-sub {
            font-size: 9px;
            color: #3f3f46;
            margin-top: 2px;
            font-family: var(--mono);
        }
        .metric-value.danger { color: var(--red); }
        .metric-value.warn { color: var(--yellow); }
        .metric-value.good { color: var(--green); }

        /* √¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê COLLAPSIBLE SECTIONS √¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê */
        .collapse-section { margin-bottom: 12px; }
        .collapse-section summary {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 14px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            letter-spacing: 0.5px;
            transition: all 0.2s;
            list-style: none;
            user-select: none;
        }
        .collapse-section summary::-webkit-details-marker { display: none; }
        .collapse-section summary:hover {
            border-color: rgba(255,255,255,0.12);
            color: var(--text-primary);
        }
        .collapse-section[open] summary {
            border-radius: 12px 12px 0 0;
            border-bottom-color: transparent;
            color: var(--orange-primary);
        }
        .collapse-body {
            padding: 16px;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-top: none;
            border-radius: 0 0 12px 12px;
        }

        /* √¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê CONTROLS √¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê */
        .controls-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }
        @media (max-width: 500px) {
            .controls-grid { grid-template-columns: 1fr; }
        }
        .control-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            padding: 14px;
        }
        .control-card.full-width { grid-column: 1 / -1; }
        .control-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .control-label {
            font-size: 10px;
            letter-spacing: 1.5px;
            color: var(--text-muted);
            font-weight: 600;
        }
        .control-value {
            font-size: 18px;
            font-weight: 700;
            font-family: var(--mono);
            color: var(--orange-light);
        }
        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #333;
            outline: none;
            cursor: pointer;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--orange-primary);
            box-shadow: 0 0 10px rgba(249,115,22,0.4);
            cursor: grab;
        }
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--orange-primary);
            border: none;
            box-shadow: 0 0 10px rgba(249,115,22,0.4);
            cursor: grab;
        }
        .slider-labels {
            display: flex;
            justify-content: space-between;
            font-size: 9px;
            color: #444;
            font-family: var(--mono);
            margin-top: 4px;
        }
        .toggle-row {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }
        .toggle-btn {
            padding: 6px 14px;
            border-radius: 8px;
            border: 1.5px solid var(--border-subtle);
            background: transparent;
            color: var(--text-muted);
            font-size: 12px;
            font-weight: 600;
            font-family: var(--mono);
            cursor: pointer;
            transition: all 0.2s;
        }
        .toggle-btn:hover {
            border-color: rgba(255,255,255,0.12);
            color: var(--text-secondary);
        }
        .toggle-btn.active {
            border-color: var(--orange-primary);
            color: var(--orange-primary);
            background: var(--orange-glow);
        }
        .mnav-presets {
            display: flex;
            gap: 4px;
            margin-top: 8px;
        }
        .mnav-btn {
            flex: 1;
            padding: 4px 0;
            border-radius: 6px;
            border: 1px solid var(--border-subtle);
            background: transparent;
            color: var(--text-muted);
            font-size: 10px;
            font-family: var(--mono);
            cursor: pointer;
            transition: all 0.2s;
        }
        .mnav-btn:hover, .mnav-btn.active {
            border-color: var(--orange-primary);
            color: var(--orange-primary);
            background: var(--orange-glow);
        }

        /* √¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê WATERFALL √¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê */
        .waterfall {
            display: flex;
            align-items: center;
            gap: 4px;
            overflow-x: auto;
            padding: 12px;
            scrollbar-width: none;
        }
        .waterfall::-webkit-scrollbar { display: none; }
        .wf-step {
            flex: 0 0 auto;
            text-align: center;
            padding: 8px 12px;
            border-radius: 8px;
            min-width: 85px;
        }
        .wf-step.btc-val { background: rgba(249,115,22,0.08); border: 1px solid rgba(249,115,22,0.2); }
        .wf-step.claims { background: var(--red-muted); border: 1px solid rgba(239,68,68,0.2); }
        .wf-step.nav { background: var(--green-muted); border: 1px solid rgba(34,197,94,0.2); }
        .wf-step.shares { background: rgba(255,255,255,0.03); border: 1px solid var(--border-subtle); }
        .wf-step.result { background: rgba(249,115,22,0.12); border: 1px solid var(--orange-border); }
        .wf-label {
            font-size: 8px;
            letter-spacing: 1px;
            color: var(--text-muted);
            margin-bottom: 2px;
        }
        .wf-value {
            font-size: 12px;
            font-weight: 700;
            font-family: var(--mono);
        }
        .wf-arrow {
            flex: 0 0 auto;
            font-size: 14px;
            color: var(--text-muted);
        }

        /* √¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê TABLE √¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê */
        .table-wrap {
            overflow-x: auto;
            border-radius: 10px;
            border: 1px solid var(--border-subtle);
            background: var(--bg-secondary);
            scrollbar-width: thin;
            scrollbar-color: #333 transparent;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            white-space: nowrap;
        }
        thead th {
            padding: 10px 12px;
            text-align: right;
            font-size: 8px;
            font-weight: 600;
            letter-spacing: 1.5px;
            color: var(--text-muted);
            border-bottom: 1px solid var(--border-subtle);
            background: rgba(255,255,255,0.02);
            position: sticky;
            top: 0;
        }
        thead th:first-child { text-align: center; }
        tbody td {
            padding: 8px 12px;
            text-align: right;
            font-family: var(--mono);
            font-size: 12px;
            border-bottom: 1px solid rgba(255,255,255,0.03);
        }
        tbody td:first-child {
            text-align: center;
            font-weight: 600;
            color: var(--text-secondary);
        }
        tbody tr:hover { background: rgba(255,255,255,0.02); }
        .cell-red { color: var(--red) !important; }
        .cell-green { color: var(--green) !important; }
        .cell-amber { color: var(--yellow) !important; }
        .cell-muted { color: var(--text-muted) !important; }
        .cell-bold { font-weight: 700 !important; }

        /* √¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê SENSITIVITY MATRIX √¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê */
        .matrix-table {
            width: 100%;
            border-collapse: collapse;
        }
        .matrix-table th {
            padding: 8px 10px;
            font-size: 9px;
            font-weight: 600;
            letter-spacing: 1px;
            color: var(--text-muted);
            border-bottom: 1px solid var(--border-subtle);
            background: rgba(255,255,255,0.02);
        }
        .matrix-table td {
            padding: 8px 10px;
            text-align: center;
            font-family: var(--mono);
            font-size: 11px;
            font-weight: 600;
            border-bottom: 1px solid rgba(255,255,255,0.03);
            transition: all 0.2s;
        }
        .matrix-table td.row-label {
            text-align: right;
            color: var(--text-secondary);
            font-weight: 600;
            background: rgba(255,255,255,0.02);
        }
        .matrix-table th:first-child { text-align: right; }
        .matrix-cell-green { color: var(--green); background: rgba(34,197,94,0.06); }
        .matrix-cell-lightgreen { color: #86efac; background: rgba(34,197,94,0.03); }
        .matrix-cell-red { color: var(--red); background: rgba(239,68,68,0.06); }
        .matrix-cell-lightred { color: #fca5a5; background: rgba(239,68,68,0.03); }
        .matrix-cell-gold { color: #fbbf24; background: rgba(251,191,36,0.08); border: 1px solid rgba(251,191,36,0.2); }
        .matrix-cell-current { outline: 2px solid var(--orange-primary); outline-offset: -2px; border-radius: 4px; }

        /* √¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê PREFERRED STACK TABLE √¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê */
        .pref-stack {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        .pref-stack th {
            padding: 8px 10px;
            text-align: left;
            font-size: 9px;
            font-weight: 600;
            letter-spacing: 1px;
            color: var(--text-muted);
            border-bottom: 1px solid var(--border-subtle);
        }
        .pref-stack td {
            padding: 8px 10px;
            font-family: var(--mono);
            font-size: 12px;
            border-bottom: 1px solid rgba(255,255,255,0.03);
        }
        .pref-stack td:first-child { font-weight: 600; color: var(--text-secondary); }
        .badge-cash {
            font-size: 9px; padding: 2px 6px; border-radius: 4px;
            background: rgba(239,68,68,0.12); color: #fca5a5; font-weight: 600;
        }
        .badge-shares {
            font-size: 9px; padding: 2px 6px; border-radius: 4px;
            background: rgba(34,197,94,0.12); color: #86efac; font-weight: 600;
        }
        .badge-cum { font-size: 9px; color: var(--text-muted); }

        /* √¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê ASSUMPTIONS √¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê */
        .assumptions {
            padding: 14px 16px;
            background: rgba(255,255,255,0.02);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            font-size: 11px;
            color: var(--text-muted);
            line-height: 1.6;
            margin-top: 16px;
        }
        .assumptions strong { color: var(--text-secondary); }

        /* √¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê FOOTER √¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê */
        .footer {
            text-align: center;
            padding-top: 24px;
            border-top: 1px solid var(--border-subtle);
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 24px;
        }
        .footer a { color: var(--orange-primary); text-decoration: none; }
        .footer a:hover { text-decoration: underline; }
        .footer-formula {
            font-family: var(--mono);
            font-size: 10px;
            color: #333;
            margin-top: 8px;
        }

        /* √¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê LOADING √¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê */
        .loading-screen {
            position: fixed;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: var(--bg-primary);
            z-index: 999;
        }
        .loading-spinner {
            width: 32px; height: 32px;
            border: 3px solid #222;
            border-top-color: var(--orange-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 12px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { font-size: 12px; color: var(--text-muted); letter-spacing: 2px; }

        /* √¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê RESPONSIVE √¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê */
        @media (max-width: 768px) {
            .hero-price { font-size: 48px; }
        }
        @media (max-width: 480px) {
            .hero-price { font-size: 40px; }
            .control-value { font-size: 16px; }
            .logo { font-size: 24px; letter-spacing: 10px; padding-left: 10px; }
        }
    </style>
</head>
<body>

<div class="loading-screen" id="loadingScreen">
    <div class="loading-spinner"></div>
    <div class="loading-text">LOADING LIVE DATA</div>
</div>

<div class="container" id="app" style="display:none">

    <!-- Header -->
    <div class="header">
        <a href="/" class="nav-back">&larr; cebetracker.io</a>
        <div class="logo-container">
            <div class="logo-glow"></div>
            <div class="logo"><span>CEBE</span></div>
            <p class="logo-whisper">tracker</p>
        </div>
        <div class="logo-badge">MSTR MODELER</div>
        <div class="header-sub">Pick a scenario. See what your MSTR is worth.</div>
        <div class="live-strip" id="liveStrip">
            <span><span class="live-dot"></span> Live Data</span>
            <span class="live-price" id="liveBtcDisplay">BTC $&mdash;</span>
            <span class="live-price" id="liveMstrDisplay">MSTR $&mdash;</span>
            <span class="live-price" id="liveDataDate">&mdash;</span>
        </div>
    </div>

    <!-- Scenario Cards ‚Äî Grouped -->
    <div class="scenarios-section">
        <div class="scenario-group" id="snapshotGroup">
            <div class="group-label">
                <span class="group-label-badge now">&#9889; NOW</span>
                <span class="group-label-text">WHAT IF BTC WERE AT THIS PRICE TODAY</span>
                <div class="group-label-line"></div>
            </div>
            <div class="scenarios-row" id="snapshotBar"></div>
        </div>
        <div class="scenario-group" id="projectionGroup">
            <div class="group-label">
                <span class="group-label-badge future">&rarr; FORWARD</span>
                <span class="group-label-text">PROJECTIONS WITH DIVIDEND DILUTION</span>
                <div class="group-label-line"></div>
            </div>
            <div class="scenarios-row" id="projectionBar"></div>
        </div>
    </div>

    <!-- Hero -->
    <div class="hero">
        <div class="hero-label">MODELED MSTR SHARE PRICE</div>
        <div class="hero-price neutral" id="heroPrice">$&mdash;</div>
        <div class="hero-change" id="heroChange">&mdash;</div>
        <div class="hero-vs" id="heroVs">vs current market price</div>
        <div class="hero-implied" id="heroImplied" style="display:none">
            Market implies <em id="impliedMnavVal">&mdash;</em> mNAV
        </div>
    </div>

    <!-- Narrative Panel -->
    <div class="narrative" id="narrativePanel">
        <div class="narrative-title" id="narrativeTitle">&#128269; What happens here</div>
        <div class="narrative-body" id="narrativeBody"></div>
    </div>

    <!-- Key Metrics -->
    <div class="metrics-grid" id="metricsGrid"></div>

    <!-- Advanced Controls (collapsed) -->
    <details class="collapse-section" id="controlsSection">
        <summary>&#9881; Adjust Inputs</summary>
        <div class="collapse-body">
            <div class="controls-grid">
                <div class="control-card">
                    <div class="control-header">
                        <span class="control-label">BTC PRICE</span>
                        <span class="control-value" id="btcPriceDisplay">$&mdash;</span>
                    </div>
                    <input type="range" id="btcSlider" min="20000" max="1000000" step="1000" value="100000">
                    <div class="slider-labels"><span>$20K</span><span>$500K</span><span>$1M</span></div>
                </div>
                <div class="control-card">
                    <div class="control-header">
                        <span class="control-label">mNAV MULTIPLE</span>
                        <span class="control-value" id="mnavDisplay">1.00&times;</span>
                    </div>
                    <input type="range" id="mnavSlider" min="30" max="400" value="100">
                    <div class="mnav-presets" id="mnavPresets"></div>
                </div>
                <div class="control-card full-width">
                    <div class="control-header">
                        <span class="control-label">TIME HORIZON</span>
                        <span class="control-value" id="horizonDisplay">Now</span>
                    </div>
                    <div class="toggle-row" id="horizonBar"></div>
                </div>
            </div>
        </div>
    </details>

    <!-- Value Waterfall (collapsed) -->
    <details class="collapse-section">
        <summary>&#128256; Value Waterfall</summary>
        <div class="collapse-body" style="padding:0;">
            <div class="waterfall" id="waterfall"></div>
        </div>
    </details>

    <!-- Year-by-Year Projection (collapsed, shows only if horizon > 0) -->
    <details class="collapse-section" id="projectionSection" style="display:none">
        <summary>&#128197; Year-by-Year Projection</summary>
        <div class="collapse-body" style="padding:0;">
            <div class="table-wrap">
                <table id="projectionTable">
                    <thead id="projHead"></thead>
                    <tbody id="projBody"></tbody>
                </table>
            </div>
        </div>
    </details>

    <!-- Sensitivity Matrix (collapsed) -->
    <details class="collapse-section">
        <summary>&#127919; Price Sensitivity Matrix</summary>
        <div class="collapse-body" style="padding:0;">
            <div class="table-wrap">
                <table class="matrix-table" id="matrixTable"></table>
            </div>
        </div>
    </details>

    <!-- Capital Structure (collapsed) -->
    <details class="collapse-section" id="customizePanel">
        <summary>&#9881; Capital Structure &amp; Preferred Stack</summary>
        <div class="collapse-body" id="customizeBody"></div>
    </details>

    <!-- Assumptions -->
    <div class="assumptions" id="assumptions"></div>

    <!-- Footer -->
    <div class="footer">
        <p>CEBE Framework by <a href="https://x.com/chcbearsfan" target="_blank">&#64;chcbearsfan</a> &middot; <a href="/">cebetracker.io</a> &middot; <a href="https://x.com/chcbearsfan/status/2014767364819063207" target="_blank">Read the Framework</a></p>
        <p style="margin-top:4px">Not financial advice &middot; Data updates after each filing</p>
        <p class="footer-formula">Share Price = CEBE &times; BTC Price &times; mNAV</p>
    </div>

</div>

<script>
// √¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê
// CEBE MSTR SHARE PRICE MODELER v2
// cebetracker.io/modeler
// Scenario-first, narrative-driven redesign
// √¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê

// √¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨ CONFIG √¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨
const SHEET_ID = '1BNsCWGVU08PDinDcfzJccqcuj9_KrK1VZGETErzBZvg';
const SNAPSHOTS_GID = '771405586';
const FINNHUB_API_KEY = 'd5tuehhr01qtjet1d7k0d5tuehhr01qtjet1d7kg';

// Preferred instrument terms
const PREF_INSTRUMENTS = [
    { id: 'strf', name: 'STRF', rate: 0.10,   payment: 'cash',   cumulative: true,  currency: 'USD', seniority: 1 },
    { id: 'strc', name: 'STRC', rate: 0.1125, payment: 'cash',   cumulative: false, currency: 'USD', seniority: 2 },
    { id: 'stre', name: 'STRE', rate: 0.10,   payment: 'cash',   cumulative: true,  currency: 'EUR', seniority: 3 },
    { id: 'strk', name: 'STRK', rate: 0.08,   payment: 'cash',   cumulative: true,  currency: 'USD', seniority: 4 },
    { id: 'strd', name: 'STRD', rate: 0.10,   payment: 'cash',   cumulative: false, currency: 'USD', seniority: 5 },
];

// Fallback defaults
const DEFAULTS = {
    btc_holdings: 713502,
    shares_outstanding: 365000000,
    debt_usd: 8214000000,
    preferred_usd: 8400000000,
    cash_usd: 2250000000,
    strk_face_usd: 3220000000,
    strf_face_usd: 2640000000,
    strd_face_usd: 1006000000,
    strc_face_usd: 748000000,
    stre_face_eur: 775000000,
    eurusd_rate: 1.04,
    software_income_usd: 75000000,
    btc_price: 97000,
    mstr_price: 340,
};

// Scenarios ‚Äî grouped: snapshots (horizon=0) vs projections (horizon>0)
const SCENARIOS = [
    { id: 'wipeout',      icon: 'üíÄ', name: 'Wipeout',      btc: 25000,  mnav: 0.5, horizon: 0, group: 'snapshot'   },
    { id: 'capitulation', icon: 'üêª', name: 'Capitulation', btc: 50000,  mnav: 0.7, horizon: 0, group: 'snapshot'   },
    { id: 'current',      icon: 'üìç', name: 'Current',      btc: null,   mnav: 1.0, horizon: 0, group: 'snapshot'   },
    { id: 'recovery',     icon: '‚òÄÔ∏è', name: 'Recovery',     btc: 150000, mnav: 1.2, horizon: 1, group: 'projection' },
    { id: 'bull',         icon: 'üêÇ', name: 'Bull Run',     btc: 250000, mnav: 1.5, horizon: 3, group: 'projection' },
    { id: 'moon',         icon: 'üöÄ', name: 'Moon Math',    btc: 500000, mnav: 2.0, horizon: 5, group: 'projection' },
    { id: 'terminal',     icon: '‚ôæÔ∏è', name: 'Terminal',     btc: 1000000, mnav: 3.0, horizon: 10, group: 'projection' },
];

const HORIZON_OPTIONS = [
    { label: 'Now', years: 0 },
    { label: '1Y', years: 1 },
    { label: '3Y', years: 3 },
    { label: '5Y', years: 5 },
    { label: '10Y', years: 10 },
];

const MNAV_PRESETS = [0.5, 0.75, 1.0, 1.5, 2.0, 3.0];
const MATRIX_BTC_PRICES = [25000, 50000, 75000, 100000, 150000, 200000, 300000, 500000, 1000000];
const MATRIX_MNAVS = [0.5, 0.75, 1.0, 1.5, 2.0, 3.0];

// √¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨ STATE √¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨
let sheetData = null;
let liveBtcPrice = null;
let liveMstrPrice = null;
let btcPrice = DEFAULTS.btc_price;
let mnavMultiple = 1.0;
let horizonYears = 0;
let activeScenario = 'current';

// √¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨ HELPERS √¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨
const $ = id => document.getElementById(id);
const fmt = n => Math.round(n).toLocaleString('en-US');
const fmtB = n => n >= 1e9 ? '$' + (n/1e9).toFixed(1) + 'B' : n >= 1e6 ? '$' + (n/1e6).toFixed(0) + 'M' : '$' + fmt(n);
const fmtPrice = p => {
    if (p >= 1e6) return '$' + (p/1e6).toFixed(1) + 'M';
    if (p >= 1000) return '$' + fmt(p);
    if (p >= 1) return '$' + p.toFixed(2);
    return '$0.00';
};
const fmtPct = (p, dec=1) => (p * 100).toFixed(dec) + '%';
const fmtSats = s => fmt(Math.round(s));

// √¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨ CSV PARSER √¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨
function parseCSVLine(line) {
    const r = []; let c = '', q = false;
    for (const ch of line) { if (ch === '"') q = !q; else if (ch === ',' && !q) { r.push(c); c = ''; } else c += ch; }
    r.push(c); return r;
}
function parseCSV(text) {
    const lines = text.split('\n');
    const headers = parseCSVLine(lines[0]);
    return lines.slice(1).filter(l => l.trim()).map(l => {
        const vals = parseCSVLine(l);
        const row = {};
        headers.forEach((h, i) => { row[h.replace(/"/g,'').trim()] = vals[i]?.replace(/"/g,'').trim() || ''; });
        return row;
    });
}

// √¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨ DATA LOADING √¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨
async function loadData() {
    try {
        const [btcRes, sheetText, mstrStockPrice] = await Promise.all([
            fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd')
                .then(r => r.json()).catch(() => null),
            fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&gid=${SNAPSHOTS_GID}`)
                .then(r => r.text()),
            fetchStockPrice('MSTR'),
        ]);

        const rows = parseCSV(sheetText);
        let mstrRow = null;
        rows.forEach(r => {
            if (r.ticker === 'MSTR' && (!r.status || r.status.toLowerCase() === 'live')) {
                if (!mstrRow || r.snapshot_date > mstrRow.snapshot_date) mstrRow = r;
            }
        });
        if (mstrRow) sheetData = mstrRow;

        liveBtcPrice = btcRes?.bitcoin?.usd || null;
        liveMstrPrice = mstrStockPrice;

        btcPrice = liveBtcPrice || parseFloat(sheetData?.btc_price) || DEFAULTS.btc_price;
        SCENARIOS.find(s => s.id === 'current').btc = btcPrice;

        $('loadingScreen').style.display = 'none';
        $('app').style.display = 'block';

        buildScenarioBar();
        buildHorizonBar();
        buildMnavPresets();
        syncSliders();
        render();
    } catch (err) {
        console.error('Load failed:', err);
        $('loadingScreen').innerHTML = '<div style="text-align:center;color:#a1a1aa;font-size:13px"><p style="margin-bottom:12px">Failed to load data</p><p style="font-size:11px;color:#52525b">' + err.message + '</p><p style="margin-top:12px"><a href="/" style="color:#f97316">&larr; Back to cebetracker.io</a></p></div>';
    }
}

async function fetchStockPrice(symbol) {
    if (!FINNHUB_API_KEY || FINNHUB_API_KEY === 'YOUR_FINNHUB_KEY_HERE') return null;
    try {
        const res = await fetch('https://finnhub.io/api/v1/quote?symbol=' + symbol + '&token=' + FINNHUB_API_KEY);
        const data = await res.json();
        if (data.c && data.c > 0) return data.c;
    } catch (e) { console.error('Finnhub failed:', e); }
    return null;
}

// √¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨ GET FIELD VALUE √¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨
function getVal(field, fallback) {
    if (sheetData && sheetData[field] !== undefined && sheetData[field] !== '') {
        const v = parseFloat(sheetData[field]);
        if (!isNaN(v)) return v;
    }
    return fallback;
}

function getInputs() {
    return {
        btcHoldings:    getVal('btc_holdings', DEFAULTS.btc_holdings),
        shares:         getVal('shares_outstanding', DEFAULTS.shares_outstanding),
        debtUsd:        getVal('debt_usd', DEFAULTS.debt_usd),
        prefTotalUsd:   getVal('preferred_usd', DEFAULTS.preferred_usd),
        cashUsd:        getVal('cash_usd', DEFAULTS.cash_usd),
        strkFace:       getVal('strk_face_usd', DEFAULTS.strk_face_usd),
        strfFace:       getVal('strf_face_usd', DEFAULTS.strf_face_usd),
        strdFace:       getVal('strd_face_usd', DEFAULTS.strd_face_usd),
        strcFace:       getVal('strc_face_usd', DEFAULTS.strc_face_usd),
        streFaceEur:    getVal('stre_face_eur', DEFAULTS.stre_face_eur),
        eurusd:         getVal('eurusd_rate', DEFAULTS.eurusd_rate),
        softwareIncome: getVal('software_income_usd', DEFAULTS.software_income_usd),
        snapshotDate:   sheetData?.snapshot_date || '&mdash;',
    };
}

// √¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨ CEBE MATH ENGINE √¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨
function calcCEBE(btcHoldings, shares, netClaimsUsd, btcPriceInput) {
    const p = btcPriceInput || btcPrice;
    const netClaimsBtc = p > 0 ? Math.max(0, netClaimsUsd / p) : 0;
    const drag = btcHoldings > 0 ? Math.max(0, Math.min(1, netClaimsBtc / btcHoldings)) : 0;
    const commonBtc = Math.max(0, btcHoldings - netClaimsBtc);
    const cebeSats = shares > 0 ? (commonBtc / shares) * 1e8 : 0;
    const cebeBtc = shares > 0 ? commonBtc / shares : 0;
    const bpsSats = shares > 0 ? (btcHoldings / shares) * 1e8 : 0;
    const amp = drag < 0.999 ? 1 / (1 - drag) : Infinity;
    const breakEven = btcHoldings > 0 ? Math.max(0, netClaimsUsd) / btcHoldings : 0;
    const navUsd = Math.max(0, (btcHoldings * p) - netClaimsUsd);
    const navPerShare = shares > 0 ? navUsd / shares : 0;
    const modeledPrice = navPerShare * mnavMultiple;
    return { commonBtc, cebeSats, cebeBtc, bpsSats, drag, amp, breakEven, navUsd, navPerShare, modeledPrice, btcHoldings, shares, netClaimsUsd };
}

// √¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨ YEAR-BY-YEAR PROJECTION √¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨
function projectYears(years) {
    const inp = getInputs();
    let btcH = inp.btcHoldings;
    let shares = inp.shares;
    let cash = inp.cashUsd;
    const debt = inp.debtUsd;
    let strkF = inp.strkFace, strfF = inp.strfFace, strdF = inp.strdFace;
    let strcF = inp.strcFace, streF_eur = inp.streFaceEur;
    const eurusd = inp.eurusd;
    const softIncome = inp.softwareIncome;
    const streF_usd = streF_eur * eurusd;
    const results = [];

    for (let y = 0; y <= years; y++) {
        const prefUsd = strkF + strfF + strdF + strcF + streF_eur * eurusd;
        const netClaims = debt + prefUsd - cash;
        const m = calcCEBE(btcH, shares, netClaims, btcPrice);
        let status = 'green', btcSold = 0, strcSkipped = false, strdSkipped = false;

        if (y === 0) {
            // All dividends paid in cash
            const totalDivAnnual = strfF * 0.10 + strcF * 0.1125 + streF_eur * eurusd * 0.10 + strkF * 0.08 + strdF * 0.10;
            const netDrain = totalDivAnnual - softIncome;
            const runway = netDrain > 0 ? cash / netDrain : Infinity;
            results.push({ year: y, btcH, shares, cebeSats: m.cebeSats, drag: m.drag, navPerShare: m.navPerShare, modeledPrice: m.modeledPrice, cash, btcSold: 0, status: 'green', newShares: 0, amp: m.amp, breakEven: m.breakEven, cashRunway: runway });
            continue;
        }

        // ALL dividends paid from cash first
        const strfDiv = strfF * 0.10;
        const strcDiv = strcF * 0.1125;
        const streDiv = streF_eur * eurusd * 0.10;
        const strkDiv = strkF * 0.08;
        const strdDiv = strdF * 0.10;
        const totalDiv = strfDiv + strcDiv + streDiv + strkDiv + strdDiv;
        cash -= (totalDiv - softIncome);

        // Distress cascade if cash goes negative
        if (cash >= 0) {
            status = 'green';
        } else {
            // Step 1: Skip STRD (non-cumulative, most junior)
            cash += strdDiv; strdSkipped = true;
            if (cash >= 0) {
                status = 'amber';
            } else {
                // Step 2: Skip STRC (non-cumulative)
                cash += strcDiv; strcSkipped = true;
                if (cash >= 0) {
                    status = 'amber';
                } else {
                    // Step 3: Sell BTC to cover cumulative obligations
                    const deficit = Math.abs(cash);
                    btcSold = btcPrice > 0 ? deficit / btcPrice : 0;
                    btcH = Math.max(0, btcH - btcSold);
                    cash = 0;
                    status = 'red';
                }
            }
        }

        const finalNetClaims = debt + (strkF + strfF + strdF + strcF + streF_eur * eurusd) - cash;
        const finalM = calcCEBE(btcH, shares, finalNetClaims, btcPrice);

        // Runway: based on next year's expected cash divs (excluding any skipped non-cums)
        let nextDivs = strfDiv + streDiv + strkDiv;
        if (!strcSkipped) nextDivs += strcDiv;
        if (!strdSkipped) nextDivs += strdDiv;
        const netDrainNext = nextDivs - softIncome;
        const runway = netDrainNext > 0 ? cash / netDrainNext : (cash > 0 ? Infinity : 0);

        results.push({ year: y, btcH, shares, cebeSats: finalM.cebeSats, drag: finalM.drag, navPerShare: finalM.navPerShare, modeledPrice: finalM.modeledPrice, cash, btcSold, status, newShares: 0, amp: finalM.amp, breakEven: finalM.breakEven, cashRunway: runway, strcSkipped, strdSkipped });
    }
    return results;
}

// √¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨ QUICK CALC (for sensitivity matrix) √¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨
function quickCalc(btcP, mnav) {
    const inp = getInputs();
    const streUsd = inp.streFaceEur * inp.eurusd;
    const prefUsd = inp.strkFace + inp.strfFace + inp.strdFace + inp.strcFace + streUsd;
    const netClaims = inp.debtUsd + prefUsd - inp.cashUsd;
    const nav = Math.max(0, (inp.btcHoldings * btcP) - netClaims);
    const navPS = inp.shares > 0 ? nav / inp.shares : 0;
    return navPS * mnav;
}


// √¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê
// RENDERING
// √¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê

function render() {
    const inp = getInputs();
    const streUsd = inp.streFaceEur * inp.eurusd;
    const prefUsd = inp.strkFace + inp.strfFace + inp.strdFace + inp.strcFace + streUsd;
    const netClaims = inp.debtUsd + prefUsd - inp.cashUsd;

    const proj = projectYears(horizonYears);
    const current = proj[0];
    const final = proj[proj.length - 1];
    const marketPrice = liveMstrPrice || DEFAULTS.mstr_price;

    renderHero(final, marketPrice);
    renderNarrative(final, current, inp, marketPrice);
    renderMetrics(final, current, inp);
    renderWaterfall(final, inp);
    renderProjectionTable(proj);
    renderSensitivityMatrix();
    renderCustomize(inp, prefUsd, streUsd);
    renderAssumptions(inp);

    // Live strip
    $('liveBtcDisplay').textContent = 'BTC ' + fmtPrice(liveBtcPrice || btcPrice);
    $('liveMstrDisplay').textContent = 'MSTR ' + fmtPrice(marketPrice);
    $('liveDataDate').textContent = inp.snapshotDate !== '&mdash;' ? 'Data: ' + inp.snapshotDate : '';

    updateSliderFills();
}

function renderHero(final, marketPrice) {
    const price = final.modeledPrice;
    const el = $('heroPrice');

    if (price <= 0 || !isFinite(price)) {
        el.textContent = '$0.00';
        el.className = 'hero-price negative';
        $('heroChange').textContent = '\u2212100%';
        $('heroChange').className = 'hero-change down';
        $('heroVs').textContent = 'common equity wiped out';
        $('heroImplied').style.display = 'none';
        return;
    }

    el.textContent = fmtPrice(price);
    const pctChange = ((price - marketPrice) / marketPrice);
    const sign = pctChange >= 0 ? '+' : '';
    $('heroChange').textContent = sign + (pctChange * 100).toFixed(1) + '% (' + sign + '$' + Math.abs(price - marketPrice).toFixed(2) + ')';
    $('heroChange').className = 'hero-change ' + (pctChange >= 0 ? 'up' : 'down');
    el.className = 'hero-price ' + (pctChange > 0.05 ? 'positive' : pctChange < -0.05 ? 'negative' : 'neutral');
    $('heroVs').textContent = 'vs MSTR market ' + fmtPrice(marketPrice) + ' \u00b7 ' + (horizonYears > 0 ? horizonYears + '-year projection with div dilution' : 'instant snapshot');

    // Implied mNAV
    const inp = getInputs();
    const streUsd = inp.streFaceEur * inp.eurusd;
    const prefUsd = inp.strkFace + inp.strfFace + inp.strdFace + inp.strcFace + streUsd;
    const netClaimsVal = inp.debtUsd + prefUsd - inp.cashUsd;
    const navNow = Math.max(0, (inp.btcHoldings * btcPrice) - netClaimsVal);
    const navPsNow = inp.shares > 0 ? navNow / inp.shares : 0;
    if (navPsNow > 0 && marketPrice > 0) {
        const impliedMnav = marketPrice / navPsNow;
        $('impliedMnavVal').textContent = impliedMnav.toFixed(2) + '\u00d7';
        $('heroImplied').style.display = 'inline-block';
    } else {
        $('heroImplied').style.display = 'none';
    }
}

// √¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨ NARRATIVE PANEL √¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨
function renderNarrative(final, current, inp, marketPrice) {
    const items = [];
    const dragPct = final.drag * 100;
    const commonPct = (1 - final.drag) * 100;
    const scenarioObj = SCENARIOS.find(s => s.id === activeScenario);
    const scenarioName = scenarioObj ? scenarioObj.name : 'Custom';

    // Title
    $('narrativeTitle').innerHTML = '&#128269; ' + scenarioName + ' &mdash; ' + fmtPrice(btcPrice) + ' BTC';

    // Drag status
    if (final.drag < 0.05) {
        items.push({ cls: 'green', icon: '&#9989;', text: '<strong>Drag nearly zero (' + dragPct.toFixed(1) + '%).</strong> Common shareholders own ' + commonPct.toFixed(1) + '% of the Bitcoin. Senior claims are irrelevant at this price.' });
    } else if (final.drag < 0.20) {
        items.push({ cls: 'green', icon: '&#128201;', text: '<strong>Low drag (' + dragPct.toFixed(1) + '%).</strong> Common shareholders own ' + commonPct.toFixed(1) + '% of the Bitcoin. Compression is well advanced.' });
    } else if (final.drag < 0.40) {
        items.push({ cls: 'neutral', icon: '&#9878;', text: '<strong>Moderate drag (' + dragPct.toFixed(1) + '%).</strong> Common owns ' + commonPct.toFixed(1) + '% of the BTC. Senior claims of ' + fmtB(final.netClaimsUsd) + ' consume ' + fmt(Math.round(btcPrice > 0 ? final.netClaimsUsd / btcPrice : 0)) + ' BTC.' });
    } else if (final.drag < 0.70) {
        items.push({ cls: 'amber', icon: '&#9888;', text: '<strong>High drag (' + dragPct.toFixed(1) + '%).</strong> Senior claims consume ' + commonPct.toFixed(1) + '% of Bitcoin is left for common. Leverage is amplifying both directions.' });
    } else {
        items.push({ cls: 'red', icon: '&#128165;', text: '<strong>Critical drag (' + dragPct.toFixed(1) + '%).</strong> Senior claims consume most of the Bitcoin value. Common equity is severely impaired.' });
    }

    // Break-even proximity
    if (btcPrice <= final.breakEven * 1.15 && btcPrice > final.breakEven) {
        items.push({ cls: 'red', icon: '&#9888;', text: '<strong>Near break-even.</strong> BTC is only ' + ((btcPrice / final.breakEven - 1) * 100).toFixed(0) + '% above the ' + fmtPrice(final.breakEven) + ' floor where common equity hits zero.' });
    } else if (btcPrice <= final.breakEven) {
        items.push({ cls: 'red', icon: '&#128128;', text: '<strong>Below break-even (' + fmtPrice(final.breakEven) + ').</strong> Senior claims exceed total BTC value. Common equity is theoretically worth $0. No callable debt means creditors cannot force liquidation.' });
    } else if (btcPrice > final.breakEven * 3) {
        items.push({ cls: 'green', icon: '&#128737;', text: '<strong>Break-even safety margin: ' + ((btcPrice / final.breakEven - 1) * 100).toFixed(0) + '%.</strong> BTC would need to fall to ' + fmtPrice(final.breakEven) + ' before common equity is wiped out.' });
    }

    // Cash runway
    if (current.cashRunway < 3 && current.cashRunway > 0) {
        items.push({ cls: 'amber', icon: '&#9200;', text: '<strong>Cash runway: ' + current.cashRunway.toFixed(1) + ' years.</strong> After depletion, STRD and STRC get skipped (non-cumulative), then BTC must be sold to cover cumulative obligations (STRF, STRE, STRK).' });
    } else if (current.cashRunway >= 3 && current.cashRunway < Infinity) {
        items.push({ cls: 'neutral', icon: '&#128176;', text: '<strong>Cash runway: ' + current.cashRunway.toFixed(1) + ' years.</strong> Reserves cover all preferred dividends for ' + current.cashRunway.toFixed(1) + ' years before any BTC needs to be sold.' });
    }

    // BTC liquidation in projection
    if (horizonYears > 0 && final.btcH < inp.btcHoldings) {
        const totalSold = inp.btcHoldings - final.btcH;
        items.push({ cls: 'red', icon: '&#128293;', text: '<strong>BTC liquidation: ' + fmt(Math.round(totalSold)) + ' BTC sold</strong> over ' + horizonYears + ' years to cover cumulative preferred dividends after cash reserves depleted. Selling BTC raises drag and lowers NAV per share.' });
    }

    // STRK conversion zone
    if (final.modeledPrice >= 800 && final.modeledPrice < 1000) {
        items.push({ cls: 'amber', icon: '&#9889;', text: '<strong>Approaching STRK conversion zone.</strong> STRK converts 10:1 into MSTR common at $1,000/share. Modeled price is ' + fmtPrice(final.modeledPrice) + '.' });
    } else if (final.modeledPrice >= 1000) {
        items.push({ cls: 'info', icon: '&#9889;', text: '<strong>STRK conversion would trigger.</strong> At ' + fmtPrice(final.modeledPrice) + ', STRK holders convert, removing ~' + fmtB(inp.strkFace) + ' in preferred claims but adding ~' + fmt(Math.round(inp.strkFace / 100 * 0.1)) + ' shares.' });
    }

    // Amplification note
    if (final.amp > 1.1 && final.amp < 100) {
        items.push({ cls: 'neutral', icon: '&#128200;', text: '<strong>Amplification: ' + final.amp.toFixed(2) + '\u00d7.</strong> Common equity moves ' + ((final.amp - 1) * 100).toFixed(0) + '% faster than BTC. This leverage works both ways.' });
    }

    // Terminal Accumulation insight ‚Äî when drag is trivial and price is extreme
    if (final.drag < 0.03 && btcPrice >= 500000) {
        const bps = (inp.btcHoldings / final.shares) * 1e8;
        const convergence = final.cebeSats / bps * 100;
        items.push({ cls: 'green', icon: '&#9854;', text: '<strong>Terminal convergence.</strong> CEBE is ' + convergence.toFixed(1) + '% of BPS &mdash; senior claims are a rounding error against ' + fmtB(inp.btcHoldings * btcPrice) + ' in BTC reserves. At this level, mNAV becomes the entire conversation.' });
    }

    $('narrativeBody').innerHTML = items.map(i =>
        '<div class="narr-item ' + i.cls + '"><span class="narr-icon">' + i.icon + '</span><span class="narr-text">' + i.text + '</span></div>'
    ).join('');
}

function renderMetrics(final, current, inp) {
    const streUsd = inp.streFaceEur * inp.eurusd;
    const totalDivAnnual = inp.strfFace * 0.10 + inp.strcFace * 0.1125 + streUsd * 0.10 + inp.strkFace * 0.08 + inp.strdFace * 0.10;

    const metrics = [
        { label: 'CEBE', value: fmtSats(final.cebeSats), sub: 'sats/share', cls: final.cebeSats <= 0 ? 'danger' : '' },
        { label: 'DRAG', value: fmtPct(final.drag), sub: fmtPct(1 - final.drag) + ' to common', cls: final.drag > 0.5 ? 'danger' : final.drag > 0.35 ? 'warn' : '' },
        { label: 'AMPLIFICATION', value: final.amp > 100 ? '\u221e' : final.amp.toFixed(2) + '\u00d7', sub: ((final.amp - 1) * 100).toFixed(0) + '% amplified', cls: '' },
        { label: 'BREAK-EVEN', value: fmtPrice(final.breakEven), sub: 'BTC floor', cls: btcPrice <= final.breakEven * 1.1 ? 'danger' : btcPrice <= final.breakEven * 1.5 ? 'warn' : '' },
        { label: 'NAV / SHARE', value: fmtPrice(final.navPerShare), sub: '\u00d7 ' + mnavMultiple.toFixed(2) + ' mNAV', cls: '' },
        { label: 'CASH RUNWAY', value: current.cashRunway === Infinity ? '\u221e' : current.cashRunway.toFixed(1) + 'yr', sub: fmtB(totalDivAnnual) + '/yr total div', cls: current.cashRunway < 2 ? 'danger' : current.cashRunway < 4 ? 'warn' : 'good' },
    ];

    $('metricsGrid').innerHTML = metrics.map(m =>
        '<div class="metric-card"><div class="metric-label">' + m.label + '</div><div class="metric-value ' + m.cls + '">' + m.value + '</div><div class="metric-sub">' + m.sub + '</div></div>'
    ).join('');
}

function renderWaterfall(final, inp) {
    const streUsd = inp.streFaceEur * inp.eurusd;
    const prefUsd = inp.strkFace + inp.strfFace + inp.strdFace + inp.strcFace + streUsd;
    const totalBtcValue = final.btcH * btcPrice;
    const netClaims = inp.debtUsd + prefUsd - final.cash;
    const nav = Math.max(0, totalBtcValue - netClaims);

    $('waterfall').innerHTML =
        '<div class="wf-step btc-val"><div class="wf-label">BTC VALUE</div><div class="wf-value">' + fmtB(totalBtcValue) + '</div></div>' +
        '<div class="wf-arrow">&rarr;</div>' +
        '<div class="wf-step claims"><div class="wf-label">&minus; CLAIMS</div><div class="wf-value">' + fmtB(netClaims) + '</div></div>' +
        '<div class="wf-arrow">&rarr;</div>' +
        '<div class="wf-step nav"><div class="wf-label">= NAV</div><div class="wf-value">' + fmtB(nav) + '</div></div>' +
        '<div class="wf-arrow">&rarr;</div>' +
        '<div class="wf-step shares"><div class="wf-label">&divide; ' + (final.shares/1e6).toFixed(0) + 'M</div><div class="wf-value">SHARES</div></div>' +
        '<div class="wf-arrow">&rarr;</div>' +
        '<div class="wf-step shares"><div class="wf-label">NAV/SHARE</div><div class="wf-value">' + fmtPrice(final.navPerShare) + '</div></div>' +
        '<div class="wf-arrow">&rarr;</div>' +
        '<div class="wf-step shares"><div class="wf-label">&times; mNAV</div><div class="wf-value">' + mnavMultiple.toFixed(2) + '\u00d7</div></div>' +
        '<div class="wf-arrow">&rarr;</div>' +
        '<div class="wf-step result"><div class="wf-label">PRICE</div><div class="wf-value" style="color:var(--orange-primary)">' + fmtPrice(final.modeledPrice) + '</div></div>';
}

function renderProjectionTable(proj) {
    const section = $('projectionSection');
    if (horizonYears === 0) { section.style.display = 'none'; return; }
    section.style.display = 'block';

    $('projHead').innerHTML = '<tr><th style="text-align:center">YEAR</th><th>BTC</th><th>SHARES</th><th>CEBE</th><th>DRAG</th><th>NAV/SH</th><th>PRICE</th><th>CASH</th><th>STATUS</th></tr>';

    $('projBody').innerHTML = proj.map(r => {
        const inp = getInputs();
        const statusEmoji = r.status === 'green' ? '&#128994;' : r.status === 'amber' ? '&#128993;' : '&#128308;';
        const statusLabel = r.status === 'green' ? 'Healthy' : r.status === 'amber' ? (r.strcSkipped ? 'Skip STRD+C' : 'Skip STRD') : 'BTC sold';
        return '<tr><td>' + statusEmoji + ' Yr ' + r.year + '</td>' +
            '<td class="' + (r.btcH < inp.btcHoldings ? 'cell-red' : '') + '">' + fmt(Math.round(r.btcH)) + '</td>' +
            '<td class="' + (r.newShares > 0 ? 'cell-amber' : '') + '">' + (r.shares / 1e6).toFixed(1) + 'M</td>' +
            '<td class="cell-bold">' + fmtSats(r.cebeSats) + '</td>' +
            '<td class="' + (r.drag > 0.5 ? 'cell-red' : r.drag > 0.35 ? 'cell-amber' : '') + '">' + fmtPct(r.drag) + '</td>' +
            '<td>' + fmtPrice(r.navPerShare) + '</td>' +
            '<td class="cell-bold" style="color:' + (r.modeledPrice > 0 ? 'var(--text-primary)' : 'var(--red)') + '">' + fmtPrice(r.modeledPrice) + '</td>' +
            '<td class="' + (r.cash <= 0 ? 'cell-red' : '') + '">' + fmtB(r.cash) + '</td>' +
            '<td style="font-size:10px">' + statusLabel + '</td></tr>';
    }).join('');
}

function renderSensitivityMatrix() {
    const marketPrice = liveMstrPrice || DEFAULTS.mstr_price;
    let html = '<thead><tr><th>BTC &darr; mNAV &rarr;</th>';
    MATRIX_MNAVS.forEach(m => { html += '<th>' + m.toFixed(2) + '\u00d7</th>'; });
    html += '</tr></thead><tbody>';

    MATRIX_BTC_PRICES.forEach(bp => {
        html += '<tr><td class="row-label">' + (bp >= 1000 ? '$' + (bp/1000) + 'K' : '$' + bp) + '</td>';
        MATRIX_MNAVS.forEach(mn => {
            const price = quickCalc(bp, mn);
            const pctDiff = marketPrice > 0 ? (price - marketPrice) / marketPrice : 0;
            let cls = '';
            if (price >= 1000) cls = 'matrix-cell-gold';
            else if (pctDiff > 0.5) cls = 'matrix-cell-green';
            else if (pctDiff > 0.1) cls = 'matrix-cell-lightgreen';
            else if (pctDiff < -0.5) cls = 'matrix-cell-red';
            else if (pctDiff < -0.1) cls = 'matrix-cell-lightred';
            const isCurrentBtc = Math.abs(bp - btcPrice) / btcPrice < 0.15;
            const isCurrentMnav = Math.abs(mn - mnavMultiple) < 0.05;
            if (isCurrentBtc && isCurrentMnav) cls += ' matrix-cell-current';
            html += '<td class="' + cls + '">' + (price <= 0 ? '$0' : fmtPrice(price)) + '</td>';
        });
        html += '</tr>';
    });
    html += '</tbody>';
    $('matrixTable').innerHTML = html;
}

function renderCustomize(inp, prefUsd, streUsd) {
    const instruments = [
        { name: 'STRK', face: inp.strkFace, rate: '8.00%', pay: 'Cash', cum: 'Cumulative', annual: inp.strkFace * 0.08 },
        { name: 'STRF', face: inp.strfFace, rate: '10.00%', pay: 'Cash', cum: 'Cumulative', annual: inp.strfFace * 0.10 },
        { name: 'STRD', face: inp.strdFace, rate: '10.00%', pay: 'Cash', cum: 'Non-cum', annual: inp.strdFace * 0.10 },
        { name: 'STRC', face: inp.strcFace, rate: '11.25%', pay: 'Cash', cum: 'Non-cum', annual: inp.strcFace * 0.1125 },
        { name: 'STRE', face: inp.streFaceEur * inp.eurusd, rate: '10.00%', pay: 'Cash (EUR)', cum: 'Cumulative', annual: inp.streFaceEur * inp.eurusd * 0.10 },
    ];
    const totalAnnual = instruments.reduce((s, i) => s + i.annual, 0);
    const totalDivAnnual = instruments.reduce((s, i) => s + i.annual, 0);
    const cumDivAnnual = instruments.filter(i => i.cum === 'Cumulative').reduce((s, i) => s + i.annual, 0);
    const skippableDivAnnual = instruments.filter(i => i.cum === 'Non-cum').reduce((s, i) => s + i.annual, 0);

    $('customizeBody').innerHTML =
        '<div style="margin-bottom:16px">' +
        '<div style="font-size:11px;color:var(--text-muted);letter-spacing:1px;margin-bottom:8px;font-weight:600">PREFERRED STOCK STACK</div>' +
        '<table class="pref-stack"><thead><tr><th>INSTRUMENT</th><th>FACE VALUE</th><th>RATE</th><th>PAYMENT</th><th>TYPE</th><th>ANNUAL</th></tr></thead><tbody>' +
        instruments.map(i =>
            '<tr><td>' + i.name + '</td><td>' + fmtB(i.face) + '</td><td>' + i.rate + '</td><td><span class="' + (i.pay.includes('Cash') ? 'badge-cash' : 'badge-shares') + '">' + i.pay + '</span></td><td><span class="badge-cum">' + i.cum + '</span></td><td>' + fmtB(i.annual) + '</td></tr>'
        ).join('') +
        '<tr style="border-top:2px solid var(--border-subtle)"><td style="color:var(--orange-primary)">TOTAL</td><td style="color:var(--orange-primary);font-weight:700">' + fmtB(prefUsd) + '</td><td></td><td></td><td></td><td style="color:var(--orange-primary);font-weight:700">' + fmtB(totalAnnual) + '</td></tr>' +
        '</tbody></table></div>' +
        '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:14px">' +
        '<div class="metric-card"><div class="metric-label">ANNUAL DIV</div><div class="metric-value">' + fmtB(totalDivAnnual) + '</div><div class="metric-sub">/yr all cash</div></div>' +
        '<div class="metric-card"><div class="metric-label">SKIPPABLE</div><div class="metric-value">' + fmtB(skippableDivAnnual) + '</div><div class="metric-sub">STRC + STRD non-cum</div></div>' +
        '<div class="metric-card"><div class="metric-label">CONVERT DEBT</div><div class="metric-value">' + fmtB(inp.debtUsd) + '</div><div class="metric-sub">zero-coupon</div></div></div>' +
        '<div style="font-size:11px;color:var(--text-muted);line-height:1.6">' +
        '<strong style="color:var(--text-secondary)">Distress cascade:</strong> All dividends paid in cash. If reserves depleted: skip STRD (non-cum, most junior) &rarr; skip STRC (non-cum) &rarr; sell BTC to cover cumulative obligations (STRF, STRE, STRK). Share issuance is a last resort, not modeled.' +
        '<br><br><strong style="color:var(--text-secondary)">Key defense:</strong> No convertible debt has early call provisions. Creditors cannot force liquidation regardless of BTC price.' +
        '</div>';
}

function renderAssumptions(inp) {
    $('assumptions').innerHTML =
        '<strong>Assumptions:</strong> Capital structure frozen at snapshot (' + inp.snapshotDate + '). BTC price static across projection years. All preferred dividends paid in cash (current practice). Distress cascade: skip non-cumulative (STRD, STRC) then sell BTC for cumulative obligations. Software income ~' + fmtB(inp.softwareIncome) + '/yr offsets cash drain. mNAV held constant. Convertible bond conversion mechanics excluded from v1.' +
        '<br><br><strong>Data sources:</strong> BTC holdings, shares, capital structure from Google Sheet (updated after 8-K filings). Live BTC price from CoinGecko. Live MSTR price from Finnhub. ' +
        (sheetData?.strk_face_usd ? 'Preferred face values from live sheet data.' : 'Using pre-Q4 estimates &mdash; update after earnings.');
}


// √¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê
// UI BUILDERS & EVENT HANDLERS
// √¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê

function buildScenarioBar() {
    const snapshots = SCENARIOS.filter(s => s.group === 'snapshot');
    const projections = SCENARIOS.filter(s => s.group === 'projection');

    function renderCard(s) {
        const isProjection = s.group === 'projection';
        const horizonLabel = s.horizon === 0 ? 'NOW' : s.horizon + 'Y';
        const badgeClass = isProjection ? 'future-badge' : 'now-badge';
        const cardClass = 'scenario-card' +
            (isProjection ? ' projection' : '') +
            (s.id === activeScenario ? ' active' : '');
        const priceDisplay = s.btc ? (s.btc >= 1000000 ? '$' + (s.btc/1000000) + 'M' : s.btc >= 1000 ? '$' + (s.btc/1000) + 'K' : '$' + s.btc) : fmtPrice(btcPrice);

        return '<div class="' + cardClass + '" data-scenario="' + s.id + '">' +
            '<span class="horizon-badge ' + badgeClass + '">' + horizonLabel + '</span>' +
            '<div class="scenario-icon">' + s.icon + '</div>' +
            '<div class="scenario-name">' + s.name + '</div>' +
            '<div class="scenario-price">' + priceDisplay + '</div>' +
            '<div class="scenario-mnav">' + s.mnav.toFixed(1) + '\u00d7 mNAV</div>' +
            '</div>';
    }

    $('snapshotBar').innerHTML = snapshots.map(renderCard).join('');
    $('projectionBar').innerHTML = projections.map(renderCard).join('');

    document.querySelectorAll('.scenario-card').forEach(card => {
        card.addEventListener('click', () => {
            const id = card.dataset.scenario;
            const scenario = SCENARIOS.find(s => s.id === id);
            if (!scenario) return;
            activeScenario = id;
            btcPrice = scenario.btc || (liveBtcPrice || DEFAULTS.btc_price);
            mnavMultiple = scenario.mnav;
            horizonYears = scenario.horizon;
            syncSliders();
            buildScenarioBar();
            updateHorizonBar();
            updateMnavPresets();
            render();
        });
    });
}

function buildHorizonBar() {
    $('horizonBar').innerHTML = HORIZON_OPTIONS.map(h =>
        '<button class="toggle-btn ' + (h.years === horizonYears ? 'active' : '') + '" data-years="' + h.years + '">' + h.label + '</button>'
    ).join('');

    document.querySelectorAll('#horizonBar .toggle-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            horizonYears = parseInt(btn.dataset.years);
            activeScenario = '';
            updateHorizonBar();
            buildScenarioBar();
            render();
        });
    });
}

function updateHorizonBar() {
    document.querySelectorAll('#horizonBar .toggle-btn').forEach(btn => {
        btn.classList.toggle('active', parseInt(btn.dataset.years) === horizonYears);
    });
    $('horizonDisplay').textContent = horizonYears === 0 ? 'Now' : horizonYears + 'Y';
}

function buildMnavPresets() {
    $('mnavPresets').innerHTML = MNAV_PRESETS.map(m =>
        '<button class="mnav-btn ' + (Math.abs(m - mnavMultiple) < 0.01 ? 'active' : '') + '" data-mnav="' + m + '">' + m.toFixed(m % 1 === 0 ? 0 : 2) + '\u00d7</button>'
    ).join('');

    document.querySelectorAll('.mnav-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            mnavMultiple = parseFloat(btn.dataset.mnav);
            $('mnavSlider').value = mnavMultiple * 100;
            $('mnavDisplay').textContent = mnavMultiple.toFixed(2) + '\u00d7';
            activeScenario = '';
            updateMnavPresets();
            buildScenarioBar();
            render();
        });
    });
}

function updateMnavPresets() {
    document.querySelectorAll('.mnav-btn').forEach(btn => {
        btn.classList.toggle('active', Math.abs(parseFloat(btn.dataset.mnav) - mnavMultiple) < 0.01);
    });
}

function syncSliders() {
    $('btcSlider').value = btcPrice;
    $('btcPriceDisplay').textContent = fmtPrice(btcPrice);
    $('mnavSlider').value = mnavMultiple * 100;
    $('mnavDisplay').textContent = mnavMultiple.toFixed(2) + '\u00d7';
    updateHorizonBar();
    updateMnavPresets();
}

function updateSliderFills() {
    const btcSlider = $('btcSlider');
    const btcPct = ((btcSlider.value - 20000) / (1000000 - 20000)) * 100;
    btcSlider.style.background = 'linear-gradient(90deg, var(--orange-primary) ' + btcPct + '%, #333 ' + btcPct + '%)';

    const mnavSlider = $('mnavSlider');
    const mnavPct = ((mnavSlider.value - 30) / (400 - 30)) * 100;
    mnavSlider.style.background = 'linear-gradient(90deg, var(--orange-primary) ' + mnavPct + '%, #333 ' + mnavPct + '%)';
}

// √¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨ SLIDER EVENTS √¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨
$('btcSlider').addEventListener('input', (e) => {
    btcPrice = parseInt(e.target.value);
    $('btcPriceDisplay').textContent = fmtPrice(btcPrice);
    activeScenario = '';
    buildScenarioBar();
    render();
});

$('mnavSlider').addEventListener('input', (e) => {
    mnavMultiple = parseInt(e.target.value) / 100;
    $('mnavDisplay').textContent = mnavMultiple.toFixed(2) + '\u00d7';
    activeScenario = '';
    updateMnavPresets();
    buildScenarioBar();
    render();
});

// √¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨ KEYBOARD SHORTCUTS √¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨
document.addEventListener('keydown', (e) => {
    if (e.target.tagName === 'INPUT') return;
    if (e.key >= '1' && e.key <= '6') {
        const idx = parseInt(e.key) - 1;
        if (SCENARIOS[idx]) {
            const scenario = SCENARIOS[idx];
            activeScenario = scenario.id;
            btcPrice = scenario.btc || (liveBtcPrice || DEFAULTS.btc_price);
            mnavMultiple = scenario.mnav;
            horizonYears = scenario.horizon;
            syncSliders();
            buildScenarioBar();
            updateHorizonBar();
            updateMnavPresets();
            render();
        }
    }
});

// √¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨ INIT √¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨
loadData();
</script>
</body>
</html>
