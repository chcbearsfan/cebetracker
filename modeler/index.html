<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>CEBE Modeler | MSTR Share Price Analysis</title>
    <meta name="description" content="Model Strategy (MSTR) share price through the CEBE framework. Scenario analysis, drag compression, dividend cascade modeling, and sensitivity matrix.">

    <meta name="application-name" content="CEBE">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#09090b">

    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect fill='%2309090b' width='32' height='32' rx='4'/%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' stop-color='%23f97316'/%3E%3Cstop offset='100%25' stop-color='%23fb923c'/%3E%3C/linearGradient%3E%3C/defs%3E%3Ctext x='16' y='15' font-family='Arial,sans-serif' font-size='14' font-weight='700' fill='url(%23g)' text-anchor='middle'%3ECE%3C/text%3E%3Ctext x='16' y='28' font-family='Arial,sans-serif' font-size='14' font-weight='700' fill='url(%23g)' text-anchor='middle'%3EBE%3C/text%3E%3C/svg%3E">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-primary: #09090b;
            --bg-secondary: #0f0f11;
            --bg-card: #141416;
            --bg-elevated: #1a1a1d;
            --orange-primary: #f97316;
            --orange-light: #fb923c;
            --orange-glow: rgba(249, 115, 22, 0.12);
            --orange-border: rgba(249, 115, 22, 0.25);
            --text-primary: #fafafa;
            --text-secondary: #a1a1aa;
            --text-muted: #52525b;
            --green: #22c55e;
            --green-muted: rgba(34, 197, 94, 0.15);
            --red: #ef4444;
            --red-muted: rgba(239, 68, 68, 0.15);
            --yellow: #eab308;
            --yellow-muted: rgba(234, 179, 8, 0.15);
            --border-subtle: rgba(255, 255, 255, 0.06);
            --mono: 'JetBrains Mono', monospace;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* Background grid */
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            pointer-events: none;
            background-image:
                linear-gradient(rgba(249,115,22,0.015) 1px, transparent 1px),
                linear-gradient(90deg, rgba(249,115,22,0.015) 1px, transparent 1px);
            background-size: 48px 48px;
            z-index: 0;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 24px 16px 60px;
            position: relative;
            z-index: 1;
        }

        /* â•â•â• HEADER â•â•â• */
        .header {
            text-align: center;
            margin-bottom: 32px;
        }
        .nav-back {
            display: inline-block;
            font-size: 12px;
            color: var(--text-muted);
            text-decoration: none;
            margin-bottom: 16px;
            letter-spacing: 1px;
            transition: color 0.2s;
        }
        .nav-back:hover { color: var(--orange-primary); }
        .logo-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 6px;
        }
        .logo-main {
            font-size: 32px;
            font-weight: 300;
            letter-spacing: 16px;
            padding-left: 16px;
            background: linear-gradient(135deg, var(--orange-primary), var(--orange-light));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .logo-badge {
            font-size: 11px;
            font-weight: 600;
            padding: 4px 10px;
            border-radius: 6px;
            background: rgba(249,115,22,0.12);
            border: 1px solid var(--orange-border);
            color: var(--orange-primary);
            letter-spacing: 1px;
            font-family: var(--mono);
        }
        .header-sub {
            font-size: 13px;
            color: var(--text-muted);
            letter-spacing: 1px;
            margin-top: 4px;
        }
        .live-strip {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            margin-top: 12px;
            font-size: 11px;
            font-family: var(--mono);
            color: var(--text-muted);
            flex-wrap: wrap;
        }
        .live-dot {
            width: 6px; height: 6px;
            border-radius: 50%;
            background: var(--green);
            display: inline-block;
            animation: pulse-dot 2s ease infinite;
        }
        @keyframes pulse-dot {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }
        .live-price { color: var(--text-secondary); }

        /* â•â•â• SCENARIO CARDS â•â•â• */
        .scenarios {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding: 4px 0 12px;
            margin-bottom: 24px;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .scenarios::-webkit-scrollbar { display: none; }
        .scenario-card {
            flex: 0 0 auto;
            min-width: 120px;
            padding: 12px 16px;
            border-radius: 12px;
            border: 1.5px solid var(--border-subtle);
            background: var(--bg-card);
            cursor: pointer;
            transition: all 0.25s ease;
            text-align: center;
            user-select: none;
        }
        .scenario-card:hover {
            border-color: rgba(255,255,255,0.12);
            background: var(--bg-elevated);
            transform: translateY(-2px);
        }
        .scenario-card.active {
            border-color: var(--orange-primary);
            background: var(--orange-glow);
            box-shadow: 0 0 20px rgba(249,115,22,0.1);
        }
        .scenario-icon { font-size: 20px; margin-bottom: 4px; }
        .scenario-name {
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.5px;
            margin-bottom: 2px;
        }
        .scenario-price {
            font-size: 13px;
            font-weight: 700;
            font-family: var(--mono);
            color: var(--orange-light);
        }

        /* â•â•â• HERO â•â•â• */
        .hero {
            text-align: center;
            padding: 32px 20px;
            margin-bottom: 24px;
            background: linear-gradient(180deg, rgba(249,115,22,0.04) 0%, transparent 100%);
            border-radius: 20px;
            border: 1px solid rgba(249,115,22,0.1);
        }
        .hero-label {
            font-size: 10px;
            letter-spacing: 3px;
            color: var(--text-muted);
            margin-bottom: 8px;
            font-weight: 500;
        }
        .hero-price {
            font-size: 64px;
            font-weight: 700;
            font-family: var(--mono);
            line-height: 1;
            margin-bottom: 8px;
            transition: color 0.3s;
        }
        .hero-price.positive { color: var(--green); }
        .hero-price.negative { color: var(--red); }
        .hero-price.neutral { color: var(--text-primary); }
        .hero-change {
            font-size: 16px;
            font-weight: 600;
            font-family: var(--mono);
            margin-bottom: 4px;
        }
        .hero-change.up { color: var(--green); }
        .hero-change.down { color: var(--red); }
        .hero-vs {
            font-size: 11px;
            color: var(--text-muted);
        }

        /* â•â•â• METRICS ROW â•â•â• */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 8px;
            margin-bottom: 28px;
        }
        .metric-card {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            padding: 12px;
            text-align: center;
        }
        .metric-label {
            font-size: 8px;
            letter-spacing: 1.5px;
            color: var(--text-muted);
            margin-bottom: 4px;
            font-weight: 600;
        }
        .metric-value {
            font-size: 18px;
            font-weight: 700;
            font-family: var(--mono);
            line-height: 1.2;
        }
        .metric-sub {
            font-size: 9px;
            color: #3f3f46;
            margin-top: 2px;
            font-family: var(--mono);
        }
        .metric-value.danger { color: var(--red); }
        .metric-value.warn { color: var(--yellow); }
        .metric-value.good { color: var(--green); }

        /* â•â•â• CONTROLS â•â•â• */
        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 28px;
        }
        @media (max-width: 640px) {
            .controls { grid-template-columns: 1fr; }
        }
        .control-card {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            padding: 16px;
        }
        .control-card.full-width {
            grid-column: 1 / -1;
        }
        .control-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .control-label {
            font-size: 10px;
            letter-spacing: 1.5px;
            color: var(--text-muted);
            font-weight: 600;
        }
        .control-value {
            font-size: 18px;
            font-weight: 700;
            font-family: var(--mono);
            color: var(--orange-light);
        }
        .slider-track {
            position: relative;
            margin-bottom: 8px;
        }
        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: linear-gradient(90deg, var(--orange-primary) 0%, #333 0%);
            outline: none;
            cursor: pointer;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--orange-primary);
            box-shadow: 0 0 10px rgba(249,115,22,0.4);
            cursor: grab;
        }
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--orange-primary);
            border: none;
            box-shadow: 0 0 10px rgba(249,115,22,0.4);
            cursor: grab;
        }
        .slider-labels {
            display: flex;
            justify-content: space-between;
            font-size: 9px;
            color: #444;
            font-family: var(--mono);
        }

        /* Time horizon + mNAV presets */
        .toggle-row {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }
        .toggle-btn {
            padding: 6px 14px;
            border-radius: 8px;
            border: 1.5px solid var(--border-subtle);
            background: transparent;
            color: var(--text-muted);
            font-size: 12px;
            font-weight: 600;
            font-family: var(--mono);
            cursor: pointer;
            transition: all 0.2s;
        }
        .toggle-btn:hover {
            border-color: rgba(255,255,255,0.12);
            color: var(--text-secondary);
        }
        .toggle-btn.active {
            border-color: var(--orange-primary);
            color: var(--orange-primary);
            background: var(--orange-glow);
        }
        .mnav-presets {
            display: flex;
            gap: 4px;
            margin-top: 8px;
        }
        .mnav-btn {
            flex: 1;
            padding: 4px 0;
            border-radius: 6px;
            border: 1px solid var(--border-subtle);
            background: transparent;
            color: var(--text-muted);
            font-size: 10px;
            font-family: var(--mono);
            cursor: pointer;
            transition: all 0.2s;
        }
        .mnav-btn:hover, .mnav-btn.active {
            border-color: var(--orange-primary);
            color: var(--orange-primary);
            background: var(--orange-glow);
        }

        /* â•â•â• WATERFALL â•â•â• */
        .waterfall {
            display: flex;
            align-items: center;
            gap: 4px;
            overflow-x: auto;
            padding: 16px;
            margin-bottom: 28px;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            scrollbar-width: none;
        }
        .waterfall::-webkit-scrollbar { display: none; }
        .wf-step {
            flex: 0 0 auto;
            text-align: center;
            padding: 8px 12px;
            border-radius: 8px;
            min-width: 90px;
        }
        .wf-step.btc-val { background: rgba(249,115,22,0.08); border: 1px solid rgba(249,115,22,0.2); }
        .wf-step.claims { background: var(--red-muted); border: 1px solid rgba(239,68,68,0.2); }
        .wf-step.nav { background: var(--green-muted); border: 1px solid rgba(34,197,94,0.2); }
        .wf-step.shares { background: rgba(255,255,255,0.03); border: 1px solid var(--border-subtle); }
        .wf-step.mnav-step { background: rgba(255,255,255,0.03); border: 1px solid var(--border-subtle); }
        .wf-step.result { background: rgba(249,115,22,0.12); border: 1px solid var(--orange-border); }
        .wf-label {
            font-size: 8px;
            letter-spacing: 1px;
            color: var(--text-muted);
            margin-bottom: 2px;
        }
        .wf-value {
            font-size: 13px;
            font-weight: 700;
            font-family: var(--mono);
        }
        .wf-arrow {
            flex: 0 0 auto;
            font-size: 14px;
            color: var(--text-muted);
        }

        /* â•â•â• SECTIONS â•â•â• */
        .section {
            margin-bottom: 28px;
        }
        .section-title {
            font-size: 14px;
            font-weight: 600;
            letter-spacing: 1px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .section-title .icon { font-size: 16px; }

        /* â•â•â• PROJECTION TABLE â•â•â• */
        .table-wrap {
            overflow-x: auto;
            border-radius: 12px;
            border: 1px solid var(--border-subtle);
            background: var(--bg-card);
            scrollbar-width: thin;
            scrollbar-color: #333 transparent;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            white-space: nowrap;
        }
        thead th {
            padding: 10px 12px;
            text-align: right;
            font-size: 8px;
            font-weight: 600;
            letter-spacing: 1.5px;
            color: var(--text-muted);
            border-bottom: 1px solid var(--border-subtle);
            background: rgba(255,255,255,0.02);
            position: sticky;
            top: 0;
        }
        thead th:first-child { text-align: center; }
        tbody td {
            padding: 8px 12px;
            text-align: right;
            font-family: var(--mono);
            font-size: 12px;
            border-bottom: 1px solid rgba(255,255,255,0.03);
        }
        tbody td:first-child {
            text-align: center;
            font-weight: 600;
            color: var(--text-secondary);
        }
        tbody tr:hover { background: rgba(255,255,255,0.02); }
        tbody tr.status-green td:first-child { color: var(--green); }
        tbody tr.status-amber td:first-child { color: var(--yellow); }
        tbody tr.status-red td:first-child { color: var(--red); }
        .cell-red { color: var(--red) !important; }
        .cell-green { color: var(--green) !important; }
        .cell-amber { color: var(--yellow) !important; }
        .cell-muted { color: var(--text-muted) !important; }
        .cell-bold { font-weight: 700 !important; }

        /* â•â•â• SENSITIVITY MATRIX â•â•â• */
        .matrix-table {
            width: 100%;
            border-collapse: collapse;
        }
        .matrix-table th {
            padding: 8px 10px;
            font-size: 9px;
            font-weight: 600;
            letter-spacing: 1px;
            color: var(--text-muted);
            border-bottom: 1px solid var(--border-subtle);
            background: rgba(255,255,255,0.02);
        }
        .matrix-table td {
            padding: 8px 10px;
            text-align: center;
            font-family: var(--mono);
            font-size: 11px;
            font-weight: 600;
            border-bottom: 1px solid rgba(255,255,255,0.03);
            transition: all 0.2s;
        }
        .matrix-table td.row-label {
            text-align: right;
            color: var(--text-secondary);
            font-weight: 600;
            background: rgba(255,255,255,0.02);
        }
        .matrix-table th:first-child { text-align: right; }
        .matrix-cell-green { color: var(--green); background: rgba(34,197,94,0.06); }
        .matrix-cell-lightgreen { color: #86efac; background: rgba(34,197,94,0.03); }
        .matrix-cell-red { color: var(--red); background: rgba(239,68,68,0.06); }
        .matrix-cell-lightred { color: #fca5a5; background: rgba(239,68,68,0.03); }
        .matrix-cell-gold { color: #fbbf24; background: rgba(251,191,36,0.08); border: 1px solid rgba(251,191,36,0.2); }
        .matrix-cell-current { outline: 2px solid var(--orange-primary); outline-offset: -2px; border-radius: 4px; }

        /* â•â•â• WARNINGS â•â•â• */
        .warnings { margin-bottom: 24px; }
        .warning-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 12px 16px;
            border-radius: 10px;
            margin-bottom: 8px;
            font-size: 13px;
            line-height: 1.5;
        }
        .warning-item.red {
            background: var(--red-muted);
            border: 1px solid rgba(239,68,68,0.25);
            color: #fca5a5;
        }
        .warning-item.amber {
            background: var(--yellow-muted);
            border: 1px solid rgba(234,179,8,0.25);
            color: #fde68a;
        }
        .warning-item.info {
            background: rgba(56,189,248,0.08);
            border: 1px solid rgba(56,189,248,0.2);
            color: #7dd3fc;
        }
        .warning-icon { font-size: 16px; flex-shrink: 0; margin-top: 1px; }

        /* â•â•â• CUSTOMIZE EXPANDER â•â•â• */
        .customize {
            margin-bottom: 28px;
        }
        .customize summary {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 14px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            letter-spacing: 0.5px;
            transition: all 0.2s;
            list-style: none;
        }
        .customize summary::-webkit-details-marker { display: none; }
        .customize summary:hover {
            border-color: rgba(255,255,255,0.12);
            color: var(--text-primary);
        }
        .customize[open] summary {
            border-radius: 12px 12px 0 0;
            border-bottom-color: transparent;
        }
        .customize-body {
            padding: 20px;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-top: none;
            border-radius: 0 0 12px 12px;
        }
        .pref-stack {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        .pref-stack th {
            padding: 8px 10px;
            text-align: left;
            font-size: 9px;
            font-weight: 600;
            letter-spacing: 1px;
            color: var(--text-muted);
            border-bottom: 1px solid var(--border-subtle);
        }
        .pref-stack td {
            padding: 8px 10px;
            font-family: var(--mono);
            font-size: 12px;
            border-bottom: 1px solid rgba(255,255,255,0.03);
        }
        .pref-stack td:first-child { font-weight: 600; color: var(--text-secondary); }
        .badge-cash { 
            font-size: 9px; padding: 2px 6px; border-radius: 4px; 
            background: rgba(239,68,68,0.12); color: #fca5a5; font-weight: 600;
        }
        .badge-shares { 
            font-size: 9px; padding: 2px 6px; border-radius: 4px; 
            background: rgba(34,197,94,0.12); color: #86efac; font-weight: 600;
        }
        .badge-cum { font-size: 9px; color: var(--text-muted); }

        /* â•â•â• ASSUMPTIONS â•â•â• */
        .assumptions {
            padding: 14px 16px;
            background: rgba(255,255,255,0.02);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            font-size: 11px;
            color: var(--text-muted);
            line-height: 1.6;
            margin-bottom: 28px;
        }
        .assumptions strong { color: var(--text-secondary); }

        /* â•â•â• FOOTER â•â•â• */
        .footer {
            text-align: center;
            padding-top: 24px;
            border-top: 1px solid var(--border-subtle);
            font-size: 11px;
            color: var(--text-muted);
        }
        .footer a { color: var(--orange-primary); text-decoration: none; }
        .footer a:hover { text-decoration: underline; }
        .footer-formula {
            font-family: var(--mono);
            font-size: 10px;
            color: #333;
            margin-top: 8px;
        }

        /* â•â•â• LOADING â•â•â• */
        .loading-screen {
            position: fixed;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: var(--bg-primary);
            z-index: 999;
        }
        .loading-spinner {
            width: 32px; height: 32px;
            border: 3px solid #222;
            border-top-color: var(--orange-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 12px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { font-size: 12px; color: var(--text-muted); letter-spacing: 2px; }

        /* â•â•â• RESPONSIVE â•â•â• */
        @media (max-width: 768px) {
            .hero-price { font-size: 48px; }
            .metrics-grid { grid-template-columns: repeat(3, 1fr); }
            .wf-step { min-width: 70px; padding: 6px 8px; }
            .wf-value { font-size: 11px; }
        }
        @media (max-width: 480px) {
            .hero-price { font-size: 40px; }
            .metrics-grid { grid-template-columns: repeat(2, 1fr); }
            .control-value { font-size: 16px; }
            .logo-main { font-size: 24px; letter-spacing: 10px; padding-left: 10px; }
        }
    </style>
</head>
<body>

<div class="loading-screen" id="loadingScreen">
    <div class="loading-spinner"></div>
    <div class="loading-text">LOADING LIVE DATA</div>
</div>

<div class="container" id="app" style="display:none">

    <!-- Header -->
    <div class="header">
        <a href="/" class="nav-back">â† cebetracker.io</a>
        <div class="logo-row">
            <div class="logo-main">CEBE</div>
            <div class="logo-badge">MSTR MODELER</div>
        </div>
        <div class="header-sub">What's your MSTR worth? Pick a scenario. See the math.</div>
        <div class="live-strip" id="liveStrip">
            <span><span class="live-dot"></span> Live Data</span>
            <span class="live-price" id="liveBtcDisplay">BTC $â€”</span>
            <span class="live-price" id="liveMstrDisplay">MSTR $â€”</span>
            <span class="live-price" id="liveDataDate">â€”</span>
        </div>
    </div>

    <!-- Scenario Cards -->
    <div class="scenarios" id="scenarioBar"></div>

    <!-- Hero -->
    <div class="hero">
        <div class="hero-label">MODELED MSTR SHARE PRICE</div>
        <div class="hero-price neutral" id="heroPrice">$â€”</div>
        <div class="hero-change" id="heroChange">â€”</div>
        <div class="hero-vs" id="heroVs">vs current market price</div>
    </div>

    <!-- Metrics -->
    <div class="metrics-grid" id="metricsGrid"></div>

    <!-- Controls -->
    <div class="controls">
        <div class="control-card">
            <div class="control-header">
                <span class="control-label">BTC PRICE</span>
                <span class="control-value" id="btcPriceDisplay">$â€”</span>
            </div>
            <div class="slider-track">
                <input type="range" id="btcSlider" min="0" max="1000" value="500">
            </div>
            <div class="slider-labels"><span>$10K</span><span>$100K</span><span>$1M</span></div>
        </div>
        <div class="control-card">
            <div class="control-header">
                <span class="control-label">mNAV MULTIPLE</span>
                <span class="control-value" id="mnavDisplay">1.00Ã—</span>
            </div>
            <div class="slider-track">
                <input type="range" id="mnavSlider" min="30" max="400" value="100">
            </div>
            <div class="mnav-presets" id="mnavPresets"></div>
        </div>
        <div class="control-card full-width">
            <div class="control-header">
                <span class="control-label">TIME HORIZON</span>
                <span class="control-value" id="horizonDisplay">Now</span>
            </div>
            <div class="toggle-row" id="horizonBar"></div>
        </div>
    </div>

    <!-- Value Waterfall -->
    <div class="section">
        <div class="section-title"><span class="icon">ðŸ”€</span> Value Waterfall</div>
        <div class="waterfall" id="waterfall"></div>
    </div>

    <!-- Year-by-Year Projection -->
    <div class="section" id="projectionSection" style="display:none">
        <div class="section-title"><span class="icon">ðŸ“…</span> Year-by-Year Projection</div>
        <div class="table-wrap">
            <table id="projectionTable">
                <thead id="projHead"></thead>
                <tbody id="projBody"></tbody>
            </table>
        </div>
    </div>

    <!-- Sensitivity Matrix -->
    <div class="section">
        <div class="section-title"><span class="icon">ðŸŽ¯</span> Price Sensitivity Matrix <span style="font-size:10px;color:var(--text-muted);font-weight:400">(BTC Price Ã— mNAV)</span></div>
        <div class="table-wrap">
            <table class="matrix-table" id="matrixTable"></table>
        </div>
    </div>

    <!-- Warnings -->
    <div class="warnings" id="warnings"></div>

    <!-- Customize -->
    <details class="customize" id="customizePanel">
        <summary>âš™ Capital Structure &amp; Preferred Stack</summary>
        <div class="customize-body" id="customizeBody"></div>
    </details>

    <!-- Assumptions -->
    <div class="assumptions" id="assumptions"></div>

    <!-- Footer -->
    <div class="footer">
        <p>CEBE Framework by <a href="https://x.com/chcbearsfan" target="_blank">@chcbearsfan</a> Â· <a href="/" >cebetracker.io</a></p>
        <p style="margin-top:4px">Data updates after each 8-K filing Â· Not financial advice</p>
        <p class="footer-formula">Share Price = CEBE Ã— BTC Price Ã— mNAV</p>
    </div>

</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CEBE MSTR SHARE PRICE MODELER
// cebetracker.io/modeler
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€â”€ CONFIG â”€â”€â”€
const SHEET_ID = '1BNsCWGVU08PDinDcfzJccqcuj9_KrK1VZGETErzBZvg';
const SNAPSHOTS_GID = '771405586';
const FINNHUB_API_KEY = 'd5tuehhr01qtjet1d7k0d5tuehhr01qtjet1d7kg';

// Preferred instrument terms (contract terms â€” don't change)
const PREF_INSTRUMENTS = [
    { id: 'strf', name: 'STRF', rate: 0.10,   payment: 'cash',   cumulative: true,  currency: 'USD', seniority: 1 },
    { id: 'strc', name: 'STRC', rate: 0.1125, payment: 'cash',   cumulative: false, currency: 'USD', seniority: 2 },
    { id: 'stre', name: 'STRE', rate: 0.10,   payment: 'cash',   cumulative: true,  currency: 'EUR', seniority: 3 },
    { id: 'strk', name: 'STRK', rate: 0.08,   payment: 'shares', cumulative: true,  currency: 'USD', seniority: 4 },
    { id: 'strd', name: 'STRD', rate: 0.10,   payment: 'shares', cumulative: false, currency: 'USD', seniority: 5 },
];

// Fallback defaults (pre-Q4 estimates â€” replaced by sheet data when available)
const DEFAULTS = {
    btc_holdings: 713502,
    shares_outstanding: 365000000,
    debt_usd: 8214000000,
    preferred_usd: 8400000000,
    cash_usd: 2250000000,
    strk_face_usd: 3220000000,
    strf_face_usd: 2640000000,
    strd_face_usd: 1006000000,
    strc_face_usd: 748000000,
    stre_face_eur: 775000000,
    eurusd_rate: 1.04,
    software_income_usd: 75000000,
    btc_price: 71400,
    mstr_price: 132,
};

// Scenario presets
const SCENARIOS = [
    { id: 'wipeout',      icon: 'ðŸ’€', name: 'Wipeout',      btc: 25000,  mnav: 0.5, horizon: 5  },
    { id: 'capitulation', icon: 'ðŸ»', name: 'Capitulation', btc: 50000,  mnav: 0.7, horizon: 3  },
    { id: 'current',      icon: 'ðŸ“', name: 'Current',      btc: null,   mnav: 1.0, horizon: 0  },
    { id: 'recovery',     icon: 'ðŸ”„', name: 'Recovery',     btc: 100000, mnav: 1.2, horizon: 1  },
    { id: 'bull',         icon: 'ðŸ‚', name: 'Bull',         btc: 200000, mnav: 1.5, horizon: 3  },
    { id: 'moon',         icon: 'ðŸš€', name: 'Moon Math',    btc: 500000, mnav: 2.0, horizon: 5  },
];

const HORIZON_OPTIONS = [
    { label: 'Now', years: 0 },
    { label: '1Y', years: 1 },
    { label: '3Y', years: 3 },
    { label: '5Y', years: 5 },
    { label: '10Y', years: 10 },
];

const MNAV_PRESETS = [0.5, 0.75, 1.0, 1.5, 2.0, 3.0];

const MATRIX_BTC_PRICES = [25000, 50000, 75000, 100000, 150000, 200000, 300000, 500000];
const MATRIX_MNAVS = [0.5, 0.75, 1.0, 1.5, 2.0, 3.0];

// Log slider mapping: 0-1000 â†’ $10K-$1M
const LOG_MIN = Math.log(10000);
const LOG_MAX = Math.log(1000000);

function sliderToPrice(val) { return Math.round(Math.exp(LOG_MIN + (val / 1000) * (LOG_MAX - LOG_MIN))); }
function priceToSlider(price) { return Math.round(1000 * (Math.log(Math.max(10000, Math.min(1000000, price))) - LOG_MIN) / (LOG_MAX - LOG_MIN)); }

// â”€â”€â”€ STATE â”€â”€â”€
let sheetData = null;        // Raw MSTR snapshot from Google Sheet
let liveBtcPrice = null;     // From CoinGecko
let liveMstrPrice = null;    // From Finnhub
let btcPrice = DEFAULTS.btc_price;
let mnavMultiple = 1.0;
let horizonYears = 0;
let activeScenario = 'current';

// â”€â”€â”€ HELPERS â”€â”€â”€
const $ = id => document.getElementById(id);
const fmt = n => Math.round(n).toLocaleString('en-US');
const fmtB = n => n >= 1e9 ? '$' + (n/1e9).toFixed(1) + 'B' : n >= 1e6 ? '$' + (n/1e6).toFixed(0) + 'M' : '$' + fmt(n);
const fmtPrice = p => {
    if (p >= 1e6) return '$' + (p/1e6).toFixed(1) + 'M';
    if (p >= 1000) return '$' + fmt(p);
    if (p >= 1) return '$' + p.toFixed(2);
    if (p >= 0) return '$' + p.toFixed(2);
    return '$0.00';
};
const fmtPct = (p, dec=1) => (p * 100).toFixed(dec) + '%';
const fmtSats = s => fmt(Math.round(s));

// â”€â”€â”€ CSV PARSER (matches main site) â”€â”€â”€
function parseCSVLine(line) {
    const r = []; let c = '', q = false;
    for (const ch of line) { if (ch === '"') q = !q; else if (ch === ',' && !q) { r.push(c); c = ''; } else c += ch; }
    r.push(c); return r;
}
function parseCSV(text) {
    const lines = text.split('\n');
    const headers = parseCSVLine(lines[0]);
    return lines.slice(1).filter(l => l.trim()).map(l => {
        const vals = parseCSVLine(l);
        const row = {};
        headers.forEach((h, i) => { row[h.replace(/"/g,'').trim()] = vals[i]?.replace(/"/g,'').trim() || ''; });
        return row;
    });
}

// â”€â”€â”€ DATA LOADING â”€â”€â”€
async function loadData() {
    try {
        const [btcRes, sheetText, mstrStockPrice] = await Promise.all([
            fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd')
                .then(r => r.json()).catch(() => null),
            fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&gid=${SNAPSHOTS_GID}`)
                .then(r => r.text()),
            fetchStockPrice('MSTR'),
        ]);

        // Parse sheet, get latest MSTR snapshot
        const rows = parseCSV(sheetText);
        let mstrRow = null;
        rows.forEach(r => {
            if (r.ticker === 'MSTR' && (!r.status || r.status.toLowerCase() === 'live')) {
                if (!mstrRow || r.snapshot_date > mstrRow.snapshot_date) mstrRow = r;
            }
        });

        if (mstrRow) sheetData = mstrRow;

        liveBtcPrice = btcRes?.bitcoin?.usd || null;
        liveMstrPrice = mstrStockPrice;

        // Set initial BTC price from live data
        btcPrice = liveBtcPrice || parseFloat(sheetData?.btc_price) || DEFAULTS.btc_price;
        SCENARIOS.find(s => s.id === 'current').btc = btcPrice;

        // Show app
        $('loadingScreen').style.display = 'none';
        $('app').style.display = 'block';

        // Build UI
        buildScenarioBar();
        buildHorizonBar();
        buildMnavPresets();
        syncSliders();
        render();
    } catch (err) {
        console.error('Load failed:', err);
        $('loadingScreen').innerHTML = `
            <div style="text-align:center;color:#a1a1aa;font-size:13px">
                <p style="margin-bottom:12px">Failed to load data</p>
                <p style="font-size:11px;color:#52525b">${err.message}</p>
                <p style="margin-top:12px"><a href="/" style="color:#f97316">â† Back to cebetracker.io</a></p>
            </div>`;
    }
}

async function fetchStockPrice(symbol) {
    if (!FINNHUB_API_KEY || FINNHUB_API_KEY === 'YOUR_FINNHUB_KEY_HERE') return null;
    try {
        const res = await fetch(`https://finnhub.io/api/v1/quote?symbol=${symbol}&token=${FINNHUB_API_KEY}`);
        const data = await res.json();
        if (data.c && data.c > 0) return data.c;
    } catch (e) { console.error('Finnhub failed:', e); }
    return null;
}

// â”€â”€â”€ GET FIELD VALUE (sheet â†’ fallback) â”€â”€â”€
function getVal(field, fallback) {
    if (sheetData && sheetData[field] !== undefined && sheetData[field] !== '') {
        const v = parseFloat(sheetData[field]);
        if (!isNaN(v)) return v;
    }
    return fallback;
}

function getInputs() {
    return {
        btcHoldings:    getVal('btc_holdings', DEFAULTS.btc_holdings),
        shares:         getVal('shares_outstanding', DEFAULTS.shares_outstanding),
        debtUsd:        getVal('debt_usd', DEFAULTS.debt_usd),
        prefTotalUsd:   getVal('preferred_usd', DEFAULTS.preferred_usd),
        cashUsd:        getVal('cash_usd', DEFAULTS.cash_usd),
        strkFace:       getVal('strk_face_usd', DEFAULTS.strk_face_usd),
        strfFace:       getVal('strf_face_usd', DEFAULTS.strf_face_usd),
        strdFace:       getVal('strd_face_usd', DEFAULTS.strd_face_usd),
        strcFace:       getVal('strc_face_usd', DEFAULTS.strc_face_usd),
        streFaceEur:    getVal('stre_face_eur', DEFAULTS.stre_face_eur),
        eurusd:         getVal('eurusd_rate', DEFAULTS.eurusd_rate),
        softwareIncome: getVal('software_income_usd', DEFAULTS.software_income_usd),
        snapshotDate:   sheetData?.snapshot_date || 'â€”',
    };
}

// â”€â”€â”€ CEBE MATH ENGINE â”€â”€â”€
function calcCEBE(btcHoldings, shares, netClaimsUsd, btcPriceInput) {
    const p = btcPriceInput || btcPrice;
    const netClaimsBtc = p > 0 ? Math.max(0, netClaimsUsd / p) : 0;
    const drag = btcHoldings > 0 ? Math.max(0, Math.min(1, netClaimsBtc / btcHoldings)) : 0;
    const commonBtc = Math.max(0, btcHoldings - netClaimsBtc);
    const cebeSats = shares > 0 ? (commonBtc / shares) * 1e8 : 0;
    const cebeBtc = shares > 0 ? commonBtc / shares : 0;
    const bpsSats = shares > 0 ? (btcHoldings / shares) * 1e8 : 0;
    const amp = drag < 0.999 ? 1 / (1 - drag) : Infinity;
    const breakEven = btcHoldings > 0 ? Math.max(0, netClaimsUsd) / btcHoldings : 0;
    const navUsd = Math.max(0, (btcHoldings * p) - netClaimsUsd);
    const navPerShare = shares > 0 ? navUsd / shares : 0;
    const modeledPrice = navPerShare * mnavMultiple;
    const cashRunway = null; // calculated separately in projection

    return { commonBtc, cebeSats, cebeBtc, bpsSats, drag, amp, breakEven, navUsd, navPerShare, modeledPrice, btcHoldings, shares, netClaimsUsd };
}

// â”€â”€â”€ YEAR-BY-YEAR PROJECTION ENGINE â”€â”€â”€
function projectYears(years) {
    const inp = getInputs();
    let btcH = inp.btcHoldings;
    let shares = inp.shares;
    let cash = inp.cashUsd;
    const debt = inp.debtUsd;

    // Preferred face values
    let strkF = inp.strkFace;
    let strfF = inp.strfFace;
    let strdF = inp.strdFace;
    let strcF = inp.strcFace;
    let streF_eur = inp.streFaceEur;
    const eurusd = inp.eurusd;
    const softIncome = inp.softwareIncome;

    const streF_usd = streF_eur * eurusd;
    const totalPrefFace = strkF + strfF + strdF + strcF + streF_usd;

    const results = [];

    for (let y = 0; y <= years; y++) {
        // Calculate net claims
        const prefUsd = strkF + strfF + strdF + strcF + streF_usd;
        const netClaims = debt + prefUsd - cash;
        const m = calcCEBE(btcH, shares, netClaims, btcPrice);

        let status = 'green';
        let btcSold = 0;
        let strcSkipped = false;
        let strdSkipped = false;
        let newSharesFromDiv = 0;
        let cashDivPaid = 0;
        let shareDivPaid = 0;

        if (y === 0) {
            // Year 0 = current state, no dividends yet
            const cashDivAnnual = strfF * 0.10 + strcF * 0.1125 + streF_eur * eurusd * 0.10;
            const netDrain = cashDivAnnual - softIncome;
            const runway = netDrain > 0 ? cash / netDrain : Infinity;

            results.push({
                year: y, btcH, shares, cebeSats: m.cebeSats, drag: m.drag, 
                navPerShare: m.navPerShare, modeledPrice: m.modeledPrice,
                cash, btcSold: 0, status: 'green', newShares: 0,
                amp: m.amp, breakEven: m.breakEven, cashRunway: runway,
            });
            continue;
        }

        // â”€â”€ Step 1: Cash-only dividends â”€â”€
        const strfDiv = strfF * 0.10;
        const strcDiv = strcF * 0.1125;
        const streDiv = streF_eur * eurusd * 0.10;
        const totalCashDiv = strfDiv + strcDiv + streDiv;
        const netCashDrain = totalCashDiv - softIncome;

        cash -= netCashDrain;
        cashDivPaid = totalCashDiv;

        if (cash >= 0) {
            status = 'green';
        } else {
            // Try skipping STRC (non-cumulative)
            cash += strcDiv;
            strcSkipped = true;
            cashDivPaid -= strcDiv;

            if (cash >= 0) {
                status = 'amber';
            } else {
                // Must sell BTC to cover cumulative cash obligations
                const deficit = Math.abs(cash);
                btcSold = btcPrice > 0 ? deficit / btcPrice : 0;
                btcH = Math.max(0, btcH - btcSold);
                cash = 0;
                status = 'red';
            }
        }

        // â”€â”€ Step 2: Share-payable dividends (reflexive) â”€â”€
        const strkDiv = strkF * 0.08;
        let strdDiv = strdF * 0.10;
        
        // Skip STRD if distressed (non-cumulative)
        if (status !== 'green') {
            strdDiv = 0;
            strdSkipped = true;
        }

        const totalShareDiv = strkDiv + strdDiv;
        shareDivPaid = totalShareDiv;

        // Recalculate with updated BTC holdings
        const updatedNetClaims = debt + (strkF + strfF + strdF + strcF + streF_eur * eurusd) - cash;
        const commonBtcNow = Math.max(0, btcH - (btcPrice > 0 ? updatedNetClaims / btcPrice : 0));

        if (totalShareDiv > 0 && commonBtcNow > 0 && shares > 0 && btcPrice > 0) {
            // Closed-form reflexive solution:
            // newShares = D Ã— S / (C Ã— P Ã— m - D)
            const denom = commonBtcNow * btcPrice * mnavMultiple - totalShareDiv;
            if (denom > 0) {
                newSharesFromDiv = totalShareDiv * shares / denom;
            } else {
                // Can't cover â€” wipeout territory
                newSharesFromDiv = shares * 10; // massive dilution indicator
                status = 'red';
            }
        }

        shares += newSharesFromDiv;

        // â”€â”€ Step 3: Recalculate final metrics â”€â”€
        const finalNetClaims = debt + (strkF + strfF + strdF + strcF + streF_eur * eurusd) - cash;
        const finalM = calcCEBE(btcH, shares, finalNetClaims, btcPrice);

        const cashDivNext = strfF * 0.10 + (strcSkipped ? 0 : strcF * 0.1125) + streF_eur * eurusd * 0.10;
        const netDrainNext = cashDivNext - softIncome;
        const runway = netDrainNext > 0 ? cash / netDrainNext : (cash > 0 ? Infinity : 0);

        results.push({
            year: y, btcH, shares, cebeSats: finalM.cebeSats, drag: finalM.drag,
            navPerShare: finalM.navPerShare, modeledPrice: finalM.modeledPrice,
            cash, btcSold, status, newShares: newSharesFromDiv,
            amp: finalM.amp, breakEven: finalM.breakEven, cashRunway: runway,
            strcSkipped, strdSkipped,
        });
    }

    return results;
}

// â”€â”€â”€ QUICK CALC (for sensitivity matrix â€” no time projection) â”€â”€â”€
function quickCalc(btcP, mnav) {
    const inp = getInputs();
    const streUsd = inp.streFaceEur * inp.eurusd;
    const prefUsd = inp.strkFace + inp.strfFace + inp.strdFace + inp.strcFace + streUsd;
    const netClaims = inp.debtUsd + prefUsd - inp.cashUsd;
    const netClaimsBtc = btcP > 0 ? Math.max(0, netClaims / btcP) : 0;
    const commonBtc = Math.max(0, inp.btcHoldings - netClaimsBtc);
    const navPerShare = inp.shares > 0 ? (commonBtc * btcP) / inp.shares : 0;
    // Subtract the claims from total BTC value more precisely
    const nav = Math.max(0, (inp.btcHoldings * btcP) - netClaims);
    const navPS = inp.shares > 0 ? nav / inp.shares : 0;
    return navPS * mnav;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UI RENDERING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function render() {
    const inp = getInputs();
    const streUsd = inp.streFaceEur * inp.eurusd;
    const prefUsd = inp.strkFace + inp.strfFace + inp.strdFace + inp.strcFace + streUsd;
    const netClaims = inp.debtUsd + prefUsd - inp.cashUsd;

    // Get projection
    const proj = projectYears(horizonYears);
    const current = proj[0];
    const final = proj[proj.length - 1];

    // Current market price
    const marketPrice = liveMstrPrice || DEFAULTS.mstr_price;

    // Render hero
    renderHero(final, marketPrice);
    renderMetrics(final, current, inp);
    renderWaterfall(final, inp);
    renderProjectionTable(proj);
    renderSensitivityMatrix();
    renderWarnings(final, current);
    renderCustomize(inp, prefUsd, streUsd);
    renderAssumptions(inp);

    // Live strip
    $('liveBtcDisplay').textContent = `BTC ${fmtPrice(liveBtcPrice || btcPrice)}`;
    $('liveMstrDisplay').textContent = `MSTR ${fmtPrice(marketPrice)}`;
    $('liveDataDate').textContent = inp.snapshotDate !== 'â€”' ? `Data: ${inp.snapshotDate}` : '';

    updateSliderFills();
}

function renderHero(final, marketPrice) {
    const price = final.modeledPrice;
    const el = $('heroPrice');
    
    if (price <= 0 || !isFinite(price)) {
        el.textContent = '$0.00';
        el.className = 'hero-price negative';
        $('heroChange').textContent = 'âˆ’100%';
        $('heroChange').className = 'hero-change down';
        $('heroVs').textContent = `common equity wiped out`;
        return;
    }

    el.textContent = fmtPrice(price);
    
    const pctChange = ((price - marketPrice) / marketPrice);
    const sign = pctChange >= 0 ? '+' : '';
    $('heroChange').textContent = `${sign}${(pctChange * 100).toFixed(1)}% (${sign}$${Math.abs(price - marketPrice).toFixed(2)})`;
    $('heroChange').className = 'hero-change ' + (pctChange >= 0 ? 'up' : 'down');
    el.className = 'hero-price ' + (pctChange > 0.05 ? 'positive' : pctChange < -0.05 ? 'negative' : 'neutral');
    $('heroVs').textContent = `vs MSTR market ${fmtPrice(marketPrice)} Â· ${horizonYears > 0 ? `Year ${horizonYears} projection` : 'at current inputs'}`;
}

function renderMetrics(final, current, inp) {
    const streUsd = inp.streFaceEur * inp.eurusd;
    const cashDivAnnual = inp.strfFace * 0.10 + inp.strcFace * 0.1125 + streUsd * 0.10;
    const shareDivAnnual = inp.strkFace * 0.08 + inp.strdFace * 0.10;
    const totalDivAnnual = cashDivAnnual + shareDivAnnual;

    const metrics = [
        { label: 'CEBE', value: fmtSats(final.cebeSats), sub: 'sats/share', cls: final.cebeSats <= 0 ? 'danger' : '' },
        { label: 'DRAG', value: fmtPct(final.drag), sub: fmtPct(1 - final.drag) + ' to common', cls: final.drag > 0.5 ? 'danger' : final.drag > 0.35 ? 'warn' : '' },
        { label: 'AMPLIFICATION', value: final.amp > 100 ? 'âˆž' : final.amp.toFixed(2) + 'Ã—', sub: `${((final.amp - 1) * 100).toFixed(0)}% amplified`, cls: '' },
        { label: 'BREAK-EVEN', value: fmtPrice(final.breakEven), sub: 'BTC price floor', cls: btcPrice <= final.breakEven * 1.1 ? 'danger' : btcPrice <= final.breakEven * 1.5 ? 'warn' : '' },
        { label: 'NAV / SHARE', value: fmtPrice(final.navPerShare), sub: `Ã— ${mnavMultiple.toFixed(2)} mNAV`, cls: '' },
        { label: 'BTC HOLDINGS', value: fmt(Math.round(final.btcH)), sub: final.btcH < inp.btcHoldings ? `âˆ’${fmt(Math.round(inp.btcHoldings - final.btcH))} sold` : 'no BTC sold', cls: final.btcH < inp.btcHoldings ? 'danger' : '' },
        { label: 'CASH RUNWAY', value: current.cashRunway === Infinity ? 'âˆž' : current.cashRunway.toFixed(1) + 'yr', sub: fmtB(cashDivAnnual) + '/yr cash div', cls: current.cashRunway < 2 ? 'danger' : current.cashRunway < 4 ? 'warn' : 'good' },
        { label: 'ANNUAL DIVIDENDS', value: fmtB(totalDivAnnual), sub: `${fmtB(cashDivAnnual)} cash Â· ${fmtB(shareDivAnnual)} shares`, cls: '' },
    ];

    $('metricsGrid').innerHTML = metrics.map(m => `
        <div class="metric-card">
            <div class="metric-label">${m.label}</div>
            <div class="metric-value ${m.cls}">${m.value}</div>
            <div class="metric-sub">${m.sub}</div>
        </div>
    `).join('');
}

function renderWaterfall(final, inp) {
    const streUsd = inp.streFaceEur * inp.eurusd;
    const prefUsd = inp.strkFace + inp.strfFace + inp.strdFace + inp.strcFace + streUsd;
    const totalBtcValue = final.btcH * btcPrice;
    const netClaims = inp.debtUsd + prefUsd - final.cash;
    const nav = Math.max(0, totalBtcValue - netClaims);

    $('waterfall').innerHTML = `
        <div class="wf-step btc-val"><div class="wf-label">BTC VALUE</div><div class="wf-value">${fmtB(totalBtcValue)}</div></div>
        <div class="wf-arrow">â†’</div>
        <div class="wf-step claims"><div class="wf-label">âˆ’ CLAIMS</div><div class="wf-value">${fmtB(netClaims)}</div></div>
        <div class="wf-arrow">â†’</div>
        <div class="wf-step nav"><div class="wf-label">= NAV</div><div class="wf-value">${fmtB(nav)}</div></div>
        <div class="wf-arrow">â†’</div>
        <div class="wf-step shares"><div class="wf-label">Ã· ${(final.shares/1e6).toFixed(0)}M</div><div class="wf-value">SHARES</div></div>
        <div class="wf-arrow">â†’</div>
        <div class="wf-step shares"><div class="wf-label">NAV/SHARE</div><div class="wf-value">${fmtPrice(final.navPerShare)}</div></div>
        <div class="wf-arrow">â†’</div>
        <div class="wf-step mnav-step"><div class="wf-label">Ã— mNAV</div><div class="wf-value">${mnavMultiple.toFixed(2)}Ã—</div></div>
        <div class="wf-arrow">â†’</div>
        <div class="wf-step result"><div class="wf-label">PRICE</div><div class="wf-value" style="color:var(--orange-primary)">${fmtPrice(final.modeledPrice)}</div></div>
    `;
}

function renderProjectionTable(proj) {
    const section = $('projectionSection');
    if (horizonYears === 0) {
        section.style.display = 'none';
        return;
    }
    section.style.display = 'block';

    $('projHead').innerHTML = `<tr>
        <th style="text-align:center">YEAR</th>
        <th>BTC HOLDINGS</th>
        <th>SHARES (M)</th>
        <th>CEBE (SATS)</th>
        <th>DRAG</th>
        <th>NAV/SHARE</th>
        <th>PRICE</th>
        <th>CASH</th>
        <th>BTC SOLD</th>
        <th>STATUS</th>
    </tr>`;

    $('projBody').innerHTML = proj.map(r => {
        const statusEmoji = r.status === 'green' ? 'ðŸŸ¢' : r.status === 'amber' ? 'ðŸŸ¡' : 'ðŸ”´';
        const statusLabel = r.status === 'green' ? 'Healthy' : r.status === 'amber' ? 'STRC skipped' : 'BTC liquidation';
        const rowClass = `status-${r.status}`;
        const inp = getInputs();
        
        return `<tr class="${rowClass}">
            <td>${statusEmoji} Yr ${r.year}</td>
            <td class="${r.btcH < inp.btcHoldings ? 'cell-red' : ''}">${fmt(Math.round(r.btcH))}</td>
            <td class="${r.newShares > 0 ? 'cell-amber' : ''}">${(r.shares / 1e6).toFixed(1)}M</td>
            <td class="cell-bold">${fmtSats(r.cebeSats)}</td>
            <td class="${r.drag > 0.5 ? 'cell-red' : r.drag > 0.35 ? 'cell-amber' : ''}">${fmtPct(r.drag)}</td>
            <td>${fmtPrice(r.navPerShare)}</td>
            <td class="cell-bold" style="color:${r.modeledPrice > 0 ? 'var(--text-primary)' : 'var(--red)'}">
                ${fmtPrice(r.modeledPrice)}
            </td>
            <td class="${r.cash <= 0 ? 'cell-red' : ''}">${fmtB(r.cash)}</td>
            <td class="${r.btcSold > 0 ? 'cell-red cell-bold' : 'cell-muted'}">${r.btcSold > 0 ? fmt(Math.round(r.btcSold)) : 'â€”'}</td>
            <td style="font-size:10px">${statusLabel}</td>
        </tr>`;
    }).join('');
}

function renderSensitivityMatrix() {
    const marketPrice = liveMstrPrice || DEFAULTS.mstr_price;
    
    let html = '<thead><tr><th>BTC â†“ mNAV â†’</th>';
    MATRIX_MNAVS.forEach(m => { html += `<th>${m.toFixed(2)}Ã—</th>`; });
    html += '</tr></thead><tbody>';

    MATRIX_BTC_PRICES.forEach(bp => {
        html += `<tr><td class="row-label">${bp >= 1000 ? '$' + (bp/1000) + 'K' : '$' + bp}</td>`;
        MATRIX_MNAVS.forEach(mn => {
            const price = quickCalc(bp, mn);
            const pctDiff = marketPrice > 0 ? (price - marketPrice) / marketPrice : 0;
            
            let cls = '';
            if (price >= 1000) cls = 'matrix-cell-gold';
            else if (pctDiff > 0.5) cls = 'matrix-cell-green';
            else if (pctDiff > 0.1) cls = 'matrix-cell-lightgreen';
            else if (pctDiff < -0.5) cls = 'matrix-cell-red';
            else if (pctDiff < -0.1) cls = 'matrix-cell-lightred';

            // Highlight current BTC price row approximately
            const isCurrentBtc = Math.abs(bp - btcPrice) / btcPrice < 0.15;
            const isCurrentMnav = Math.abs(mn - mnavMultiple) < 0.05;
            if (isCurrentBtc && isCurrentMnav) cls += ' matrix-cell-current';

            html += `<td class="${cls}">${price <= 0 ? '$0' : fmtPrice(price)}</td>`;
        });
        html += '</tr>';
    });
    html += '</tbody>';
    $('matrixTable').innerHTML = html;
}

function renderWarnings(final, current) {
    const warnings = [];
    const inp = getInputs();

    // STRK conversion warning
    if (final.modeledPrice >= 800) {
        warnings.push({
            type: final.modeledPrice >= 1000 ? 'info' : 'amber',
            icon: 'âš¡',
            text: `<strong>STRK conversion zone.</strong> STRK converts 10:1 into MSTR at $1,000/share. Modeled price: ${fmtPrice(final.modeledPrice)}. ${final.modeledPrice >= 1000 ? 'Conversion would remove STRK claims but add ~' + fmt(Math.round(inp.strkFace / 100 * 0.1)) + ' shares.' : 'Approaching threshold.'}`,
        });
    }

    // Break-even proximity
    if (btcPrice <= final.breakEven * 1.1 && btcPrice > final.breakEven * 0.5) {
        warnings.push({
            type: 'red',
            icon: 'âš ',
            text: `<strong>Near break-even.</strong> At ${fmtPrice(btcPrice)} BTC, Strategy is ${btcPrice > final.breakEven ? 'only ' + ((btcPrice/final.breakEven - 1)*100).toFixed(0) + '% above' : ((1 - btcPrice/final.breakEven)*100).toFixed(0) + '% below'} break-even (${fmtPrice(final.breakEven)}).`,
        });
    }

    // Below break-even
    if (btcPrice < final.breakEven * 0.5) {
        warnings.push({
            type: 'red',
            icon: 'ðŸ’€',
            text: `<strong>Deep underwater.</strong> At ${fmtPrice(btcPrice)}, senior claims exceed BTC value. Common equity is theoretically worth $0. Note: no callable debt means creditors cannot force liquidation.`,
        });
    }

    // Cash depletion
    if (current.cashRunway < 3 && current.cashRunway > 0) {
        warnings.push({
            type: 'amber',
            icon: 'â°',
            text: `<strong>Cash runway: ${current.cashRunway.toFixed(1)} years.</strong> Cash reserves deplete from preferred dividends. After depletion, STRC gets skipped (non-cumulative), but STRF and STRE (cumulative, cash-only) force BTC liquidation.`,
        });
    }

    // BTC sold in projection
    if (final.btcSold > 0 || final.btcH < inp.btcHoldings) {
        const totalSold = inp.btcHoldings - final.btcH;
        warnings.push({
            type: 'red',
            icon: 'ðŸ”¥',
            text: `<strong>BTC liquidation triggered.</strong> ${fmt(Math.round(totalSold))} BTC sold over ${horizonYears} years to cover cumulative preferred dividends. This is the death spiral: selling BTC â†’ more drag â†’ lower NAV â†’ more dilutive share dividends.`,
        });
    }

    // Average cost basis
    const avgCost = 76052;
    if (btcPrice < avgCost) {
        warnings.push({
            type: 'amber',
            icon: 'ðŸ“‰',
            text: `<strong>Below cost basis.</strong> Strategy's average BTC cost is ~$76,052. At ${fmtPrice(btcPrice)}, holdings are ${((1 - btcPrice/avgCost)*100).toFixed(1)}% underwater.`,
        });
    }

    $('warnings').innerHTML = warnings.map(w => `
        <div class="warning-item ${w.type}">
            <span class="warning-icon">${w.icon}</span>
            <span>${w.text}</span>
        </div>
    `).join('');
}

function renderCustomize(inp, prefUsd, streUsd) {
    const instruments = [
        { name: 'STRK', face: inp.strkFace, rate: '8.00%', pay: 'Shares', cum: 'Cumulative', annual: inp.strkFace * 0.08 },
        { name: 'STRF', face: inp.strfFace, rate: '10.00%', pay: 'Cash', cum: 'Cumulative', annual: inp.strfFace * 0.10 },
        { name: 'STRD', face: inp.strdFace, rate: '10.00%', pay: 'Shares', cum: 'Non-cum', annual: inp.strdFace * 0.10 },
        { name: 'STRC', face: inp.strcFace, rate: '11.25%', pay: 'Cash', cum: 'Non-cum', annual: inp.strcFace * 0.1125 },
        { name: 'STRE', face: inp.streFaceEur * inp.eurusd, rate: '10.00%', pay: 'Cash (EUR)', cum: 'Cumulative', annual: inp.streFaceEur * inp.eurusd * 0.10, note: `â‚¬${fmt(Math.round(inp.streFaceEur/1e6))}M @ ${inp.eurusd} EUR/USD` },
    ];

    const totalAnnual = instruments.reduce((s, i) => s + i.annual, 0);
    const cashAnnual = instruments.filter(i => i.pay.includes('Cash')).reduce((s, i) => s + i.annual, 0);
    const shareAnnual = instruments.filter(i => i.pay === 'Shares').reduce((s, i) => s + i.annual, 0);

    $('customizeBody').innerHTML = `
        <div style="margin-bottom:16px">
            <div style="font-size:11px;color:var(--text-muted);letter-spacing:1px;margin-bottom:8px;font-weight:600">PREFERRED STOCK STACK</div>
            <table class="pref-stack">
                <thead><tr>
                    <th>INSTRUMENT</th><th>FACE VALUE</th><th>RATE</th><th>PAYMENT</th><th>TYPE</th><th>ANNUAL COST</th>
                </tr></thead>
                <tbody>
                    ${instruments.map(i => `<tr>
                        <td>${i.name}</td>
                        <td>${fmtB(i.face)}</td>
                        <td>${i.rate}</td>
                        <td><span class="${i.pay.includes('Cash') ? 'badge-cash' : 'badge-shares'}">${i.pay}</span></td>
                        <td><span class="badge-cum">${i.cum}</span></td>
                        <td>${fmtB(i.annual)}</td>
                    </tr>`).join('')}
                    <tr style="border-top:2px solid var(--border-subtle)">
                        <td style="color:var(--orange-primary)">TOTAL</td>
                        <td style="color:var(--orange-primary);font-weight:700">${fmtB(prefUsd)}</td>
                        <td></td><td></td><td></td>
                        <td style="color:var(--orange-primary);font-weight:700">${fmtB(totalAnnual)}</td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:16px">
            <div class="metric-card">
                <div class="metric-label">CASH DIVIDENDS</div>
                <div class="metric-value">${fmtB(cashAnnual)}</div>
                <div class="metric-sub">/year Â· drains reserves</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">SHARE DIVIDENDS</div>
                <div class="metric-value">${fmtB(shareAnnual)}</div>
                <div class="metric-sub">/year Â· dilutes common</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">CONVERTIBLE DEBT</div>
                <div class="metric-value">${fmtB(inp.debtUsd)}</div>
                <div class="metric-sub">zero-coupon + low coupon</div>
            </div>
        </div>
        <div style="font-size:11px;color:var(--text-muted);line-height:1.6">
            <strong style="color:var(--text-secondary)">Payment hierarchy in distress:</strong> 
            STRF (most senior, cash, cumulative) â†’ STRC (cash, non-cumulative â€” can skip) â†’ STRE (cash, cumulative, EUR) â†’ STRK (shares, cumulative) â†’ STRD (shares, non-cumulative â€” can skip)
            <br><br>
            <strong style="color:var(--text-secondary)">The doom loop:</strong>
            Miss preferred dividend â†’ can't issue common via ATM â†’ can't raise cash â†’ can't pay dividends â†’ can't issue shares. Cash-only cumulative instruments (STRF, STRE) force BTC liquidation when cash depletes.
            <br><br>
            <strong style="color:var(--text-secondary)">Key defense:</strong>
            No convertible debt has early call provisions. Creditors cannot force liquidation regardless of BTC price. The only hard triggers are maturity dates and put option dates.
        </div>
    `;
}

function renderAssumptions(inp) {
    $('assumptions').innerHTML = `
        <strong>Assumptions:</strong> Capital structure frozen at snapshot (${inp.snapshotDate}). 
        BTC price static at slider value across all projection years. 
        Share-payable dividends computed reflexively (Annual Div Cost Ã· Modeled Price = New Shares/Year). 
        Software operating income ~${fmtB(inp.softwareIncome)}/yr offsets cash drain. 
        In distress: STRC and STRD skipped (non-cumulative). STRF and STRE force BTC liquidation when cash depletes. 
        mNAV held constant across projection. Convertible bond conversion mechanics excluded from v1.
        <br><br>
        <strong>Data sources:</strong> BTC holdings, shares, capital structure from Google Sheet (updated after 8-K filings). 
        Live BTC price from CoinGecko. Live MSTR price from Finnhub. 
        Individual preferred face values ${sheetData?.strk_face_usd ? 'from live sheet data' : 'using pre-Q4 estimates â€” update after earnings'}.
    `;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UI BUILDERS & EVENT HANDLERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function buildScenarioBar() {
    $('scenarioBar').innerHTML = SCENARIOS.map(s => `
        <div class="scenario-card ${s.id === activeScenario ? 'active' : ''}" data-scenario="${s.id}">
            <div class="scenario-icon">${s.icon}</div>
            <div class="scenario-name">${s.name}</div>
            <div class="scenario-price">${s.btc ? (s.btc >= 1000 ? '$' + (s.btc/1000) + 'K' : '$' + s.btc) : fmtPrice(btcPrice)}</div>
        </div>
    `).join('');

    document.querySelectorAll('.scenario-card').forEach(card => {
        card.addEventListener('click', () => {
            const id = card.dataset.scenario;
            const scenario = SCENARIOS.find(s => s.id === id);
            if (!scenario) return;

            activeScenario = id;
            btcPrice = scenario.btc || (liveBtcPrice || DEFAULTS.btc_price);
            mnavMultiple = scenario.mnav;
            horizonYears = scenario.horizon;

            syncSliders();
            buildScenarioBar();
            updateHorizonBar();
            updateMnavPresets();
            render();
        });
    });
}

function buildHorizonBar() {
    $('horizonBar').innerHTML = HORIZON_OPTIONS.map(h => `
        <button class="toggle-btn ${h.years === horizonYears ? 'active' : ''}" data-years="${h.years}">${h.label}</button>
    `).join('');

    document.querySelectorAll('#horizonBar .toggle-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            horizonYears = parseInt(btn.dataset.years);
            activeScenario = '';
            updateHorizonBar();
            render();
        });
    });
}

function updateHorizonBar() {
    document.querySelectorAll('#horizonBar .toggle-btn').forEach(btn => {
        btn.classList.toggle('active', parseInt(btn.dataset.years) === horizonYears);
    });
    $('horizonDisplay').textContent = horizonYears === 0 ? 'Now' : `${horizonYears}Y`;
}

function buildMnavPresets() {
    $('mnavPresets').innerHTML = MNAV_PRESETS.map(m => `
        <button class="mnav-btn ${Math.abs(m - mnavMultiple) < 0.01 ? 'active' : ''}" data-mnav="${m}">${m.toFixed(m % 1 === 0 ? 0 : 2)}Ã—</button>
    `).join('');

    document.querySelectorAll('.mnav-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            mnavMultiple = parseFloat(btn.dataset.mnav);
            $('mnavSlider').value = mnavMultiple * 100;
            $('mnavDisplay').textContent = mnavMultiple.toFixed(2) + 'Ã—';
            activeScenario = '';
            updateMnavPresets();
            buildScenarioBar();
            render();
        });
    });
}

function updateMnavPresets() {
    document.querySelectorAll('.mnav-btn').forEach(btn => {
        btn.classList.toggle('active', Math.abs(parseFloat(btn.dataset.mnav) - mnavMultiple) < 0.01);
    });
}

function syncSliders() {
    $('btcSlider').value = priceToSlider(btcPrice);
    $('btcPriceDisplay').textContent = fmtPrice(btcPrice);
    $('mnavSlider').value = mnavMultiple * 100;
    $('mnavDisplay').textContent = mnavMultiple.toFixed(2) + 'Ã—';
    updateHorizonBar();
    updateMnavPresets();
}

function updateSliderFills() {
    const btcSlider = $('btcSlider');
    const btcPct = btcSlider.value / 1000 * 100;
    btcSlider.style.background = `linear-gradient(90deg, var(--orange-primary) ${btcPct}%, #333 ${btcPct}%)`;

    const mnavSlider = $('mnavSlider');
    const mnavPct = ((mnavSlider.value - 30) / (400 - 30)) * 100;
    mnavSlider.style.background = `linear-gradient(90deg, var(--orange-primary) ${mnavPct}%, #333 ${mnavPct}%)`;
}

// â”€â”€â”€ SLIDER EVENTS â”€â”€â”€
$('btcSlider').addEventListener('input', (e) => {
    btcPrice = sliderToPrice(parseInt(e.target.value));
    $('btcPriceDisplay').textContent = fmtPrice(btcPrice);
    activeScenario = '';
    buildScenarioBar();
    render();
});

$('mnavSlider').addEventListener('input', (e) => {
    mnavMultiple = parseInt(e.target.value) / 100;
    $('mnavDisplay').textContent = mnavMultiple.toFixed(2) + 'Ã—';
    activeScenario = '';
    updateMnavPresets();
    buildScenarioBar();
    render();
});

// â”€â”€â”€ KEYBOARD SHORTCUTS â”€â”€â”€
document.addEventListener('keydown', (e) => {
    if (e.key >= '1' && e.key <= '6') {
        const idx = parseInt(e.key) - 1;
        if (SCENARIOS[idx]) {
            const scenario = SCENARIOS[idx];
            activeScenario = scenario.id;
            btcPrice = scenario.btc || (liveBtcPrice || DEFAULTS.btc_price);
            mnavMultiple = scenario.mnav;
            horizonYears = scenario.horizon;
            syncSliders();
            buildScenarioBar();
            updateHorizonBar();
            updateMnavPresets();
            render();
        }
    }
});

// â”€â”€â”€ INIT â”€â”€â”€
loadData();

</script>
</body>
</html>
