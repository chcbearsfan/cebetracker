<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Strive Modeler | CEBE Tracker</title>
    <meta name="description" content="Model Strive share price through CEBE. Preferred equity structure, aggressive debt retirement, USD-denominated. Nasdaq: ASST.">
    <meta name="theme-color" content="#09090b">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect fill='%2309090b' width='32' height='32' rx='4'/%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' stop-color='%23f97316'/%3E%3Cstop offset='100%25' stop-color='%23fb923c'/%3E%3C/linearGradient%3E%3C/defs%3E%3Ctext x='16' y='15' font-family='Arial,sans-serif' font-size='14' font-weight='700' fill='url(%23g)' text-anchor='middle'%3ECE%3C/text%3E%3Ctext x='16' y='28' font-family='Arial,sans-serif' font-size='14' font-weight='700' fill='url(%23g)' text-anchor='middle'%3EBE%3C/text%3E%3C/svg%3E">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #09090b;
            --bg-secondary: #0f0f11;
            --bg-card: #141416;
            --bg-elevated: #1a1a1d;
            --orange-primary: #f97316;
            --orange-light: #fb923c;
            --orange-glow: rgba(249, 115, 22, 0.12);
            --orange-border: rgba(249, 115, 22, 0.25);
            --text-primary: #fafafa;
            --text-secondary: #a1a1aa;
            --text-muted: #52525b;
            --green: #22c55e;
            --green-muted: rgba(34, 197, 94, 0.15);
            --red: #ef4444;
            --red-muted: rgba(239, 68, 68, 0.15);
            --yellow: #eab308;
            --yellow-muted: rgba(234, 179, 8, 0.15);
            --border-subtle: rgba(255, 255, 255, 0.06);
            --mono: 'JetBrains Mono', monospace;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* Background grid */
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            pointer-events: none;
            background-image:
                linear-gradient(rgba(249,115,22,0.015) 1px, transparent 1px),
                linear-gradient(90deg, rgba(249,115,22,0.015) 1px, transparent 1px);
            background-size: 48px 48px;
            z-index: 0;
        }

        .container {
            max-width: 680px;
            margin: 0 auto;
            padding: 24px 16px 60px;
            position: relative;
            z-index: 1;
        }

        /* ═══ HEADER ═══ */
        .header { text-align: center; margin-bottom: 28px; }
        .nav-back {
            display: inline-block;
            font-size: 12px;
            color: var(--text-muted);
            text-decoration: none;
            margin-bottom: 12px;
            letter-spacing: 1px;
            transition: color 0.2s;
        }
        .nav-back:hover { color: var(--orange-primary); }
        .logo-container {
            position: relative;
            display: inline-block;
            margin-bottom: 6px;
        }
        .logo {
            font-size: 32px;
            font-weight: 300;
            letter-spacing: 16px;
            padding-left: 16px;
            color: var(--text-primary);
            position: relative;
            z-index: 1;
        }
        .logo span {
            background: linear-gradient(135deg, var(--orange-primary) 0%, var(--orange-light) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 600;
        }
        .logo-whisper {
            font-size: 11px;
            font-weight: 400;
            letter-spacing: 8px;
            padding-left: 8px;
            margin-top: 2px;
            text-transform: lowercase;
            background: linear-gradient(180deg, rgba(161,161,170,0.6) 0%, rgba(82,82,91,0.2) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .logo-glow {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 180px;
            height: 50px;
            background: radial-gradient(ellipse, rgba(249,115,22,0.3) 0%, transparent 70%);
            filter: blur(20px);
            z-index: 0;
        }
        .logo-badge {
            display: inline-block;
            font-size: 11px;
            font-weight: 600;
            padding: 4px 10px;
            border-radius: 6px;
            background: var(--green-muted);
            border: 1px solid rgba(34,197,94,0.3);
            color: var(--green);
            letter-spacing: 1px;
            font-family: var(--mono);
            margin-top: 8px;
        }
        .header-sub {
            font-size: 13px;
            color: var(--text-muted);
            letter-spacing: 1px;
            margin-top: 4px;
        }
        .live-strip {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            margin-top: 12px;
            font-size: 11px;
            font-family: var(--mono);
            color: var(--text-muted);
            flex-wrap: wrap;
        }
        .live-dot {
            width: 6px; height: 6px;
            border-radius: 50%;
            background: var(--green);
            display: inline-block;
            animation: pulse-dot 2s ease infinite;
        }
        @keyframes pulse-dot {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }
        .live-price { color: var(--text-secondary); }

        /* ═══ COMPANY SELECTOR ═══ */
        .company-selector {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-bottom: 24px;
        }
        .company-btn {
            padding: 10px 20px;
            border-radius: 12px;
            border: 1.5px solid var(--border-subtle);
            background: var(--bg-card);
            cursor: pointer;
            transition: all 0.25s ease;
            text-align: center;
            user-select: none;
            flex: 1;
            max-width: 280px;
        }
        .company-btn:hover {
            border-color: rgba(255,255,255,0.12);
            background: var(--bg-elevated);
            transform: translateY(-2px);
        }
        .company-btn.active {
            border-color: var(--orange-primary);
            background: var(--orange-glow);
            box-shadow: 0 0 20px rgba(249,115,22,0.1);
        }
        .company-btn-flag { font-size: 20px; margin-bottom: 2px; }
        .company-btn-name {
            font-size: 14px;
            font-weight: 700;
            letter-spacing: 0.5px;
        }
        .company-btn-ticker {
            font-size: 10px;
            color: var(--text-muted);
            font-family: var(--mono);
            margin-top: 2px;
        }

        /* ═══ CLAIMS BANNER ═══ */
        .claims-banner {
            background: rgba(249,115,22,0.06);
            border: 1px solid var(--orange-border);
            border-radius: 12px;
            padding: 16px 20px;
            text-align: center;
            margin-bottom: 24px;
        }
        .claims-banner.low-drag {
            background: var(--green-muted);
            border-color: rgba(34,197,94,0.25);
        }
        .claims-banner.high-drag {
            background: var(--red-muted);
            border-color: rgba(239,68,68,0.25);
        }
        .claims-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--orange-primary);
            margin-bottom: 4px;
            font-family: var(--mono);
        }
        .claims-banner.low-drag .claims-title { color: var(--green); }
        .claims-banner.high-drag .claims-title { color: var(--red); }
        .claims-sub {
            font-size: 13px;
            color: var(--text-secondary);
        }
        .claims-formula {
            font-size: 11px;
            color: #71717a;
            font-family: var(--mono);
            margin-top: 6px;
            letter-spacing: 0.3px;
        }
        
        /* ═══ CLAIMS STACK ═══ */
        .claims-stack {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-top: 12px;
        }
        .claim-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            border-radius: 8px;
            background: rgba(255,255,255,0.02);
            border: 1px solid var(--border-subtle);
            font-size: 12px;
        }
        .claim-label { color: var(--text-secondary); font-weight: 500; }
        .claim-value { font-family: var(--mono); font-weight: 600; }
        .claim-badge {
            font-size: 9px;
            font-family: var(--mono);
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 6px;
        }
        .claim-badge.preferred { background: rgba(249,115,22,0.12); color: var(--orange-primary); }
        .claim-badge.debt { background: rgba(239,68,68,0.1); color: var(--red); }
        .claim-badge.cash { background: var(--green-muted); color: var(--green); }
        .claim-total {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            border-radius: 8px;
            background: rgba(249,115,22,0.06);
            border: 1px solid var(--orange-border);
            font-size: 13px;
            font-weight: 700;
        }
        .claim-total-label { color: var(--orange-light); }
        .claim-total-value { font-family: var(--mono); color: var(--orange-primary); }

        /* ═══ SCENARIO CARDS ═══ */
        .scenarios-section { margin-bottom: 24px; }
        .scenarios-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        @media (max-width: 500px) {
            .scenarios-row { grid-template-columns: repeat(2, 1fr); }
        }
        .scenario-card {
            padding: 16px 12px 14px;
            border-radius: 12px;
            border: 1.5px solid var(--border-subtle);
            background: var(--bg-card);
            cursor: pointer;
            transition: all 0.25s ease;
            text-align: center;
            user-select: none;
            position: relative;
        }
        .scenario-card:hover {
            border-color: rgba(255,255,255,0.12);
            background: var(--bg-elevated);
            transform: translateY(-2px);
        }
        .scenario-card.active {
            border-color: var(--orange-primary);
            background: var(--orange-glow);
            box-shadow: 0 0 20px rgba(249,115,22,0.1);
        }
        .scenario-icon { font-size: 22px; margin-bottom: 4px; }
        .scenario-name {
            font-size: 12px;
            font-weight: 600;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        .scenario-price {
            font-size: 15px;
            font-weight: 700;
            font-family: var(--mono);
            color: var(--orange-light);
        }
        .scenario-mnav {
            font-size: 10px;
            color: var(--text-muted);
            font-family: var(--mono);
            margin-top: 4px;
        }

        /* ═══ HERO ═══ */
        .hero {
            text-align: center;
            padding: 28px 20px;
            margin-bottom: 20px;
            background: linear-gradient(180deg, rgba(249,115,22,0.04) 0%, transparent 100%);
            border-radius: 20px;
            border: 1px solid rgba(249,115,22,0.1);
        }
        .hero-label {
            font-size: 10px;
            letter-spacing: 3px;
            color: var(--text-muted);
            margin-bottom: 6px;
            font-weight: 500;
        }
        .hero-price {
            font-size: 64px;
            font-weight: 700;
            font-family: var(--mono);
            line-height: 1;
            margin-bottom: 8px;
            transition: color 0.3s;
        }
        .hero-price.positive { color: var(--green); }
        .hero-price.negative { color: var(--red); }
        .hero-price.neutral { color: var(--text-primary); }
        .hero-usd {
            font-size: 18px;
            font-family: var(--mono);
            color: var(--text-secondary);
            margin-bottom: 6px;
        }
        .hero-change {
            font-size: 16px;
            font-weight: 600;
            font-family: var(--mono);
            margin-bottom: 4px;
        }
        .hero-change.up { color: var(--green); }
        .hero-change.down { color: var(--red); }
        .hero-vs {
            font-size: 11px;
            color: var(--text-muted);
        }
        .hero-implied {
            margin-top: 10px;
            font-size: 12px;
            font-family: var(--mono);
            color: var(--text-secondary);
            padding: 6px 14px;
            border-radius: 20px;
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--border-subtle);
            display: inline-block;
        }
        .hero-implied em {
            font-style: normal;
            color: var(--orange-primary);
            font-weight: 600;
        }

        /* ═══ NARRATIVE PANEL ═══ */
        .narrative {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 14px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .narrative-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .narrative-body {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .narr-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 10px 14px;
            border-radius: 10px;
            font-size: 13px;
            line-height: 1.5;
        }
        .narr-item.green {
            background: var(--green-muted);
            border: 1px solid rgba(34,197,94,0.2);
            color: #86efac;
        }
        .narr-item.red {
            background: var(--red-muted);
            border: 1px solid rgba(239,68,68,0.2);
            color: #fca5a5;
        }
        .narr-item.amber {
            background: var(--yellow-muted);
            border: 1px solid rgba(234,179,8,0.2);
            color: #fde68a;
        }
        .narr-item.info {
            background: rgba(56,189,248,0.08);
            border: 1px solid rgba(56,189,248,0.2);
            color: #7dd3fc;
        }
        .narr-item.neutral {
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--border-subtle);
            color: var(--text-secondary);
        }
        .narr-icon { font-size: 16px; flex-shrink: 0; margin-top: 1px; }
        .narr-text strong { color: var(--text-primary); }

        /* ═══ METRICS ROW ═══ */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 8px;
            margin-bottom: 20px;
        }
        .metric-card {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            padding: 12px 10px;
            text-align: center;
        }
        .metric-label {
            font-size: 8px;
            letter-spacing: 1.5px;
            color: var(--text-muted);
            margin-bottom: 4px;
            font-weight: 600;
        }
        .metric-value {
            font-size: 17px;
            font-weight: 700;
            font-family: var(--mono);
            line-height: 1.2;
        }
        .metric-sub {
            font-size: 9px;
            color: #3f3f46;
            margin-top: 2px;
            font-family: var(--mono);
        }
        .metric-value.good { color: var(--green); }
        .metric-value.warn { color: var(--yellow); }
        .metric-value.danger { color: var(--red); }

        /* ═══ COLLAPSIBLE SECTIONS ═══ */
        .collapse-section { margin-bottom: 12px; }
        .collapse-section summary {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 14px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            letter-spacing: 0.5px;
            transition: all 0.2s;
            list-style: none;
            user-select: none;
        }
        .collapse-section summary::-webkit-details-marker { display: none; }
        .collapse-section summary:hover {
            border-color: rgba(255,255,255,0.12);
            color: var(--text-primary);
        }
        .collapse-section[open] summary {
            border-radius: 12px 12px 0 0;
            border-bottom-color: transparent;
            color: var(--orange-primary);
        }
        .collapse-body {
            padding: 16px;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-top: none;
            border-radius: 0 0 12px 12px;
        }

        /* ═══ CONTROLS ═══ */
        .controls-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }
        @media (max-width: 500px) {
            .controls-grid { grid-template-columns: 1fr; }
        }
        .control-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            padding: 14px;
        }
        .control-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .control-label {
            font-size: 10px;
            letter-spacing: 1.5px;
            color: var(--text-muted);
            font-weight: 600;
        }
        .control-value {
            font-size: 18px;
            font-weight: 700;
            font-family: var(--mono);
            color: var(--orange-light);
        }
        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #333;
            outline: none;
            cursor: pointer;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--orange-primary);
            box-shadow: 0 0 10px rgba(249,115,22,0.4);
            cursor: grab;
        }
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--orange-primary);
            border: none;
            box-shadow: 0 0 10px rgba(249,115,22,0.4);
            cursor: grab;
        }
        .slider-labels {
            display: flex;
            justify-content: space-between;
            font-size: 9px;
            color: #444;
            font-family: var(--mono);
            margin-top: 4px;
        }
        .control-locked { font-size:10px; color:var(--orange-primary); opacity:0.7; margin-top:6px; font-family:var(--mono); letter-spacing:0.5px; }
        .mnav-presets {
            display: flex;
            gap: 4px;
            margin-top: 8px;
        }
        .mnav-btn {
            flex: 1;
            padding: 4px 0;
            border-radius: 6px;
            border: 1px solid var(--border-subtle);
            background: transparent;
            color: var(--text-muted);
            font-size: 10px;
            font-family: var(--mono);
            cursor: pointer;
            transition: all 0.2s;
        }
        .mnav-btn:hover, .mnav-btn.active {
            border-color: var(--orange-primary);
            color: var(--orange-primary);
            background: var(--orange-glow);
        }

        /* ═══ WATERFALL ═══ */
        .waterfall {
            display: flex;
            align-items: center;
            gap: 4px;
            overflow-x: auto;
            padding: 12px;
            scrollbar-width: none;
        }
        .waterfall::-webkit-scrollbar { display: none; }
        .wf-step {
            flex: 0 0 auto;
            text-align: center;
            padding: 8px 14px;
            border-radius: 8px;
            min-width: 90px;
        }
        .wf-step.btc-val { background: rgba(249,115,22,0.08); border: 1px solid rgba(249,115,22,0.2); }
        .wf-step.nav { background: var(--green-muted); border: 1px solid rgba(34,197,94,0.2); }
        .wf-step.shares { background: rgba(255,255,255,0.03); border: 1px solid var(--border-subtle); }
        .wf-step.result { background: rgba(249,115,22,0.12); border: 1px solid var(--orange-border); }
        .wf-label {
            font-size: 8px;
            letter-spacing: 1px;
            color: var(--text-muted);
            margin-bottom: 2px;
        }
        .wf-value {
            font-size: 12px;
            font-weight: 700;
            font-family: var(--mono);
        }
        .wf-arrow {
            flex: 0 0 auto;
            font-size: 14px;
            color: var(--text-muted);
        }

        /* ═══ SENSITIVITY MATRIX ═══ */
        .matrix-table {
            width: 100%;
            border-collapse: collapse;
        }
        .matrix-table th {
            padding: 8px 10px;
            font-size: 9px;
            font-weight: 600;
            letter-spacing: 1px;
            color: var(--text-muted);
            border-bottom: 1px solid var(--border-subtle);
            background: rgba(255,255,255,0.02);
        }
        .matrix-table td {
            padding: 8px 10px;
            text-align: center;
            font-family: var(--mono);
            font-size: 11px;
            font-weight: 600;
            border-bottom: 1px solid rgba(255,255,255,0.03);
            transition: all 0.2s;
        }
        .matrix-table td.row-label {
            text-align: right;
            color: var(--text-secondary);
            font-weight: 600;
            background: rgba(255,255,255,0.02);
        }
        .matrix-table th:first-child { text-align: right; }
        .matrix-cell-green { color: var(--green); background: rgba(34,197,94,0.06); }
        .matrix-cell-lightgreen { color: #86efac; background: rgba(34,197,94,0.03); }
        .matrix-cell-red { color: var(--red); background: rgba(239,68,68,0.06); }
        .matrix-cell-lightred { color: #fca5a5; background: rgba(239,68,68,0.03); }
        .matrix-cell-current { outline: 2px solid var(--orange-primary); outline-offset: -2px; border-radius: 4px; }

        /* ═══ CONTRAST SECTION ═══ */
        .contrast-card {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            padding: 16px;
            margin-top: 12px;
        }
        .contrast-title {
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 1px;
            color: var(--text-muted);
            margin-bottom: 12px;
        }
        .contrast-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
        }
        .contrast-item {
            text-align: center;
            padding: 10px 8px;
            border-radius: 8px;
            background: rgba(255,255,255,0.02);
            border: 1px solid var(--border-subtle);
        }
        .contrast-company {
            font-size: 9px;
            font-weight: 600;
            letter-spacing: 1px;
            color: var(--text-muted);
            margin-bottom: 4px;
        }
        .contrast-value {
            font-size: 18px;
            font-weight: 700;
            font-family: var(--mono);
        }
        .contrast-label {
            font-size: 9px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        /* ═══ FOOTER ═══ */
        .footer {
            text-align: center;
            padding-top: 24px;
            border-top: 1px solid var(--border-subtle);
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 24px;
        }
        .footer a { color: var(--orange-primary); text-decoration: none; }
        .footer a:hover { text-decoration: underline; }
        .footer-formula {
            font-family: var(--mono);
            font-size: 10px;
            color: #333;
            margin-top: 8px;
        }

        /* ═══ LOADING ═══ */
        .loading-screen {
            position: fixed;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: var(--bg-primary);
            z-index: 999;
        }
        .loading-spinner {
            width: 32px; height: 32px;
            border: 3px solid #222;
            border-top-color: var(--green);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 12px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { font-size: 12px; color: var(--text-muted); letter-spacing: 2px; }

        /* ═══ RESPONSIVE ═══ */
        /* Horizon toggle */
        .toggle-row { display:flex; gap:4px; margin-top:8px; }
        .toggle-btn { flex:1; padding:5px 0; border-radius:6px; border:1px solid var(--border-subtle); background:transparent; color:var(--text-muted); font-size:10px; font-family:var(--mono); cursor:pointer; transition:all 0.2s; }
        .toggle-btn:hover, .toggle-btn.active { border-color:var(--orange-primary); color:var(--orange-primary); background:rgba(249,115,22,0.08); }
        .horizon-badge { position:absolute; top:8px; right:8px; font-size:9px; font-weight:700; font-family:var(--mono); padding:2px 6px; border-radius:4px; letter-spacing:.5px; }
        .horizon-badge.now-badge { background:rgba(255,255,255,0.04); color:#52525b; border:1px solid rgba(255,255,255,0.06); }
        .horizon-badge.future-badge { background:rgba(249,115,22,0.1); color:var(--orange-primary); border:1px solid var(--orange-border); }
        .scenario-group-label { font-size:9px; letter-spacing:1.5px; color:var(--text-muted); text-transform:uppercase; margin:12px 0 6px; font-weight:600; }
        .group-label { display:flex; align-items:center; gap:10px; margin-bottom:8px; padding-left:4px; }
        .group-label-badge { font-size:9px; font-family:var(--mono); font-weight:700; letter-spacing:1.5px; padding:3px 8px; border-radius:4px; white-space:nowrap; }
        .group-label-badge.now { background:rgba(255,255,255,0.04); color:var(--text-muted); border:1px solid rgba(255,255,255,0.06); }
        .group-label-badge.future { background:rgba(249,115,22,0.08); color:var(--orange-primary); border:1px solid var(--orange-border); }
        .group-label-text { font-size:9px; letter-spacing:2px; font-weight:600; color:var(--text-muted); }
        .group-label-line { flex:1; height:1px; background:var(--border-subtle); }
        .scenario-group { margin-bottom:16px; }
        /* Status colors in projection */
        .status-green { color: var(--green); }
        .status-amber { color: #f59e0b; }
        .status-red { color: var(--red); }
        @media (max-width: 768px) {
            .hero-price { font-size: 48px; }
        }
        @media (max-width: 480px) {
            .hero-price { font-size: 36px; }
            .control-value { font-size: 16px; }
            .logo { font-size: 24px; letter-spacing: 10px; padding-left: 10px; }
            .contrast-row { grid-template-columns: 1fr; }
        }
    </style>
    <script defer src="/_vercel/insights/script.js"></script>
    <script defer src="/_vercel/speed-insights/script.js"></script>
</head>
<body>

<div class="loading-screen" id="loadingScreen">
    <div class="loading-spinner"></div>
    <div class="loading-text">LOADING LIVE DATA</div>
</div>

<div class="container" id="app" style="display:none">

    <!-- Header -->
    <div class="header">
        <a href="/modeler" class="nav-back">&larr; modelers</a>
        <div class="logo-container">
            <div class="logo-glow"></div>
            <div class="logo"><span>CEBE</span></div>
            <p class="logo-whisper">tracker</p>
        </div>
        <div class="logo-badge">&#127482;&#127480; STRIVE MODELER</div>
        <div class="header-sub" id="headerSub">Bitcoin-First Asset Manager &middot; Nasdaq: ASST</div>
        <div class="live-strip" id="liveStrip">
            <span><span class="live-dot"></span> Live Data</span>
            <span class="live-price" id="liveBtcDisplay">BTC $&mdash;</span>
            <span class="live-price" id="liveDataDate">&mdash;</span>
        </div>
    </div>

    <!-- Claims Banner -->
    <div class="claims-banner" id="claimsBanner">
        <div class="claims-title" id="claimsDragDisplay">DRAG: —%</div>
        <div class="claims-sub" id="claimsSub">SATA preferred + residual debt − cash offsets</div>
        <div class="claims-formula" id="claimsFormula"></div>
    </div>

    <!-- Scenario Cards -->
    <div class="scenarios-section">
        <div class="scenario-group">
            <div class="group-label"><span class="group-label-badge now">&#9889; NOW</span><span class="group-label-text">WHAT IF BTC WERE AT THIS PRICE TODAY</span><div class="group-label-line"></div></div>
            <div class="scenarios-row" id="snapshotBar"></div>
        </div>
        <div class="scenario-group">
            <div class="group-label"><span class="group-label-badge future">&rarr; FORWARD</span><span class="group-label-text">10-YEAR PROJECTIONS &middot; SATA ENGINE &middot; WRAPPER COSTS</span><div class="group-label-line"></div></div>
            <div class="scenarios-row" id="projectionBar"></div>
        </div>
    </div>

    <!-- Hero -->
    <div class="hero">
        <div class="hero-label" id="heroLabel">MODELED SHARE PRICE</div>
        <div class="hero-price neutral" id="heroPrice">&mdash;</div>
        <div class="hero-usd" id="heroUsd"></div>
        <div class="hero-change" id="heroChange">&mdash;</div>
        <div class="hero-vs" id="heroVs">vs current market price</div>
        <div class="hero-implied" id="heroImplied" style="display:none">
            Market implies <em id="impliedMnavVal">&mdash;</em> mNAV
        </div>
    </div>

    <!-- Narrative Panel -->
    <div class="narrative" id="narrativePanel">
        <div class="narrative-title">&#128269; What happens here</div>
        <div class="narrative-body" id="narrativeBody"></div>
    </div>

    <!-- Key Metrics -->
    <div class="metrics-grid" id="metricsGrid"></div>

    <!-- Advanced Controls (collapsed) -->
    <details class="collapse-section">
        <summary>&#9881; Adjust Inputs</summary>
        <div class="collapse-body">
            <div class="controls-grid">
                <div class="control-card">
                    <div class="control-header">
                        <span class="control-label">BTC PRICE</span>
                        <span class="control-value" id="btcPriceDisplay">$&mdash;</span>
                    </div>
                    <input type="range" id="btcSlider" min="0" max="1000" value="500">
                    <div class="slider-labels"><span>$10K</span><span>$1M</span></div>
                    <div class="control-locked" id="btcLockedMsg" style="display:none">&#128274; Controlled by scenario CAGR curve</div>
                </div>
                <div class="control-card">
                    <div class="control-header">
                        <span class="control-label">mNAV MULTIPLE</span>
                        <span class="control-value" id="mnavDisplay">1.00&times;</span>
                    </div>
                    <input type="range" id="mnavSlider" min="30" max="400" value="100">
                    <div class="mnav-presets" id="mnavPresets"></div>
                    <div class="control-locked" id="mnavLockedMsg" style="display:none">&#128274; Controlled by scenario mNAV curve</div>
                </div>
                <div class="control-card">
                    <div class="control-header"><span class="control-label">TIME HORIZON</span><span class="control-value" id="horizonDisplay">Now</span></div>
                    <div class="toggle-row" id="horizonBar"></div>
                </div>
            </div>
        </div>
    </details>

    <!-- Claims Stack (collapsed) -->
    <details class="collapse-section">
        <summary>&#9878; Senior Claims Stack</summary>
        <div class="collapse-body" id="claimsBody"></div>
    </details>

    <!-- Value Waterfall (collapsed) -->
    <details class="collapse-section">
        <summary>&#128256; Value Waterfall</summary>
        <div class="collapse-body" style="padding:0;">
            <div class="waterfall" id="waterfall"></div>
        </div>
    </details>

    <!-- Year-by-Year Projection (hidden when horizon=0) -->
    <div id="projectionSection" style="display:none;">
        <details class="collapse-section" open>
            <summary>&#128200; Year-by-Year Projection</summary>
            <div class="collapse-body" style="padding:0;">
                <div style="overflow-x:auto;">
                    <table class="matrix-table" id="projTable"></table>
                </div>
                <div id="projEvents" style="padding:12px 16px;font-size:12px;color:#a1a1aa;line-height:1.7;"></div>
            </div>
        </details>
    </div>

    <!-- Assumptions (visible for projections) -->
    <div id="assumptionsSection" style="display:none;">
        <details class="collapse-section">
            <summary>&#128196; Assumptions &amp; Sources</summary>
            <div class="collapse-body" id="assumptions" style="font-size:12px;color:#a1a1aa;line-height:1.7;"></div>
        </details>
    </div>

    <!-- Sensitivity Matrix (collapsed) -->
    <details class="collapse-section">
        <summary>&#127919; Price Sensitivity Matrix</summary>
        <div class="collapse-body" style="padding:0;">
            <div style="overflow-x:auto;">
                <table class="matrix-table" id="matrixTable"></table>
            </div>
        </div>
    </details>

    <!-- Drag Contrast (collapsed) -->
    <details class="collapse-section">
        <summary>&#9878; How Strive Drag Compares</summary>
        <div class="collapse-body" id="contrastBody"></div>
    </details>

    <!-- Footer -->
    <div class="footer">
        <p>CEBE Framework by <a href="https://x.com/chcbearsfan" target="_blank">&#64;chcbearsfan</a> &middot; <a href="/">cebetracker.io</a> &middot; <a href="https://x.com/chcbearsfan/status/2014767364819063207" target="_blank">Read the Framework</a></p>
        <p style="margin-top:4px">Not financial advice &middot; Data updates after each filing</p>
        <p class="footer-formula">CEBE = (Total BTC &minus; Senior Claims in BTC) &divide; Shares Outstanding</p>
    </div>

</div>

<script>
// ═══════════════════════════════════════════════
// CEBE STRIVE MODELER
// cebetracker.io — Strive
// SATA preferred + residual debt
// ═══════════════════════════════════════════════

// ─── COMPANY DATA ───
const COMPANY = {
    name: 'Strive',
    flag: '&#127482;&#127480;',
    tickers: 'Nasdaq: ASST',
    tagline: "Bitcoin-First Asset Manager",
    currency: 'USD',
    currencySymbol: '$',
    sheetTicker: 'ASST',
    defaults: {
        btc_holdings: 13132,
        shares: 63048519,          // Feb 11 8-K: 53,168,237 Class A + 9,880,282 Class B
        stock_price_local: 8.31,   // Feb 13 close
        fx_rate: 1.0,
        debt_usd: 10000000,        // $10M Semler converts remaining (retire by Apr 2026)
        preferred_usd: 426551800,  // 4,265,518 SATA × $100 stated
        cash_usd: 127200000,       // Feb 11 8-K
        // Granular columns (preferred when available from sheet)
        sata_face_usd: 426551800,  // 4,265,518 shares × $100
        semler_convert_usd: 10000000, // $10M remaining of $100M (retire by Apr 2026)
        coinbase_debt_usd: 0,      // Fully retired Jan 28, 2026
    },
    // Wrapper fee components (verified from Costs tab)
    sata_div_rate: 0.125,       // 12.50% — variable rate, effective Feb 16 2026
    sbc_annual_usd: 8e6,        // $8M/yr — S-4 employment agreements, annualized
    cash_comp_annual_usd: 5.2e6,// $5.2M/yr — Cole+Pham+Beirne+Sarkhani base+bonus
    aum_fee_income: 12e6,       // $12M/yr — Strive ETF management fee revenue offset
    legacy_debt_usd: 10e6,      // Retiring Apr 2026
    debt_retire_year: 2026,
};

const SHEET_ID = '1BNsCWGVU08PDinDcfzJccqcuj9_KrK1VZGETErzBZvg';
const SNAPSHOTS_GID = '771405586';

const SCENARIOS = [
    { id: 'wipeout', icon: '&#128128;', name: 'Wipeout',      btc: 25000,   mnav: 0.5, horizon: 0, group: 'snapshot', type: 'static' },
    { id: 'current', icon: '&#128205;', name: 'Current',      btc: null,    mnav: 1.0, horizon: 0, group: 'snapshot', type: 'static' },
    { id: 'bull',    icon: '&#9728;',   name: 'Bull',         btc: 150000,  mnav: 1.5, horizon: 0, group: 'snapshot', type: 'static' },
    { id: 'siege',    icon: '&#127984;', name: 'Siege',        btc: 50000,   mnav: 0.7, horizon: 10, group: 'projection', type: 'siege' },
    { id: 'powerlaw', icon: '&#128200;', name: 'Power Law Support', btc: null, mnav: null, horizon: 10, group: 'projection', type: 'powerlaw' },
    { id: 'cole10',  icon: '&#128640;', name: 'Cole 10-Year', btc: null,    mnav: null, horizon: 10, group: 'projection', type: 'cole10' },
];

// Power Law Support Line: ~23% avg CAGR → ~$770K by 2036 (Santostasi/Burger model, floor)
// Decelerating curve matching power law's flattening slope
const POWERLAW_CAGR = [
    {year:1,cagr:.30},{year:2,cagr:.27},{year:3,cagr:.25},{year:4,cagr:.24},{year:5,cagr:.23},
    {year:6,cagr:.22},{year:7,cagr:.21},{year:8,cagr:.20},{year:9,cagr:.19},{year:10,cagr:.18},
];
// Conservative mNAV — modest premium, no hype cycle
const POWERLAW_MNAV = [
    {year:0,mnav:1.0},{year:1,mnav:1.0},{year:2,mnav:1.1},{year:3,mnav:1.1},{year:4,mnav:1.2},
    {year:5,mnav:1.2},{year:6,mnav:1.2},{year:7,mnav:1.2},{year:8,mnav:1.2},{year:9,mnav:1.2},{year:10,mnav:1.2},
];

// Cole 10-Year BTC price path: ~26% avg CAGR → ~$1M from ~$97K start
// Decelerating curve — calibrated so Y10 ≈ $1M at current live BTC
const COLE_CAGR = [
    {year:1,cagr:.35},{year:2,cagr:.32},{year:3,cagr:.29},{year:4,cagr:.27},{year:5,cagr:.26},
    {year:6,cagr:.25},{year:7,cagr:.24},{year:8,cagr:.23},{year:9,cagr:.22},{year:10,cagr:.21},
];
// Strive mNAV curve — more conservative than MSTR (smaller company, less institutional premium)
const COLE_MNAV = [
    {year:0,mnav:1.0},{year:1,mnav:1.2},{year:2,mnav:1.3},{year:3,mnav:1.5},{year:4,mnav:1.5},
    {year:5,mnav:1.5},{year:6,mnav:1.5},{year:7,mnav:1.5},{year:8,mnav:1.5},{year:9,mnav:1.5},{year:10,mnav:1.5},
];
// Cole's stated target: "25% plus amplification" maintained via SATA (Stephan Livera SLP710, Jan 2026)
// Gross amplification = (Debt + Preferred) / BTC NAV
const COLE_TARGET_AMP = 0.25;
const COLE_MAX_SATA_YEAR = 2e9; // Cap: $2B new SATA per year (market capacity limit)
const POWERLAW_TARGET_AMP = 0.15; // Maintenance: 15% gross amp (vs 25% Cole)
const POWERLAW_MAX_SATA_YEAR = 500e6; // Cap: $500M new SATA per year

const MNAV_PRESETS = [0.5, 0.75, 1.0, 1.5, 2.0, 3.0];
const MATRIX_BTC = [25000, 50000, 75000, 100000, 150000, 200000, 300000, 500000, 1000000];
const MATRIX_MNAVS = [0.5, 0.75, 1.0, 1.5, 2.0, 3.0];

const HORIZON_OPTIONS = [{label:'Now',years:0},{label:'1Y',years:1},{label:'3Y',years:3},{label:'5Y',years:5},{label:'10Y',years:10}];
const START_YEAR = 2026;

// ─── STATE ───
let btcPrice = 97000;
let mnavMultiple = 1.0;
let horizonYears = 0;
let activeScenario = 'current';
let liveBtcPrice = null;
let liveFxRate = COMPANY.defaults.fx_rate;
let loadedData = {};

// ─── HELPERS ───
const $ = id => document.getElementById(id);
const fmt = n => Math.round(n).toLocaleString('en-US');
const fmtB = n => n >= 1e9 ? '$' + (n/1e9).toFixed(1) + 'B' : n >= 1e6 ? '$' + (n/1e6).toFixed(0) + 'M' : '$' + fmt(n);
const fmtPrice = p => {
    if (p >= 1e6) return '$' + (p/1e6).toFixed(1) + 'M';
    if (p >= 1000) return '$' + fmt(p);
    if (p >= 0.01) return '$' + p.toFixed(2);
    return '$0.00';
};
const fmtPct = (p, dec=1) => (p * 100).toFixed(dec) + '%';
const fmtSats = s => fmt(Math.round(s));

// Logarithmic BTC slider (matches MSTR modeler)
function sliderToBtc(val) {
    const minLog = Math.log10(10000);
    const maxLog = Math.log10(1000000);
    return Math.round(Math.pow(10, minLog + (val / 1000) * (maxLog - minLog)));
}
function btcToSlider(btc) {
    const minLog = Math.log10(10000);
    const maxLog = Math.log10(1000000);
    return Math.round(((Math.log10(Math.max(10000, btc)) - minLog) / (maxLog - minLog)) * 1000);
}

function getData() {
    return {
        btcHoldings: loadedData.btc_holdings || COMPANY.defaults.btc_holdings,
        shares: loadedData.shares || COMPANY.defaults.shares,
        stockLocal: loadedData.stock_price_local || COMPANY.defaults.stock_price_local,
        fxRate: 1.0,
        debtUsd: loadedData.debt_usd || COMPANY.defaults.debt_usd,
        preferredUsd: loadedData.preferred_usd || COMPANY.defaults.preferred_usd,
        cashUsd: loadedData.cash_usd || COMPANY.defaults.cash_usd,
        snapshotDate: loadedData.snapshot_date || null,
    };
}

// ─── CSV PARSER ───
function parseCSVLine(line) {
    const r = []; let c = '', q = false;
    for (const ch of line) { if (ch === '"') q = !q; else if (ch === ',' && !q) { r.push(c); c = ''; } else c += ch; }
    r.push(c); return r;
}
function parseCSV(text) {
    const lines = text.split('\n');
    const headers = parseCSVLine(lines[0]);
    return lines.slice(1).filter(l => l.trim()).map(l => {
        const vals = parseCSVLine(l);
        const row = {};
        headers.forEach((h, i) => { row[h.replace(/"/g,'').trim()] = vals[i]?.replace(/"/g,'').trim() || ''; });
        return row;
    });
}

// ─── CORE MATH ───
// Strive: SATA preferred + residual debt - cash
function compute(btcH, shares, btcP, mnav, debtUsd, prefUsd, cashUsd) {
    var netClaims = Math.max(0, (debtUsd || 0) + (prefUsd || 0) - (cashUsd || 0));
    var claimsBtc = btcP > 0 ? netClaims / btcP : 0;
    var drag = btcH > 0 ? claimsBtc / btcH : 0;
    var bpsBtc = shares > 0 ? btcH / shares : 0;
    var bpsSats = Math.round(bpsBtc * 1e8);
    var cebeBtc = shares > 0 ? (btcH - claimsBtc) / shares : 0;
    var cebeSats = Math.max(0, Math.round(cebeBtc * 1e8));
    var navUsd = (btcH * btcP) - netClaims;
    var navPerShare = shares > 0 ? navUsd / shares : 0;
    var modeledUsd = navPerShare * mnav;
    var breakEven = btcH > 0 ? netClaims / btcH : 0;
    var amplification = drag < 1 ? 1 / (1 - drag) : Infinity;
    return { bpsBtc, bpsSats, cebeBtc, cebeSats, navUsd, navPerShare, modeledUsd, drag, netClaims, claimsBtc, breakEven, amplification, debtUsd: debtUsd || 0, prefUsd: prefUsd || 0, cashUsd: cashUsd || 0 };
}

// ─── HELPER: get active scenario type ───
function getActiveType() {
    var s = SCENARIOS.find(function(x){return x.id===activeScenario});
    return s ? s.type : 'static';
}
function isSlidersLocked() { var t = getActiveType(); return t === 'cole10' || t === 'powerlaw'; }

// ─── PROJECTION ENGINE ───
function projectYears(years) {
    var d = getData(), co = COMPANY;
    var btcH = d.btcHoldings, shares = d.shares, cash = d.cashUsd;
    var prefUsd = d.preferredUsd, debtUsd = d.debtUsd;
    var sataDivRate = co.sata_div_rate;
    var sbcAnnual = co.sbc_annual_usd;
    var cashComp = co.cash_comp_annual_usd;
    var aumFee = co.aum_fee_income;
    var debtRetireYear = co.debt_retire_year;
    var results = [], allEvents = [];
    var startBtc = liveBtcPrice || btcPrice;

    for (var y = 0; y <= years; y++) {
        var calYear = START_YEAR + y, yearEvents = [];

        // 1. BTC PRICE + mNAV for this year
        var yearBtcPrice, yearMnav;
        var sType = getActiveType();
        if (sType === 'siege') { yearBtcPrice = 50000; yearMnav = 0.7; }
        else if (sType === 'powerlaw') {
            if (y === 0) { yearBtcPrice = startBtc; yearMnav = POWERLAW_MNAV[0].mnav; }
            else {
                var ce = POWERLAW_CAGR[Math.min(y - 1, POWERLAW_CAGR.length - 1)];
                var prevB = y === 1 ? startBtc : results[y - 1].yearBtcPrice;
                yearBtcPrice = prevB * (1 + ce.cagr);
                yearMnav = POWERLAW_MNAV[Math.min(y, POWERLAW_MNAV.length - 1)].mnav;
            }
        }
        else if (sType === 'cole10') {
            if (y === 0) { yearBtcPrice = startBtc; yearMnav = COLE_MNAV[0].mnav; }
            else {
                var ce = COLE_CAGR[Math.min(y - 1, COLE_CAGR.length - 1)];
                var prevB = y === 1 ? startBtc : results[y - 1].yearBtcPrice;
                yearBtcPrice = prevB * (1 + ce.cagr);
                yearMnav = COLE_MNAV[Math.min(y, COLE_MNAV.length - 1)].mnav;
            }
        }
        else { yearBtcPrice = btcPrice; yearMnav = mnavMultiple; }

        // 2. DEBT RETIREMENT (one-time)
        if (y > 0 && debtUsd > 0 && calYear >= debtRetireYear) {
            cash -= debtUsd;
            yearEvents.push({type:'debt',cls:'green',icon:'\u2705',text:'<strong>Legacy debt retired.</strong> $' + (debtUsd/1e6).toFixed(0) + 'M paid from cash reserves.'});
            debtUsd = 0;
        }

        // 3. PAY DIVIDENDS + OPERATING COSTS (just subtract from cash)
        var status = 'green', btcSold = 0, yearSbcShares = 0, atmSharesForCash = 0;
        var TARGET_RUNWAY_YEARS = 2;
        if (y > 0) {
            var sataDivAnnual = prefUsd * sataDivRate;
            var netDrain = sataDivAnnual + cashComp - aumFee;
            cash -= netDrain;

            // Siege: capital markets closed — sell BTC immediately if cash negative
            if (sType === 'siege' && cash < 0) {
                var deficit = Math.abs(cash);
                btcSold = yearBtcPrice > 0 ? deficit / yearBtcPrice : 0;
                btcH = Math.max(0, btcH - btcSold);
                cash = 0;
                status = 'red';
                yearEvents.push({type:'btcsale',cls:'red',icon:'\u26A0\uFE0F',text:'<strong>BTC liquidated.</strong> Sold ' + fmt(Math.round(btcSold)) + ' BTC (' + fmtB(deficit) + ') to cover obligations. Capital markets assumed closed.'});
            }
        }

        // 4. COLE 10-YEAR CAPITAL ENGINE — maintain 25% gross amplification via SATA
        var newSataIssued = 0, newBtcAcq = 0;
        if (y > 0 && sType === 'cole10') {
            var btcNAV = btcH * yearBtcPrice;
            var grossAmp = btcNAV > 0 ? (debtUsd + prefUsd) / btcNAV : 0;
            if (grossAmp < COLE_TARGET_AMP && btcNAV > 0) {
                var currentClaims = debtUsd + prefUsd;
                newSataIssued = (COLE_TARGET_AMP * btcNAV - currentClaims) / (1 - COLE_TARGET_AMP);
                newSataIssued = Math.max(0, Math.min(newSataIssued, COLE_MAX_SATA_YEAR));
                if (newSataIssued > 0) {
                    newBtcAcq = yearBtcPrice > 0 ? newSataIssued / yearBtcPrice : 0;
                    btcH += newBtcAcq;
                    prefUsd += newSataIssued;
                    yearEvents.push({type:'sata',cls:'info',icon:'\u{1F4E6}',text:'<strong>SATA re-leverage.</strong> Issued ' + fmtB(newSataIssued) + ' new SATA to maintain 25% amplification. Acquired ' + fmt(Math.round(newBtcAcq)) + ' BTC.'});
                }
            }
        }

        // 4b. POWER LAW MAINTENANCE SATA — 15% target, $500M/yr cap
        if (y > 0 && sType === 'powerlaw') {
            var btcNAV = btcH * yearBtcPrice;
            var grossAmp = btcNAV > 0 ? (debtUsd + prefUsd) / btcNAV : 0;
            if (grossAmp < POWERLAW_TARGET_AMP && btcNAV > 0) {
                var currentClaims = debtUsd + prefUsd;
                newSataIssued = (POWERLAW_TARGET_AMP * btcNAV - currentClaims) / (1 - POWERLAW_TARGET_AMP);
                newSataIssued = Math.max(0, Math.min(newSataIssued, POWERLAW_MAX_SATA_YEAR));
                if (newSataIssued > 0) {
                    newBtcAcq = yearBtcPrice > 0 ? newSataIssued / yearBtcPrice : 0;
                    btcH += newBtcAcq;
                    prefUsd += newSataIssued;
                    yearEvents.push({type:'sata',cls:'info',icon:'\u{1F4E6}',text:'<strong>Maintenance SATA.</strong> Issued ' + fmtB(newSataIssued) + ' new SATA to maintain 15% amplification. Acquired ' + fmt(Math.round(newBtcAcq)) + ' BTC.'});
                }
            }
        }

        // 5. CASH RESERVE MAINTENANCE (non-siege only, AFTER SATA so target reflects new obligations)
        if (y > 0 && sType !== 'siege') {
            var currentAnnDrain = (prefUsd * sataDivRate) + cashComp - aumFee;
            var targetCash = Math.max(0, currentAnnDrain * TARGET_RUNWAY_YEARS);

            if (cash < 0) {
                // Cash negative — ATM to cover deficit + rebuild to target
                var atmNeeded = Math.abs(cash) + targetCash;
                var netCl = Math.max(0, debtUsd + prefUsd);
                var navNow = Math.max(0, (btcH * yearBtcPrice) - netCl);
                var navPS = shares > 0 ? navNow / shares : 0;
                var atmPrice = navPS * yearMnav;
                if (atmPrice > 0) {
                    atmSharesForCash = atmNeeded / atmPrice;
                    shares += atmSharesForCash;
                    cash = targetCash;
                    status = 'amber';
                    yearEvents.push({type:'atm',cls:'amber',icon:'\u{1F4B3}',text:'<strong>ATM to maintain reserves.</strong> Issued ' + fmt(Math.round(atmSharesForCash)) + ' shares (' + fmtB(atmNeeded) + ') to cover obligations and maintain ' + TARGET_RUNWAY_YEARS + '-year cash reserve.'});
                } else {
                    btcSold = yearBtcPrice > 0 ? Math.abs(cash) / yearBtcPrice : 0;
                    btcH = Math.max(0, btcH - btcSold);
                    cash = 0;
                    status = 'red';
                    yearEvents.push({type:'btcsale',cls:'red',icon:'\u26A0\uFE0F',text:'<strong>NAV too low for ATM.</strong> Sold ' + fmt(Math.round(btcSold)) + ' BTC to cover obligations.'});
                }
            } else if (cash < targetCash) {
                // Cash positive but below target — top up
                var topUp = targetCash - cash;
                var netCl = Math.max(0, debtUsd + prefUsd - cash);
                var navNow = Math.max(0, (btcH * yearBtcPrice) - netCl);
                var navPS = shares > 0 ? navNow / shares : 0;
                var atmPrice = navPS * yearMnav;
                if (atmPrice > 0 && topUp > 1e6) {
                    atmSharesForCash = topUp / atmPrice;
                    shares += atmSharesForCash;
                    cash += topUp;
                    yearEvents.push({type:'atm',cls:'info',icon:'\u{1F4B3}',text:'<strong>ATM reserve top-up.</strong> Issued ' + fmt(Math.round(atmSharesForCash)) + ' shares (' + fmtB(topUp) + ') to maintain ' + TARGET_RUNWAY_YEARS + '-year cash reserve (' + fmtB(targetCash) + ' target).'});
                }
            }
        }

        // 6. SBC DILUTION — shares issued, no BTC acquired
        if (y > 0 && sbcAnnual > 0) {
            var netCl = Math.max(0, debtUsd + prefUsd - cash);
            var navNow = Math.max(0, (btcH * yearBtcPrice) - netCl);
            var navPS = shares > 0 ? navNow / shares : 0;
            var tmpPrice = navPS * yearMnav;
            if (tmpPrice > 0) { yearSbcShares = sbcAnnual / tmpPrice; shares += yearSbcShares; }
        }

        // 7. YEAR-END STATE
        var netClaims = Math.max(0, debtUsd + prefUsd - cash);
        var m = compute(btcH, shares, yearBtcPrice, yearMnav, debtUsd, prefUsd, cash);
        var sataDivAnnualEnd = prefUsd * sataDivRate;
        var netDrainEnd = sataDivAnnualEnd + cashComp - aumFee;
        var runway = netDrainEnd > 0 ? (cash > 0 ? cash / netDrainEnd : 0) : Infinity;

        // Wrapper fee
        var totalAnnualCost = sataDivAnnualEnd + sbcAnnual + cashComp;
        var netAnnualCost = totalAnnualCost - aumFee;
        var btcReserveVal = btcH * yearBtcPrice;
        var wrapperFee = btcReserveVal > 0 ? netAnnualCost / btcReserveVal : 0;

        // Gross amplification for display
        var grossAmpEnd = btcReserveVal > 0 ? (debtUsd + prefUsd) / btcReserveVal : 0;

        results.push({
            year: y, calYear: calYear, btcH: btcH, shares: shares, cebeSats: m.cebeSats, drag: m.drag,
            navPerShare: m.navPerShare, modeledPrice: m.modeledUsd, cash: cash, btcSold: btcSold, status: status,
            amp: m.amplification, breakEven: m.breakEven, cashRunway: runway,
            yearBtcPrice: yearBtcPrice, yearMnav: yearMnav,
            sbcSharesAdded: yearSbcShares, events: yearEvents, netClaimsUsd: netClaims,
            remainingDebt: debtUsd, totalPrefFace: prefUsd,
            totalDivObligation: sataDivAnnualEnd, wrapperFee: wrapperFee, netAnnualCost: netAnnualCost,
            newSataIssued: newSataIssued, newBtcAcq: newBtcAcq, grossAmp: grossAmpEnd,
            atmSharesForDiv: atmSharesForCash
        });
        yearEvents.forEach(function(e){ allEvents.push({year:y, type:e.type, cls:e.cls, icon:e.icon, text:e.text}); });
    }
    results._events = allEvents;
    return results;
}

// ─── DATA LOADING ───
async function loadData() {
    try {
        // BTC price + FX rates from CoinGecko
        const btcRes = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd')
            .then(r => r.json()).catch(() => null);

        if (btcRes && btcRes.bitcoin) {
            liveBtcPrice = btcRes.bitcoin.usd;
            liveFxRate = 1.0;  // USD-denominated, no FX
        }

        // Google Sheet data
        const sheetText = await fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&gid=${SNAPSHOTS_GID}`)
            .then(r => r.text()).catch(() => null);

        if (sheetText) {
            const rows = parseCSV(sheetText);
            let best = null;
            rows.forEach(r => {
                if (r.ticker === COMPANY.sheetTicker && (!r.status || r.status.toLowerCase() === 'live')) {
                    if (!best || r.snapshot_date > best.snapshot_date) best = r;
                }
            });
            if (best) {
                loadedData = {
                    btc_holdings: parseFloat(best.btc_holdings) || COMPANY.defaults.btc_holdings,
                    shares: parseFloat(best.shares_outstanding) || COMPANY.defaults.shares,
                    debt_usd: parseFloat(best.debt_usd) || COMPANY.defaults.debt_usd,
                    preferred_usd: parseFloat(best.preferred_usd) || COMPANY.defaults.preferred_usd,
                    cash_usd: parseFloat(best.cash_usd) || COMPANY.defaults.cash_usd,
                    snapshot_date: best.snapshot_date || null,
                    stock_price_local: parseFloat(best.btc_price) ? undefined : undefined, // use live
                    // Granular columns — override lump sums when present
                    sata_face_usd: parseFloat(best.sata_face_usd) || null,
                    sata_div_rate: parseFloat(best.sata_div_rate) || null,
                    semler_convert_usd: parseFloat(best.semler_convert_usd),
                    coinbase_debt_usd: parseFloat(best.coinbase_debt_usd),
                };
                // If granular preferred column exists, prefer it over lump preferred_usd
                if (loadedData.sata_face_usd) {
                    loadedData.preferred_usd = loadedData.sata_face_usd;
                }
                // If granular debt columns exist, compute total debt from them
                if (!isNaN(loadedData.semler_convert_usd) && !isNaN(loadedData.coinbase_debt_usd)) {
                    loadedData.debt_usd = loadedData.semler_convert_usd + loadedData.coinbase_debt_usd;
                }
                // Override variable div rate from sheet if present
                if (loadedData.sata_div_rate) {
                    COMPANY.sata_div_rate = loadedData.sata_div_rate;
                }
            }
        }

        btcPrice = liveBtcPrice || 70000;
        SCENARIOS.find(s => s.id === 'current').btc = btcPrice;

        $('loadingScreen').style.display = 'none';
        $('app').style.display = 'block';

        $('headerSub').innerHTML = COMPANY.tagline + ' &middot; ' + COMPANY.tickers;
        buildScenarioBar();
        buildMnavPresets();
        buildHorizonBar();
        syncSliders();
        render();
    } catch (err) {
        console.error('Load failed:', err);
        $('loadingScreen').innerHTML = '<div style="text-align:center;color:#a1a1aa;font-size:13px"><p style="margin-bottom:12px">Failed to load data</p><p style="font-size:11px;color:#52525b">' + err.message + '</p><p style="margin-top:12px"><a href="/modeler" style="color:#f97316">&larr; Back to modelers</a></p></div>';
    }
}

// ═══════════════════════════════════════════════
// RENDERING
// ═══════════════════════════════════════════════

function render() {
    const co = COMPANY;
    const d = getData();
    var projResults = null, endR = null;

    if (horizonYears > 0) {
        projResults = projectYears(horizonYears);
        var endState = projResults[projResults.length - 1];
        // Use projected end-state for hero/metrics
        endR = compute(endState.btcH, endState.shares, endState.yearBtcPrice, endState.yearMnav, endState.remainingDebt, endState.totalPrefFace, endState.cash);
        endR._proj = endState; // attach projection data
    }

    const r = endR || compute(d.btcHoldings, d.shares, btcPrice, mnavMultiple, d.debtUsd, d.preferredUsd, d.cashUsd);

    renderHero(r, co, d);
    renderClaimsBanner(r);
    renderNarrative(r, co, d, projResults);
    renderMetrics(r, co, d, projResults);
    renderClaims(r);
    renderWaterfall(r, co, d);
    renderMatrix(co, d);
    renderContrast(r);

    // Projection table
    if (projResults && horizonYears > 0) {
        $('projectionSection').style.display = 'block';
        $('assumptionsSection').style.display = 'block';
        renderProjectionTable(projResults);
        renderAssumptions();
    } else {
        $('projectionSection').style.display = 'none';
        $('assumptionsSection').style.display = 'none';
    }

    // Horizon badge on hero
    var heroLabel = $('heroLabel');
    if (horizonYears > 0) {
        heroLabel.innerHTML = 'MODELED ' + co.name.toUpperCase() + ' SHARE PRICE <span class="horizon-badge future-badge">Y' + horizonYears + '</span>';
    } else {
        heroLabel.innerHTML = 'MODELED ' + co.name.toUpperCase() + ' SHARE PRICE';
    }

    // Live strip
    $('liveBtcDisplay').textContent = 'BTC ' + fmtPrice(liveBtcPrice || btcPrice);
    $('liveDataDate').textContent = d.snapshotDate ? 'Data: ' + d.snapshotDate : '';

    updateSliderFills();
}

function renderHero(r, co, d) {
    const price = r.modeledUsd;
    const el = $('heroPrice');

    $('heroLabel').innerHTML = 'MODELED ' + co.name.toUpperCase() + ' SHARE PRICE';

    if (price <= 0) {
        el.textContent = '$0.00';
        el.className = 'hero-price negative';
        $('heroUsd').textContent = 'Common equity wiped out at this price';
        $('heroChange').textContent = '';
        $('heroVs').textContent = '';
        $('heroImplied').style.display = 'none';
        return;
    }

    el.innerHTML = '$' + (price >= 1 ? price.toFixed(2) : price.toFixed(4));
    $('heroUsd').textContent = '';

    // Change vs market
    const market = d.stockLocal;
    if (market > 0) {
        const chg = price - market;
        const chgPct = (chg / market) * 100;
        const sign = chg >= 0 ? '+' : '';
        $('heroChange').textContent = sign + chgPct.toFixed(1) + '%';
        $('heroChange').className = 'hero-change ' + (chg >= 0 ? 'up' : 'down');
        el.className = 'hero-price ' + (chgPct > 5 ? 'positive' : chgPct < -5 ? 'negative' : 'neutral');
        $('heroVs').innerHTML = 'vs market $' + market.toFixed(2);
    } else {
        $('heroChange').textContent = '';
        el.className = 'hero-price neutral';
        $('heroVs').textContent = '';
    }

    // Implied mNAV
    if (market > 0 && r.navPerShare > 0) {
        const impliedMnav = market / r.navPerShare;
        $('impliedMnavVal').textContent = impliedMnav.toFixed(2) + '\u00d7';
        $('heroImplied').style.display = 'inline-block';
    } else {
        $('heroImplied').style.display = 'none';
    }
}

function renderClaimsBanner(r) {
    const banner = $('claimsBanner');
    const dragPct = (r.drag * 100).toFixed(1);
    const useBtcP = r._proj ? r._proj.yearBtcPrice : btcPrice;
    const totalBtc = useBtcP > 0 ? Math.round((r.navUsd + r.netClaims) / useBtcP) : 0;
    const claimsBtc = Math.round(r.claimsBtc);
    const netBtc = totalBtc - claimsBtc;
    const sharesM = r._proj ? (r._proj.shares / 1e6).toFixed(1) : (getData().shares / 1e6).toFixed(1);
    $('claimsDragDisplay').textContent = 'DRAG: ' + dragPct + '%';
    $('claimsSub').innerHTML = 'Common equity owns ' + ((1 - r.drag) * 100).toFixed(1) + '% of ' + fmt(totalBtc) + ' BTC &middot; Break-even: ' + fmtPrice(r.breakEven);
    $('claimsFormula').innerHTML = 'CEBE = (' + fmt(totalBtc) + ' \u2212 ' + fmt(claimsBtc) + ') \u00f7 ' + sharesM + 'M = ' + fmtSats(r.cebeSats) + ' sats/share';
    banner.className = 'claims-banner' + (r.drag < 0.2 ? ' low-drag' : r.drag > 0.5 ? ' high-drag' : '');
}

function renderNarrative(r, co, d, projResults) {
    const items = [];
    const scenarioObj = SCENARIOS.find(s => s.id === activeScenario);
    const scenarioName = scenarioObj ? scenarioObj.name : 'Custom';
    var useBtc = (r._proj ? r._proj.yearBtcPrice : btcPrice);
    var useMnav = (r._proj ? r._proj.yearMnav : mnavMultiple);
    var useBtcH = (r._proj ? r._proj.btcH : d.btcHoldings);

    document.querySelector('.narrative-title').innerHTML = '&#128269; ' + scenarioName + (horizonYears > 0 ? ' &mdash; Year ' + horizonYears : '') + ' &mdash; ' + fmtPrice(useBtc) + ' BTC';

    // Drag status
    const dragPct = (r.drag * 100).toFixed(1);
    const ownPct = ((1 - r.drag) * 100).toFixed(1);
    if (r.drag < 0.15) {
        items.push({ cls: 'green', icon: '&#9989;', text: '<strong>' + dragPct + '% drag &mdash; near pure equity.</strong> After aggressive debt retirement ($120M &rarr; $10M), Strive\'s capital structure is 97.7% preferred equity. Common shareholders own ' + ownPct + '% of the ' + fmt(useBtcH) + ' BTC.' });
    } else if (r.drag < 0.4) {
        items.push({ cls: 'info', icon: '&#128200;', text: '<strong>' + dragPct + '% drag.</strong> Common equity owns ' + ownPct + '% of the ' + fmt(useBtcH) + ' BTC on the balance sheet. ' + fmtB(r.prefUsd) + ' in SATA preferred is the primary senior claim.' });
    } else {
        items.push({ cls: 'amber', icon: '&#9888;', text: '<strong>' + dragPct + '% drag &mdash; elevated.</strong> At ' + fmtPrice(useBtc) + ' BTC, SATA preferred claims consume ' + dragPct + '% of holdings. Common equity owns ' + ownPct + '% of the ' + fmt(useBtcH) + ' BTC.' });
    }

    // Amplification
    if (r.amplification < 10) {
        items.push({ cls: 'neutral', icon: '&#9878;', text: '<strong>Amplification: ' + r.amplification.toFixed(2) + '&times;</strong> Common equity gets ' + r.amplification.toFixed(2) + '&times; the BTC price movement. SATA preferred creates leverage that works both directions &mdash; amplifying gains in a bull run and losses in a drawdown.' });
    }

    // Break-even context — use projected BTC price
    if (useBtc < r.breakEven * 2) {
        items.push({ cls: 'red', icon: '&#128680;', text: '<strong>Break-even proximity.</strong> At ' + fmtPrice(r.breakEven) + ', net senior claims equal total BTC value and common equity hits zero. Current price is ' + ((useBtc / r.breakEven - 1) * 100).toFixed(0) + '% above break-even. No callable debt means no forced liquidation, but NAV goes to zero.' });
    } else {
        items.push({ cls: 'green', icon: '&#128161;', text: '<strong>Break-even: ' + fmtPrice(r.breakEven) + '.</strong> BTC would need to fall ' + ((1 - r.breakEven / useBtc) * 100).toFixed(0) + '% from here before common equity hits zero. No callable debt &mdash; creditors cannot force liquidation at any price.' });
    }

    // Cash offset
    var cashToShow = r._proj ? r._proj.cash : r.cashUsd;
    if (cashToShow > 0) {
        items.push({ cls: 'info', icon: '&#128176;', text: '<strong>' + fmtB(cashToShow) + ' cash reserve</strong> offsets senior claims, reducing net drag. Strive retired $110M in debt in two weeks (Jan 2026), shifting from mixed debt to 97.7% preferred equity structure.' });
    }

    // mNAV interpretation — use projected mNAV
    if (useMnav > 1.1) {
        items.push({ cls: 'amber', icon: '&#9888;', text: '<strong>Premium at ' + useMnav.toFixed(2) + '&times; mNAV.</strong> Market is pricing execution premium above net BTC value. Justified by BTC Yield (21%+ QTD) and aggressive accumulation strategy.' });
    } else if (useMnav < 0.9) {
        items.push({ cls: 'green', icon: '&#128176;', text: '<strong>Discount at ' + useMnav.toFixed(2) + '&times; mNAV.</strong> Market is pricing Strive below its net Bitcoin value. At this mNAV, you\u2019re buying BTC exposure cheaper than spot through the equity.' });
    }

    // Wrapper fee (snapshot or projection)
    var wfBtcH = r._proj ? r._proj.btcH : d.btcHoldings;
    var wfBtcP = r._proj ? r._proj.yearBtcPrice : btcPrice;
    var btcResVal = wfBtcH * wfBtcP;
    var sataDivAnn = (r._proj ? r._proj.totalPrefFace : d.preferredUsd) * co.sata_div_rate;
    var annCost = sataDivAnn + co.sbc_annual_usd + co.cash_comp_annual_usd;
    var netCost = annCost - co.aum_fee_income;
    var wfPct = btcResVal > 0 ? netCost / btcResVal : 0;
    if (wfPct > 0.025) {
        items.push({ cls: 'amber', icon: '&#128203;', text: '<strong>Wrapper fee: ' + (wfPct*100).toFixed(2) + '% of BTC reserve.</strong> Annual cost of ' + fmtB(netCost) + ' (SATA div ' + fmtB(sataDivAnn) + ' + SBC ' + fmtB(co.sbc_annual_usd) + ' + comp ' + fmtB(co.cash_comp_annual_usd) + ' \u2212 AUM fee ' + fmtB(co.aum_fee_income) + '). Compresses as BTC appreciates.' });
    } else if (wfPct > 0) {
        items.push({ cls: 'green', icon: '&#128203;', text: '<strong>Wrapper fee: ' + (wfPct*100).toFixed(2) + '%.</strong> Low annual cost relative to BTC reserve. AUM fee income significantly offsets operating expenses.' });
    }

    // Projection-specific: cash runway + events
    if (r._proj && horizonYears > 0) {
        var runway = r._proj.cashRunway;
        var sType = getActiveType();
        var isAtmScenario = (sType === 'powerlaw' || sType === 'cole10');
        if (sType === 'siege') {
            var totalBtcSold = 0;
            if (projResults) { projResults.forEach(function(row) { totalBtcSold += row.btcSold; }); }
            if (totalBtcSold > 0) {
                items.push({ cls: 'red', icon: '&#128680;', text: '<strong>BTC treasury depleted.</strong> Over ' + horizonYears + ' years at $50K, ' + fmt(Math.round(totalBtcSold)) + ' BTC liquidated to cover obligations. Capital markets assumed closed.' });
            }
            if (runway < 1) {
                items.push({ cls: 'red', icon: '&#9888;', text: '<strong>Cash runway: 0 years.</strong> All cash reserves consumed. Ongoing BTC sales required.' });
            }
        } else if (isAtmScenario) {
            if (r._proj.cash > 0) {
                var rwyYrs = r._proj.cashRunway;
                var rwyText = rwyYrs >= 100 ? '\u221e' : rwyYrs.toFixed(1);
                items.push({ cls: 'green', icon: '&#128176;', text: '<strong>Cash reserves maintained: ' + fmtB(r._proj.cash) + '.</strong> ' + rwyText + ' years of coverage. Company issues ATM equity as needed to maintain reserves alongside growing SATA obligations.' });
            }
        } else if (runway < 3) {
            items.push({ cls: 'red', icon: '&#128680;', text: '<strong>Cash runway: ' + runway.toFixed(1) + ' years.</strong> Cash reserves low.' });
        } else if (runway < Infinity) {
            items.push({ cls: 'info', icon: '&#128176;', text: '<strong>Cash runway: ' + runway.toFixed(1) + ' years.</strong> Cash reserves cover ' + runway.toFixed(1) + ' years of net operating costs.' });
        }
        // Break-even safety margin
        var beMargin = useBtc > 0 && r.breakEven > 0 ? ((useBtc / r.breakEven - 1) * 100) : 999;
        if (beMargin < 200) {
            items.push({ cls: 'amber', icon: '&#9888;', text: '<strong>Break-even safety: ' + beMargin.toFixed(0) + '%.</strong> BTC at ' + fmtPrice(useBtc) + ' is ' + beMargin.toFixed(0) + '% above break-even (' + fmtPrice(r.breakEven) + '). Margin is compressed.' });
        }

        // SATA issuance / engine events (year-by-year)
        if (projResults && projResults._events) {
            projResults._events.forEach(function(e) {
                items.push({ cls: e.cls, icon: e.icon, text: e.text });
            });
        }
    }

    $('narrativeBody').innerHTML = items.map(i =>
        '<div class="narr-item ' + i.cls + '"><span class="narr-icon">' + i.icon + '</span><span>' + i.text + '</span></div>'
    ).join('');
}

function renderMetrics(r, co, d, projResults) {
    const dragPct = (r.drag * 100).toFixed(1);
    const dragCls = r.drag < 0.2 ? 'good' : r.drag > 0.5 ? 'danger' : 'warn';

    // Wrapper fee calc
    var wfBtcH = r._proj ? r._proj.btcH : d.btcHoldings;
    var wfBtcP = r._proj ? r._proj.yearBtcPrice : btcPrice;
    var btcResVal = wfBtcH * wfBtcP;
    var sataDivAnn = (r._proj ? r._proj.totalPrefFace : d.preferredUsd) * co.sata_div_rate;
    var annCost = sataDivAnn + co.sbc_annual_usd + co.cash_comp_annual_usd;
    var netCost = annCost - co.aum_fee_income;
    var wfPct = btcResVal > 0 ? netCost / btcResVal : 0;
    var wfCls = wfPct > 0.05 ? 'danger' : wfPct > 0.03 ? 'warn' : '';

    // Cash runway
    var cashRunwayVal = '--';
    if (r._proj) {
        var rwy = r._proj.cashRunway;
        if (rwy >= 100) { cashRunwayVal = '&infin;'; }
        else { cashRunwayVal = rwy.toFixed(1) + 'yr'; }
    } else {
        var netDrain = sataDivAnn + co.cash_comp_annual_usd - co.aum_fee_income;
        if (netDrain > 0 && d.cashUsd > 0) { cashRunwayVal = (d.cashUsd / netDrain).toFixed(1) + 'yr'; }
        else { cashRunwayVal = '&infin;'; }
    }

    const metrics = [
        { label: 'CEBE', value: fmtSats(r.cebeSats) + ' sats', cls: '' },
        { label: 'DRAG', value: dragPct + '%', cls: dragCls },
        { label: 'AMPLIFICATION', value: r.amplification < 10 ? r.amplification.toFixed(2) + '&times;' : '&infin;', cls: '' },
        { label: 'BREAK-EVEN', value: fmtPrice(r.breakEven), cls: btcPrice < r.breakEven * 2 ? 'danger' : '' },
        { label: 'NAV/SHARE', value: '$' + (r.navPerShare >= 1 ? r.navPerShare.toFixed(2) : r.navPerShare.toFixed(4)), cls: '' },
        { label: 'WRAPPER FEE', value: (wfPct * 100).toFixed(2) + '%', sub: fmtB(netCost) + '/yr net', cls: wfCls },
        { label: 'CASH RUNWAY', value: cashRunwayVal, cls: '' },
        { label: 'NET CLAIMS', value: fmtB(r.netClaims), cls: '' },
    ];

    $('metricsGrid').innerHTML = metrics.map(m =>
        '<div class="metric-card"><div class="metric-label">' + m.label + '</div><div class="metric-value ' + (m.cls||'') + '">' + m.value + '</div>' + (m.sub ? '<div style="font-size:10px;color:#71717a;margin-top:2px">' + m.sub + '</div>' : '') + '</div>'
    ).join('');
}

function renderClaims(r) {
    $('claimsBody').innerHTML =
        '<div class="claims-stack">' +
            '<div class="claim-row"><span class="claim-label">SATA Preferred <span class="claim-badge preferred">PERP</span></span><span class="claim-value">' + fmtB(r.prefUsd) + '</span></div>' +
            '<div class="claim-row"><span class="claim-label">Debt <span class="claim-badge debt">RESIDUAL</span></span><span class="claim-value">' + fmtB(r.debtUsd) + '</span></div>' +
            '<div class="claim-row"><span class="claim-label">Cash Reserve <span class="claim-badge cash">OFFSET</span></span><span class="claim-value" style="color:var(--green)">-' + fmtB(r.cashUsd) + '</span></div>' +
            '<div class="claim-total"><span class="claim-total-label">NET SENIOR CLAIMS</span><span class="claim-total-value">' + fmtB(r.netClaims) + '</span></div>' +
            '<div style="margin-top:10px;font-size:11px;color:var(--text-muted);text-align:center">= ' + fmt(Math.round(r.claimsBtc)) + ' BTC at ' + fmtPrice(btcPrice) + '</div>' +
        '</div>';
}

function renderWaterfall(r, co, d) {
    const sym = co.currencySymbol;
    const navLocal = r.navPerShare / d.fxRate;
    const priceLocal = r.modeledUsd / d.fxRate;

    var grossBtcVal = d.btcHoldings * btcPrice;
    $('waterfall').innerHTML =
        '<div class="wf-step btc-val"><div class="wf-label">BTC RESERVE</div><div class="wf-value">' + fmtB(grossBtcVal) + '</div></div>' +
        '<span class="wf-arrow">&#8594;</span>' +
        '<div class="wf-step" style="background:var(--red-muted);border:1px solid rgba(239,68,68,0.2)"><div class="wf-label">CLAIMS</div><div class="wf-value" style="color:var(--red)">&#8722;' + fmtB(r.netClaims) + '</div></div>' +
        '<span class="wf-arrow">=</span>' +
        '<div class="wf-step nav"><div class="wf-label">NAV</div><div class="wf-value">' + fmtB(r.navUsd) + '</div></div>' +
        '<span class="wf-arrow">&#247;</span>' +
        '<div class="wf-step shares"><div class="wf-label">SHARES</div><div class="wf-value">' + (d.shares / 1e6).toFixed(0) + 'M</div></div>' +
        '<span class="wf-arrow">=</span>' +
        '<div class="wf-step shares"><div class="wf-label">NAV/SHARE</div><div class="wf-value">' + sym + (navLocal >= 1 ? navLocal.toFixed(2) : navLocal.toFixed(4)) + '</div></div>' +
        '<span class="wf-arrow">&times;</span>' +
        '<div class="wf-step shares"><div class="wf-label">mNAV</div><div class="wf-value">' + mnavMultiple.toFixed(2) + '&times;</div></div>' +
        '<span class="wf-arrow">=</span>' +
        '<div class="wf-step result"><div class="wf-label">PRICE</div><div class="wf-value">' + sym + (priceLocal >= 1 ? priceLocal.toFixed(2) : priceLocal.toFixed(4)) + '</div></div>';
}

function renderMatrix(co, d) {
    const sym = co.currencySymbol;
    let html = '<thead><tr><th>BTC &#8595; \\ mNAV &#8594;</th>';
    MATRIX_MNAVS.forEach(m => { html += '<th>' + m.toFixed(m % 1 === 0 ? 0 : 2) + '&times;</th>'; });
    html += '</tr></thead><tbody>';

    MATRIX_BTC.forEach(btcP => {
        const r = compute(d.btcHoldings, d.shares, btcP, 1.0);
        const label = btcP >= 1e6 ? '$' + (btcP/1e6) + 'M' : '$' + (btcP/1e3) + 'K';
        html += '<tr><td class="row-label">' + label + '</td>';
        MATRIX_MNAVS.forEach(m => {
            const priceUsd = r.navPerShare * m;
            const priceLocal = priceUsd / d.fxRate;
            const display = priceLocal >= 100 ? sym + Math.round(priceLocal).toLocaleString() : priceLocal >= 1 ? sym + priceLocal.toFixed(2) : sym + priceLocal.toFixed(4);

            // Color relative to current market
            const marketUsd = d.stockLocal * d.fxRate;
            let cls = '';
            if (marketUsd > 0) {
                const ratio = priceUsd / marketUsd;
                if (ratio > 1.5) cls = 'matrix-cell-green';
                else if (ratio > 1.1) cls = 'matrix-cell-lightgreen';
                else if (ratio < 0.5) cls = 'matrix-cell-red';
                else if (ratio < 0.9) cls = 'matrix-cell-lightred';
            }

            // Highlight nearest to current inputs
            const btcClose = Math.abs(btcP - btcPrice) < btcPrice * 0.25;
            const mnavClose = Math.abs(m - mnavMultiple) < 0.15;
            if (btcClose && mnavClose) cls += ' matrix-cell-current';

            html += '<td class="' + cls + '">' + display + '</td>';
        });
        html += '</tr>';
    });
    html += '</tbody>';
    $('matrixTable').innerHTML = html;
}

function renderContrast(r) {
    const striveDrag = (r.drag * 100).toFixed(1);
    const striveOwn = ((1 - r.drag) * 100).toFixed(1);
    const striveColor = r.drag < 0.2 ? 'var(--green)' : r.drag > 0.5 ? 'var(--red)' : 'var(--yellow)';

    $('contrastBody').innerHTML =
        '<div class="contrast-title">DRAG COMPARISON AT ' + fmtPrice(btcPrice) + ' BTC</div>' +
        '<div class="contrast-row">' +
            '<div class="contrast-item"><div class="contrast-company">STRIVE</div><div class="contrast-value" style="color:' + striveColor + '">' + striveDrag + '%</div><div class="contrast-label">owns ' + striveOwn + '%</div></div>' +
            '<div class="contrast-item"><div class="contrast-company">METAPLANET</div><div class="contrast-value" style="color:var(--yellow)">~14%</div><div class="contrast-label">owns ~86%</div></div>' +
            '<div class="contrast-item"><div class="contrast-company">STRATEGY</div><div class="contrast-value" style="color:var(--orange-light)">~27%</div><div class="contrast-label">owns ~73%</div></div>' +
        '</div>' +
        '<div style="margin-top:14px;font-size:12px;color:var(--text-muted);line-height:1.6">' +
            '<strong style="color:var(--text-secondary)">Strive\u2019s structure:</strong> Nearly all senior claims come from SATA perpetual preferred equity ($' + (r.prefUsd / 1e6).toFixed(0) + 'M). After retiring $110M in debt, only $' + (r.debtUsd / 1e6).toFixed(0) + 'M in residual debt remains. No convertible bonds, no complex maturity schedule.' +
            '<br><br>' +
            '<strong style="color:var(--text-secondary)">The SATA advantage:</strong> Perpetual preferred has no maturity date \u2014 no forced redemption at any BTC price. This removes the existential convert maturity risk that Strategy faces. The tradeoff is ongoing preferred dividend obligations.' +
        '</div>';
}


// ═══════════════════════════════════════════════
// UI BUILDERS & EVENT HANDLERS
// ═══════════════════════════════════════════════

function renderProjectionTable(results) {
    var sType = getActiveType();
    var showSata = sType === 'cole10';
    var html = '<thead><tr><th>Year</th><th>BTC Price</th><th>BTC Held</th><th>Shares (M)</th><th>SATA Face</th><th>Cash</th><th>Drag %</th><th>CEBE</th><th>Price</th><th>Status</th></tr></thead><tbody>';
    results.forEach(function(row) {
        var statusIcon = row.status === 'green' ? '&#9989;' : row.status === 'amber' ? '&#9888;' : '&#128680;';
        html += '<tr>' +
            '<td>' + (row.year === 0 ? 'Now' : 'Y' + row.year + ' (' + row.calYear + ')') + '</td>' +
            '<td>' + fmtPrice(row.yearBtcPrice) + '</td>' +
            '<td>' + fmt(Math.round(row.btcH)) + '</td>' +
            '<td>' + (row.shares / 1e6).toFixed(1) + '</td>' +
            '<td>' + fmtB(row.totalPrefFace) + '</td>' +
            '<td>' + fmtB(Math.max(0,row.cash)) + '</td>' +
            '<td class="status-' + row.status + '">' + (row.drag * 100).toFixed(1) + '%</td>' +
            '<td>' + fmtSats(row.cebeSats) + '</td>' +
            '<td>$' + (row.modeledPrice >= 1 ? row.modeledPrice.toFixed(2) : row.modeledPrice.toFixed(4)) + '</td>' +
            '<td>' + statusIcon + '</td>' +
        '</tr>';
    });
    html += '</tbody>';
    $('projTable').innerHTML = html;

    // Events timeline
    var events = results._events || [];
    if (events.length > 0) {
        $('projEvents').innerHTML = '<strong style="color:var(--text-secondary)">Events:</strong><br>' +
            events.map(function(e) { return '<span style="color:var(--text-muted)">Y' + e.year + ':</span> ' + e.text; }).join('<br>');
    } else {
        $('projEvents').innerHTML = '<span style="color:var(--text-muted)">No material events during projection period.</span>';
    }
}

function renderAssumptions() {
    var co = COMPANY, sType = getActiveType();
    var t = '';
    if (sType === 'siege') {
        t = '<strong>Siege:</strong> BTC $50,000 for entire horizon. mNAV 0.7\u00d7. Capital markets closed \u2014 cash shortfalls force BTC liquidation. SATA preferred dividend at ' + (co.sata_div_rate*100).toFixed(2) + '%. SBC dilution ~' + fmtB(co.sbc_annual_usd) + '/yr. Legacy debt ($10M) retires 2026. Tests: can the company survive a prolonged bear market?';
    } else if (sType === 'powerlaw') {
        t = '<strong>Power Law (Support Floor):</strong> BTC follows the power law support line. ~23% avg CAGR decelerating from 30% to 18%, reaching ~$770K by 2036 (<a href="https://charts.bitbo.io/long-term-power-law/" target="_blank" style="color:var(--orange-primary)">Santostasi/Burger model</a>). This is the mathematical FLOOR, not the regression midline ($2.2M) or resistance ($5.3M). mNAV conservative at 1.0x to 1.2x. Maintenance SATA issuance to sustain 15% amplification (capped at $500M/yr). Costs covered from cash, then ATM equity if needed.';
    } else if (sType === 'cole10') {
        t = '<strong>Cole 10-Year:</strong> BTC follows ~26% avg CAGR curve to ~$1M. Cole maintains 25% gross amplification floor via SATA issuance (<a href="https://stephanlivera.com/episode/710/" target="_blank" style="color:var(--orange-primary)">SLP710, Jan 2026</a>). When BTC appreciation compresses amplification below 25%, new SATA is issued and proceeds buy BTC. mNAV starts 1.0\u00d7, reaches 1.5\u00d7 by Y3. SATA capped at $2B/yr. Costs covered by ATM equity when cash depletes.';
    } else {
        t = '<strong>Custom projection:</strong> BTC ' + fmtPrice(btcPrice) + ', mNAV ' + mnavMultiple.toFixed(2) + '\u00d7. Capital structure frozen. SATA div ' + (co.sata_div_rate*100).toFixed(2) + '%. Legacy debt retires 2026.';
    }
    t += '<br><br><strong>Wrapper costs:</strong> SATA preferred dividend (variable, currently ' + (co.sata_div_rate*100).toFixed(2) + '%), SBC $8M/yr (annualized from employment agreements), exec comp $5.2M/yr, offset by $12M/yr AUM fee revenue.';
    t += '<br><br><strong>Data:</strong> Holdings, shares, capital structure from Google Sheet. Live BTC from CoinGecko. All preferred/debt values from Q4 filings and Strive press releases.';
    $('assumptions').innerHTML = t;
}

function buildHorizonBar() {
    $('horizonBar').innerHTML = HORIZON_OPTIONS.map(function(h) {
        return '<button class="toggle-btn ' + (h.years === horizonYears ? 'active' : '') + '" data-years="' + h.years + '">' + h.label + '</button>';
    }).join('');

    document.querySelectorAll('#horizonBar .toggle-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            horizonYears = parseInt(btn.dataset.years);
            $('horizonDisplay').textContent = horizonYears === 0 ? 'Now' : horizonYears + 'Y';
            buildHorizonBar();
            render();
        });
    });
}

function buildScenarioBar() {
    var snapshots = SCENARIOS.filter(function(s){ return s.group === 'snapshot'; });
    var projections = SCENARIOS.filter(function(s){ return s.group === 'projection'; });

    function renderCards(arr) {
        return arr.map(function(s) {
            var priceDisplay = s.btc ? (s.btc >= 1e6 ? '$' + (s.btc/1e6) + 'M' : '$' + (s.btc/1e3) + 'K') : fmtPrice(liveBtcPrice || btcPrice);
            var badge = s.horizon > 0 ? '<span class="horizon-badge future-badge">' + s.horizon + 'Y</span>' : '<span class="horizon-badge now-badge">NOW</span>';
            var mnavText;
            if (s.type === 'cole10') {
                priceDisplay = '&rarr; $1M';
                mnavText = 'SATA engine &middot; 10Y';
            } else if (s.type === 'powerlaw') {
                priceDisplay = '&rarr; $770K';
                mnavText = 'Support floor &middot; 10Y';
            } else {
                var mnavVal = s.mnav !== null && s.mnav !== undefined ? s.mnav : 1.0;
                mnavText = mnavVal.toFixed(1) + '&times; mNAV';
                if (s.horizon > 0) mnavText += ' &middot; ' + s.horizon + 'Y';
            }
            return '<div class="scenario-card ' + (s.id === activeScenario ? 'active' : '') + '" data-scenario="' + s.id + '">' +
                badge +
                '<div class="scenario-icon">' + s.icon + '</div>' +
                '<div class="scenario-name">' + s.name + '</div>' +
                '<div class="scenario-price">' + priceDisplay + '</div>' +
                '<div class="scenario-mnav">' + mnavText + '</div>' +
            '</div>';
        }).join('');
    }

    $('snapshotBar').innerHTML = renderCards(snapshots);
    $('projectionBar').innerHTML = renderCards(projections);

    document.querySelectorAll('.scenario-card').forEach(card => {
        card.addEventListener('click', () => {
            const id = card.dataset.scenario;
            const scenario = SCENARIOS.find(s => s.id === id);
            if (!scenario) return;
            activeScenario = id;
            btcPrice = scenario.btc || (liveBtcPrice || 97000);
            mnavMultiple = scenario.mnav !== null && scenario.mnav !== undefined ? scenario.mnav : 1.0;
            if (scenario.horizon !== undefined) {
                horizonYears = scenario.horizon;
                $('horizonDisplay').textContent = horizonYears === 0 ? 'Now' : horizonYears + 'Y';
                buildHorizonBar();
            }
            syncSliders();
            buildScenarioBar();
            updateMnavPresets();
            render();
        });
    });
}

function buildMnavPresets() {
    $('mnavPresets').innerHTML = MNAV_PRESETS.map(m =>
        '<button class="mnav-btn ' + (Math.abs(m - mnavMultiple) < 0.01 ? 'active' : '') + '" data-mnav="' + m + '">' + m.toFixed(m % 1 === 0 ? 0 : 2) + '&times;</button>'
    ).join('');

    document.querySelectorAll('.mnav-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            if (isSlidersLocked()) return;
            mnavMultiple = parseFloat(btn.dataset.mnav);
            $('mnavSlider').value = mnavMultiple * 100;
            $('mnavDisplay').textContent = mnavMultiple.toFixed(2) + '\u00d7';
            activeScenario = '';
            updateMnavPresets();
            buildScenarioBar();
            render();
        });
    });
}

function updateMnavPresets() {
    document.querySelectorAll('.mnav-btn').forEach(btn => {
        btn.classList.toggle('active', Math.abs(parseFloat(btn.dataset.mnav) - mnavMultiple) < 0.01);
    });
}

function syncSliders() {
    var locked = isSlidersLocked();
    $('btcSlider').value = btcToSlider(btcPrice);
    $('btcPriceDisplay').textContent = fmtPrice(btcPrice);
    $('mnavSlider').value = mnavMultiple * 100;
    $('mnavDisplay').textContent = mnavMultiple.toFixed(2) + '\u00d7';
    $('btcSlider').disabled = locked;
    $('mnavSlider').disabled = locked;
    $('btcSlider').style.opacity = locked ? '0.35' : '1';
    $('mnavSlider').style.opacity = locked ? '0.35' : '1';
    $('btcLockedMsg').style.display = locked ? 'block' : 'none';
    $('mnavLockedMsg').style.display = locked ? 'block' : 'none';
    updateMnavPresets();
}

function updateSliderFills() {
    const btcSlider = $('btcSlider');
    const btcPct = (btcSlider.value / 1000) * 100;
    btcSlider.style.background = 'linear-gradient(90deg, var(--orange-primary) ' + btcPct + '%, #333 ' + btcPct + '%)';

    const mnavSlider = $('mnavSlider');
    const mnavPct = ((mnavSlider.value - 30) / (400 - 30)) * 100;
    mnavSlider.style.background = 'linear-gradient(90deg, var(--orange-primary) ' + mnavPct + '%, #333 ' + mnavPct + '%)';
}

// ─── SLIDER EVENTS ───
$('btcSlider').addEventListener('input', (e) => {
    if (isSlidersLocked()) return;
    btcPrice = sliderToBtc(parseInt(e.target.value));
    $('btcPriceDisplay').textContent = fmtPrice(btcPrice);
    activeScenario = '';
    buildScenarioBar();
    render();
});

$('mnavSlider').addEventListener('input', (e) => {
    if (isSlidersLocked()) return;
    mnavMultiple = parseInt(e.target.value) / 100;
    $('mnavDisplay').textContent = mnavMultiple.toFixed(2) + '\u00d7';
    activeScenario = '';
    updateMnavPresets();
    buildScenarioBar();
    render();
});

// ─── KEYBOARD SHORTCUTS ───
document.addEventListener('keydown', (e) => {
    if (e.target.tagName === 'INPUT') return;
    if (e.key >= '1' && e.key <= '6') {
        const idx = parseInt(e.key) - 1;
        if (SCENARIOS[idx]) {
            const scenario = SCENARIOS[idx];
            activeScenario = scenario.id;
            btcPrice = scenario.btc || (liveBtcPrice || 97000);
            mnavMultiple = scenario.mnav !== null && scenario.mnav !== undefined ? scenario.mnav : 1.0;
            syncSliders();
            buildScenarioBar();
            updateMnavPresets();
            render();
        }
    }

});

// ─── INIT ───
loadData();
</script>
</body>
</html>
