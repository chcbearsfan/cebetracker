<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>CEBE Modeler | Metaplanet Share Price Analysis</title>
    <meta name="description" content="Model Metaplanet (3350/MTPLF) share price through the CEBE framework. JPY/USD dynamics, drag compression, zero-coupon bond structure, and dual sensitivity matrices.">
    <meta name="application-name" content="CEBE">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#09090b">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect fill='%2309090b' width='32' height='32' rx='4'/%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' stop-color='%23f97316'/%3E%3Cstop offset='100%25' stop-color='%23fb923c'/%3E%3C/linearGradient%3E%3C/defs%3E%3Ctext x='16' y='15' font-family='Arial,sans-serif' font-size='14' font-weight='700' fill='url(%23g)' text-anchor='middle'%3ECE%3C/text%3E%3Ctext x='16' y='28' font-family='Arial,sans-serif' font-size='14' font-weight='700' fill='url(%23g)' text-anchor='middle'%3EBE%3C/text%3E%3C/svg%3E">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #09090b; --bg-secondary: #0f0f11; --bg-card: #141416; --bg-elevated: #1a1a1d;
            --orange-primary: #f97316; --orange-light: #fb923c;
            --orange-glow: rgba(249,115,22,0.12); --orange-border: rgba(249,115,22,0.25);
            --text-primary: #fafafa; --text-secondary: #a1a1aa; --text-muted: #52525b;
            --green: #22c55e; --green-muted: rgba(34,197,94,0.15);
            --red: #ef4444; --red-muted: rgba(239,68,68,0.15);
            --yellow: #eab308; --yellow-muted: rgba(234,179,8,0.15);
            --blue: #38bdf8; --blue-muted: rgba(56,189,248,0.08);
            --border-subtle: rgba(255,255,255,0.06); --mono: 'JetBrains Mono', monospace;
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family:'Inter',-apple-system,BlinkMacSystemFont,sans-serif; background:var(--bg-primary); color:var(--text-primary); line-height:1.6; min-height:100vh; }
        body::before { content:''; position:fixed; inset:0; pointer-events:none; background-image:linear-gradient(rgba(249,115,22,0.015) 1px,transparent 1px),linear-gradient(90deg,rgba(249,115,22,0.015) 1px,transparent 1px); background-size:48px 48px; z-index:0; }
        .container { max-width:720px; margin:0 auto; padding:24px 16px 60px; position:relative; z-index:1; }

        /* HEADER */
        .header { text-align:center; margin-bottom:28px; }
        .nav-back { display:inline-block; font-size:12px; color:var(--text-muted); text-decoration:none; margin-bottom:12px; letter-spacing:1px; transition:color .2s; }
        .nav-back:hover { color:var(--orange-primary); }
        .logo-container { position:relative; display:inline-block; margin-bottom:6px; }
        .logo { font-size:32px; font-weight:300; letter-spacing:16px; padding-left:16px; color:var(--text-primary); position:relative; z-index:1; }
        .logo span { background:linear-gradient(135deg,var(--orange-primary),var(--orange-light)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; font-weight:600; }
        .logo-whisper { font-size:11px; font-weight:400; letter-spacing:8px; padding-left:8px; margin-top:2px; text-transform:lowercase; background:linear-gradient(180deg,rgba(161,161,170,0.6),rgba(82,82,91,0.2)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; }
        .logo-glow { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:180px; height:50px; background:radial-gradient(ellipse,rgba(249,115,22,0.3),transparent 70%); filter:blur(20px); z-index:0; }
        .logo-badge { display:inline-block; font-size:11px; font-weight:600; padding:4px 10px; border-radius:6px; background:rgba(249,115,22,0.12); border:1px solid var(--orange-border); color:var(--orange-primary); letter-spacing:1px; font-family:var(--mono); margin-top:8px; }
        .header-sub { font-size:13px; color:var(--text-muted); letter-spacing:1px; margin-top:4px; }
        .live-strip { display:flex; align-items:center; justify-content:center; gap:16px; margin-top:12px; font-size:11px; font-family:var(--mono); color:var(--text-muted); flex-wrap:wrap; }
        .live-dot { width:6px; height:6px; border-radius:50%; background:var(--green); display:inline-block; animation:pulse-dot 2s ease infinite; }
        @keyframes pulse-dot { 0%,100%{opacity:1} 50%{opacity:.4} }
        .live-price { color:var(--text-secondary); }

        /* SCENARIOS */
        .scenarios-section { margin-bottom:24px; }
        .scenario-group { margin-bottom:14px; }
        .scenario-group:last-child { margin-bottom:0; }
        .group-label { display:flex; align-items:center; gap:10px; margin-bottom:8px; padding-left:4px; }
        .group-label-badge { font-size:9px; font-family:var(--mono); font-weight:700; letter-spacing:1.5px; padding:3px 8px; border-radius:4px; white-space:nowrap; }
        .group-label-badge.now { background:rgba(255,255,255,0.04); color:var(--text-muted); border:1px solid var(--border-subtle); }
        .group-label-badge.future { background:rgba(249,115,22,0.08); color:var(--orange-primary); border:1px solid var(--orange-border); }
        .group-label-text { font-size:9px; letter-spacing:2px; font-weight:600; color:var(--text-muted); }
        .group-label-line { flex:1; height:1px; background:var(--border-subtle); }
        .scenarios-row { display:grid; grid-template-columns:repeat(3,1fr); gap:8px; }
        @media(max-width:500px){ .scenarios-row{grid-template-columns:repeat(2,1fr)} }
        .scenario-card { padding:16px 12px 14px; border-radius:12px; border:1.5px solid var(--border-subtle); background:var(--bg-card); cursor:pointer; transition:all .25s ease; text-align:center; user-select:none; position:relative; }
        .scenario-card:hover { border-color:rgba(255,255,255,0.12); background:var(--bg-elevated); transform:translateY(-2px); }
        .scenario-card.active { border-color:var(--orange-primary); background:var(--orange-glow); box-shadow:0 0 20px rgba(249,115,22,0.1); }
        .scenario-card.projection { border-left:3px solid rgba(249,115,22,0.3); }
        .scenario-card.projection.active { border-left-color:var(--orange-primary); }
        .horizon-badge { position:absolute; top:8px; right:8px; font-size:9px; font-weight:700; font-family:var(--mono); padding:2px 6px; border-radius:4px; letter-spacing:.5px; }
        .horizon-badge.now-badge { background:rgba(255,255,255,0.04); color:#52525b; border:1px solid rgba(255,255,255,0.06); }
        .horizon-badge.future-badge { background:rgba(249,115,22,0.1); color:var(--orange-primary); border:1px solid var(--orange-border); }
        .scenario-icon { font-size:22px; margin-bottom:4px; }
        .scenario-name { font-size:12px; font-weight:600; letter-spacing:.5px; margin-bottom:4px; }
        .scenario-price { font-size:15px; font-weight:700; font-family:var(--mono); color:var(--orange-light); }
        .scenario-mnav { font-size:10px; color:var(--text-muted); font-family:var(--mono); margin-top:4px; }
        .scenario-fx { font-size:10px; color:var(--red); font-family:var(--mono); margin-top:2px; }

        /* HERO */
        .hero { text-align:center; padding:28px 20px; margin-bottom:20px; background:linear-gradient(180deg,rgba(249,115,22,0.04),transparent); border-radius:20px; border:1px solid rgba(249,115,22,0.1); }
        .hero-label { font-size:10px; letter-spacing:3px; color:var(--text-muted); margin-bottom:6px; font-weight:500; }
        .hero-price { font-size:64px; font-weight:700; font-family:var(--mono); line-height:1; margin-bottom:8px; transition:color .3s; }
        .hero-price.positive{color:var(--green)} .hero-price.negative{color:var(--red)} .hero-price.neutral{color:var(--text-primary)}
        .hero-usd { font-size:16px; font-family:var(--mono); color:var(--text-secondary); margin-bottom:6px; }
        .hero-change { font-size:16px; font-weight:600; font-family:var(--mono); margin-bottom:4px; }
        .hero-change.up{color:var(--green)} .hero-change.down{color:var(--red)}
        .hero-vs { font-size:11px; color:var(--text-muted); }
        .hero-context { margin-top:4px; font-size:10px; color:var(--text-muted); font-family:var(--mono); letter-spacing:.5px; }
        .hero-fx { margin-top:8px; font-size:10px; font-weight:600; font-family:var(--mono); padding:4px 10px; border-radius:6px; display:inline-block; letter-spacing:.5px; }
        .hero-fx.compress { background:var(--green-muted); border:1px solid rgba(34,197,94,0.3); color:var(--green); }
        .hero-fx.expand { background:var(--red-muted); border:1px solid rgba(239,68,68,0.3); color:var(--red); }
        .hero-fx.fx-neutral { background:rgba(255,255,255,0.03); border:1px solid var(--border-subtle); color:var(--text-muted); }
        .hero-implied { margin-top:10px; font-size:12px; font-family:var(--mono); color:var(--text-secondary); padding:6px 14px; border-radius:20px; background:rgba(255,255,255,0.03); border:1px solid var(--border-subtle); display:inline-block; }
        .hero-implied em { font-style:normal; color:var(--orange-primary); font-weight:600; }

        /* NARRATIVE */
        .narrative { background:var(--bg-card); border:1px solid var(--border-subtle); border-radius:14px; padding:20px; margin-bottom:20px; }
        .narrative-title { font-size:14px; font-weight:600; margin-bottom:12px; display:flex; align-items:center; gap:8px; }
        .narrative-body { display:flex; flex-direction:column; gap:10px; }
        .narr-item { display:flex; align-items:flex-start; gap:10px; padding:10px 14px; border-radius:10px; font-size:13px; line-height:1.5; }
        .narr-item.green { background:var(--green-muted); border:1px solid rgba(34,197,94,0.2); color:#86efac; }
        .narr-item.red { background:var(--red-muted); border:1px solid rgba(239,68,68,0.2); color:#fca5a5; }
        .narr-item.amber { background:var(--yellow-muted); border:1px solid rgba(234,179,8,0.2); color:#fde68a; }
        .narr-item.info { background:var(--blue-muted); border:1px solid rgba(56,189,248,0.2); color:#7dd3fc; }
        .narr-item.neutral { background:rgba(255,255,255,0.03); border:1px solid var(--border-subtle); color:var(--text-secondary); }
        .narr-icon { font-size:16px; flex-shrink:0; margin-top:1px; }
        .narr-text strong { color:var(--text-primary); }

        /* METRICS */
        .metrics-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(100px,1fr)); gap:8px; margin-bottom:20px; }
        .metric-card { background:var(--bg-card); border:1px solid var(--border-subtle); border-radius:10px; padding:12px 10px; text-align:center; }
        .metric-label { font-size:8px; letter-spacing:1.5px; color:var(--text-muted); margin-bottom:4px; font-weight:600; }
        .metric-value { font-size:17px; font-weight:700; font-family:var(--mono); line-height:1.2; }
        .metric-sub { font-size:9px; color:#3f3f46; margin-top:2px; font-family:var(--mono); }
        .metric-value.danger{color:var(--red)} .metric-value.warn{color:var(--yellow)} .metric-value.good{color:var(--green)}

        /* COLLAPSIBLE */
        .collapse-section { margin-bottom:12px; }
        .collapse-section summary { display:flex; align-items:center; gap:8px; padding:14px 16px; background:var(--bg-card); border:1px solid var(--border-subtle); border-radius:12px; cursor:pointer; font-size:13px; font-weight:600; color:var(--text-secondary); letter-spacing:.5px; transition:all .2s; list-style:none; user-select:none; }
        .collapse-section summary::-webkit-details-marker{display:none}
        .collapse-section summary:hover { border-color:rgba(255,255,255,0.12); color:var(--text-primary); }
        .collapse-section[open] summary { border-radius:12px 12px 0 0; border-bottom-color:transparent; color:var(--orange-primary); }
        .collapse-body { padding:16px; background:var(--bg-card); border:1px solid var(--border-subtle); border-top:none; border-radius:0 0 12px 12px; }

        /* CONTROLS */
        .controls-grid { display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:16px; }
        @media(max-width:500px){ .controls-grid{grid-template-columns:1fr} }
        .control-card { background:var(--bg-secondary); border:1px solid var(--border-subtle); border-radius:10px; padding:14px; }
        .control-card.full-width { grid-column:1/-1; }
        .control-card.fx-card { border-color:rgba(239,68,68,0.25); background:rgba(239,68,68,0.03); }
        .control-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
        .control-label { font-size:10px; letter-spacing:1.5px; color:var(--text-muted); font-weight:600; }
        .control-label.fx-label { color:var(--red); }
        .control-value { font-size:18px; font-weight:700; font-family:var(--mono); color:var(--orange-light); }
        .control-value.fx-value { color:var(--red); }
        input[type=range] { -webkit-appearance:none; width:100%; height:6px; border-radius:3px; background:#333; outline:none; cursor:pointer; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance:none; width:20px; height:20px; border-radius:50%; background:var(--orange-primary); box-shadow:0 0 10px rgba(249,115,22,0.4); cursor:grab; }
        input[type=range]::-moz-range-thumb { width:20px; height:20px; border-radius:50%; background:var(--orange-primary); border:none; box-shadow:0 0 10px rgba(249,115,22,0.4); cursor:grab; }
        input[type=range].fx-range::-webkit-slider-thumb { background:var(--red); box-shadow:0 0 10px rgba(239,68,68,0.4); }
        input[type=range].fx-range::-moz-range-thumb { background:var(--red); box-shadow:0 0 10px rgba(239,68,68,0.4); }
        .slider-labels { display:flex; justify-content:space-between; font-size:9px; color:#444; font-family:var(--mono); margin-top:4px; }
        .mnav-presets { display:flex; gap:4px; margin-top:8px; }
        .mnav-btn { flex:1; padding:4px 0; border-radius:6px; border:1px solid var(--border-subtle); background:transparent; color:var(--text-muted); font-size:10px; font-family:var(--mono); cursor:pointer; transition:all .2s; }
        .mnav-btn:hover,.mnav-btn.active { border-color:var(--orange-primary); color:var(--orange-primary); background:var(--orange-glow); }

        /* WATERFALL */
        .waterfall { display:flex; align-items:center; gap:4px; overflow-x:auto; padding:12px; padding-right:24px; scrollbar-width:none; }
        .waterfall::-webkit-scrollbar{display:none}
        .waterfall::after { content:''; flex:0 0 12px; }
        .wf-step { flex:0 0 auto; text-align:center; padding:8px 12px; border-radius:8px; min-width:85px; }
        .wf-step.btc-val { background:rgba(249,115,22,0.08); border:1px solid rgba(249,115,22,0.2); }
        .wf-step.claims { background:var(--red-muted); border:1px solid rgba(239,68,68,0.2); }
        .wf-step.nav { background:var(--green-muted); border:1px solid rgba(34,197,94,0.2); }
        .wf-step.shares { background:rgba(255,255,255,0.03); border:1px solid var(--border-subtle); }
        .wf-step.result { background:rgba(249,115,22,0.12); border:1px solid var(--orange-border); }
        .wf-label { font-size:8px; letter-spacing:1px; color:var(--text-muted); margin-bottom:2px; }
        .wf-value { font-size:12px; font-weight:700; font-family:var(--mono); }
        .wf-arrow { flex:0 0 auto; font-size:14px; color:var(--text-muted); }

        /* MATRIX */
        .matrix-table { width:100%; border-collapse:collapse; }
        .matrix-table th { padding:8px 10px; font-size:9px; font-weight:600; letter-spacing:1px; color:var(--text-muted); border-bottom:1px solid var(--border-subtle); background:rgba(255,255,255,0.02); }
        .matrix-table td { padding:8px 10px; text-align:center; font-family:var(--mono); font-size:11px; font-weight:600; border-bottom:1px solid rgba(255,255,255,0.03); }
        .matrix-table td.row-label { text-align:right; color:var(--text-secondary); font-weight:600; background:rgba(255,255,255,0.02); }
        .matrix-table th:first-child{text-align:right}
        .matrix-cell-green{color:var(--green);background:rgba(34,197,94,0.06)} .matrix-cell-lightgreen{color:#86efac;background:rgba(34,197,94,0.03)}
        .matrix-cell-red{color:var(--red);background:rgba(239,68,68,0.06)} .matrix-cell-lightred{color:#fca5a5;background:rgba(239,68,68,0.03)}
        .matrix-cell-gold{color:#fbbf24;background:rgba(251,191,36,0.08);border:1px solid rgba(251,191,36,0.2)}
        .matrix-cell-current{outline:2px solid var(--orange-primary);outline-offset:-2px;border-radius:4px}

        /* BOND TABLE */
        .bond-stack { width:100%; border-collapse:collapse; font-size:12px; }
        .bond-stack th { padding:8px 10px; text-align:left; font-size:9px; font-weight:600; letter-spacing:1px; color:var(--text-muted); border-bottom:1px solid var(--border-subtle); }
        .bond-stack td { padding:8px 10px; font-family:var(--mono); font-size:12px; border-bottom:1px solid rgba(255,255,255,0.03); }
        .bond-stack td:first-child { font-weight:600; color:var(--text-secondary); }
        .badge-zero { font-size:9px; padding:2px 6px; border-radius:4px; background:var(--green-muted); color:var(--green); font-weight:600; }
        .badge-jpy { font-size:9px; padding:2px 6px; border-radius:4px; background:rgba(239,68,68,0.12); color:#fca5a5; font-weight:600; }

        /* ASSUMPTIONS & FOOTER */
        .assumptions { padding:14px 16px; background:rgba(255,255,255,0.02); border:1px solid var(--border-subtle); border-radius:10px; font-size:11px; color:var(--text-muted); line-height:1.6; margin-top:16px; }
        .assumptions strong{color:var(--text-secondary)}
        .footer { text-align:center; padding-top:24px; border-top:1px solid var(--border-subtle); font-size:11px; color:var(--text-muted); margin-top:24px; }
        .footer a{color:var(--orange-primary);text-decoration:none} .footer a:hover{text-decoration:underline}
        .footer-formula { font-family:var(--mono); font-size:10px; color:#333; margin-top:8px; }

        /* LOADING */
        .loading-screen { position:fixed; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center; background:var(--bg-primary); z-index:999; }
        .loading-spinner { width:32px; height:32px; border:3px solid #222; border-top-color:var(--orange-primary); border-radius:50%; animation:spin .8s linear infinite; margin-bottom:12px; }
        @keyframes spin{to{transform:rotate(360deg)}}
        .loading-text { font-size:12px; color:var(--text-muted); letter-spacing:2px; }

        @media(max-width:768px){ .hero-price{font-size:48px} }
        @media(max-width:480px){ .hero-price{font-size:40px} .control-value{font-size:16px} .logo{font-size:24px;letter-spacing:10px;padding-left:10px} }
    </style>
    <script defer src="/_vercel/insights/script.js"></script>
    <script defer src="/_vercel/speed-insights/script.js"></script>
</head>
<body>
<div class="loading-screen" id="loadingScreen"><div class="loading-spinner"></div><div class="loading-text">LOADING LIVE DATA</div></div>
<div class="container" id="app" style="display:none">
    <div class="header">
        <a href="/" class="nav-back">&larr; cebetracker.io</a>
        <div class="logo-container"><div class="logo-glow"></div><div class="logo"><span>CEBE</span></div><p class="logo-whisper">tracker</p></div>
        <div class="logo-badge">&#127471;&#127477; METAPLANET MODELER</div>
        <div class="header-sub">Pick a scenario. See what your MTPLF is worth.</div>
        <div class="live-strip" id="liveStrip">
            <span><span class="live-dot"></span> Live Data</span>
            <span class="live-price" id="liveBtcDisplay">BTC $&mdash;</span>
            <span class="live-price" id="liveFxDisplay">&yen;&mdash;/$</span>
            <span class="live-price" id="liveDataDate">&mdash;</span>
        </div>
    </div>
    <div class="scenarios-section">
        <div class="scenario-group">
            <div class="group-label"><span class="group-label-badge now">&#9889; NOW</span><span class="group-label-text">WHAT IF BTC WERE AT THIS PRICE TODAY</span><div class="group-label-line"></div></div>
            <div class="scenarios-row" id="snapshotBar"></div>
        </div>
        <div class="scenario-group">
            <div class="group-label"><span class="group-label-badge future">&rarr; SCENARIOS</span><span class="group-label-text">FX DYNAMICS &middot; BOJ &middot; GEROVICH MODEL</span><div class="group-label-line"></div></div>
            <div class="scenarios-row" id="projectionBar"></div>
        </div>
    </div>
    <div class="hero">
        <div class="hero-label">MODELED METAPLANET SHARE PRICE</div>
        <div class="hero-price neutral" id="heroPrice">&yen;&mdash;</div>
        <div class="hero-usd" id="heroUsd"></div>
        <div class="hero-change" id="heroChange">&mdash;</div>
        <div class="hero-vs" id="heroVs">vs current market price</div>
        <div class="hero-context" id="heroContext"></div>
        <div class="hero-fx fx-neutral" id="heroFx" style="display:none"></div>
        <div class="hero-implied" id="heroImplied" style="display:none">Market implies <em id="impliedMnavVal">&mdash;</em> mNAV</div>
    </div>
    <div class="narrative" id="narrativePanel"><div class="narrative-title" id="narrativeTitle">&#128269; What happens here</div><div class="narrative-body" id="narrativeBody"></div></div>
    <div class="metrics-grid" id="metricsGrid"></div>
    <details class="collapse-section" id="controlsSection">
        <summary>&#9881; Adjust Inputs</summary>
        <div class="collapse-body">
            <div class="controls-grid">
                <div class="control-card">
                    <div class="control-header"><span class="control-label">BTC PRICE</span><span class="control-value" id="btcPriceDisplay">$&mdash;</span></div>
                    <input type="range" id="btcSlider" min="20000" max="1000000" step="1000" value="100000">
                    <div class="slider-labels"><span>$20K</span><span>$500K</span><span>$1M</span></div>
                </div>
                <div class="control-card">
                    <div class="control-header"><span class="control-label">mNAV MULTIPLE</span><span class="control-value" id="mnavDisplay">1.00&times;</span></div>
                    <input type="range" id="mnavSlider" min="30" max="400" value="100">
                    <div class="mnav-presets" id="mnavPresets"></div>
                </div>
                <div class="control-card full-width fx-card">
                    <div class="control-header"><span class="control-label fx-label">&#127471;&#127477; JPY/USD EXCHANGE RATE</span><span class="control-value fx-value" id="fxDisplay">&yen;153</span></div>
                    <input type="range" class="fx-range" id="fxSlider" min="120" max="200" step="1" value="153">
                    <div class="slider-labels"><span>&yen;120 (strong)</span><span>&yen;153</span><span>&yen;200 (weak)</span></div>
                </div>
            </div>
        </div>
    </details>
    <details class="collapse-section"><summary>&#128256; Value Waterfall</summary><div class="collapse-body" style="padding:0"><div class="waterfall" id="waterfall"></div></div></details>
    <details class="collapse-section"><summary>&#127919; Price Sensitivity &mdash; BTC &times; mNAV</summary><div class="collapse-body" style="padding:0"><div class="table-wrap" style="overflow-x:auto;border-radius:10px"><table class="matrix-table" id="priceMatrix"></table></div></div></details>
    <details class="collapse-section"><summary>&#127471;&#127477; Drag Matrix &mdash; BTC &times; JPY/USD</summary><div class="collapse-body" style="padding:0"><div class="table-wrap" style="overflow-x:auto;border-radius:10px"><table class="matrix-table" id="dragMatrix"></table></div></div></details>
    <details class="collapse-section"><summary>&#9881; Capital Structure &amp; Bond Stack</summary><div class="collapse-body" id="customizeBody"></div></details>
    <div class="assumptions" id="assumptions"></div>
    <div class="footer">
        <p>CEBE Framework by <a href="https://x.com/chcbearsfan" target="_blank">&#64;chcbearsfan</a> &middot; <a href="/">cebetracker.io</a> &middot; <a href="https://x.com/chcbearsfan/status/2014767364819063207" target="_blank">Read the Framework</a></p>
        <p style="margin-top:4px">Not financial advice &middot; Data updates after each filing</p>
        <p class="footer-formula">CEBE = (Total BTC &minus; &yen; Claims &divide; JPY&middot;USD &divide; BTC Price) &divide; Shares</p>
    </div>
</div>
</body>
<script>
// ═══════════════════════════════════════════════════════════════
// CEBE METAPLANET SHARE PRICE MODELER v1
// Double Compression Engine · JPY/USD First-Class Variable
// Zero-Coupon Bond Structure · Dual Sensitivity Matrices
// cebetracker.io/modeler/metaplanet
// ═══════════════════════════════════════════════════════════════

var SHEET_ID='1BNsCWGVU08PDinDcfzJccqcuj9_KrK1VZGETErzBZvg';
var SNAPSHOTS_GID='771405586';

// Hardcoded capital structure from filings
var DEFAULTS={
    btc_holdings:35102,
    shares_outstanding:1140000000,
    debt_jpy:54.3e9,   // ~¥54.3B total zero-coupon JPY bonds (~$355M at ¥153)
    cash_usd:30e6,     // Approximate cash offset
    jpyusd:153,
    btc_price:68000,
    mtplf_price_jpy:340,
};

var SCENARIOS=[
    {id:'wipeout',  icon:'\u{1F480}',name:'Wipeout',    btc:25000,   mnav:0.5, fx:140, group:'snapshot'},
    {id:'current',  icon:'\u{1F4CD}',name:'Current',    btc:null,    mnav:1.0, fx:null,group:'snapshot'},
    {id:'ath',      icon:'\u{1F451}',name:'Former ATH', btc:126000,  mnav:1.5, fx:160, group:'snapshot'},
    {id:'boj',      icon:'\u{1F3E6}',name:'BOJ Shock',  btc:50000,   mnav:0.6, fx:130, group:'projection'},
    {id:'gerovich', icon:'\u{1F4D0}',name:'Gerovich',   btc:200000,  mnav:2.0, fx:170, group:'projection'},
    {id:'terminal', icon:'\u{1F300}',name:'Terminal',    btc:1000000, mnav:3.0, fx:180, group:'projection'},
];

var MNAV_PRESETS=[0.5,0.75,1.0,1.5,2.0,3.0];
var MATRIX_BTC=[25000,50000,75000,100000,150000,200000,300000,500000,1000000];
var MATRIX_MNAVS=[0.5,0.75,1.0,1.5,2.0,3.0];
var MATRIX_FX=[130,140,145,153,160,170,180,200];

// ─── STATE ───
var sheetData=null, liveBtcPrice=null, liveFxRate=null;
var btcPrice=DEFAULTS.btc_price, mnavMultiple=1.0, fxRate=DEFAULTS.jpyusd, activeScenario='current';

// ─── HELPERS ───
var $=function(id){return document.getElementById(id)};
var fmt=function(n){return Math.round(n).toLocaleString('en-US')};
var fmtB=function(n){return n>=1e9?'$'+(n/1e9).toFixed(1)+'B':n>=1e6?'$'+(n/1e6).toFixed(0)+'M':'$'+fmt(n)};
var fmtByen=function(n){return n>=1e12?'\u00a5'+(n/1e12).toFixed(1)+'T':n>=1e9?'\u00a5'+(n/1e9).toFixed(1)+'B':n>=1e6?'\u00a5'+(n/1e6).toFixed(0)+'M':'\u00a5'+fmt(n)};
var fmtPrice=function(p){if(p>=1e6)return '$'+(p/1e6).toFixed(1)+'M';if(p>=1000)return '$'+fmt(p);if(p>=1)return '$'+p.toFixed(2);return '$0.00'};
var fmtPct=function(p,d){return(p*100).toFixed(d!==undefined?d:1)+'%'};
var fmtSats=function(s){return fmt(Math.round(s))};
var fmtYen=function(y){if(y>=1e6)return '\u00a5'+(y/1e6).toFixed(1)+'M';if(y>=10000)return '\u00a5'+fmt(Math.round(y));if(y>=1)return '\u00a5'+Math.round(y);return '\u00a5'+y.toFixed(2)};

// ─── CSV ───
function parseCSVLine(l){var r=[],c='',q=false;for(var i=0;i<l.length;i++){var ch=l[i];if(ch==='"')q=!q;else if(ch===','&&!q){r.push(c);c=''}else c+=ch}r.push(c);return r}
function parseCSV(text){var lines=text.split('\n'),headers=parseCSVLine(lines[0]);return lines.slice(1).filter(function(l){return l.trim()}).map(function(l){var vals=parseCSVLine(l),row={};headers.forEach(function(h,i){row[h.replace(/"/g,'').trim()]=vals[i]?vals[i].replace(/"/g,'').trim():''});return row})}

// ─── DATA LOADING ───
async function loadData(){
    try{
        var results=await Promise.all([
            fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd,jpy').then(function(r){return r.json()}).catch(function(){return null}),
            fetch('https://docs.google.com/spreadsheets/d/'+SHEET_ID+'/gviz/tq?tqx=out:csv&gid='+SNAPSHOTS_GID).then(function(r){return r.text()}).catch(function(){return null}),
        ]);
        var btcRes=results[0],sheetText=results[1];
        if(btcRes&&btcRes.bitcoin){
            liveBtcPrice=btcRes.bitcoin.usd;
            if(btcRes.bitcoin.jpy&&btcRes.bitcoin.usd)liveFxRate=Math.round(btcRes.bitcoin.jpy/btcRes.bitcoin.usd);
        }
        if(sheetText){
            var rows=parseCSV(sheetText),best=null;
            rows.forEach(function(r){if(r.ticker==='MTPLF'&&(!r.status||r.status.toLowerCase()==='live')){if(!best||r.snapshot_date>best.snapshot_date)best=r}});
            if(best)sheetData=best;
        }
        btcPrice=liveBtcPrice||getVal('btc_price',DEFAULTS.btc_price);
        fxRate=liveFxRate||DEFAULTS.jpyusd;
        SCENARIOS[1].btc=btcPrice; SCENARIOS[1].fx=fxRate;
        $('loadingScreen').style.display='none';$('app').style.display='block';
        buildScenarioBar();buildMnavPresets();syncSliders();render();
    }catch(err){
        console.error('Load failed:',err);
        $('loadingScreen').innerHTML='<div style="text-align:center;color:#a1a1aa;font-size:13px"><p style="margin-bottom:12px">Failed to load data</p><p style="font-size:11px;color:#52525b">'+err.message+'</p><p style="margin-top:12px"><a href="/" style="color:#f97316">&larr; Back to cebetracker.io</a></p></div>';
    }
}
function getVal(field,fallback){if(sheetData&&sheetData[field]!==undefined&&sheetData[field]!==''){var v=parseFloat(sheetData[field]);if(!isNaN(v))return v}return fallback}
function getInputs(){
    return{
        btcH:getVal('btc_holdings',DEFAULTS.btc_holdings),
        shares:getVal('shares_outstanding',DEFAULTS.shares_outstanding),
        debtJpy:DEFAULTS.debt_jpy,
        cashUsd:getVal('cash_usd',DEFAULTS.cash_usd),
        snapshotDate:sheetData?sheetData.snapshot_date||'\u2014':'\u2014',
    };
}

// ═══════════════════════════════════════════════════
// CEBE MATH ENGINE (with FX)
// ═══════════════════════════════════════════════════
function calcCEBE(btcH,shares,debtJpy,cashUsd,bp,fx,mn){
    var p=bp||btcPrice, f=fx||fxRate, m=mn!==undefined?mn:mnavMultiple;
    var claimsUsd=f>0?debtJpy/f:0;
    var netClaimsUsd=Math.max(0,claimsUsd-cashUsd);
    var claimsBtc=p>0?netClaimsUsd/p:0;
    var drag=btcH>0?Math.max(0,Math.min(1,claimsBtc/btcH)):0;
    var commonBtc=Math.max(0,btcH-claimsBtc);
    var cebeSats=shares>0?(commonBtc/shares)*1e8:0;
    var bpsSats=shares>0?(btcH/shares)*1e8:0;
    var amp=drag<.999?1/(1-drag):Infinity;
    var breakEven=btcH>0?netClaimsUsd/btcH:0;
    var navUsd=Math.max(0,(btcH*p)-netClaimsUsd);
    var navPerShare=shares>0?navUsd/shares:0;
    var navJpy=navPerShare*f;
    var modeledJpy=navJpy*m;
    var modeledUsd=navPerShare*m;
    return{commonBtc:commonBtc,cebeSats:cebeSats,bpsSats:bpsSats,drag:drag,amp:amp,breakEven:breakEven,
        navUsd:navUsd,navPerShare:navPerShare,navJpy:navJpy,modeledJpy:modeledJpy,modeledUsd:modeledUsd,
        netClaimsUsd:netClaimsUsd,claimsUsd:claimsUsd,btcHoldings:btcH,shares:shares};
}

function quickPrice(bp,mn){var inp=getInputs();return calcCEBE(inp.btcH,inp.shares,inp.debtJpy,inp.cashUsd,bp,fxRate,mn).modeledJpy}
function quickDrag(bp,fx){var inp=getInputs();return calcCEBE(inp.btcH,inp.shares,inp.debtJpy,inp.cashUsd,bp,fx,1.0).drag}

// ═══════════════════════════════════════════════════
// RENDERING
// ═══════════════════════════════════════════════════
function render(){
    var inp=getInputs();
    var r=calcCEBE(inp.btcH,inp.shares,inp.debtJpy,inp.cashUsd,btcPrice,fxRate,mnavMultiple);
    var marketJpy=DEFAULTS.mtplf_price_jpy;
    renderHero(r,marketJpy);renderNarrative(r,inp);renderMetrics(r,inp);
    renderWaterfall(r,inp);renderPriceMatrix();renderDragMatrix();renderCapStructure(r,inp);renderAssumptions(inp);
    $('liveBtcDisplay').textContent='BTC '+fmtPrice(liveBtcPrice||btcPrice);
    $('liveFxDisplay').textContent='\u00a5'+(liveFxRate||fxRate)+'/$';
    $('liveDataDate').textContent=inp.snapshotDate!=='\u2014'?'Data: '+inp.snapshotDate:'';
    updateSliderFills();
}

function renderHero(r,marketJpy){
    var el=$('heroPrice');
    if(r.modeledJpy<=0||!isFinite(r.modeledJpy)){
        el.textContent='\u00a50';el.className='hero-price negative';$('heroUsd').textContent='';
        $('heroChange').textContent='\u2212100%';$('heroChange').className='hero-change down';
        $('heroVs').textContent='common equity wiped out';$('heroContext').textContent='';
        $('heroFx').style.display='none';$('heroImplied').style.display='none';return;
    }
    el.textContent=fmtYen(r.modeledJpy);
    $('heroUsd').innerHTML='\u2248 $'+(r.modeledUsd>=1?r.modeledUsd.toFixed(2):r.modeledUsd.toFixed(4))+' USD';
    var pctC=(r.modeledJpy-marketJpy)/marketJpy, sign=pctC>=0?'+':'';
    $('heroChange').textContent=sign+(pctC*100).toFixed(1)+'%';
    $('heroChange').className='hero-change '+(pctC>=0?'up':'down');
    el.className='hero-price '+(pctC>.05?'positive':pctC<-.05?'negative':'neutral');
    $('heroVs').textContent='vs market \u00a5'+marketJpy;
    $('heroContext').textContent='instant snapshot \u00b7 \u00a5'+fxRate+'/$ FX rate';

    // FX badge
    var baseFx=liveFxRate||DEFAULTS.jpyusd, fb=$('heroFx');
    if(Math.abs(fxRate-baseFx)>2){
        var dir=fxRate>baseFx?'compress':'expand';
        fb.className='hero-fx '+dir;
        fb.textContent=dir==='compress'?'FX \u2193 JPY weak \u2192 drag compresses':'FX \u2191 JPY strong \u2192 drag expands';
        fb.style.display='inline-block';
    }else{fb.className='hero-fx fx-neutral';fb.textContent='FX neutral';fb.style.display='inline-block'}

    // Implied mNAV
    if(marketJpy>0&&r.navJpy>0){$('impliedMnavVal').textContent=(marketJpy/r.navJpy).toFixed(2)+'\u00d7';$('heroImplied').style.display='inline-block'}
    else{$('heroImplied').style.display='none'}
}

function renderNarrative(r,inp){
    var items=[], dp=r.drag*100, cp=(1-r.drag)*100;
    var sObj=SCENARIOS.find(function(s){return s.id===activeScenario}), sName=sObj?sObj.name:'Custom';
    $('narrativeTitle').innerHTML='\u{1F50D} '+sName+' \u2014 '+fmtPrice(btcPrice)+' BTC \u00b7 \u00a5'+fxRate+'/$';

    // Drag
    if(r.drag<.05)items.push({cls:'green',icon:'\u2705',text:'<strong>Drag nearly zero ('+dp.toFixed(1)+'%).</strong> Common owns '+cp.toFixed(1)+'% of Metaplanet\u2019s '+fmt(inp.btcH)+' BTC.'});
    else if(r.drag<.20)items.push({cls:'green',icon:'\u{1F4C8}',text:'<strong>Low drag ('+dp.toFixed(1)+'%).</strong> Common owns '+cp.toFixed(1)+'% of the Bitcoin. Claims '+fmtB(r.netClaimsUsd)+' ('+fmtByen(inp.debtJpy)+').'});
    else if(r.drag<.40)items.push({cls:'neutral',icon:'\u2696',text:'<strong>Moderate drag ('+dp.toFixed(1)+'%).</strong> Common owns '+cp.toFixed(1)+'% of BTC. Net claims '+fmtB(r.netClaimsUsd)+'.'});
    else if(r.drag<.70)items.push({cls:'amber',icon:'\u26A0',text:'<strong>High drag ('+dp.toFixed(1)+'%).</strong> Only '+cp.toFixed(1)+'% of Bitcoin left for common.'});
    else items.push({cls:'red',icon:'\u{1F4A5}',text:'<strong>Critical drag ('+dp.toFixed(1)+'%).</strong> Senior claims consume most Bitcoin value.'});

    // Zero carry cost — always show
    items.push({cls:'info',icon:'\u{1F4B0}',text:'<strong>Zero carry cost.</strong> Unlike Strategy\u2019s ~$1.4B/yr preferred dividend obligation, Metaplanet\u2019s zero-coupon bonds cost \u00a50 in annual interest. No cash drain, no share dilution from dividend coverage.'});

    // FX dynamics
    var baseFx=liveFxRate||DEFAULTS.jpyusd;
    if(fxRate>baseFx+5){
        var baseR=calcCEBE(inp.btcH,inp.shares,inp.debtJpy,inp.cashUsd,btcPrice,baseFx,mnavMultiple);
        var fc=((baseR.drag-r.drag)*100).toFixed(1);
        items.push({cls:'green',icon:'\u{1F4B1}',text:'<strong>Double compression active.</strong> Weak yen (\u00a5'+fxRate+' vs baseline \u00a5'+baseFx+') shrinks JPY claims in USD terms. FX contributed ~'+fc+'pp of drag compression.'});
    }else if(fxRate<baseFx-5){
        var baseR=calcCEBE(inp.btcH,inp.shares,inp.debtJpy,inp.cashUsd,btcPrice,baseFx,mnavMultiple);
        var fc=((r.drag-baseR.drag)*100).toFixed(1);
        items.push({cls:'red',icon:'\u{1F4B1}',text:'<strong>Double expansion risk.</strong> Strong yen (\u00a5'+fxRate+' vs baseline \u00a5'+baseFx+') inflates JPY claims in USD terms. FX added ~'+fc+'pp of drag expansion.'});
    }

    // Break-even
    if(btcPrice<=r.breakEven)items.push({cls:'red',icon:'\u{1F480}',text:'<strong>Below break-even ('+fmtPrice(r.breakEven)+').</strong> Common equity theoretically \u00a50.'});
    else if(btcPrice<=r.breakEven*1.15)items.push({cls:'red',icon:'\u26A0',text:'<strong>Near break-even.</strong> BTC only '+((btcPrice/r.breakEven-1)*100).toFixed(0)+'% above '+fmtPrice(r.breakEven)+' floor.'});
    else if(btcPrice>r.breakEven*3)items.push({cls:'green',icon:'\u{1F6E1}',text:'<strong>Break-even safety margin: '+((btcPrice/r.breakEven-1)*100).toFixed(0)+'%.</strong> BTC must fall to '+fmtPrice(r.breakEven)+' to wipe common equity.'});

    // Scenario-specific
    if(activeScenario==='boj')items.push({cls:'amber',icon:'\u{1F3E6}',text:'<strong>BOJ Shock scenario.</strong> Bank of Japan tightens aggressively. Yen surges to \u00a5130/$. Combined with BTC decline to $50K, drag expands from both FX and price. This is Metaplanet\u2019s structural risk \u2014 the double compression engine works in reverse.'});
    if(activeScenario==='gerovich')items.push({cls:'info',icon:'\u{1F4D0}',text:'<strong>Gerovich Model.</strong> 555 Million Plan executing. BTC $200K, yen weakens to \u00a5170 as BOJ maintains accommodation. Zero-cost bond leverage + FX tailwind = maximum drag compression. Target: 100K BTC by end 2026.'});
    if(activeScenario==='terminal')items.push({cls:'green',icon:'\u{1F300}',text:'<strong>Terminal value.</strong> At $1M BTC with \u00a5180/$, drag becomes negligible. CEBE converges to BPS. Common equity owns effectively 100% of the Bitcoin.'});

    $('narrativeBody').innerHTML=items.map(function(i){return'<div class="narr-item '+i.cls+'"><span class="narr-icon">'+i.icon+'</span><span class="narr-text">'+i.text+'</span></div>'}).join('');
}

function renderMetrics(r,inp){
    var metrics=[
        {label:'CEBE',value:fmtSats(r.cebeSats),sub:'sats/share',cls:r.cebeSats<=0?'danger':''},
        {label:'DRAG',value:fmtPct(r.drag),sub:fmtPct(1-r.drag)+' to common',cls:r.drag>.5?'danger':r.drag>.35?'warn':r.drag>.20?'':'good'},
        {label:'AMPLIFICATION',value:r.amp>100?'\u221e':r.amp.toFixed(2)+'\u00d7',sub:((r.amp-1)*100).toFixed(0)+'% amplified',cls:''},
        {label:'BREAK-EVEN',value:fmtPrice(r.breakEven),sub:'BTC floor',cls:btcPrice<=r.breakEven*1.1?'danger':btcPrice<=r.breakEven*1.5?'warn':''},
        {label:'NAV/SHARE',value:fmtYen(r.navJpy),sub:'\u00d7 '+mnavMultiple.toFixed(2)+' mNAV',cls:''},
        {label:'ANNUAL COST',value:'\u00a50',sub:'zero-coupon',cls:'good'},
    ];
    $('metricsGrid').innerHTML=metrics.map(function(m){return'<div class="metric-card"><div class="metric-label">'+m.label+'</div><div class="metric-value '+m.cls+'">'+m.value+'</div><div class="metric-sub">'+m.sub+'</div></div>'}).join('');
}

function renderWaterfall(r,inp){
    var totalBtcVal=inp.btcH*btcPrice;
    $('waterfall').innerHTML=
        '<div class="wf-step btc-val"><div class="wf-label">BTC VALUE</div><div class="wf-value">'+fmtB(totalBtcVal)+'</div></div>'+
        '<div class="wf-arrow">\u2192</div><div class="wf-step claims"><div class="wf-label">\u2212 \u00a5 CLAIMS</div><div class="wf-value">'+fmtB(r.netClaimsUsd)+'</div></div>'+
        '<div class="wf-arrow">\u2192</div><div class="wf-step nav"><div class="wf-label">= NAV</div><div class="wf-value">'+fmtB(r.navUsd)+'</div></div>'+
        '<div class="wf-arrow">\u2192</div><div class="wf-step shares"><div class="wf-label">\u00f7 '+(inp.shares/1e9).toFixed(2)+'B</div><div class="wf-value">SHARES</div></div>'+
        '<div class="wf-arrow">\u2192</div><div class="wf-step shares"><div class="wf-label">NAV/SH</div><div class="wf-value">'+fmtYen(r.navJpy)+'</div></div>'+
        '<div class="wf-arrow">\u2192</div><div class="wf-step shares"><div class="wf-label">\u00d7 mNAV</div><div class="wf-value">'+mnavMultiple.toFixed(2)+'\u00d7</div></div>'+
        '<div class="wf-arrow">\u2192</div><div class="wf-step result"><div class="wf-label">PRICE</div><div class="wf-value" style="color:var(--orange-primary)">'+fmtYen(r.modeledJpy)+'</div></div>';
}

function renderPriceMatrix(){
    var marketJpy=DEFAULTS.mtplf_price_jpy;
    var html='<thead><tr><th>BTC \u2193 mNAV \u2192</th>';
    MATRIX_MNAVS.forEach(function(m){html+='<th>'+m.toFixed(2)+'\u00d7</th>'});
    html+='</tr></thead><tbody>';
    MATRIX_BTC.forEach(function(bp){
        html+='<tr><td class="row-label">'+(bp>=1e6?'$'+(bp/1e6)+'M':'$'+(bp/1000)+'K')+'</td>';
        MATRIX_MNAVS.forEach(function(mn){
            var pJpy=quickPrice(bp,mn), pctD=marketJpy>0?(pJpy-marketJpy)/marketJpy:0, cls='';
            if(pJpy>=10000)cls='matrix-cell-gold';else if(pctD>.5)cls='matrix-cell-green';else if(pctD>.1)cls='matrix-cell-lightgreen';else if(pctD<-.5)cls='matrix-cell-red';else if(pctD<-.1)cls='matrix-cell-lightred';
            var isBtc=Math.abs(bp-btcPrice)/btcPrice<.15,isMnav=Math.abs(mn-mnavMultiple)<.05;
            if(isBtc&&isMnav)cls+=' matrix-cell-current';
            html+='<td class="'+cls+'">'+(pJpy<=0?'\u00a50':fmtYen(pJpy))+'</td>';
        });html+='</tr>';
    });html+='</tbody>';
    $('priceMatrix').innerHTML=html;
}

function renderDragMatrix(){
    var html='<thead><tr><th>BTC \u2193 JPY/$ \u2192</th>';
    MATRIX_FX.forEach(function(fx){html+='<th>\u00a5'+fx+'</th>'});
    html+='</tr></thead><tbody>';
    MATRIX_BTC.forEach(function(bp){
        html+='<tr><td class="row-label">'+(bp>=1e6?'$'+(bp/1e6)+'M':'$'+(bp/1000)+'K')+'</td>';
        MATRIX_FX.forEach(function(fx){
            var drag=quickDrag(bp,fx), cls='';
            if(drag<.05)cls='matrix-cell-green';else if(drag<.10)cls='matrix-cell-lightgreen';else if(drag>.50)cls='matrix-cell-red';else if(drag>.30)cls='matrix-cell-lightred';
            var isBtc=Math.abs(bp-btcPrice)/btcPrice<.15,isFx=Math.abs(fx-fxRate)<5;
            if(isBtc&&isFx)cls+=' matrix-cell-current';
            html+='<td class="'+cls+'">'+fmtPct(drag)+'</td>';
        });html+='</tr>';
    });html+='</tbody>';
    $('dragMatrix').innerHTML=html;
}

function renderCapStructure(r,inp){
    $('customizeBody').innerHTML=
        '<div style="margin-bottom:16px"><div style="font-size:11px;color:var(--text-muted);letter-spacing:1px;margin-bottom:8px;font-weight:600">ZERO-COUPON BOND STACK</div>'+
        '<table class="bond-stack"><thead><tr><th>INSTRUMENT</th><th>FACE VALUE</th><th>INTEREST</th><th>CURRENCY</th><th>TYPE</th></tr></thead><tbody>'+
        '<tr><td>JPY Bonds (Aggregate)</td><td>'+fmtByen(inp.debtJpy)+'</td><td><span class="badge-zero">0%</span></td><td><span class="badge-jpy">JPY</span></td><td>Zero-coupon, unsecured</td></tr>'+
        '<tr style="border-top:2px solid var(--border-subtle)"><td style="color:var(--text-secondary)">USD EQUIVALENT</td><td style="color:var(--orange-primary);font-weight:700">'+fmtB(r.claimsUsd)+'</td><td></td><td style="font-size:10px;color:var(--text-muted)">\u00a5'+fxRate+'/$</td><td></td></tr>'+
        '</tbody></table></div>'+
        '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:14px">'+
        '<div class="metric-card"><div class="metric-label">ANNUAL COST</div><div class="metric-value good">\u00a50</div><div class="metric-sub">zero-coupon</div></div>'+
        '<div class="metric-card"><div class="metric-label">BTC HOLDINGS</div><div class="metric-value">'+fmt(inp.btcH)+'</div><div class="metric-sub">BTC</div></div>'+
        '<div class="metric-card"><div class="metric-label">SHARES</div><div class="metric-value">'+(inp.shares/1e9).toFixed(2)+'B</div><div class="metric-sub">outstanding</div></div></div>'+
        '<div style="font-size:11px;color:var(--text-muted);line-height:1.6">'+
        '<strong style="color:var(--text-secondary)">Structural advantage:</strong> Zero carry cost. No dividends, no interest. Bond obligations are principal-only at maturity. Issued as unsecured ordinary bonds to EVO Fund. All JPY-denominated \u2014 FX movements directly affect claims in BTC terms.'+
        '<br><br><strong style="color:var(--text-secondary)">Key risk:</strong> Bond maturity refinancing. If BTC price is low AND yen is strong at maturity, refinancing becomes expensive. Unlike Strategy\u2019s converts, these bonds have no equity conversion option.'+
        '<br><br><strong style="color:var(--text-secondary)">555 Million Plan:</strong> Targets 100K BTC by end 2026, 210K BTC by 2027. Funding via equity raises + additional bond issuance.</div>';
}

function renderAssumptions(inp){
    var t='<strong>Assumptions:</strong> Capital structure snapshot ('+inp.snapshotDate+'). All bonds JPY-denominated zero-coupon. BTC price static. FX rate set by user. No bond maturity modeling in v1 (snapshot only). Cash position approximate.';
    t+='<br><br><strong>Data:</strong> Holdings from Google Sheet (post-filing updates). Live BTC + JPY/USD derived from CoinGecko (BTC/JPY \u00f7 BTC/USD). Bond aggregate ~\u00a554.3B from Metaplanet analytics ($355M outstanding). Share count 1.14B from filings.';
    t+='<br><br><strong>FX derivation:</strong> JPY/USD = BTC price in JPY \u00f7 BTC price in USD. This gives the market-consistent cross rate without needing a separate FX API.';
    $('assumptions').innerHTML=t;
}

// ═══════════════════════════════════════════════════
// UI BUILDERS
// ═══════════════════════════════════════════════════
function buildScenarioBar(){
    var snaps=SCENARIOS.filter(function(s){return s.group==='snapshot'});
    var projs=SCENARIOS.filter(function(s){return s.group==='projection'});
    function renderCard(s){
        var isP=s.group==='projection';
        var bClass=isP?'future-badge':'now-badge', hLabel=isP?'FX':'NOW';
        var cClass='scenario-card'+(isP?' projection':'')+(s.id===activeScenario?' active':'');
        var pDisp;
        if(s.btc)pDisp=s.btc>=1e6?'$'+(s.btc/1e6)+'M':'$'+(s.btc/1000)+'K';
        else pDisp=fmtPrice(btcPrice);
        var mDisp=(s.mnav||1).toFixed(1)+'\u00d7 mNAV';
        var fxDisp=s.fx?'\u00a5'+s.fx+'/$':'\u00a5'+fxRate+'/$';
        return'<div class="'+cClass+'" data-scenario="'+s.id+'"><span class="horizon-badge '+bClass+'">'+hLabel+'</span><div class="scenario-icon">'+s.icon+'</div><div class="scenario-name">'+s.name+'</div><div class="scenario-price">'+pDisp+'</div><div class="scenario-mnav">'+mDisp+'</div><div class="scenario-fx">'+fxDisp+'</div></div>';
    }
    $('snapshotBar').innerHTML=snaps.map(renderCard).join('');
    $('projectionBar').innerHTML=projs.map(renderCard).join('');
    document.querySelectorAll('.scenario-card').forEach(function(card){
        card.addEventListener('click',function(){
            var id=this.dataset.scenario,sc=SCENARIOS.find(function(s){return s.id===id});if(!sc)return;
            activeScenario=id;
            btcPrice=sc.btc||(liveBtcPrice||DEFAULTS.btc_price);
            mnavMultiple=sc.mnav||1.0;
            fxRate=sc.fx||(liveFxRate||DEFAULTS.jpyusd);
            syncSliders();buildScenarioBar();updateMnavPresets();render();
        });
    });
}

function buildMnavPresets(){
    $('mnavPresets').innerHTML=MNAV_PRESETS.map(function(m){return'<button class="mnav-btn '+(Math.abs(m-mnavMultiple)<.01?'active':'')+'" data-mnav="'+m+'">'+(m%1===0?m.toFixed(0):m.toFixed(2))+'\u00d7</button>'}).join('');
    document.querySelectorAll('.mnav-btn').forEach(function(btn){
        btn.addEventListener('click',function(){mnavMultiple=parseFloat(this.dataset.mnav);$('mnavSlider').value=mnavMultiple*100;$('mnavDisplay').textContent=mnavMultiple.toFixed(2)+'\u00d7';activeScenario='';updateMnavPresets();buildScenarioBar();render()});
    });
}
function updateMnavPresets(){document.querySelectorAll('.mnav-btn').forEach(function(btn){btn.classList.toggle('active',Math.abs(parseFloat(btn.dataset.mnav)-mnavMultiple)<.01)})}
function syncSliders(){
    $('btcSlider').value=btcPrice;$('btcPriceDisplay').textContent=fmtPrice(btcPrice);
    $('mnavSlider').value=mnavMultiple*100;$('mnavDisplay').textContent=mnavMultiple.toFixed(2)+'\u00d7';
    $('fxSlider').value=fxRate;$('fxDisplay').textContent='\u00a5'+fxRate;
    updateMnavPresets();
}
function updateSliderFills(){
    var bs=$('btcSlider'),bp=((bs.value-20000)/(1e6-20000))*100;bs.style.background='linear-gradient(90deg,var(--orange-primary) '+bp+'%,#333 '+bp+'%)';
    var ms=$('mnavSlider'),mp=((ms.value-30)/(400-30))*100;ms.style.background='linear-gradient(90deg,var(--orange-primary) '+mp+'%,#333 '+mp+'%)';
    var fs=$('fxSlider'),fp=((fs.value-120)/(200-120))*100;fs.style.background='linear-gradient(90deg,var(--red) '+fp+'%,#333 '+fp+'%)';
}

// ─── SLIDER EVENTS ───
$('btcSlider').addEventListener('input',function(e){btcPrice=parseInt(e.target.value);$('btcPriceDisplay').textContent=fmtPrice(btcPrice);activeScenario='';buildScenarioBar();render()});
$('mnavSlider').addEventListener('input',function(e){mnavMultiple=parseInt(e.target.value)/100;$('mnavDisplay').textContent=mnavMultiple.toFixed(2)+'\u00d7';activeScenario='';updateMnavPresets();buildScenarioBar();render()});
$('fxSlider').addEventListener('input',function(e){fxRate=parseInt(e.target.value);$('fxDisplay').textContent='\u00a5'+fxRate;activeScenario='';buildScenarioBar();render()});

// ─── KEYBOARD SHORTCUTS ───
document.addEventListener('keydown',function(e){
    if(e.target.tagName==='INPUT')return;
    if(e.key>='1'&&e.key<='6'){var idx=parseInt(e.key)-1;if(SCENARIOS[idx]){var sc=SCENARIOS[idx];activeScenario=sc.id;
        btcPrice=sc.btc||(liveBtcPrice||DEFAULTS.btc_price);mnavMultiple=sc.mnav||1.0;fxRate=sc.fx||(liveFxRate||DEFAULTS.jpyusd);
        syncSliders();buildScenarioBar();updateMnavPresets();render()}}
});

loadData();
</script>
</html>
